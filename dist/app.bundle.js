(()=>{var Bo=Object.defineProperty;var G=(e,o)=>()=>(e&&(o=e(e=0)),o);var Z=(e,o)=>{for(var t in o)Bo(e,t,{get:o[t],enumerable:!0})};function pe(e){x=e}function we(e){M=e}function me(e){A=e}function ve(e){P=e}function We(e){ze=e}function De(e){xe=e}function je(e){Xe=e}function Me(e){qe=e}function Xt(e){de=e}function Wt(e){ue=e}function jt(e){oe=e}function Gt(e){J=e}function Kt(e){Ro=e}function Ge(e,o){ne=e,re=o}function Jt(e){V=e}function Ke(e){mt=e}function gt(e){pt=e}var x,M,V,Ce,A,qe,k,ut,q,ze,xe,Xe,pt,de,ue,oe,D,J,Ro,be,ne,re,P,mt,X=G(()=>{x=[{id:1,productCode:"1ATC50001AP",name:"Acetaminophen 500mg",batchSizeKg:51.08,date:"2023-01-15T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,2,6,11,13,16],activeIngredients:[{id:1,name:"Acetaminophen",therapeuticDose:500,mdd:4e3,solubility:"Freely soluble",cleanability:"Easy",pde:12.5,ld50:1944}]},{id:2,productCode:"2IBU20011PN",name:"Ibuprofen 200mg",batchSizeKg:113.51,date:"2023-02-20T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,3,5,12,16],activeIngredients:[{id:2,name:"Ibuprofen",therapeuticDose:200,mdd:1200,solubility:"Practically insoluble",cleanability:"Medium",pde:1.2,ld50:636}]},{id:3,productCode:"3CFR18003MX",name:"Cold & Flu Relief",batchSizeKg:180,date:"2023-03-10T10:00:00.000Z",isCritical:!0,criticalReason:"Stains equipment yellow",productType:"Tablets",machineIds:[1,2,6,11,13,16],activeIngredients:[{id:3,name:"Acetaminophen",therapeuticDose:650,mdd:3900,solubility:"Freely soluble",cleanability:"Easy",pde:12.5,ld50:1944},{id:4,name:"Phenylephrine HCl",therapeuticDose:10,mdd:60,solubility:"Very soluble",cleanability:"Easy",pde:.6,ld50:350},{id:5,name:"Dextromethorphan HBr",therapeuticDose:30,mdd:120,solubility:"Slightly soluble",cleanability:"Medium",pde:1,ld50:750}]},{id:4,productCode:"4ASA32504AC",name:"Aspirin 325mg",batchSizeKg:75.5,date:"2023-04-05T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,4,7,12,16],activeIngredients:[{id:6,name:"Aspirin",therapeuticDose:325,mdd:4e3,solubility:"Slightly soluble",cleanability:"Medium",pde:.5,ld50:null}]},{id:5,productCode:"5OME02005PR",name:"Omeprazole 20mg",batchSizeKg:25.2,date:"2023-05-25T10:00:00.000Z",isCritical:!0,criticalReason:"New API",productType:"Capsules",machineIds:[1,5,9,14,15],activeIngredients:[{id:7,name:"Omeprazole",therapeuticDose:20,mdd:40,solubility:"Practically insoluble",cleanability:"Hard",pde:.013,ld50:null}]},{id:6,productCode:"6PCX00506XP",name:"Potent Compound X",batchSizeKg:5,date:"2023-06-30T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Sterile Products",machineIds:[1,5,10,14,15],activeIngredients:[{id:8,name:"Potent Compound X",therapeuticDose:1,mdd:2,solubility:"Slightly soluble",cleanability:"Hard",pde:5e-4,ld50:25}]}],M=[{id:1,machineNumber:"M-001",name:"weighing tool",stage:"Weighing",area:55e3,group:""},{id:2,machineNumber:"M-002",name:"nin mill",stage:"Milling",area:35e3,group:""},{id:3,machineNumber:"M-003",name:"fitz mill",stage:"Milling",area:42e3,group:""},{id:4,machineNumber:"M-004",name:"FBD",stage:"Mixing",area:12e4,group:""},{id:5,machineNumber:"M-005",name:"Glatt",stage:"Mixing",area:95e3,group:""},{id:6,machineNumber:"M-006",name:"Compactor",stage:"Mixing",area:85e3,group:""},{id:7,machineNumber:"M-007",name:"Bin 200",stage:"Mixing",area:45e3,group:"Mixing Bins"},{id:8,machineNumber:"M-008",name:"Bin 400",stage:"Mixing",area:65e3,group:"Mixing Bins"},{id:9,machineNumber:"M-009",name:"Bin 600",stage:"Mixing",area:85e3,group:"Mixing Bins"},{id:10,machineNumber:"M-010",name:"Bin 800",stage:"Mixing",area:105e3,group:"Mixing Bins"},{id:11,machineNumber:"M-011",name:"Jcmco",stage:"Compression",area:15e4,group:"Compression Machines"},{id:12,machineNumber:"M-012",name:"Natoli",stage:"Compression",area:165e3,group:"Compression Machines"},{id:13,machineNumber:"M-013",name:"Korsch",stage:"Compression",area:18e4,group:"Compression Machines"},{id:14,machineNumber:"M-014",name:"Coat",stage:"Coating",area:11e4,group:""},{id:15,machineNumber:"M-015",name:"jar filling",stage:"Filling",area:75e3,group:""},{id:16,machineNumber:"M-016",name:"Bliste",stage:"Packing",area:22e4,group:""}],V=["Weighing","Mixing","Milling","Compression","Coating","Filling","Packing","Other"],Ce=["Mixing Bins","Compression Machines","Milling Equipment","Granulators","Coating Equipment","Packaging Equipment","Weighing Equipment","Filling Equipment"],A=[{id:1,name:"Default Detergent",ld50:5e3}],qe=2,k={"Sterile Products":{min:1e3,max:1e4,route:"Sterile"},Semisolids:{min:10,max:100,route:"Topical"},Tablets:{min:100,max:1e3,route:"Oral"},Capsules:{min:100,max:1e3,route:"Oral"},Liquids:{min:100,max:1e3,route:"Oral"},Other:{min:100,max:1e3,route:"Oral"}},ut=["Sterile Products","Semisolids","Tablets","Capsules","Liquids","Other"],q={productRegister:[],worstCaseProducts:[]},ze=x.length>0?Math.max(...x.map(e=>e.id))+1:1,xe=x.length>0?Math.max(...x.flatMap(e=>e.activeIngredients.map(o=>o.id)))+1:1,Xe=M.length>0?Math.max(...M.map(e=>e.id))+1:1,pt=0,oe=!1,D={key:"rpn",direction:"desc"},J={key:"name",direction:"asc"},Ro="dashboard",be=new Map,ne=[],re=-1,P={solubility:{title:"Solubility Rating",defaultScore:3,type:"exactMatch",criteria:[{text:"Very soluble",score:1},{text:"Freely soluble",score:2},{text:"Soluble",score:3},{text:"Sparingly soluble",score:4},{text:"Slightly soluble",score:5},{text:"Very slightly soluble",score:6},{text:"Practically insoluble",score:7},{text:"Insoluble",score:7}]},therapeuticDose:{title:"Therapeutic Dose Rating",defaultScore:3,type:"range",criteria:[{text:">1000 mg",score:1,lowerBound:1e3,comparison:"greater_exclusive"},{text:"100-1000 mg",score:2,lowerBound:100,upperBound:1e3,comparison:"between_inclusive_both"},{text:"10-99 mg",score:3,lowerBound:10,upperBound:99,comparison:"between_inclusive_both"},{text:"1-9 mg",score:4,lowerBound:1,upperBound:9,comparison:"between_inclusive_both"},{text:"<1 mg",score:5,upperBound:1,comparison:"less_exclusive"}]},cleanability:{title:"Cleanability Rating",defaultScore:2,type:"exactMatch",criteria:[{text:"Easy",score:1},{text:"Medium",score:2},{text:"Hard",score:3}]},toxicityLd50:{title:"Toxicity Rating (LD50)",defaultScore:3,type:"range",criteria:[{text:">5000 mg/kg",score:1,lowerBound:5e3,comparison:"greater_exclusive"},{text:"500-5000 mg/kg",score:2,lowerBound:500,upperBound:5e3,comparison:"between_inclusive_both"},{text:"50-499 mg/kg",score:3,lowerBound:50,upperBound:499,comparison:"between_inclusive_both"},{text:"1-49 mg/kg",score:4,lowerBound:1,upperBound:49,comparison:"between_inclusive_both"},{text:"<1 mg/kg",score:5,upperBound:1,comparison:"less_exclusive"}]},toxicityPde:{title:"PDE Rating (mg/day)",defaultScore:3,type:"range",criteria:[{text:"\u2264 0.001",score:10,upperBound:.001,comparison:"less_inclusive"},{text:">0.001 \u2013 \u22640.01",score:9,lowerBound:.001,upperBound:.01,comparison:"between_exclusive_lower_inclusive_upper"},{text:">0.01 \u2013 \u22640.1",score:8,lowerBound:.01,upperBound:.1,comparison:"between_exclusive_lower_inclusive_upper"},{text:">0.1 \u2013 \u22641",score:7,lowerBound:.1,upperBound:1,comparison:"between_exclusive_lower_inclusive_upper"},{text:">1 \u2013 \u226410",score:6,lowerBound:1,upperBound:10,comparison:"between_exclusive_lower_inclusive_upper"},{text:">10 \u2013 \u2264100",score:5,lowerBound:10,upperBound:100,comparison:"between_exclusive_lower_inclusive_upper"},{text:">100 \u2013 \u22641000",score:4,lowerBound:100,upperBound:1e3,comparison:"between_exclusive_lower_inclusive_upper"},{text:">1000",score:3,lowerBound:1e3,comparison:"greater_exclusive"}]},rpnRating:{title:"RPN Rating",type:"rpn_threshold",criteria:[{rangeDescription:"1-20",rating:"Low",min:1,max:20},{rangeDescription:"21-50",rating:"Medium",min:21,max:50},{rangeDescription:"51 and more",rating:"High",min:51,max:1/0}]}},mt=!1});var U={};Z(U,{calculateScores:()=>_,consolidateMachinesByGroup:()=>Ie,debugRpnRating:()=>Fo,formatTrainGroupDisplay:()=>_o,generateTrainMap:()=>$e,getGroupedTrainSurfaceArea:()=>Ut,getMacoPerSwabForTrain:()=>ft,getProductTrainId:()=>K,getRpnRatingClass:()=>se,getRpnRatingText:()=>yt,getToxicityPreference:()=>ae,getTrainData:()=>B,getTrainGroupingDetails:()=>Oo,getWorstCaseProductType:()=>ie,populateSelectWithOptions:()=>Ae});function ae(){let e=localStorage.getItem("productRegister-pdeHidden")==="true",o=localStorage.getItem("productRegister-ld50Hidden")==="true";return e&&!o?"ld50":!e&&o||e&&o?"pde":"auto"}function $e(){let e=new Map(be),o={};x.forEach(s=>{if(s.machineIds&&s.machineIds.length>0){let i=ht(s.machineIds),c=JSON.stringify(i);o[c]||(o[c]={products:[]}),o[c].products.push(s.id)}}),be.clear();let t=0;e.forEach(s=>{s>t&&(t=s)});let n=Object.keys(o).sort(),r=[];n.forEach(s=>{e.has(s)?be.set(s,e.get(s)):r.push(s)});let a=t+1;r.forEach(s=>{be.set(s,a++)})}function ht(e){let o=[],t=new Set;return[...e].sort((r,a)=>r-a).forEach(r=>{let a=M.find(s=>s.id===r);a&&(a.group&&a.group!==""?t.has(a.group)||(o.push(`group:${a.group}`),t.add(a.group)):o.push(`machine:${r}`))}),o.sort()}function K(e){if(!e.machineIds||e.machineIds.length===0)return"N/A";let o=ht(e.machineIds),t=JSON.stringify(o);return be.get(t)||"N/A"}function _(e,o="auto"){let t=(m,g)=>{let h=String(g||"").toLowerCase(),p=m.criteria.find(f=>String(f.text||"").toLowerCase()===h);return p?p.score:m.defaultScore},n=(m,g)=>{let h=parseFloat(g);if(isNaN(h))return m.defaultScore;for(let p of m.criteria)if(p.comparison==="greater_exclusive"&&h>p.lowerBound||p.comparison==="less_exclusive"&&h<p.upperBound||p.comparison==="between_inclusive_both"&&h>=p.lowerBound&&h<=p.upperBound||p.comparison==="less_inclusive"&&h<=p.upperBound||p.comparison==="between_exclusive_lower_inclusive_upper"&&h>p.lowerBound&&h<=p.upperBound)return p.score;return m.defaultScore},r=t(P.solubility,e.solubility),a=n(P.therapeuticDose,e.therapeuticDose),s=t(P.cleanability,e.cleanability),i,c,l;e.pde!==null&&!isNaN(e.pde)&&(c=n(P.toxicityPde,e.pde)),e.ld50!==null&&!isNaN(e.ld50)&&(l=n(P.toxicityLd50,e.ld50)),o==="ld50"?l!==void 0?i=l:c!==void 0?i=c:i=1:c!==void 0?i=c:l!==void 0?i=l:i=1;let d=r*a*s*i,u=yt(d);return{rpn:d,pdeScore:c,ld50Score:l,solubilityScore:r,therapeuticDoseScore:a,cleanabilityScore:s,rpnRatingText:u}}function B(){let e={};x.forEach(t=>{if(t.machineIds&&t.machineIds.length>0){let n=ht(t.machineIds),r=JSON.stringify(n);if(!e[r])e[r]={key:r,consolidatedPath:n,machineIds:t.machineIds,products:[]};else{let a=new Set(e[r].machineIds);t.machineIds.forEach(s=>a.add(s)),e[r].machineIds=Array.from(a).sort((s,i)=>s-i)}e[r].products.push(t)}});let o=Object.values(e).map(t=>({...t,id:be.get(t.key)})).filter(t=>t.id!==void 0);return o.sort((t,n)=>t.id-n.id),o.length===0?[]:(o.forEach(t=>{t.essa=Ut(t.machineIds);let n=null,r=-1;t.products.forEach(m=>{m.activeIngredients.forEach(g=>{let{rpn:h}=_(g);h>r&&(r=h,n={productName:m.name,ingredientName:g.name,rpn:r,rating:yt(r)})})}),t.worstProductRpn=n;let a=1/0,s=-1;t.products.forEach(m=>{m.activeIngredients.forEach(g=>{g.therapeuticDose<a&&(a=g.therapeuticDose,s=m.id)})}),t.lowestLtd=a,t.lowestLtdProductId=s;let i=t.products.map(m=>{let g=Math.min(...m.activeIngredients.map(h=>m.batchSizeKg*1e3/(h.mdd/1e3)));return{productId:m.id,ratio:g}}).sort((m,g)=>m.ratio-g.ratio),c,l=-1;if(i.length>0){let m=i[0];if(m.productId===s&&i.length>1){let g=i[1];c=g.ratio,l=g.productId}else c=m.ratio,l=m.productId}else c=1/0;t.minBsMddRatio=c,t.minRatioProductId=l;let d=t.products.reduce((m,g)=>g.batchSizeKg<m.batchSizeKg?g:m,t.products[0]);t.minMbsKg=d.batchSizeKg,t.minMbsProductId=d.id;let u=t.products.flatMap(m=>m.activeIngredients).map(m=>m.pde).filter(m=>m!=null);t.lowestPde=u.length>0?Math.min(...u):null,t.assumedSsa=25}),o)}function ie(e){for(let n of ut)if(e.includes(n))return n;let t=[...new Set(e)].find(n=>!ut.includes(n));return t||"Other"}function ft(e,o){let n=(k[ie(e.products.map(d=>d.productType))]||k.Other).max,r=e.lowestLtd*e.minBsMddRatio/n,a=10*e.minMbsKg,s=1/0;e.lowestPde!==null&&(s=e.lowestPde*e.minBsMddRatio);let i=.004*o,c=Math.min(r,a,s,i);return(o>0?c/o:0)*e.assumedSsa}function Ae(e,o,t=!1,n=null){if(!e)return;e.innerHTML="",t?e.innerHTML='<option value="all">All</option>':e.innerHTML='<option value="" disabled selected>Select...</option>';let r;if(n)r=[...new Set(n)];else{let a=P[o];if(!a)return;r=[...new Set(a.criteria.map(s=>s.text))]}r.forEach(a=>{e.innerHTML+=`<option value="${a}">${a}</option>`})}function Ie(e){let o=[],t=new Map;return e.forEach(n=>{let r=M.find(i=>i.id===n);if(!r)return;let a=r.group||`individual_${r.id}`;t.has(a)||t.set(a,{group:r.group||null,machines:[],maxArea:0,representativeMachine:r});let s=t.get(a);s.machines.push(r),r.area>s.maxArea&&(s.maxArea=r.area,s.representativeMachine=r)}),t.forEach((n,r)=>{n.group?o.push({id:`group_${n.group}`,name:`${n.group} (Group)`,group:n.group,area:n.maxArea,stage:n.representativeMachine.stage,isGroup:!0,machineCount:n.machines.length,machines:n.machines}):o.push({...n.representativeMachine,isGroup:!1,machineCount:1,machines:[n.representativeMachine]})}),o}function Ut(e){return Ie(e).reduce((t,n)=>t+n.area,0)}function Oo(e){let o=Ie(e),t={totalMachines:e.length,consolidatedUnits:o.length,groups:[],individuals:[],totalSurfaceArea:0,worstCaseOptimization:0},n=0;return e.forEach(r=>{let a=M.find(s=>s.id===r);a&&(n+=a.area)}),o.forEach(r=>{t.totalSurfaceArea+=r.area,r.isGroup?t.groups.push({name:r.group,machineCount:r.machineCount,worstCaseArea:r.area,machines:r.machines.map(a=>({id:a.id,name:a.name,area:a.area}))}):t.individuals.push({id:r.id,name:r.name,area:r.area})}),t.worstCaseOptimization=n-t.totalSurfaceArea,t}function _o(e){return Ie(e).map(t=>t.isGroup?`<span class="group-indicator" title="Group: ${t.group} (${t.machineCount} machines, worst-case area: ${t.area.toLocaleString()} cm\xB2)">
                <strong>${t.group}</strong> <em>(${t.machineCount}x)</em>
            </span>`:`<span class="individual-machine" title="Individual machine: ${t.name}">${t.name}</span>`).join(" \u2192 ")}var yt,se,Fo,$=G(()=>{X();yt=e=>{let o=P.rpnRating;if(!o||!o.criteria)return"N/A";for(let t of o.criteria){let n=parseFloat(t.min),r=t.max===null||t.max===void 0?1/0:parseFloat(t.max);if(e>=n&&e<=r)return t.rating}return"N/A"},se=e=>{switch(String(e).toLowerCase()){case"low":return"rpn-low";case"medium":return"rpn-medium";case"high":return"rpn-high";default:return"rpn-default"}},Fo=e=>{console.log("=== DEBUG RPN RATING ==="),console.log("RPN Value:",e),console.log("RPN Config:",P.rpnRating);let o=P.rpnRating;if(!o){console.log("ERROR: rpnConfig is undefined or null");return}if(!o.criteria){console.log("ERROR: rpnConfig.criteria is undefined or null");return}console.log("Available criteria:",o.criteria),o.criteria.forEach((t,n)=>{console.log(`Criteria ${n}:`,{min:t.min,max:t.max,rating:t.rating,minParsed:parseFloat(t.min),maxParsed:parseFloat(t.max),rangeCheck:`${e} >= ${parseFloat(t.min)} && ${e} <= ${parseFloat(t.max)}`,result:e>=parseFloat(t.min)&&e<=parseFloat(t.max)})}),console.log("=== END DEBUG ===")}});var xt={};Z(xt,{addCriterionToScoringTab:()=>Ho,renderScoringSystem:()=>Je,saveScoringCriteria:()=>Yt,toggleScoringEditMode:()=>ee});function ee(e){jt(e);let o=document.getElementById("editScoringBtn"),t="btn-gradient",n="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200";e?(o.textContent="View",o.className=`px-4 py-2 text-sm rounded-lg ${n}`):(o.textContent="Edit",o.className=`px-4 py-2 text-sm rounded-lg ${t}`),Je()}function Je(){let e=document.getElementById("scoringSystemContainer");if(e.innerHTML="",oe){let o=document.createElement("form");o.id="scoringForm",o.className="space-y-6";for(let n in P){let r=P[n],a=document.createElement("div");a.innerHTML=`<h4 class="text-lg font-semibold mb-3">${r.title}</h4>`;let s=document.createElement("div");s.id=`fields-container-${n}`,s.className="space-y-2",r.criteria.forEach(c=>s.appendChild(Zt(n,c))),a.appendChild(s);let i=document.createElement("div");i.className="pt-2 no-print",i.innerHTML=`<button type="button" onclick="addCriterionToScoringTab('${n}')" class="text-sm px-3 py-1 rounded-md text-white btn-gradient">+ Add Criterion</button>`,a.appendChild(i),o.appendChild(a)}e.appendChild(o);let t=document.createElement("button");t.onclick=n=>Yt(n),t.className="w-full mt-6 py-2.5 text-white rounded-lg no-print btn-gradient",t.textContent="Save All Changes",e.appendChild(t)}else{let o=document.createElement("div");o.className="grid grid-cols-1 md:grid-cols-2 gap-6";for(let t in P){let n=P[t],r=document.createElement("div");r.className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700";let a=`<h4 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">${n.title}</h4>
                                     <div class="overflow-hidden rounded-md border border-gray-300 dark:border-gray-600">
                                         <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">`,s=n.type==="rpn_threshold";a+=`<thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${s?"Range Description":"Criteria"}</th>
                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${s?"Rating":"Score"}</th>
                                    </tr>
                                  </thead>
                                  <tbody class="divide-y divide-gray-200 dark:divide-gray-600" style="background-color: var(--bg-secondary);">`,n.criteria.forEach(l=>{let d,u;s?(d=l.rangeDescription,u=`<span class="rpn-rating-badge ${se(l.rating)}">${l.rating}</span>`):(d=l.text,u=`<span class="score-badge ${`score-${l.score}`}">${l.score}</span>`),a+=`<tr>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${d}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${u}</td>
                                      </tr>`}),a+="</tbody></table></div>",r.innerHTML=a,o.appendChild(r)}e.appendChild(o)}}function Zt(e,o){let t=document.createElement("div");t.className="grid gap-2 items-center p-2 border rounded-md",t.style.borderColor="var(--border-color)";let n=P[e].type;if(n==="exactMatch")t.style.gridTemplateColumns="3fr 1fr 0.5fr",t.innerHTML=`<input type="text" value="${o.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" value="${o.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if(n==="range")t.style.gridTemplateColumns="2fr 1fr 1fr 1fr 0.5fr",t.innerHTML=`<input type="text" value="${o.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" step="any" value="${o.lowerBound??""}" placeholder="Min" class="w-full px-2 py-1 border rounded-md text-sm" data-field="lowerBound" min="0"><input type="number" step="any" value="${o.upperBound??""}" placeholder="Max" class="w-full px-2 py-1 border rounded-md text-sm" data-field="upperBound" min="0"><input type="number" value="${o.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if(n==="rpn_threshold"){t.style.gridTemplateColumns="1fr 1fr 1fr 1fr 0.5fr";let r=o.max===1/0?"":o.max;t.innerHTML=`<input type="number" value="${o.min}" placeholder="Min RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="minRpn" min="0"><input type="number" value="${r}" placeholder="Max RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="maxRpn" min="0"><input type="text" value="${o.rating}" placeholder="Rating" class="w-full px-2 py-1 border rounded-md text-sm" data-field="ratingText"><span class="text-xs self-center" style="color:var(--text-secondary);">${o.rangeDescription}</span>`}return t.innerHTML+='<button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>',t}function Ho(e){let o=document.getElementById(`fields-container-${e}`),t=P[e],n;t.type==="rpn_threshold"?n={min:0,max:10,rating:"NEW",rangeDescription:"0-10"}:(n={...t.criteria[0]||{text:"",score:0},text:"New Criterion",score:t.defaultScore||1},t.type==="range"&&(delete n.lowerBound,delete n.upperBound,n.comparison=t.criteria[0]?.comparison||"between_inclusive_both")),o.appendChild(Zt(e,n))}function Yt(e){let o=e.target;R(),o.disabled=!0;try{let t=JSON.parse(JSON.stringify(P)),n=!0;for(let r in t){if(!n)break;let a=t[r],s=P[r].type;a.criteria=[];let i=document.getElementById(`fields-container-${r}`);i&&Array.from(i.children).forEach(c=>{if(!n)return;let l={};if(s==="exactMatch"||s==="range"){if(l.text=c.querySelector('[data-field="text"]').value,l.score=parseInt(c.querySelector('[data-field="score"]').value),!l.text||isNaN(l.score)){n=!1;return}if(s==="range"){let d=c.querySelector('[data-field="lowerBound"]').value,u=c.querySelector('[data-field="upperBound"]').value;if(l.lowerBound=d?parseFloat(d):void 0,l.upperBound=u?parseFloat(u):void 0,d&&isNaN(l.lowerBound)||u&&isNaN(l.upperBound)||l.lowerBound!==void 0&&l.upperBound!==void 0&&l.lowerBound>=l.upperBound){n=!1;return}l.lowerBound===void 0&&l.upperBound!==void 0?l.comparison="less_inclusive":l.lowerBound!==void 0&&l.upperBound===void 0?l.comparison="greater_exclusive":l.comparison=P[r].criteria.find(m=>m.text===l.text)?.comparison||"between_exclusive_lower_inclusive_upper"}}else if(s==="rpn_threshold"){l.min=parseFloat(c.querySelector('[data-field="minRpn"]').value);let d=c.querySelector('[data-field="maxRpn"]').value;if(l.max=d===""||d===null?1/0:parseFloat(d),l.rating=c.querySelector('[data-field="ratingText"]').value.trim(),isNaN(l.min)||d!==""&&isNaN(l.max)||!l.rating||l.min>=l.max){n=!1;return}l.rangeDescription=`${l.min} - ${d||"Infinity"}`}a.criteria.push(l)})}n?(ve(t),F(),ee(!1),L(),b("Success","Changes saved successfully.")):b("Validation Error","Please check your input. Some fields may be invalid.")}catch(t){console.error("Error saving scoring criteria:",t),b("Error","Failed to save changes. Please try again.")}finally{S(),o.disabled=!1}}var bt=G(()=>{X();Ne();W();$()});var Ee={};Z(Ee,{executeExportSelection:()=>no,executePrintSelection:()=>ro,handleSearchAndFilter:()=>Le,handleWorstCaseProductFilter:()=>wt,renderRpnChart:()=>Be,renderWorstCaseByTrain:()=>ge,sortData:()=>Ze,toggleAllTrainsSelection:()=>oo,toggleWorstCaseExportDropdown:()=>eo,toggleWorstCasePrintDropdown:()=>to,updateAllTrainsCheckbox:()=>Ue,updateSortIndicators:()=>Qt});function Le(e){if(e!=="worstCaseProducts")return;let o=document.getElementById("worstCaseProductNameFilter"),t=o?o.value.toLowerCase():"";q[e]=x.filter(n=>n.name.toLowerCase().includes(t)),ge()}function wt(){Le("worstCaseProducts")}function Ze(e,o){o==="worstCaseProducts"&&(D.key===e?D.direction=D.direction==="asc"?"desc":"asc":(D.key=e,D.direction=e==="rpn"?"desc":"asc"),ge(!1))}function Qt(e){let o=document.getElementById(e);o&&o.querySelectorAll(".mainTable th.sortable").forEach(t=>{let n=t.querySelector(".sort-indicator"),r=t.dataset.key;n.textContent="",r===D.key&&(n.textContent=D.direction==="asc"?"\u25B2":"\u25BC")})}function ge(e=!0){let o=document.getElementById("worstCaseTrainsContainer"),t=document.getElementById("noWorstCaseMessage");o.innerHTML="",q.worstCaseProducts||(q.worstCaseProducts=[...x]);let n=[...q.worstCaseProducts];if(n.length===0){t.style.display="block",o.style.display="none";return}let r={};if(n.forEach(s=>{let i=K(s);i!=="N/A"&&(r[i]||(r[i]=[]),r[i].push(s))}),Object.keys(r).length===0){t.style.display="block",o.style.display="none";return}t.style.display="none",o.style.display="block",Object.keys(r).sort((s,i)=>s-i).forEach((s,i)=>{if(window.printSelectedTrain&&window.printSelectedTrain!=="all"){if(Array.isArray(window.printSelectedTrain)){if(!window.printSelectedTrain.includes(String(s)))return}else if(String(s)!==String(window.printSelectedTrain))return}let c=r[s],d=!(document.body.classList.contains("printing-worstCaseProducts")||!e),u=document.createElement("div");u.className="train-card";let m=`
                <div class="train-header" onclick="toggleTrain('wc-${s}')">
                <span>Train ${s} - Worst Case Analysis</span>
                <button class="train-toggle" id="toggle-wc-${s}">${d?"\u25B6":"\u25BC"}</button>
                </div>
                <div class="train-content ${d?"collapsed":""}" id="content-wc-${s}">
                <div class="train-content-inner">
                    <table class="w-full text-sm mainTable">
                    <thead style="background: var(--bg-accent);">
                        <tr>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="productCode"
                        onclick="(event)=>event.stopPropagation()">
                            Product Code <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="name">
                            Product Name <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="rpn">
                            Highest RPN <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Special Case Product</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y" style="border-color: var(--border-color);">`;c.forEach(h=>{let p=ae(),f=h.activeIngredients.map(y=>_(y,p).rpn);h.sortValue=f.length>0?Math.max(...f):0}),c.sort((h,p)=>{let f=D.key,y=D.direction==="asc"?1:-1,w,I;switch(f){case"productCode":w=h.productCode,I=p.productCode;break;case"name":w=h.name,I=p.name;break;case"rpn":default:w=h.sortValue,I=p.sortValue}return w<I?-1*y:w>I?1*y:0}),c.forEach(h=>{let p=h.isCritical?"Yes":"No",f=h.isCritical?"text-red-600 font-bold":"";m+=`
                        <tr class="product-main-row">
                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${h.productCode}</td>
                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">
                                <span class="product-name">${h.name}</span>
                                <p class="text-xs italic" style="color: var(--text-secondary);">${h.productType||"N/A"}</p>    
                            </td>
                            <td class="px-3 py-3 text-sm font-bold whitespace-nowrap align-top" style="color: var(--gradient-mid);">${h.sortValue}</td>
                            <td class="px-3 py-3 text-sm align-top">
                                <span class="${f}">${p}</span>
                                ${h.isCritical&&h.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 150px; white-space: normal;">${h.criticalReason}</p>`:""}
                            </td>
                        </tr>`;let y=ae(),w=h.activeIngredients.sort((I,T)=>_(T,y).rpn-_(I,y).rpn);if(w.length>0){let I='<tr class="ingredients-sub-row"><td colspan="4"><div class="p-4 ingredients-sub-table rounded-b-lg"><table class="w-full text-sm"><thead class="bg-transparent"><tr class="border-b" style="border-color: var(--border-color);"><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Ingredient</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">TD Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Solubility Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Cleanability Score</th><th class="pde-col px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">PDE Score</th><th class="ld50-col px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">LD50 Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">RPN</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Rating</th></tr></thead><tbody class="bg-transparent">';w.forEach(T=>{let v=_(T,y);I+=`<tr><td class="px-3 py-2 font-semibold">${T.name}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${v.therapeuticDoseScore}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${v.solubilityScore}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${v.cleanabilityScore}</td><td class="pde-col px-3 py-2" style="color: var(--text-secondary);">${v.pdeScore??"N/A"}</td><td class="ld50-col px-3 py-2" style="color: var(--text-secondary);">${v.ld50Score??"N/A"}</td><td class="px-3 py-2 font-bold" style="color: var(--gradient-mid);">${v.rpn}</td><td class="px-3 py-2"><span class="rpn-rating-badge ${se(v.rpnRatingText)}">${v.rpnRatingText}</span></td></tr>`}),I+="</tbody></table></div></td></tr>",m+=I}}),m+="</tbody></table></div></div></div>",u.innerHTML=m,o.appendChild(u),u.querySelectorAll("th.sortable[data-key]").forEach(h=>{h.addEventListener("click",function(p){p.stopPropagation();let f=this.getAttribute("data-key");Ze(f,"worstCaseProducts")})})}),te("worstCaseProducts"),Qt("worstCaseProducts"),S(),vt()}function Be(){let e=document.getElementById("rpnChartCanvas"),o=document.getElementById("rpnChartPlaceholder"),t={low:{bg:"rgba(74, 222, 128, 0.6)",border:"rgba(34, 197, 94, 1)"},medium:{bg:"rgba(250, 204, 21, 0.6)",border:"rgba(234, 179, 8, 1)"},high:{bg:"rgba(239, 68, 68, 0.6)",border:"rgba(220, 38, 38, 1)"},default:{bg:"rgba(156, 163, 175, 0.6)",border:"rgba(107, 114, 128, 1)"}};q.worstCaseProducts||(q.worstCaseProducts=[...x]);let n=q.worstCaseProducts||[],r=ae(),a=n.flatMap(m=>m.activeIngredients.map(g=>{let h=_(g,r),p=K(m);return{productName:m.name,ingredientName:g.name,rpn:h.rpn,ratingKey:h.rpnRatingText.toLowerCase(),trainId:p!=="N/A"?`T${p}`:""}}));if(a.length===0){e.style.display="none",o.style.display="flex",de&&de.destroy();return}else e.style.display="block",o.style.display="none";a.sort((m,g)=>g.rpn-m.rpn);let s=a.map(m=>`${m.productName} (${m.ingredientName}) ${m.trainId}`),i=a.map(m=>m.rpn),c=a.map(m=>(t[m.ratingKey]||t.default).bg),l=a.map(m=>(t[m.ratingKey]||t.default).border);de&&de.destroy();let d=e.getContext("2d"),u=new Chart(d,{type:"bar",data:{labels:s,datasets:[{label:"RPN",data:i,backgroundColor:c,borderColor:l,borderWidth:1}]},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"var(--text-secondary)"},grid:{display:!1}},y:{beginAtZero:!0,ticks:{color:"var(--text-secondary)"},grid:{color:"var(--border-color)"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(m){let g=m.dataset.label||"";return g&&(g+=": "),m.parsed.y!==null&&(g+=m.parsed.y),g}}}}}});Xt(u)}function eo(){let e=document.getElementById("worstCaseExportDropdown");e.classList.toggle("hidden"),vt(),document.addEventListener("click",function o(t){!t.target.closest("#worstCaseExportDropdown")&&!t.target.closest('button[onclick="toggleWorstCaseExportDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function to(){let e=document.getElementById("worstCasePrintDropdown");e.classList.toggle("hidden"),vt(),document.addEventListener("click",function o(t){!t.target.closest("#worstCasePrintDropdown")&&!t.target.closest('button[onclick="toggleWorstCasePrintDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function vt(){let e=q.worstCaseProducts||x,o=new Set;e.forEach(a=>{let s=K(a);s!=="N/A"&&o.add(s)});let t=Array.from(o).sort((a,s)=>a-s),n=document.getElementById("worstCaseExportTrainOptions");n&&(n.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 export-train-checkbox",i.value=a,i.onchange=()=>Ue("export");let c=document.createElement("span");c.textContent=`Train ${a}`,s.appendChild(i),s.appendChild(c),n.appendChild(s)}));let r=document.getElementById("worstCasePrintTrainOptions");r&&(r.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 print-train-checkbox",i.value=a,i.onchange=()=>Ue("print");let c=document.createElement("span");c.textContent=`Train ${a}`,s.appendChild(i),s.appendChild(c),r.appendChild(s)}))}function oo(e){let o=document.getElementById(`${e}AllTrainsCheckbox`);document.querySelectorAll(`.${e}-train-checkbox`).forEach(n=>{n.checked=o.checked})}function Ue(e){let o=document.getElementById(`${e}AllTrainsCheckbox`),t=document.querySelectorAll(`.${e}-train-checkbox`),n=document.querySelectorAll(`.${e}-train-checkbox:checked`);n.length===0?(o.checked=!1,o.indeterminate=!1):n.length===t.length?(o.checked=!0,o.indeterminate=!1):(o.checked=!1,o.indeterminate=!0)}function no(){let e=document.getElementById("exportAllTrainsCheckbox"),o=[];if(e.checked)exportWorstCaseToExcel("all");else{if(document.querySelectorAll(".export-train-checkbox:checked").forEach(n=>{o.push(n.value)}),o.length===0){b("No Selection","Please select at least one train to export.");return}exportWorstCaseToExcel(o)}document.getElementById("worstCaseExportDropdown").classList.add("hidden")}function ro(){let e=document.getElementById("printAllTrainsCheckbox"),o=[];if(e.checked)printCurrentView("worstCaseProducts","all");else{if(document.querySelectorAll(".print-train-checkbox:checked").forEach(n=>{o.push(n.value)}),o.length===0){b("No Selection","Please select at least one train to print.");return}printCurrentView("worstCaseProducts",o)}document.getElementById("worstCasePrintDropdown").classList.add("hidden")}var he=G(()=>{X();W();$();window.toggleAllTrainsSelection=oo;window.updateAllTrainsCheckbox=Ue;window.executeExportSelection=no;window.executePrintSelection=ro;window.toggleWorstCaseExportDropdown=eo;window.toggleWorstCasePrintDropdown=to});var St={};Z(St,{renderMacoChart:()=>Qe,renderMainDashboard:()=>Ye});function Ye(){let e=document.getElementById("dashboardStats");e.innerHTML="";let o=B(),t={id:"N/A",finalMaco:1/0},n={id:"N/A",essa:0};if(o.length>0){let a=o.reduce((i,c)=>Math.max(i,c.essa),0),s=o.map(i=>{let l=(k[ie(i.products.map(h=>h.productType))]||k.Other).max,d=i.lowestLtd*i.minBsMddRatio/l,u=10*i.minMbsKg,m=1/0;i.lowestPde!==null&&(m=i.lowestPde*i.minBsMddRatio);let g=.004*a;return{...i,finalMaco:Math.min(d,u,m,g)}});t=s.reduce((i,c)=>c.finalMaco<i.finalMaco?c:i),n=s.reduce((i,c)=>c.essa>i.essa?c:i)}[{label:"Total Products",value:x.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16"><path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.405 1.372L8 2.267l3.75 2.605 2.405-1.372L8.186 1.113zM3.75 4.81L8 7.76l4.25-2.95L8 1.815 3.75 4.81z"/><path d="M1 4.53v7.94l6.5 3.53 6.5-3.53V4.53L8 8.06 1 4.53zm7.5 3.56l-3.5-2-3.5 2v7.19l3.5 2 3.5-2v-7.19zm3.5 2l-3.5 2v7.19l3.5-2 3.5 2v-7.19l-3.5-2z"/></svg>'},{label:"Total Machines",value:M.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-gear-wide-connected" viewBox="0 0 16 16"><path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.62 1.105l-.09.282c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.09-.282c-.268-1.135.925-1.824 1.62-1.105l.205.211a.96.96 0 0 0 1.622-.434L7.068.727zM12.973 8.5H8.25l-1.03-1.03a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l2.5-2.5a1 1 0 0 0-1.414-1.414L12.973 8.5z"/><path d="M.242 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353-.14l.17-.186c.695-.761 1.888.06 1.62 1.204l-.066.261c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066-.261c-.268-1.144.925-1.965 1.62-1.204l.17.186a.96.96 0 0 0 1.353.14l.058-.058a.626.626 0 0 1 0-.884zM15.758 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353.14l.17-.186c.695.761-.925 1.965-1.62 1.204l-.066-.261c-.273-.85-.92-1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066.261c-.268 1.144 1.888.443 1.62-1.204l.17-.186a.96.96 0 0 0 1.353-.14l.058-.058a.626.626 0 0 1 0 .884z"/></svg>'},{label:"Number of Trains",value:o.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-diagram-3" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H14a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 2 7h5.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 10.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/></svg>'},{label:"Lowest MACO Train",value:`Train ${t.id}`,subValue:`${t.finalMaco?t.finalMaco.toFixed(2):"N/A"} mg`,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 0 1 14 0H1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/><path d="M7.25 4.5a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5h-1.5z"/></svg>'},{label:"Largest Area Train",value:`Train ${n.id}`,subValue:`${n.essa.toLocaleString()} cm\xB2`,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 1.5a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-1 0v-12a.5.5 0 0 1 .5-.5z"/><path d="M1.5 6.002a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5z"/><path d="M14.25 2.164a.5.5 0 0 1 .146.353v10.966a.5.5 0 0 1-.146.353l-10.966 2.193a.5.5 0 0 1-.611-.493v-1.077A5.002 5.002 0 0 1 5.5 7.425V4.28a.5.5 0 0 1 .2-.4l8-3a.5.5 0 0 1 .55.284zM3.5 13.923v-1.077A5.002 5.002 0 0 1 5.5 7.425V4.893L3.5 5.672v8.251zm2-6.538A4.002 4.002 0 0 0 4.5 12.8v-1.077a4 4 0 0 0-1-2.316V8.19a4 4 0 0 0 2 1.2V7.385zM13.5 3.33v-.171l-8 3v3.115A4.002 4.002 0 0 0 9.5 8.19v2.292a4 4 0 0 0 1-2.316V9.423a4 4 0 0 0 2-1.2v-4.9z"/></svg>'}].forEach(a=>{let s=document.createElement("div");s.className="card p-6 flex items-center",s.innerHTML=`
                    <div class="p-3 rounded-full mr-4 text-white" style="background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));">
                        ${a.icon}
                    </div>
                    <div>
                        <p class="text-2xl font-bold">${a.value}</p>
                        <p class="text-sm -mt-1" style="color: var(--text-secondary);">${a.label}</p>
                        ${a.subValue?`<p class="text-xs font-semibold mt-1" style="color: var(--text-primary);">${a.subValue}</p>`:""}
                    </div>
                `,e.appendChild(s)}),Be(),Qe()}function Vo(e,o){let n=(k[ie(e.products.map(d=>d.productType))]||k.Other).max,r=e.lowestLtd*e.minBsMddRatio/n,a=10*e.minMbsKg,s=1/0;e.lowestPde!==null&&(s=e.lowestPde*e.minBsMddRatio);let i=.004*o,c=Math.min(r,a,s,i);return(o>0?c/o:0)*e.assumedSsa}function Qe(){let e=document.getElementById("macoChartCanvas"),o=document.getElementById("macoChartPlaceholder"),t=B();if(t.length===0){e.style.display="none",o.style.display="flex",ue&&ue.destroy();return}e.style.display="block",o.style.display="none";let n=t.reduce((l,d)=>Math.max(l,d.essa),0),r=t.map(l=>`Train ${l.id}`),a=t.map(l=>Vo(l,n));ue&&ue.destroy();let s=e.getContext("2d"),i=s.createLinearGradient(0,0,0,400);i.addColorStop(0,"rgba(59, 130, 246, 0.8)"),i.addColorStop(1,"rgba(139, 92, 246, 0.6)");let c=new Chart(s,{type:"bar",data:{labels:r,datasets:[{label:"MACO per Swab",data:a,backgroundColor:i,borderColor:"rgba(99, 102, 241, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"var(--text-secondary)"},grid:{display:!1}},y:{type:"logarithmic",ticks:{color:"var(--text-secondary)"},grid:{display:!1},title:{display:!0,text:"MACO (mg/Swab)",color:"var(--text-secondary)"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(l){let d=l.dataset.label||"";return d&&(d+=": "),l.parsed.y!==null&&(d+=l.parsed.y.toLocaleString(void 0,{maximumFractionDigits:5})),d}}}}}});Wt(c)}var Ct=G(()=>{X();$();he();X()});var tt={};Z(tt,{executeMacoExportSelection:()=>lo,executeMacoPrintSelection:()=>uo,recalculateProductMacoForTrain:()=>ao,renderMacoForTrains:()=>Re,toggleAllMacoTrainsSelection:()=>co,toggleMacoExportDropdown:()=>so,toggleMacoPrintDropdown:()=>io,updateAllMacoTrainsCheckbox:()=>et});function Re(){let e=document.getElementById("trainsContainer"),o=document.getElementById("noTrainsMessage");e.innerHTML="";let t=B();if(t.length===0){o.style.display="block",e.style.display="none";return}let n=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(Array.isArray(window.printSelectedTrain)?n=t.filter(i=>window.printSelectedTrain.includes(String(i.id))):n=t.filter(i=>String(i.id)===String(window.printSelectedTrain))),n.length===0){o.style.display="block",e.style.display="none";return}if(n.length===0){o.style.display="block",e.style.display="none";return}o.style.display="none",e.style.display="block";let r=t.reduce((i,c)=>c.essa>i.essa?c:i),a=r.essa;n.forEach((i,c)=>{let d=i.products.map(v=>v.productType),u=ie(d),m=k[u]||safetyFactorConfig.Other,g=document.createElement("div");g.className="train-card",g.id=`product-maco-train-${i.id}`;let h=p(i.machineIds);function p(v){return Ie(v).map(E=>{if(E.isGroup){let z=E.machines.map(O=>O.name).join(", ");return`<span class="group-indicator" title="Group: ${E.group} - ${z} - Max area: ${E.area.toLocaleString()} cm\xB2">
                <strong>${E.group}</strong>
            </span>`}else return`<span class="individual-machine" title="Individual machine: ${E.name}">${E.name}</span>`}).join(" \u2192 ")}let f=i.products.map(v=>{let N=v.activeIngredients.length>0?Math.min(...v.activeIngredients.map(O=>v.batchSizeKg*1e3/(O.mdd/1e3))):1/0,E=v.id===i.minMbsProductId,z=v.id===i.minRatioProductId;return`
                    <tr class="product-main-row">
                        <td class="px-4 py-3 whitespace-nowrap">${v.productCode}</td>
                        <td class="px-4 py-3 font-medium">${v.name}<p class="text-xs italic" style="color:var(--text-secondary);">${v.productType}</p></td>
                        <td class="px-4 py-3 whitespace-nowrap ${E?"font-bold":""}" style="${E?"color: var(--gradient-start);":""}">${v.batchSizeKg} ${E?'<span class="text-xs ml-1" title="Minimum Batch Size in Train">\u2605</span>':""}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${z?"font-bold":""}" style="${z?"color: var(--gradient-end);":""}">${isFinite(N)?N.toLocaleString(void 0,{maximumFractionDigits:2}):"N/A"} ${z?'<span class="text-xs ml-1" title="Minimum BS/MDD Ratio in Train">\u2605</span>':""}</td>
                    </tr>
                    <tr class="ingredients-sub-row">
                        <td colspan="4" class="!pb-0">
                            <div class="p-3 ingredients-sub-table">
                                 <ul class="text-xs list-disc list-inside">
                                 ${v.activeIngredients.map(O=>`<li><b>${O.name}</b> (TD: ${O.therapeuticDose}mg, MDD: ${O.mdd/1e3}g)</li>`).join("")}
                                 </ul>
                            </div>
                        </td>
                    </tr>`}).join(""),y=i.worstProductRpn?`<p><b class="text-sm" >${i.worstProductRpn.productName}</b> (Ingredient: ${i.worstProductRpn.ingredientName})</p>
                 <p class="mt-0.4">RPN: <span class="font-bold text-sm" style="color:var(--gradient-mid);">${i.worstProductRpn.rpn}</span> <span class="rpn-rating-badge ${se(i.worstProductRpn.rating)}">${i.worstProductRpn.rating}</span></p>`:'<p style="color:var(--text-secondary);">N/A</p>',w=x.find(v=>v.id===i.lowestLtdProductId),I=x.find(v=>v.id===i.minRatioProductId),T=x.find(v=>v.id===i.minMbsProductId);g.innerHTML=`
                    <div class="train-header" onclick="toggleTrain('pm-${i.id}')">
                        <span>Train ${i.id} - Product MACO Calculation</span>
                        <button class="train-toggle" id="toggle-pm-${i.id}">\u25B6</button>
                    </div>
                    <div class="train-content collapsed" id="content-pm-${i.id}">
                        <div class="train-content-inner space-y-6">
                            <!-- Train Details -->
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        <h3 class="text-lg font-bold">Train ${i.id} Details</h3>
                                        <div class="flex items-center gap-x-2 mt-1" id="train-badges-${i.id}"></div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <p class="text-sm uppercase font-semibold" style="color: var(--text-secondary);">Train Area (ESSA)</p>
                                        <p class="text-lg font-bold" style="color: var(--gradient-mid);">${i.essa.toLocaleString()} cm\xB2</p>
                                    </div>
                                </div>
                                <div class="mt-4 p-3 rounded-md" style="background-color:var(--bg-accent);">
                                    <p class="text-xs uppercase font-semibold mb-1" style="color: var(--text-secondary);">Machines in Train</p>
                                    <p class="text-sm">${h}</p>
                                </div>
                            </div>

                            <!-- Products Table -->
                            <div class="space-y-2">
                                <h4 class="text-lg font-semibold">Products in Train</h4>
                                <div class="overflow-hidden rounded-md border" style="border-color: var(--border-color);">
                                    <table class="w-full text-sm">
                                        <thead class="border-b" style="border-color: var(--border-color);">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Code</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Product Name</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Batch Size (Kg)</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">BS/MDD Ratio</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y" style="border-color: var(--border-color);">${f}</tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Analysis & Calculations Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4 border-t" style="border-color: var(--border-color);">
                                <!-- Left Column: RPN & MACO Limits -->
                                <div class="space-y-6">
                                    <div class="p-4 rounded-lg" style="background-color:var(--bg-accent);">
                                        <div class="flex items-center gap-2 mb-2">
                                                   <div class="relative group">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16" style="color: var(--text-secondary);" title="Information">
                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                                </svg>
            
                                            </div>
                                            <h5 class="text-sm font-semibold">Worst-Case Product for Cleaning Study (by RPN)</h5>

                                        </div>
                                        ${y}
                                    </div>
      
                                </div>

                                <!-- Right Column: MACO Calculation Details -->
                                <div class="space-y-4">

                                     <h4 class="text-md font-semibold">MACO Calculation Breakdown</h4>
                                     <button id="breakdown-toggle-btn-${i.id}" onclick="toggleMacoBreakdown(${i.id})" class="w-full text-sm py-2 px-4 rounded-md border" style="color: var(--gradient-mid); border-color: var(--gradient-mid);">Show MACO Calculation Breakdown</button>
                                     <div id="maco-breakdown-details-${i.id}" class="hidden space-y-4">
                                         <div class="p-4 rounded-lg" style="background-color: var(--bg-accent);">
                                            <p class="text-sm"><b>Worst-Case Dosage Form:</b> ${u}</p>
                                            <p class="text-xs mt-1" style="color:var(--text-secondary);">Range for ${m.route} route: ${m.min.toLocaleString()} - ${m.max.toLocaleString()}</p>
                                            <label for="product-sf-input-train-${i.id}" class="block text-sm font-small mt-2 mb-1">Safety Factor (SF)</label>
                                            <input type="number" id="product-sf-input-train-${i.id}" class="w-full px-2 py-2 border rounded-lg" value="${m.max}" min="${m.min}" max="${m.max}" oninput="recalculateProductMacoForTrain(${i.id})" onchange="clampSafetyFactor(this, ${i.id})">
                                         </div>
                                         <ul class="text-sm space-y-1 p-3 border-l-4 rounded-r-md" style="border-color:var(--gradient-mid); background-color:var(--bg-accent);">
                                            <li><b>Minimum Batch Size (MBS):</b> ${i.minMbsKg} kg <span class="text-xs" style="color:var(--text-secondary);">(from ${T.name})</span></li>
                                            <li><b>Lowest LTD:</b> ${i.lowestLtd} mg <span class="text-xs" style="color:var(--text-secondary);">(from ${w.name})</span></li>
                                            <li><b>Minimum BS(g)/MDD(g) Ratio:</b> ${i.minBsMddRatio.toLocaleString(void 0,{maximumFractionDigits:2})} <span class="text-xs" style="color:var(--text-secondary);">(from ${I.name})</span></li>
                                            <li><b>Lowest PDE (ADE):</b> ${i.lowestPde!==null?i.lowestPde+" mg":"N/A"}</li>
                                            <li><b>Global Largest ESSA:</b> ${a.toLocaleString()} cm\xB2 (from Train ${r.id})</li>
                                         </ul>
                                         <div id="maco-breakdown-container-${i.id}" class="divide-y rounded-md border" style="border-color:var(--border-color);"></div>
                                    </div>
                                    <div id="final-maco-container-${i.id}" class="p-3 rounded-md text-center" style="background-color:var(--bg-secondary); border: 2px solid var(--gradient-mid);"></div>
                                                                    <div class="p-4 rounded-lg border" style="border-color:var(--gradient-mid);">
                                        <h5 class="text-sm font-semibold mb-2">Final MACO Limits for Train ${i.id}</h5>
                                        <div class="space-y-3">
                                            <div><p class="text-sm" style="color:var(--text-secondary);">MACO / Area</p><p class="text-md font-bold" id="maco-per-area-val-${i.id}">...</p></div>
                                            <div><p class="text-sm" style="color:var(--text-secondary);">MACO / Swab (assuming ${i.assumedSsa} cm\xB2 area)</p><p class="text-md font-bold" id="maco-per-swab-val-${i.id}">...</p></div>
                                        </div>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(g),ao(i.id,a)});let s=n.map(i=>{let c=document.getElementById(`final-maco-val-${i.id}`);return c&&c.dataset.value?{...i,finalMaco:parseFloat(c.dataset.value)}:{...i,finalMaco:0}});if(s.length>0){let i=s.reduce((d,u)=>u.finalMaco<d.finalMaco?u:d),c=document.getElementById(`train-badges-${r.id}`),l=document.getElementById(`train-badges-${i.id}`);c&&(c.innerHTML+='<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300">Largest ESSA</span>'),l&&(l.innerHTML+='<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 ml-2">Lowest MACO</span>')}Mt(),S()}function ao(e,o){let t=B().find(f=>f.id===e);if(!t)return;if(o===void 0){let f=B();o=f.length>0?Math.max(...f.map(y=>y.essa)):0}let n=document.getElementById(`product-sf-input-train-${t.id}`),r=parseFloat(n.value);if(isNaN(r))return;let a=t.lowestLtd*t.minBsMddRatio/r,s=10*t.minMbsKg,i=1/0;t.lowestPde!==null&&(i=t.lowestPde*t.minBsMddRatio);let c=.004*o,l=[{name:"0.1% Therapeutic Dose",value:a},{name:"10 ppm Criterion",value:s},{name:"Health-Based Limit (ADE)",value:i},{name:"Visual Clean Limit",value:c}],d=l.reduce((f,y)=>y.value<f.value?y:f),u=d.value,m=o>0?u/o:0,g=m*t.assumedSsa;document.getElementById(`maco-per-area-val-${t.id}`).textContent=`${m.toExponential(3)} mg/cm\xB2`,document.getElementById(`maco-per-swab-val-${t.id}`).textContent=`${g.toLocaleString(void 0,{minimumFractionDigits:4,maximumFractionDigits:4})} mg/Swab`;let h=document.getElementById(`maco-breakdown-container-${t.id}`);h&&(h.innerHTML=l.map(({value:f,name:y})=>{let w="";return y==="0.1% Therapeutic Dose"?w='MACO = (<span title="Lowest Therapeutic Dose (mg)">LTD</span> \xD7 <span title="Batch Size / Maximum Daily Dose Ratio">BS/MDD Ratio</span>) / <span title="Safety Factor">SF</span>':y==="10 ppm Criterion"?w='MACO = 10 \xD7 <span title="Minimum Batch Size (kg)">MBS(kg)</span>':y==="Health-Based Limit (ADE)"?w='MACO = <span title="Acceptable Daily Exposure (mg)">ADE</span> \xD7 <span title="Batch Size / Maximum Daily Dose Ratio">BS/MDD Ratio</span>':y==="Visual Clean Limit"&&(w='MACO = 0.004 \xD7 <span title="Equipment Surface Shared Area (cm\xB2)">Largest ESSA</span>'),`
                    <div class="p-3 ${d.value===f?"font-bold":""}" style="${d.value===f?"background-color: #dcfce7; color: #166534;":""}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-medium">${y}</span>
                            <span class="text-sm text-right">${isFinite(f)?f.toLocaleString(void 0,{maximumFractionDigits:2})+" mg":"N/A"} ${d.value===f?'<span class="text-xs ml-2">\u2713</span>':""}</span>
                        </div>
                        <div class="text-xs font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded mt-1" style="color: var(--text-secondary);">
                            ${w}
                        </div>
                    </div>
                `}).join(""));let p=document.getElementById(`final-maco-container-${t.id}`);p.innerHTML=`
                <p class="text-sm" style="color:var(--text-secondary);">Selected Limit: ${d.name}</p>
                <p class="text-lg font-extrabold" style="color:var(--gradient-mid);" id="final-maco-val-${t.id}" data-value="${u}">${u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})} mg</p>
            `}function so(){let e=document.getElementById("macoExportDropdown");e.classList.toggle("hidden"),Mt(),document.addEventListener("click",function o(t){!t.target.closest("#macoExportDropdown")&&!t.target.closest('button[onclick="toggleMacoExportDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function io(){let e=document.getElementById("macoPrintDropdown");e.classList.toggle("hidden"),Mt(),document.addEventListener("click",function o(t){!t.target.closest("#macoPrintDropdown")&&!t.target.closest('button[onclick="toggleMacoPrintDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function Mt(){Promise.resolve().then(()=>($(),U)).then(e=>{let{getTrainData:o}=e,t=o(),n=document.getElementById("macoExportTrainOptions");n&&(n.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 export-maco-train-checkbox",i.value=a.id,i.onchange=()=>et("export");let c=document.createElement("span");c.textContent=`Train ${a.id}`,s.appendChild(i),s.appendChild(c),n.appendChild(s)}));let r=document.getElementById("macoPrintTrainOptions");r&&(r.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 print-maco-train-checkbox",i.value=a.id,i.onchange=()=>et("print");let c=document.createElement("span");c.textContent=`Train ${a.id}`,s.appendChild(i),s.appendChild(c),r.appendChild(s)}))})}function co(e){let o=document.getElementById(`${e}MacoAllTrainsCheckbox`);document.querySelectorAll(`.${e}-maco-train-checkbox`).forEach(n=>{n.checked=o.checked})}function et(e){let o=document.getElementById(`${e}MacoAllTrainsCheckbox`),t=document.querySelectorAll(`.${e}-maco-train-checkbox`),n=document.querySelectorAll(`.${e}-maco-train-checkbox:checked`);n.length===0?(o.checked=!1,o.indeterminate=!1):n.length===t.length?(o.checked=!0,o.indeterminate=!1):(o.checked=!1,o.indeterminate=!0)}function lo(){Promise.resolve().then(()=>(W(),ce)).then(e=>{let o=document.getElementById("exportMacoAllTrainsCheckbox"),t=[];if(o.checked)e.exportProductMacoToExcel("all");else{if(document.querySelectorAll(".export-maco-train-checkbox:checked").forEach(r=>{t.push(r.value)}),t.length===0){e.showCustomAlert("No Selection","Please select at least one train to export.");return}e.exportProductMacoToExcel(t)}document.getElementById("macoExportDropdown").classList.add("hidden")}).catch(e=>{console.error("Error loading export function:",e),alert("Error loading export function")})}function uo(){Promise.resolve().then(()=>(W(),ce)).then(e=>{let o=document.getElementById("printMacoAllTrainsCheckbox"),t=[];if(o.checked)e.printCurrentView("macoForTrains","all");else{if(document.querySelectorAll(".print-maco-train-checkbox:checked").forEach(r=>{t.push(r.value)}),t.length===0){e.showCustomAlert("No Selection","Please select at least one train to print.");return}e.printCurrentView("macoForTrains",t)}document.getElementById("macoPrintDropdown").classList.add("hidden")}).catch(e=>{console.error("Error loading print function:",e),alert("Error loading print function")})}var It=G(()=>{X();W();$();window.toggleMacoExportDropdown=so;window.toggleMacoPrintDropdown=io;window.toggleAllMacoTrainsSelection=co;window.updateAllMacoTrainsCheckbox=et;window.executeMacoExportSelection=lo;window.executeMacoPrintSelection=uo});var Oe={};Z(Oe,{addDetergentIngredient:()=>qo,executeDetergentExportSelection:()=>go,executeDetergentPrintSelection:()=>ho,populateDetergentTrainOptions:()=>Et,recalculateDetergentMacoForTrain:()=>po,removeDetergentIngredient:()=>zo,renderDetergentIngredientsList:()=>Fe,renderDetergentMaco:()=>Se,toggleAllDetergentTrainsSelection:()=>mo,toggleDetergentExportDropdown:()=>yo,toggleDetergentPrintDropdown:()=>fo,updateAllDetergentTrainsCheckbox:()=>ot,updateDetergentIngredient:()=>Xo});function Se(){let e=document.getElementById("detergentMacoResults"),o=document.getElementById("noTrainsForDetergentMessage");e.innerHTML="";let t=B(),n=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(Array.isArray(window.printSelectedTrain)?n=t.filter(s=>window.printSelectedTrain.includes(String(s.id))):n=t.filter(s=>String(s.id)===String(window.printSelectedTrain))),n.length===0){o.style.display="block";return}o.style.display="none";let r=B(),a=r.length>0?Math.max(...r.map(s=>s.essa)):0;n.forEach((s,i)=>{let l=s.products.map(g=>g.productType),d=ie(l),u=k[d]||k.Other,m=document.createElement("div");m.className="train-card",m.innerHTML=`
                    <div class="train-header" onclick="toggleTrain('dm-${s.id}')">
                        <span>Train ${s.id} - Detergent MACO Calculation</span>
                        <button class="train-toggle" id="toggle-dm-${s.id}">\u25B6</button>
                    </div>
                    <div class="train-content collapsed" id="content-dm-${s.id}">
                        <div class="train-content-inner space-y-3">
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                               
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">
                                    Based on products in the train, the minimum (Batch Size / MDD) ratio is: <b>${s.minBsMddRatio.toLocaleString(void 0,{maximumFractionDigits:2})}</b>.
                                </p>
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">
                                    Min LD50 = <b><span id="min-ld50-train-${s.id}">...</span> mg/kg</b>
                                </p>
                            </div>

                            <div class="p-3 rounded-md border" style="border-color:var(--border-color)">
                                <label for="sf-input-train-${s.id}" class="block text-sm font-small mb-1">Safety Factor (SF)</label>
                                <input type="number" 
                                    id="sf-input-train-${s.id}" 
                                    class="w-full px-2 py-2 border rounded-md text-sm"
                                    value="${u.max}" 
                                    min="${u.min}" 
                                    max="${u.max}" 
                                    oninput="recalculateDetergentMacoForTrain(${s.id})"
                                    onchange="clampSafetyFactor(this, ${s.id})">
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">Range for ${u.route} route: ${u.min.toLocaleString()} - ${u.max.toLocaleString()}</p>
                            </div>
                            
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">ADI = (5e-4 * LD50 * BW) / SF</p>
                                <p><b  class="text-sm">Acceptable Daily Intake (ADI):</b> <span  class="text-sm" id="adi-value-train-${s.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO = (ADI * Min BS/MDD Ratio)</p>
                                <p><b  class="text-sm">MACO:</b> <span  class="text-sm" id="maco-value-train-${s.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO/Area = MACO / Global Largest ESSA</p>
                                <p><b  class="text-sm">MACO per Area:</b> <span class="text-sm"id="macoarea-value-train-${s.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO/Swab = (MACO/Area) * SSA</p>
                                <p><b class="text-sm">MACO per Swab:</b> <span  class="text-sm" id="macoswab-value-train-${s.id}">...</span></p>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(m),po(s.id,a)})}function po(e,o){let t=B().find(u=>u.id===e);if(!t)return;if(o===void 0){let u=B();o=u.length>0?Math.max(...u.map(m=>m.essa)):0}let n=A.map(u=>parseFloat(u.ld50)).filter(u=>!isNaN(u)),r=n.length>0?Math.min(...n):0,a=parseFloat(document.getElementById("bodyWeight").value)||0,s=parseFloat(document.getElementById(`sf-input-train-${e}`).value)||1,i=5e-4*r*a/s,c=i*t.minBsMddRatio,l=o>0?c/o:0,d=l*t.assumedSsa;document.getElementById(`min-ld50-train-${e}`).textContent=r.toLocaleString(),document.getElementById(`adi-value-train-${e}`).textContent=`${i.toFixed(4)} mg`,document.getElementById(`maco-value-train-${e}`).textContent=`${c.toFixed(2)} mg`,document.getElementById(`macoarea-value-train-${e}`).textContent=`${l.toExponential(3)} mg/cm\xB2`,document.getElementById(`macoswab-value-train-${e}`).textContent=`${d.toFixed(4)} mg/swab`}function Fe(){let e=document.getElementById("detergentIngredientsContainer");e.innerHTML="",A.length===0&&(e.innerHTML='<p class="text-sm text-center p-2" style="color:var(--text-secondary);">Please add at least one detergent ingredient.</p>'),A.forEach(o=>{let t=document.createElement("div");t.className="flex items-center gap-x-2 mb-2",t.innerHTML=`
                    <input type="text" oninput="updateDetergentIngredient(${o.id}, 'name', this.value)" value="${o.name}" placeholder="Ingredient Name" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <input type="number" oninput="updateDetergentIngredient(${o.id}, 'ld50', this.value)" value="${o.ld50}" placeholder="LD50 (mg/kg)" class="w-32 px-3 py-2 border rounded-lg text-sm" min="0">
                    <div class="w-8 px-3 py-2 flex items-center justify-center">
                        <button onclick="removeDetergentIngredient(${o.id})" class="text-red-500 hover:bg-red-50 rounded p-1" title="Remove Ingredient">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
                        </button>
                    </div>
                `,e.appendChild(t)})}function qo(){let e=[...A,{id:qe,name:"",ld50:""}];Me(qe+1),me(e),Fe(),Se()}function zo(e){let o=A.filter(t=>t.id!==e);me(o),Fe(),Se()}function Xo(e,o,t){let n=A.find(r=>r.id===e);n&&(n[o]=t,Se())}function Et(){Promise.resolve().then(()=>($(),U)).then(e=>{let{getTrainData:o}=e,t=o(),n=document.getElementById("detergentExportTrainOptions");n&&(n.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 export-detergent-train-checkbox",i.value=a.id,i.onchange=()=>ot("export");let c=document.createElement("span");c.textContent=`Train ${a.id}`,s.appendChild(i),s.appendChild(c),n.appendChild(s)}));let r=document.getElementById("detergentPrintTrainOptions");r&&(r.innerHTML="",t.forEach(a=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let i=document.createElement("input");i.type="checkbox",i.className="mr-2 print-detergent-train-checkbox",i.value=a.id,i.onchange=()=>ot("print");let c=document.createElement("span");c.textContent=`Train ${a.id}`,s.appendChild(i),s.appendChild(c),r.appendChild(s)}))}).catch(e=>console.error("Error populating detergent train options:",e))}function mo(e){let o=document.getElementById(`${e}DetergentAllTrainsCheckbox`);document.querySelectorAll(`.${e}-detergent-train-checkbox`).forEach(n=>{n.checked=o.checked})}function ot(e){let o=document.getElementById(`${e}DetergentAllTrainsCheckbox`),t=document.querySelectorAll(`.${e}-detergent-train-checkbox`),n=document.querySelectorAll(`.${e}-detergent-train-checkbox:checked`);o&&(n.length===0?(o.checked=!1,o.indeterminate=!1):n.length===t.length?(o.checked=!0,o.indeterminate=!1):(o.checked=!1,o.indeterminate=!0))}function go(){Promise.resolve().then(()=>(W(),ce)).then(e=>{let o=document.getElementById("exportDetergentAllTrainsCheckbox"),t=[];if(o&&o.checked)e.exportDetergentMacoToExcel();else{if(document.querySelectorAll(".export-detergent-train-checkbox:checked").forEach(a=>t.push(a.value)),t.length===0){e.showCustomAlert("No Selection","Please select at least one train to export.");return}window.exportSelectedDetergentTrains=t,e.exportDetergentMacoToExcel(t)}let n=document.getElementById("detergentExportDropdown");n&&n.classList.add("hidden")}).catch(e=>console.error("Error executing detergent export selection:",e))}function ho(){Promise.resolve().then(()=>(W(),ce)).then(e=>{let o=document.getElementById("printDetergentAllTrainsCheckbox"),t=[];if(o&&o.checked)e.printCurrentView("detergentMaco","all");else{if(document.querySelectorAll(".print-detergent-train-checkbox:checked").forEach(a=>t.push(a.value)),t.length===0){e.showCustomAlert("No Selection","Please select at least one train to print.");return}window.printSelectedTrain=t,e.printCurrentView("detergentMaco",t)}let n=document.getElementById("detergentPrintDropdown");n&&n.classList.add("hidden")}).catch(e=>console.error("Error executing detergent print selection:",e))}function yo(){let e=document.getElementById("detergentExportDropdown");e&&(e.classList.toggle("hidden"),e.classList.contains("hidden")||(Et(),setTimeout(()=>{function o(t){!t.target.closest("#detergentExportDropdown")&&!t.target.closest('[onclick="toggleDetergentExportDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))}document.addEventListener("click",o)},10)))}function fo(){let e=document.getElementById("detergentPrintDropdown");e&&(e.classList.toggle("hidden"),e.classList.contains("hidden")||(Et(),setTimeout(()=>{function o(t){!t.target.closest("#detergentPrintDropdown")&&!t.target.closest('[onclick="toggleDetergentPrintDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))}document.addEventListener("click",o)},10)))}var nt=G(()=>{X();$();window.toggleDetergentExportDropdown=yo;window.toggleDetergentPrintDropdown=fo;window.toggleAllDetergentTrainsSelection=mo;window.updateAllDetergentTrainsCheckbox=ot;window.executeDetergentExportSelection=go;window.executeDetergentPrintSelection=ho});var st={};Z(st,{executeTrainSummaryExportSelection:()=>vo,executeTrainSummaryPrintSelection:()=>So,renderTrainSummary:()=>at,toggleAllTrainSummaryTrainsSelection:()=>wo,toggleTrainSummaryExportDropdown:()=>xo,toggleTrainSummaryPrintDropdown:()=>bo,updateAllTrainSummaryTrainsCheckbox:()=>rt});function Wo(e){let o=null,t=0;try{if(!e||!e.products||!Array.isArray(e.products))return null;for(let n of e.products)if(!(!n||!n.activeIngredients||!Array.isArray(n.activeIngredients))){for(let r of n.activeIngredients)if(r)try{let a=_(r);a&&a.rpn>t&&(t=a.rpn,o={productCode:n.productCode||"Unknown",productName:n.name||"Unknown Product",ingredientName:r.name||"Unknown Ingredient",rpn:a.rpn})}catch(a){console.warn("Error calculating scores for ingredient:",r,a);continue}}}catch(n){return console.error("Error in getWorstCaseProductForTrain:",n),null}return o}function jo(e){try{if(!e)return 0;let o=B();if(!o||!Array.isArray(o))return 0;let t=Math.max(...o.map(r=>r.essa||0));return t<=0?0:ft(e,t)||0}catch(o){return console.error("Error calculating MACO for train:",e?.id||"unknown",o),0}}function at(){let e=document.getElementById("trainSummaryContainer"),o=document.getElementById("noTrainSummaryMessage");e.innerHTML="";let t=B();if(t.length===0){o.style.display="block",e.style.display="none";return}let n=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(console.log("Filtering trains for print:",window.printSelectedTrain),console.log("Available trains:",t.map(a=>a.id)),Array.isArray(window.printSelectedTrain)?n=t.filter(a=>window.printSelectedTrain.includes(String(a.id))):n=t.filter(a=>String(a.id)===String(window.printSelectedTrain)),console.log("Filtered trains:",n.map(a=>a.id))),n.length===0){console.log("No trains to render after filtering"),o.style.display="block",e.style.display="none";return}o.style.display="none",e.style.display="block";let r=n.map(a=>{let i=a.machineIds.map(h=>{let p=M.find(f=>f.id===h);return p||{id:h,name:`Unknown (ID: ${h})`,machineNumber:"N/A"}}).map(h=>{let p=h.group?` [${h.group}]`:"";return`${h.name}${p}`}).join(", "),c=a.products.map(h=>h.name).join(", "),l=`
            <div class="mb-2">
                <span class="font-semibold text-blue-600">Machines:</span><br>
                <span class="text-sm">${i}</span>
            </div>
            <div>
                <span class="font-semibold text-purple-600">Products:</span><br>
                <span class="text-sm">${c}</span>
            </div>
        `,d=Wo(a),u=d?`
                <div class="text-sm">
                    <div class="font-semibold text-orange-600">${d.productName}</div>
                    <div class="text-xs text-gray-600">Ingredient: ${d.ingredientName}</div>
                    <div class="text-xs font-bold text-red-600">RPN: ${d.rpn.toFixed(2)}</div>
                </div>
            `:'<span class="text-gray-500 text-sm">No data available</span>',m=jo(a),g=m>0?`<span class="font-semibold text-green-600">${m.toFixed(4)} mg/swab</span>`:'<span class="text-gray-500">Not calculated</span>';return`
            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800/50" style="border-color: var(--border-color);">
                <td class="px-4 py-4 text-center font-bold text-lg" style="color: var(--text-primary);">T${a.id}</td>
                <td class="px-4 py-4" style="color: var(--text-primary);">
                    ${l}
                </td>
                <td class="px-4 py-4" style="color: var(--text-primary);">
                    ${u}
                </td>
                <td class="px-4 py-4 text-center" style="color: var(--text-primary);">
                    ${g}
                </td>
            </tr>
        `}).join("");e.innerHTML=`
        <div class="overflow-hidden rounded-lg border" style="border-color: var(--border-color);">
            <table class="w-full text-sm">
                <thead class="bg-gray-200 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider w-20" style="color: var(--text-secondary);">Train</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Machines & Products</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider w-64" style="color: var(--text-secondary);">Worst Case Product</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider w-32" style="color: var(--text-secondary);">MACO</th>
                    </tr>
                </thead>
                <tbody style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    ${r}
                </tbody>
            </table>
        </div>
    `,Tt(),S()}function xo(){let e=document.getElementById("trainSummaryExportDropdown");e.classList.toggle("hidden"),Tt(),document.addEventListener("click",function o(t){!t.target.closest("#trainSummaryExportDropdown")&&!t.target.closest('button[onclick="toggleTrainSummaryExportDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function bo(){let e=document.getElementById("trainSummaryPrintDropdown");e.classList.toggle("hidden"),Tt(),document.addEventListener("click",function o(t){!t.target.closest("#trainSummaryPrintDropdown")&&!t.target.closest('button[onclick="toggleTrainSummaryPrintDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function Tt(){let e=B(),o=document.getElementById("trainSummaryExportTrainOptions");o&&(o.innerHTML="",e.forEach(n=>{let r=document.createElement("label");r.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",r.style.color="var(--text-primary)";let a=document.createElement("input");a.type="checkbox",a.className="mr-2 export-trainsummary-train-checkbox",a.value=n.id,a.onchange=()=>rt("export");let s=document.createElement("span");s.textContent=`Train ${n.id}`,r.appendChild(a),r.appendChild(s),o.appendChild(r)}));let t=document.getElementById("trainSummaryPrintTrainOptions");t&&(t.innerHTML="",e.forEach(n=>{let r=document.createElement("label");r.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",r.style.color="var(--text-primary)";let a=document.createElement("input");a.type="checkbox",a.className="mr-2 print-trainsummary-train-checkbox",a.value=n.id,a.onchange=()=>rt("print");let s=document.createElement("span");s.textContent=`Train ${n.id}`,r.appendChild(a),r.appendChild(s),t.appendChild(r)}))}function wo(e){let o=document.getElementById(`${e}TrainSummaryAllTrainsCheckbox`);document.querySelectorAll(`.${e}-trainsummary-train-checkbox`).forEach(n=>{n.checked=o.checked})}function rt(e){let o=document.getElementById(`${e}TrainSummaryAllTrainsCheckbox`),t=document.querySelectorAll(`.${e}-trainsummary-train-checkbox`),n=document.querySelectorAll(`.${e}-trainsummary-train-checkbox:checked`);n.length===0?(o.checked=!1,o.indeterminate=!1):n.length===t.length?(o.checked=!0,o.indeterminate=!1):(o.checked=!1,o.indeterminate=!0)}function vo(){Promise.resolve().then(()=>(W(),ce)).then(e=>{let{showCustomAlert:o,exportTrainSummaryToExcel:t}=e,n=document.getElementById("exportTrainSummaryAllTrainsCheckbox"),r=[];if(n.checked)t("all");else{if(document.querySelectorAll(".export-trainsummary-train-checkbox:checked").forEach(s=>{r.push(s.value)}),r.length===0){o("No Selection","Please select at least one train to export.");return}t(r)}document.getElementById("trainSummaryExportDropdown").classList.add("hidden")}).catch(e=>{console.error("Error loading export function:",e),alert("Error loading export function")})}function So(){try{let e=document.getElementById("printTrainSummaryAllTrainsCheckbox"),o=document.querySelectorAll(".print-trainsummary-train-checkbox:checked");if(console.log("All checkbox checked:",e?e.checked:"not found"),console.log("Individual checkboxes found:",o.length),!e){alert("Print dropdown elements not found. Please try refreshing the page.");return}Promise.resolve().then(()=>(W(),ce)).then(t=>{let{showCustomAlert:n,printCurrentView:r}=t,a=[];if(e.checked)console.log("Printing all trains"),r("trainSummary","all");else{if(o.forEach(i=>{a.push(i.value)}),console.log("Selected trains for printing:",a),a.length===0){n("No Selection","Please select at least one train to print.");return}r("trainSummary",a)}let s=document.getElementById("trainSummaryPrintDropdown");s&&s.classList.add("hidden")}).catch(t=>{console.error("Error loading print function:",t),alert("Error loading print function: "+t.message)})}catch(e){console.error("Error in executeTrainSummaryPrintSelection:",e),alert("Print function error: "+e.message)}}var Pt=G(()=>{X();W();$();$();window.toggleTrainSummaryExportDropdown=xo;window.toggleTrainSummaryPrintDropdown=bo;window.toggleAllTrainSummaryTrainsSelection=wo;window.updateAllTrainSummaryTrainsCheckbox=rt;window.executeTrainSummaryExportSelection=vo;window.executeTrainSummaryPrintSelection=So});var ce={};Z(ce,{clampSafetyFactor:()=>on,exportAllTabsToExcel:()=>pn,exportAllToJson:()=>Zo,exportDetergentMacoToExcel:()=>ln,exportMachinesToExcel:()=>sn,exportProductMacoToExcel:()=>cn,exportSummaryToExcel:()=>un,exportToExcel:()=>Uo,exportTrainSummaryToExcel:()=>dn,exportWorstCaseToExcel:()=>an,hideLoader:()=>S,hideModal:()=>Q,importFromJson:()=>Yo,loadAllDataFromLocalStorage:()=>it,printCurrentView:()=>Go,redoChange:()=>Dt,saveAllDataToLocalStorage:()=>Te,saveStateForUndo:()=>F,showCustomAlert:()=>b,showLoader:()=>R,toggleColumn:()=>Ko,toggleColumnVisibilityDropdown:()=>Jo,toggleDarkMode:()=>_e,toggleMacoBreakdown:()=>rn,toggleOtherMachineGroup:()=>tn,toggleOtherMachineStage:()=>en,toggleOtherProductType:()=>Qo,toggleStageSection:()=>mn,toggleTrain:()=>nn,undoChange:()=>kt,updateToggleIcons:()=>te,updateUndoRedoButtons:()=>ct});function b(e,o){document.getElementById("customAlertTitle").textContent=e,document.getElementById("customAlertMessage").textContent=o,document.getElementById("customAlertModal").style.display="flex"}function Te(){try{localStorage.setItem("macoProducts",JSON.stringify(x)),localStorage.setItem("macoMachines",JSON.stringify(M)),localStorage.setItem("macoScoringCriteria",JSON.stringify(P)),localStorage.setItem("macoDetergentIngredients",JSON.stringify(A)),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(V))}catch(e){console.error("Failed to save data to localStorage",e),b("Save Error","Could not save data. Storage might be full.")}}function it(){let e=localStorage.getItem("macoProducts"),o=localStorage.getItem("macoMachines"),t=localStorage.getItem("macoScoringCriteria"),n=localStorage.getItem("macoDetergentIngredients"),r=localStorage.getItem("machineStageDisplayOrder");if(e)try{pe(JSON.parse(e))}catch(a){console.error("Error loading products",a)}if(o)try{we(JSON.parse(o))}catch(a){console.error("Error loading machines",a)}if(t)try{ve(JSON.parse(t))}catch(a){console.error("Error loading scoring criteria",a)}if(n)try{me(JSON.parse(n))}catch(a){console.error("Error loading detergent ingredients",a)}if(r)try{Jt(JSON.parse(r))}catch(a){console.error("Error loading machine stage order",a)}}function F(){$e();let e=ne.slice(0,re+1),o={products:JSON.parse(JSON.stringify(x)),machines:JSON.parse(JSON.stringify(M)),scoringCriteria:JSON.parse(JSON.stringify(P)),detergentIngredients:JSON.parse(JSON.stringify(A))};e.push(o),Ge(e,e.length-1),ct(),Te()}function ct(){let e=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");e&&(e.disabled=re<=0),o&&(o.disabled=re>=ne.length-1)}function kt(){if(re>0){let e=re-1,o=ne[e];pe(JSON.parse(JSON.stringify(o.products))),we(JSON.parse(JSON.stringify(o.machines))),ve(JSON.parse(JSON.stringify(o.scoringCriteria))),me(JSON.parse(JSON.stringify(o.detergentIngredients))),Ge(ne,e),oe&&ee(!1),L(),ct(),Te()}}function Dt(){if(re<ne.length-1){let e=re+1,o=ne[e];pe(JSON.parse(JSON.stringify(o.products))),we(JSON.parse(JSON.stringify(o.machines))),ve(JSON.parse(JSON.stringify(o.scoringCriteria))),me(JSON.parse(JSON.stringify(o.detergentIngredients))),Ge(ne,e),oe&&ee(!1),L(),ct(),Te()}}function _e(e){let o=document.getElementById("theme-toggle-light-icon"),t=document.getElementById("theme-toggle-dark-icon");e?(document.documentElement.classList.add("dark"),o&&o.classList.add("hidden"),t&&t.classList.remove("hidden")):(document.documentElement.classList.remove("dark"),o&&o.classList.remove("hidden"),t&&t.classList.add("hidden")),de&&Be(),ue&&Qe()}function Go(e,o="all"){e==="scoring-system"&&oe&&(Ke(!0),ee(!1)),console.log("Printing view:",e,"Train:",o),document.body.classList.add(`printing-${e}`),e==="worstCaseProducts"?Promise.resolve().then(()=>(he(),Ee)).then(t=>{window.printSelectedTrain=o,t.renderWorstCaseByTrain(),setTimeout(()=>{window.print()},200)}):e==="macoForTrains"?(window.printSelectedTrain=o,Promise.resolve().then(()=>(It(),tt)).then(t=>{t.renderMacoForTrains();let n=document.querySelectorAll("#macoForTrains .train-content.collapsed"),r=[];n.forEach(i=>{let c=i.id.match(/content-pm-(\d+)/);if(c){r.push(c[1]),i.classList.remove("collapsed");let l=document.getElementById(`toggle-pm-${c[1]}`);l&&(l.textContent="\u25BC")}});let a=document.querySelectorAll('#macoForTrains [id^="maco-breakdown-details-"].hidden'),s=[];a.forEach(i=>{let c=i.id.match(/maco-breakdown-details-(\d+)/);if(c){s.push(c[1]),i.classList.remove("hidden");let l=document.getElementById(`breakdown-toggle-btn-${c[1]}`);l&&(l.textContent="Hide MACO Calculation Breakdown")}}),setTimeout(()=>{window.print(),setTimeout(()=>{r.forEach(i=>{let c=document.getElementById(`content-pm-${i}`),l=document.getElementById(`toggle-pm-${i}`);c&&c.classList.add("collapsed"),l&&(l.textContent="\u25B6")}),s.forEach(i=>{let c=document.getElementById(`maco-breakdown-details-${i}`),l=document.getElementById(`breakdown-toggle-btn-${i}`);c&&c.classList.add("hidden"),l&&(l.textContent="Show MACO Calculation Breakdown")})},1e3)},200)})):e==="detergentMaco"?(window.printSelectedTrain=o,Promise.resolve().then(()=>(nt(),Oe)).then(t=>{t.renderDetergentMaco();let n=document.querySelectorAll("#detergentMaco .train-content.collapsed"),r=[];n.forEach(a=>{let s=a.id.match(/content-dm-(\d+)/);if(s){r.push(s[1]),a.classList.remove("collapsed");let i=document.getElementById(`toggle-dm-${s[1]}`);i&&(i.textContent="\u25BC")}}),setTimeout(()=>{window.print(),setTimeout(()=>{r.forEach(a=>{let s=document.getElementById(`content-dm-${a}`),i=document.getElementById(`toggle-dm-${a}`);s&&s.classList.add("collapsed"),i&&(i.textContent="\u25B6")})},1e3)},200)}).catch(t=>{console.error("Error loading detergent view for print:",t),window.print()}).finally(()=>{setTimeout(()=>{window.printSelectedTrain=null,Promise.resolve().then(()=>(nt(),Oe)).then(t=>t.renderDetergentMaco()).catch(()=>{})},1200)})):e==="trainSummary"?(window.printSelectedTrain=o,console.log("Setting printSelectedTrain to:",o),Promise.resolve().then(()=>(Pt(),st)).then(t=>{t.renderTrainSummary(),setTimeout(()=>{let n=document.getElementById("trainSummaryContainer"),r=document.getElementById("noTrainSummaryMessage");if(console.log("Container display:",n?n.style.display:"not found"),console.log("No trains message display:",r?r.style.display:"not found"),console.log("Container has content:",n?n.innerHTML.length>0:!1),!n||n.style.display==="none"){console.warn("Train summary container is hidden or missing"),alert("No train data to print. Please ensure you have created trains first.");return}window.print(),setTimeout(()=>{window.printSelectedTrain=null,t.renderTrainSummary()},1e3)},500)}).catch(t=>{console.error("Error loading train summary view:",t),alert("Error loading train summary: "+t.message)})):setTimeout(()=>{window.print()},100)}function Ko(e,o){if(e==="pde"||e==="ld50"){["productRegister","worstCaseProducts"].forEach(n=>{document.querySelectorAll(`#${n} .mainTable, #${n} .ingredients-sub-table`).forEach(r=>{r.classList.toggle(`hide-${e}`)}),document.querySelectorAll(`#${n}, #${n} .train-content-inner`).forEach(r=>{r&&r.classList.toggle(`hide-${e}`)})});let t=document.querySelector(`#productRegister .mainTable.hide-${e}`)!==null;localStorage.setItem(`productRegister-${e}Hidden`,t),te("productRegister"),te("worstCaseProducts"),Promise.resolve().then(()=>(he(),Ee)).then(n=>{n.renderWorstCaseByTrain()}),Promise.resolve().then(()=>(he(),Ee)).then(n=>{n.renderRpnChart&&n.renderRpnChart()})}else{document.querySelectorAll(`#${o} .mainTable, #${o} .ingredients-sub-table`).forEach(n=>{n.classList.toggle(`hide-${e}`)});let t=document.querySelector(`#${o} .mainTable.hide-${e}`)!==null;localStorage.setItem(`${o}-${e}Hidden`,t),te(o)}}function Jo(){let e=document.getElementById("columnVisibilityDropdown");e.classList.toggle("hidden"),e.classList.contains("hidden")||document.addEventListener("click",function o(t){!t.target.closest("#columnVisibilityDropdown")&&!t.target.closest('button[onclick="toggleColumnVisibilityDropdown()"]')&&(e.classList.add("hidden"),document.removeEventListener("click",o))})}function te(e){let o=document.getElementById(e);if(!o)return;let t,n;if(e==="worstCaseProducts"){let c=localStorage.getItem("productRegister-pdeHidden"),l=localStorage.getItem("productRegister-ld50Hidden");if(c===null&&l===null)t=!1,n=!1;else{let d=c==="true",u=l==="true";d&&u?(t=!1,n=!0):(t=d,n=u)}}else{let c=localStorage.getItem(`${e}-pdeHidden`),l=localStorage.getItem(`${e}-ld50Hidden`);t=c==="true",n=l==="true"}let r=o.querySelector(".toggle-pde"),a=o.querySelector(".toggle-ld50");r&&(r.innerHTML=t?"Show PDE":"Hide PDE"),a&&(a.innerHTML=n?"Show LD50":"Hide LD50"),document.querySelectorAll(`#${e} .mainTable, #${e} .ingredients-sub-table`).forEach(c=>{c&&(c.classList.toggle("hide-pde",t),c.classList.toggle("hide-ld50",n))}),document.querySelectorAll(`#${e}, #${e} .train-content-inner`).forEach(c=>{c&&(c.classList.toggle("hide-pde",t),c.classList.toggle("hide-ld50",n))})}function Uo(){R(),Promise.resolve().then(()=>($(),U)).then(e=>{let{getProductTrainId:o,calculateScores:t}=e,n=[];if(x.forEach(l=>{let d="No";l.isCritical&&(d=`Yes${l.criticalReason?`: ${l.criticalReason}`:""}`);let u=o(l),m=l.date?new Date(l.date).toLocaleDateString():"";n.push({Date:m,"Product Code":l.productCode,"Product Name":l.name,"Train No.":u,"Dosage Form":l.productType||"","Batch Size (Kg)":l.batchSizeKg,"Special Case Product":d,"Active Ingredient":"",Solubility:"","Therapeutic Dose (mg/day)":"",Cleanability:"","PDE (\xB5g/day)":"","LD50 (mg/kg)":"","Solubility Score":"","Therapeutic Dose Score":"","Cleanability Score":"","Toxicity Score":"",RPN:"","RPN Rating":""}),l.activeIngredients.forEach(g=>{let h=t(g);n.push({Date:"","Product Code":"","Product Name":`  \u2514\u2500 ${g.name}`,"Train No.":"","Dosage Form":"","Batch Size (Kg)":"","Special Case Product":"","Active Ingredient":g.name,Solubility:g.solubility||"","Therapeutic Dose (mg/day)":g.therapeuticDose||"",Cleanability:g.cleanability||"","PDE (\xB5g/day)":g.pde||"","LD50 (mg/kg)":g.ld50||"","Solubility Score":h.solubilityScore||"","Therapeutic Dose Score":h.therapeuticDoseScore||"","Cleanability Score":h.cleanabilityScore||"","Toxicity Score":h.pdeScore||h.ld50Score||"",RPN:h.rpn,"RPN Rating":h.rpnRatingText})})}),n.length===0){S(),b("No Data","There is no data in the current view to export.");return}let a=XLSX.utils.json_to_sheet(n),s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,a,"MACO Report");let c=Object.keys(n[0]).map(l=>({wch:Math.max(l.length,...n.map(d=>String(d[l]||"").length))+2}));a["!cols"]=c,XLSX.writeFile(s,"MACO_All_Products_Report.xlsx"),S()}).catch(e=>{console.error("Error exporting to Excel:",e),S(),b("Error","Failed to export data to Excel.")})}function Zo(){R();try{let e={exportDate:new Date().toISOString(),scoringCriteria:P,products:x,machines:M,detergentIngredients:A},o=JSON.stringify(e,null,2),t=new Blob([o],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="maco_data_export.json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}catch(e){b("Error","Failed to export data to JSON."+e.message)}finally{S()}}function Yo(e){let o=e.target.files[0];if(!o)return;let t=new FileReader;t.onload=function(n){try{let r=JSON.parse(n.target.result);r&&r.products&&r.scoringCriteria&&r.machines?(pe(r.products),we(r.machines),ve(r.scoringCriteria),r.detergentIngredients&&me(r.detergentIngredients),F(),L(),b("Success","Data imported successfully.")):b("Error","Invalid JSON file structure.")}catch{b("Error","Failed to parse JSON file.")}finally{e.target.value=""}},t.readAsText(o)}function Qo(e,o){let t=document.getElementById(o),n=t.querySelector("input");e.value==="Other"?(t.style.display="block",n.required=!0):(t.style.display="none",n.required=!1,n.value="")}function en(e,o){let t=document.getElementById(o),n=t.querySelector("input");e.value==="Other"?(t.style.display="block",n.required=!0):(t.style.display="none",n.required=!1,n.value="")}function tn(e,o){let t=document.getElementById(o),n=t.querySelector("input");e.value==="Other"?(t.style.display="block",n.required=!0):(t.style.display="none",n.required=!1,n.value="")}function on(e,o){let t=parseFloat(e.min),n=parseFloat(e.max),r=parseFloat(e.value);isNaN(r)&&(r=t),r<t?r=t:r>n&&(r=n),parseFloat(e.value)!==r&&(e.value=r),e.id.startsWith("product-sf-input")?recalculateProductMacoForTrain(o):e.id.startsWith("sf-input-train")&&recalculateDetergentMacoForTrain(o)}function nn(e){let o=document.getElementById(`content-${e}`),t=document.getElementById(`toggle-${e}`);o&&t&&(o.classList.contains("collapsed")?(o.classList.remove("collapsed"),t.textContent="\u25BC"):(o.classList.add("collapsed"),t.textContent="\u25B6"))}function rn(e){let o=document.getElementById(`maco-breakdown-details-${e}`),t=document.getElementById(`breakdown-toggle-btn-${e}`);o.classList.contains("hidden")?(o.classList.remove("hidden"),t.textContent="Hide MACO Calculation Breakdown"):(o.classList.add("hidden"),t.textContent="Show MACO Calculation Breakdown")}function an(e="all"){R(),Promise.resolve().then(()=>($(),U)).then(o=>{let{getProductTrainId:t,calculateScores:n,getToxicityPreference:r}=o,a=[],s=q.worstCaseProducts||x;if(s.length===0){S(),b("No Data","There are no products in the worst case view to export.");return}let i={};s.forEach(y=>{let w=t(y);w!=="N/A"&&(i[w]||(i[w]=[]),i[w].push(y))});let c=i;if(e!=="all"&&(c={},Array.isArray(e)?e.forEach(y=>{i[y]&&(c[y]=i[y])}):i[e]&&(c={[e]:i[e]}),Object.keys(c).length===0)){S();let y=Array.isArray(e)?`Trains ${e.join(", ")}`:`Train ${e}`;b("No Data",`${y} not found or has no products.`);return}let l=r();if(Object.keys(c).sort((y,w)=>y-w).forEach(y=>{let w=c[y];a.push({Train:`Train ${y} - Worst Case Analysis`,"Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""}),w.forEach(I=>{let T=I.activeIngredients.map(v=>n(v,l).rpn);I.sortValue=T.length>0?Math.max(...T):0}),w.sort((I,T)=>T.sortValue-I.sortValue),w.forEach(I=>{let T=I.isCritical?"Yes":"No";a.push({Train:"","Product Code":I.productCode,"Product Name":I.name,"Highest RPN":I.sortValue,"Special Case Product":T,Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""}),I.activeIngredients.sort((N,E)=>n(E,l).rpn-n(N,l).rpn).forEach(N=>{let E=n(N,l);a.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:N.name,"TD Score":E.therapeuticDoseScore,"Solubility Score":E.solubilityScore,"Cleanability Score":E.cleanabilityScore,"PDE Score":E.pdeScore??"N/A","LD50 Score":E.ld50Score??"N/A",RPN:E.rpn,Rating:E.rpnRatingText})}),a.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""})})}),a.length===0){S(),b("No Data","There is no data in the worst case view to export.");return}let u=XLSX.utils.json_to_sheet(a),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,u,"Worst Case Products");let h=Object.keys(a[0]).map(y=>({wch:Math.max(y.length,...a.map(w=>String(w[y]||"").length))+2}));u["!cols"]=h;let p=new Date().toISOString().split("T")[0],f="";e!=="all"&&(Array.isArray(e)?f=`_Trains_${e.join("_")}`:f=`_Train_${e}`),XLSX.writeFile(m,`MACO_Worst_Case_Products${f}_${p}.xlsx`),S()}).catch(o=>{console.error("Error exporting worst case to Excel:",o),S(),b("Error","Failed to export worst case data to Excel.")})}function sn(){R();try{if(M.length===0){S(),b("No Data","There are no machines to export.");return}let e=[],o={};M.forEach(i=>{o[i.stage]||(o[i.stage]=[]),o[i.stage].push(i)}),V.forEach(i=>{o[i]&&o[i].forEach(c=>{let l=x.filter(m=>m.machineIds&&m.machineIds.includes(c.id)),d=l.map(m=>m.name).join(", ")||"None",u=l.length;e.push({"Machine Number":c.machineNumber,"Machine Name":c.name,Stage:c.stage,"Area (sq cm)":c.area,"Assigned Products Count":u,"Assigned Products":d})})});let t=XLSX.utils.json_to_sheet(e),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,t,"Machines");let r=[{wch:15},{wch:20},{wch:15},{wch:15},{wch:20},{wch:50}];t["!cols"]=r;let s=new Date().toISOString().split("T")[0];XLSX.writeFile(n,`MACO_Machines_${s}.xlsx`),S(),b("Success","Machines data exported to Excel successfully!")}catch(e){console.error("Error exporting machines to Excel:",e),S(),b("Error","Failed to export machines data to Excel.")}}function cn(e="all"){R(),Promise.resolve().then(()=>($(),U)).then(o=>{let{getTrainData:t,getWorstCaseProductType:n,getMacoPerSwabForTrain:r}=o,a=t();if(a.length===0){S(),b("No Data","There are no trains to export. Assign machines to products first.");return}let s=a;if(e!=="all"&&(Array.isArray(e)?s=a.filter(p=>e.includes(String(p.id))):s=a.filter(p=>String(p.id)===String(e))),s.length===0){S(),b("No Data","No trains match the selected criteria.");return}let i=[],l=a.reduce((p,f)=>f.essa>p.essa?f:p).essa;s.forEach(p=>{let f=n(p.products.map(H=>H.productType)),w=(k[f]||k.Other).max,I=p.lowestLtd*p.minBsMddRatio/w,T=10*p.minMbsKg,v="N/A";p.lowestPde!==null&&(v=p.lowestPde*p.minBsMddRatio);let N=.004*l,z=[{name:"0.1% Therapeutic Dose",value:I},{name:"10 ppm Criterion",value:T},{name:"Health-Based Limit (ADE)",value:typeof v=="number"?v:1/0},{name:"Visual Clean Limit",value:N}].reduce((H,ke)=>ke.value<H.value?ke:H),O=z.value,le=l>0?O/l:0,ye=le*p.assumedSsa,C=p.machineIds.map(H=>{let ke=M.find(Lo=>Lo.id===H);return ke||{name:`Unknown (ID: ${H})`,machineNumber:"N/A"}}),j=o.consolidateMachinesByGroup(p.machineIds).map(H=>H.isGroup?`${H.group} (${H.machineCount}x)`:H.name).join(" \u2192 "),fe=p.products.map(H=>`${H.productCode} - ${H.name}`).join("; "),No=p.worstProductRpn?`${p.worstProductRpn.productName} (${p.worstProductRpn.ingredientName}) - RPN: ${p.worstProductRpn.rpn}`:"N/A";i.push({Train:`T${p.id}`,"Total Products":p.products.length,"Total Machines":C.length,"Total Area (ESSA) cm\xB2":p.essa.toLocaleString(),Products:fe,Machines:j,"Worst-Case Dosage Form":f,"Safety Factor":w,"Lowest LTD (mg)":p.lowestLtd,"Min Batch Size (kg)":p.minMbsKg,"Min BS/MDD Ratio":p.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":p.lowestPde!==null?p.lowestPde:"N/A","Worst-Case Product (by RPN)":No,"MACO - Therapeutic Dose (mg)":I.toFixed(2),"MACO - 10 ppm (mg)":T.toFixed(2),"MACO - Health-Based (mg)":typeof v=="number"?v.toFixed(2):"N/A","MACO - Visual Clean (mg)":N.toFixed(2),"Selected MACO Method":z.name,"Final MACO (mg)":O.toFixed(2),"MACO per Area (mg/cm\xB2)":le.toExponential(3),"MACO per Swab (mg/Swab)":ye.toFixed(4)})});let d=XLSX.utils.json_to_sheet(i),u=XLSX.utils.book_new();XLSX.utils.book_append_sheet(u,d,"Product MACO Report");let m=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:40},{wch:18},{wch:15},{wch:18},{wch:15},{wch:20},{wch:15},{wch:18},{wch:18}];d["!cols"]=m;let g=new Date().toISOString().split("T")[0],h="Product_MACO_Report";if(e!=="all")if(Array.isArray(e)){let p=e.sort((f,y)=>f-y);h+=`_Trains_${p.join("_")}`}else h+=`_Train_${e}`;h+=`_${g}.xlsx`,XLSX.writeFile(u,h),S(),b("Success","Product MACO data exported to Excel successfully!")}).catch(o=>{console.error("Error exporting Product MACO to Excel:",o),S(),b("Error","Failed to export Product MACO data to Excel.")})}function ln(e="all"){R(),Promise.resolve().then(()=>($(),U)).then(o=>{let{getTrainData:t,getWorstCaseProductType:n}=o,r=t();if(e!=="all"&&(Array.isArray(e)?r=r.filter(p=>e.includes(String(p.id))):r=r.filter(p=>String(p.id)===String(e))),r.length===0){S(),b("No Data","There are no trains to export. Assign machines to products first.");return}if(A.length===0){S(),b("No Data","There are no detergent ingredients configured. Add detergent ingredients first.");return}let a=[],s=r.length>0?Math.max(...r.map(p=>p.essa)):0,i=parseFloat(document.getElementById("bodyWeight")?.value)||70,c=A.map(p=>parseFloat(p.ld50)).filter(p=>!isNaN(p)),l=c.length>0?Math.min(...c):0,d=A.map(p=>p.name).filter(p=>p.trim()!=="").join(", ");r.forEach(p=>{let f=n(p.products.map(C=>C.productType)),y=k[f]||k.Other,w=document.getElementById(`sf-input-train-${p.id}`),I=w&&parseFloat(w.value)||y.max,T=5e-4*l*i/I,v=T*p.minBsMddRatio,N=s>0?v/s:0,E=N*p.assumedSsa,z=p.machineIds.map(C=>{let j=M.find(fe=>fe.id===C);return j||{name:`Unknown (ID: ${C})`,machineNumber:"N/A"}}),O=o.consolidateMachinesByGroup(p.machineIds).map(C=>C.isGroup?`${C.group} (${C.machineCount}x)`:C.name).join(" \u2192 "),le=p.products.map(C=>`${C.productCode} - ${C.name}`).join("; "),ye=p.worstProductRpn?`${p.worstProductRpn.productName} (${p.worstProductRpn.ingredientName}) - RPN: ${p.worstProductRpn.rpn}`:"N/A";a.push({Train:`T${p.id}`,"Total Products":p.products.length,"Total Machines":z.length,"Total Area (ESSA) cm\xB2":p.essa.toLocaleString(),Products:le,Machines:O,"Worst-Case Dosage Form":f,"Safety Factor Range":`${y.min} - ${y.max}`,"Applied Safety Factor":I,"Detergent Ingredients":d,"Body Weight (kg)":i,"Minimum LD50 (mg/kg)":l,"Min Batch Size (kg)":p.minMbsKg,"Min BS/MDD Ratio":p.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":ye,"ADI (mg)":T.toFixed(4),"MACO (mg)":v.toFixed(2),"MACO per Area (mg/cm\xB2)":N.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let u=XLSX.utils.json_to_sheet(a),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,u,"Detergent MACO Report");let g=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:15},{wch:15},{wch:30},{wch:12},{wch:15},{wch:12},{wch:12},{wch:40},{wch:12},{wch:12},{wch:18},{wch:18}];u["!cols"]=g;let h=new Date().toISOString().split("T")[0];XLSX.writeFile(m,`Detergent_MACO_Report_${h}.xlsx`),S(),b("Success","Detergent MACO data exported to Excel successfully!")}).catch(o=>{console.error("Error exporting Detergent MACO to Excel:",o),S(),b("Error","Failed to export Detergent MACO data to Excel.")})}function dn(e="all"){R(),Promise.resolve().then(()=>($(),U)).then(o=>{let{getTrainData:t}=o,n=t();if(n.length===0){S(),b("No Data","There are no trains to export. Assign machines to products first.");return}let r=n;if(e!=="all"&&(Array.isArray(e)?r=n.filter(u=>e.includes(String(u.id))):r=n.filter(u=>String(u.id)===String(e))),r.length===0){S(),b("No Data","No trains match the selected criteria.");return}let a=[];r.forEach(u=>{let m=u.machineIds.map(y=>{let w=M.find(I=>I.id===y);return w||{id:y,name:`Unknown (ID: ${y})`,machineNumber:"N/A"}}),g=o.consolidateMachinesByGroup(u.machineIds).map(y=>y.isGroup?`${y.group} (${y.machineCount}x)`:y.name).join(" \u2192 "),h=u.products.map(y=>`${y.productCode} - ${y.name}`).join("; "),p=u.products.map(y=>`${y.productCode}: ${y.name}`).join(`
`),f=m.map(y=>`${y.machineNumber}: ${y.name}`).join(`
`);a.push({"Train ID":`T${u.id}`,"Products Count":u.products.length,"Machines Count":m.length,"Total Area (ESSA) cm\xB2":u.essa.toLocaleString(),"Products (Code - Name)":h,"Machines (Number - Name)":g,"Products Detailed":p,"Machines Detailed":f,"Min Batch Size (kg)":u.minMbsKg,"Min BS/MDD Ratio":u.minBsMddRatio.toFixed(2),"Assumed SSA (cm\xB2)":u.assumedSsa,"Lowest LTD (mg)":u.lowestLtd,"Lowest PDE (mg)":u.lowestPde!==null?u.lowestPde:"N/A","Worst RPN Product":u.worstProductRpn?`${u.worstProductRpn.productName} (${u.worstProductRpn.ingredientName}) - RPN: ${u.worstProductRpn.rpn}`:"N/A"})});let s=XLSX.utils.json_to_sheet(a),i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,s,"Train Summary Report");let c=[{wch:10},{wch:12},{wch:12},{wch:15},{wch:60},{wch:60},{wch:40},{wch:40},{wch:15},{wch:15},{wch:15},{wch:12},{wch:12},{wch:50}];s["!cols"]=c;let l=new Date().toISOString().split("T")[0],d="Train_Summary_Report";if(e!=="all")if(Array.isArray(e)){let u=e.sort((m,g)=>m-g);d+=`_Trains_${u.join("_")}`}else d+=`_Train_${e}`;d+=`_${l}.xlsx`,XLSX.writeFile(i,d),S(),b("Success","Train Summary data exported to Excel successfully!")}).catch(o=>{console.error("Error exporting Train Summary to Excel:",o),S(),b("Error","Failed to export Train Summary data to Excel.")})}function un(){R(),Promise.resolve().then(()=>($(),U)).then(e=>{let{getProductTrainId:o,calculateScores:t}=e,n=x.flatMap(d=>{let u=o(d);return d.activeIngredients.map(m=>({productName:d.name,productCode:d.productCode,ingredientName:m.name,rpn:t(m).rpn,trainId:u!=="N/A"?`T${u}`:"N/A",scores:t(m)}))}).sort((d,u)=>u.rpn-d.rpn).slice(0,10),r=x.filter(d=>d.isCritical);if(n.length===0&&r.length===0){S(),b("No Data","There are no summary data to export. Add products and ingredients first.");return}let a=XLSX.utils.book_new();if(n.length>0){let d=n.map((g,h)=>({Rank:h+1,"Product Code":g.productCode,"Product Name":g.productName,Train:g.trainId,Ingredient:g.ingredientName,RPN:g.rpn})),u=XLSX.utils.json_to_sheet(d),m=[{wch:8},{wch:15},{wch:30},{wch:10},{wch:25},{wch:8}];u["!cols"]=m,XLSX.utils.book_append_sheet(a,u,"Top 10 RPN")}if(r.length>0){let d=r.map(g=>({"Product Code":g.productCode,"Product Name":g.name,"Product Type":g.productType,"Batch Size (kg)":g.batchSizeKg,"MDD (mg)":g.mddMg,"Critical Reason":g.criticalReason||"No reason provided",Train:o(g)!=="N/A"?`T${o(g)}`:"N/A"})),u=XLSX.utils.json_to_sheet(d),m=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:50},{wch:10}];u["!cols"]=m,XLSX.utils.book_append_sheet(a,u,"Critical Products")}let s=x.map(d=>{let u=o(d),m=d.activeIngredients.reduce((g,h)=>{let p=t(h).rpn;return p>g.rpn?{...h,rpn:p}:g},{rpn:0,name:"N/A"});return{"Product Code":d.productCode,"Product Name":d.name,"Product Type":d.productType,"Batch Size (kg)":d.batchSizeKg,"MDD (mg)":d.mddMg,Train:u!=="N/A"?`T${u}`:"N/A","Is Critical":d.isCritical?"Yes":"No","Critical Reason":d.criticalReason||"N/A","Ingredients Count":d.activeIngredients.length,"Highest RPN Ingredient":m.name,"Highest RPN Value":m.rpn||0}}),i=XLSX.utils.json_to_sheet(s),c=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:10},{wch:10},{wch:40},{wch:12},{wch:25},{wch:12}];i["!cols"]=c,XLSX.utils.book_append_sheet(a,i,"All Products");let l=new Date().toISOString().split("T")[0];XLSX.writeFile(a,`MACO_Summary_Report_${l}.xlsx`),S(),b("Success","Summary report data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Summary to Excel:",e),S(),b("Error","Failed to export Summary report data to Excel.")})}function pn(){R(),Promise.resolve().then(()=>($(),U)).then(e=>{let{getTrainData:o,getWorstCaseProductType:t,getProductTrainId:n,calculateScores:r}=e,a=o();if(a.length===0){S(),b("No Data","There are no trains to export. Assign machines to products first.");return}let s=XLSX.utils.book_new();try{let c=a.reduce((u,m)=>m.essa>u.essa?m:u).essa,l=[];a.forEach(u=>{let m=t(u.products.map(C=>C.productType)),h=(k[m]||k.Other).max,p=u.lowestLtd*u.minBsMddRatio/h,f=10*u.minMbsKg,y="N/A";u.lowestPde!==null&&(y=u.lowestPde*u.minBsMddRatio);let w=.004*c,T=[{name:"0.1% Therapeutic Dose",value:p},{name:"10 ppm Criterion",value:f},{name:"Health-Based Limit (ADE)",value:typeof y=="number"?y:1/0},{name:"Visual Clean Limit",value:w}].reduce((C,j)=>j.value<C.value?j:C),v=T.value,N=c>0?v/c:0,E=N*u.assumedSsa,z=u.machineIds.map(C=>{let j=M.find(fe=>fe.id===C);return j||{name:`Unknown (ID: ${C})`,machineNumber:"N/A"}}),O=e.consolidateMachinesByGroup(u.machineIds).map(C=>C.isGroup?`${C.group} (${C.machineCount}x)`:C.name).join(" \u2192 "),le=u.products.map(C=>`${C.productCode} - ${C.name}`).join("; "),ye=u.worstProductRpn?`${u.worstProductRpn.productName} (${u.worstProductRpn.ingredientName}) - RPN: ${u.worstProductRpn.rpn}`:"N/A";l.push({Train:`T${u.id}`,"Total Products":u.products.length,"Total Machines":z.length,"Total Area (ESSA) cm\xB2":u.essa.toLocaleString(),Products:le,Machines:O,"Worst-Case Dosage Form":m,"Safety Factor":h,"Lowest LTD (mg)":u.lowestLtd,"Min Batch Size (kg)":u.minMbsKg,"Min BS/MDD Ratio":u.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":u.lowestPde!==null?u.lowestPde:"N/A","Worst-Case Product (by RPN)":ye,"MACO - Therapeutic Dose (mg)":p.toFixed(2),"MACO - 10 ppm (mg)":f.toFixed(2),"MACO - Health-Based (mg)":typeof y=="number"?y.toFixed(2):"N/A","MACO - Visual Clean (mg)":w.toFixed(2),"Selected MACO Method":T.name,"Final MACO (mg)":v.toFixed(2),"MACO per Area (mg/cm\xB2)":N.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let d=XLSX.utils.json_to_sheet(l);XLSX.utils.book_append_sheet(s,d,"Product MACO")}catch(c){console.error("Error creating Product MACO sheet:",c)}try{if(A.length>0){let c=a.length>0?Math.max(...a.map(p=>p.essa)):0,l=parseFloat(document.getElementById("bodyWeight")?.value)||70,d=A.map(p=>parseFloat(p.ld50)).filter(p=>!isNaN(p)),u=d.length>0?Math.min(...d):0,m=A.map(p=>p.name).filter(p=>p.trim()!=="").join(", "),g=[];a.forEach(p=>{let f=t(p.products.map(C=>C.productType)),y=k[f]||k.Other,w=document.getElementById(`sf-input-train-${p.id}`),I=w&&parseFloat(w.value)||y.max,T=5e-4*u*l/I,v=T*p.minBsMddRatio,N=c>0?v/c:0,E=N*p.assumedSsa,z=p.machineIds.map(C=>{let j=M.find(fe=>fe.id===C);return j||{name:`Unknown (ID: ${C})`,machineNumber:"N/A"}}),O=e.consolidateMachinesByGroup(p.machineIds).map(C=>C.isGroup?`${C.group} (${C.machineCount}x)`:C.name).join(" \u2192 "),le=p.products.map(C=>`${C.productCode} - ${C.name}`).join("; "),ye=p.worstProductRpn?`${p.worstProductRpn.productName} (${p.worstProductRpn.ingredientName}) - RPN: ${p.worstProductRpn.rpn}`:"N/A";g.push({Train:`T${p.id}`,"Total Products":p.products.length,"Total Machines":z.length,"Total Area (ESSA) cm\xB2":p.essa.toLocaleString(),Products:le,Machines:O,"Worst-Case Dosage Form":f,"Safety Factor Range":`${y.min} - ${y.max}`,"Applied Safety Factor":I,"Detergent Ingredients":m,"Body Weight (kg)":l,"Minimum LD50 (mg/kg)":u,"Min Batch Size (kg)":p.minMbsKg,"Min BS/MDD Ratio":p.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":ye,"ADI (mg)":T.toFixed(4),"MACO (mg)":v.toFixed(2),"MACO per Area (mg/cm\xB2)":N.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let h=XLSX.utils.json_to_sheet(g);XLSX.utils.book_append_sheet(s,h,"Detergent MACO")}}catch(c){console.error("Error creating Detergent MACO sheet:",c)}try{let c=[];a.forEach(d=>{let u=d.machineIds.map(f=>{let y=M.find(w=>w.id===f);return y||{id:f,name:`Unknown (ID: ${f})`,machineNumber:"N/A"}}),m=e.consolidateMachinesByGroup(d.machineIds).map(f=>f.isGroup?`${f.group} (${f.machineCount}x)`:f.name).join(" \u2192 "),g=d.products.map(f=>`${f.productCode} - ${f.name}`).join("; "),h=d.products.map(f=>`${f.productCode}: ${f.name}`).join(`
`),p=u.map(f=>`${f.machineNumber}: ${f.name}`).join(`
`);c.push({"Train ID":`T${d.id}`,"Products Count":d.products.length,"Machines Count":u.length,"Total Area (ESSA) cm\xB2":d.essa.toLocaleString(),"Products (Code - Name)":g,"Machines (Number - Name)":m,"Products Detailed":h,"Machines Detailed":p,"Min Batch Size (kg)":d.minMbsKg,"Min BS/MDD Ratio":d.minBsMddRatio.toFixed(2),"Assumed SSA (cm\xB2)":d.assumedSsa,"Lowest LTD (mg)":d.lowestLtd,"Lowest PDE (mg)":d.lowestPde!==null?d.lowestPde:"N/A","Worst RPN Product":d.worstProductRpn?`${d.worstProductRpn.productName} (${d.worstProductRpn.ingredientName}) - RPN: ${d.worstProductRpn.rpn}`:"N/A"})});let l=XLSX.utils.json_to_sheet(c);XLSX.utils.book_append_sheet(s,l,"Train Summary")}catch(c){console.error("Error creating Train Summary sheet:",c)}try{let c=x.flatMap(l=>{let d=n(l);return l.activeIngredients.map(u=>({productName:l.name,productCode:l.productCode,ingredientName:u.name,rpn:r(u).rpn,trainId:d!=="N/A"?`T${d}`:"N/A"}))}).sort((l,d)=>d.rpn-l.rpn).slice(0,10);if(c.length>0){let l=c.map((u,m)=>({Rank:m+1,"Product Code":u.productCode,"Product Name":u.productName,Train:u.trainId,Ingredient:u.ingredientName,RPN:u.rpn})),d=XLSX.utils.json_to_sheet(l);XLSX.utils.book_append_sheet(s,d,"Top 10 RPN")}}catch(c){console.error("Error creating Top 10 RPN sheet:",c)}try{let c=x.filter(l=>l.isCritical);if(c.length>0){let l=c.map(u=>({"Product Code":u.productCode,"Product Name":u.name,"Product Type":u.productType,"Batch Size (kg)":u.batchSizeKg,"MDD (mg)":u.mddMg,"Critical Reason":u.criticalReason||"No reason provided",Train:n(u)!=="N/A"?`T${n(u)}`:"N/A"})),d=XLSX.utils.json_to_sheet(l);XLSX.utils.book_append_sheet(s,d,"Critical Products")}}catch(c){console.error("Error creating Critical Products sheet:",c)}try{let c=x.map(d=>{let u=n(d),m=d.activeIngredients.reduce((g,h)=>{let p=r(h).rpn;return p>g.rpn?{...h,rpn:p}:g},{rpn:0,name:"N/A"});return{"Product Code":d.productCode,"Product Name":d.name,"Product Type":d.productType,"Batch Size (kg)":d.batchSizeKg,"MDD (mg)":d.mddMg,Train:u!=="N/A"?`T${u}`:"N/A","Is Critical":d.isCritical?"Yes":"No","Critical Reason":d.criticalReason||"N/A","Ingredients Count":d.activeIngredients.length,"Highest RPN Ingredient":m.name,"Highest RPN Value":m.rpn||0}}),l=XLSX.utils.json_to_sheet(c);XLSX.utils.book_append_sheet(s,l,"All Products")}catch(c){console.error("Error creating All Products sheet:",c)}try{let c=[];x.forEach(d=>{let u=n(d),m={"Product Code":d.productCode,"Product Name":d.name,"Product Type":d.productType,"Batch Size (kg)":d.batchSizeKg,"MDD (mg)":d.mddMg,Train:u!=="N/A"?`T${u}`:"N/A","Is Critical":d.isCritical?"Yes":"No","Critical Reason":d.criticalReason||"N/A","Ingredient Type":"PRODUCT","Ingredient Name":"","LTD (mg)":"","PDE (mg)":"","LD50 (mg/kg)":"",Severity:"",Occurrence:"",Detection:"",RPN:""};c.push(m),d.activeIngredients.forEach(g=>{let h=r(g);c.push({"Product Code":"","Product Name":"","Product Type":"","Batch Size (kg)":"","MDD (mg)":"",Train:"","Is Critical":"","Critical Reason":"","Ingredient Type":"INGREDIENT","Ingredient Name":g.name,"LTD (mg)":g.ltdMg||"N/A","PDE (mg)":g.pdeMg||"N/A","LD50 (mg/kg)":g.ld50||"N/A",Severity:h.severity,Occurrence:h.occurrence,Detection:h.detection,RPN:h.rpn})})});let l=XLSX.utils.json_to_sheet(c);XLSX.utils.book_append_sheet(s,l,"Product Register")}catch(c){console.error("Error creating Product Register sheet:",c)}let i=new Date().toISOString().split("T")[0];XLSX.writeFile(s,`Complete_MACO_Report_${i}.xlsx`),S(),b("Success","Complete report with all tabs exported to Excel successfully!")}).catch(e=>{console.error("Error exporting all tabs to Excel:",e),S(),b("Error","Failed to export complete report to Excel.")})}function mn(e){let o=document.getElementById(`stage-${e}`),t=o.style.display==="none";o.style.display=t?"":"none",localStorage.setItem(`machineStage-${e}-hidden`,!t);let n=o.parentElement.querySelector("button");n&&(n.textContent=t?"Hide":"Show")}var Co,R,S,Q,W=G(()=>{X();Ne();$();bt();he();Ct();Co=document.getElementById("loader"),R=()=>Co.style.display="flex",S=()=>Co.style.display="none";Q=e=>document.getElementById(e).style.display="none"});var Ft={};Z(Ft,{addIngredientFormFields:()=>Io,addNewProduct:()=>Rt,deleteIngredient:()=>xn,deleteProduct:()=>fn,handleSearchAndFilter:()=>Pe,populateDynamicSelectsForElement:()=>At,populateFilterSelects:()=>Bt,renderProducts:()=>lt,resetFilters:()=>bn,saveIngredientChanges:()=>Lt,saveProductChanges:()=>Nt,showAddForm:()=>gn,showEditIngredientModal:()=>yn,showEditProductModal:()=>hn,sortData:()=>$t,updateSortIndicators:()=>Mo});function lt(e){if(e==="worstCaseProducts"){ge();return}let o=document.getElementById(e);if(!o)return;let t=o.querySelector(".productsTable"),n=o.querySelector(".noResultsMessage"),r=[...q[e]];r.sort((a,s)=>{let i,c;switch(D.key){case"productCode":i=a.productCode,c=s.productCode;break;case"name":i=a.name,c=s.name;break;case"batchSizeKg":i=a.batchSizeKg,c=s.batchSizeKg;break;case"date":i=new Date(a.date),c=new Date(s.date);break;default:return 0}let d=D.direction==="asc"?1:-1;return i<c?-1*d:i>c?1*d:0}),t.innerHTML="",n.style.display=r.length>0?"none":"block",t.style.display=r.length>0?"":"none",r.forEach((a,s)=>{let i=document.createElement("tr");i.className="product-main-row";let c=a.isCritical?"Yes":"No",l=a.isCritical?"text-red-600 font-bold":"",d=K(a),u=d!=="N/A"?"T"+d:"N/A";i.innerHTML=`
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${s+1}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${new Date(a.date).toLocaleDateString()}</td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${a.productCode}</td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">
                        <span class="product-name">${a.name}</span>
                    </td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top text-center" style="color: var(--text-secondary);">${u}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${a.productType||"N/A"}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${a.batchSizeKg}</td>
                    <td class="px-3 py-3 text-sm align-top">
                         <span class="${l}">${c}</span>
                         ${a.isCritical&&a.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 200px; white-space: normal;">${a.criticalReason}</p>`:""}
                    </td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top">
                        <div class="flex items-center gap-x-2 no-print">
                           <button onclick="showAssignMachinesModal(${a.id})" class="p-1" style="color: var(--text-secondary);" title="Assign Machines">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-wide-connected" viewBox="0 0 16 16"><path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.62 1.105l-.09.282c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.09-.282c-.268-1.135.925-1.824 1.62-1.105l.205.211a.96.96 0 0 0 1.622-.434L7.068.727zM12.973 8.5H8.25l-1.03-1.03a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l2.5-2.5a1 1 0 0 0-1.414-1.414L12.973 8.5z"/><path d="M.242 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353-.14l.17-.186c.695-.761 1.888.06 1.62 1.204l-.066.261c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066-.261c-.268-1.144.925-1.965 1.62-1.204l.17.186a.96.96 0 0 0 1.353.14l.058-.058a.626.626 0 0 1 0-.884zM15.758 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353.14l.17-.186c.695.761-.925 1.965-1.62 1.204l-.066-.261c-.273-.85-.92-1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066.261c-.268 1.144 1.888.443 1.62-1.204l.17-.186a.96.96 0 0 0 1.353-.14l.058-.058a.626.626 0 0 1 0 .884z"/></svg>
                            </button>
                             <button onclick="showEditProductModal(${a.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Product"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                            <button onclick="deleteProduct(${a.id})" class="p-1 text-red-500" title="Delete Product">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>
                            </button>
                        </div>
                    </td>
                `;let m=document.createElement("tr");m.className="ingredients-sub-row";let g=document.createElement("td");g.colSpan=9;let h=`
                    <div class="p-4 ingredients-sub-table rounded-b-lg">
                        <table class="w-full text-xs">
                            <thead class="bg-transparent">
                                <tr class="border-b" style="border-color: var(--border-color);">
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Ingredient</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">TD (mg)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">MDD (g/day)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Solubility</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Cleanability</th>
                                    <th class="pde-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">PDE (mg/day)</th>
                                    <th class="ld50-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">LD50 (mg/kg)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-transparent">`;a.activeIngredients.forEach(p=>{h+=`
                        <tr>
                            <td class="px-3 py-2 font-semibold">${p.name}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${p.therapeuticDose}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${p.mdd/1e3}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${p.solubility}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${p.cleanability}</td>
                            <td class="pde-col px-3 py-2" style="color: var(--text-secondary);">${p.pde??"N/A"}</td>
                            <td class="ld50-col px-3 py-2" style="color: var(--text-secondary);">${p.ld50??"N/A"}</td>
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-x-2 no-print">
                                    <button onclick="showEditIngredientModal(${a.id}, ${p.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                                    <button onclick="deleteIngredient(${a.id}, ${p.id})" class="p-1 text-red-500" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                                </div>
                            </td>
                        </tr>`}),h+="</tbody></table></div>",g.innerHTML=h,m.appendChild(g),t.appendChild(i),t.appendChild(m)}),Mo(e),te(e),S()}function Pe(e){R();let o=document.getElementById(e);if(e==="worstCaseProducts"){let i=document.getElementById("worstCaseProductNameFilter"),c=i?i.value.toLowerCase():"";q[e]=x.filter(l=>l.name.toLowerCase().includes(c)),lt(e);return}let t=o.querySelector(".filterColProductCode").value.toLowerCase(),n=o.querySelector(".filterColProductName").value.toLowerCase(),r=o.querySelector(".filterColTrainNo").value,a=o.querySelector(".filterColProductType").value,s=o.querySelector(".filterColIsCritical").value;q[e]=x.filter(i=>{let c=i.productCode.toLowerCase().includes(t),l=i.name.toLowerCase().includes(n),d=K(i),u=d!=="N/A"?"T"+d:"N/A",m=r==="all"||u===r,g=a==="all"||i.productType===a,h=s==="all"||String(i.isCritical)===s;return c&&l&&m&&g&&h}),lt(e)}function $t(e,o){D.key===e?D.direction=D.direction==="asc"?"desc":"asc":(D.key=e,D.direction=e==="rpn"?"desc":"asc"),o==="worstCaseProducts"?ge():lt(o)}function Mo(e){let o=document.getElementById(e);!o||e==="worstCaseProducts"||o.querySelectorAll(".mainTable th.sortable").forEach(t=>{let n=t.querySelector(".sort-indicator");t.getAttribute("onclick").match(/'(.*?)'/)[1]===D.key?n.textContent=D.direction==="asc"?"\u25B2":"\u25BC":n.textContent=""})}function gn(){let e=document.getElementById("addProductForm");e.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="addProductCode" class="w-full px-3 py-2 border rounded-lg" required placeholder="e.g. 1ABC12345DE" pattern="[0-9]{1}[A-Z]{3}[0-9]{5}[A-Z]{2}"></div>
                                  <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" required></div>
                                  <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="addProductDate" class="w-full px-3 py-2 border rounded-lg" required></div>
                              </div>
                              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                                  <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="addBatchSize" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>
                                  <div class="md:col-span-2">
                                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Dosage Form</label>
                                            <select id="addProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="toggleOtherProductType(this, 'addOtherTypeContainer')">
                                                <option value="" disabled selected>Select a form...</option>
                                                <option value="Tablets">Tablets</option>
                                                <option value="Capsules">Capsules</option>
                                                <option value="Liquids">Liquids</option>
                                                <option value="Semisolids">Semisolids</option>
                                                <option value="Sterile Products">Sterile Products</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div id="addOtherTypeContainer" style="display: none;">
                                            <label class="block text-sm font-medium mb-1">Specify Other Form</label>
                                            <input type="text" id="addOtherProductType" class="w-full px-3 py-2 border rounded-lg">
                                        </div>
                                      </div>
                                  </div>
                              </div>
                              <div><div class="flex justify-between items-center mb-4"><h4 class="text-lg font-medium">Active Ingredients</h4><button type="button" onclick="addIngredientFormFields('ingredientsContainer')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button></div><div id="ingredientsContainer"></div></div>`,document.getElementById("ingredientsContainer").innerHTML="",gt(0),Io("ingredientsContainer"),document.getElementById("addProductDate").value=new Date().toISOString().split("T")[0],document.getElementById("addProductModal").style.display="flex"}function Io(e,o=null){let t=!!o;gt(pt+1);let n=document.getElementById(e),r=document.createElement("div");r.className="border rounded-lg p-4 mb-4 relative ingredient-edit-row",r.style.borderColor="var(--border-color)";let a=t||n.id==="editIngredientsContainer"||n.children.length>0?`<button type="button" onclick="this.closest('.ingredient-edit-row').remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>`:"";r.innerHTML=`
        ${a}
        <input type="hidden" name="ingredientId" value="${o?.id||""}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="md:col-span-2"><label class="block text-xs font-medium mb-1">Ingredient Name</label><input type="text" name="ingredientName" value="${o?.name||""}" class="w-full px-3 py-2 border rounded-lg text-sm" required></div>
            <div><label class="block text-xs font-medium mb-1">TD (mg)</label><input type="number" step="any" name="therapeuticDose" value="${o?.therapeuticDose||""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>
            <div><label class="block text-xs font-medium mb-1">MDD (g/day)</label><input type="number" step="any" name="mdd" value="${o?o.mdd/1e3:""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>
            <div><label class="block text-xs font-medium mb-1">Solubility</label><select name="solubility" class="w-full px-3 py-2 border rounded-lg text-sm"></select></div>
            <div><label class="block text-xs font-medium mb-1">Cleanability</label><select name="cleanability" class="w-full px-3 py-2 border rounded-lg text-sm" required></select></div>
            <div><label class="block text-xs font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" name="pde" value="${o?.pde??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>
            <div><label class="block text-xs font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" name="ld50" value="${o?.ld50??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>
        </div>`,n.appendChild(r),At(r),o&&(r.querySelector('select[name="solubility"]').value=o.solubility,r.querySelector('select[name="cleanability"]').value=o.cleanability)}function At(e){Ae(e.querySelector('select[name="solubility"], #editSolubility'),"solubility"),Ae(e.querySelector('select[name="cleanability"], #editCleanability'),"cleanability")}function hn(e){let o=x.find(l=>l.id===e);if(!o)return;let t=document.getElementById("editProductForm"),n=o.date?new Date(o.date).toISOString().split("T")[0]:"";t.innerHTML=`
                <input type="hidden" id="editProductId" value="${o.id}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="editProductCode" value="${o.productCode}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="editProductName" value="${o.name}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="editProductDate" value="${n}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="editBatchSize" value="${o.batchSizeKg}" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                    <div>
                        <label class="block text-sm font-medium mb-1">Dosage Form</label>
                        <select id="editProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="toggleOtherProductType(this, 'editOtherTypeContainer')">
                            <option value="Tablets">Tablets</option>
                            <option value="Capsules">Capsules</option>
                            <option value="Liquids">Liquids</option>
                            <option value="Semisolids">Semisolids</option>
                            <option value="Sterile Products">Sterile Products</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div id="editOtherTypeContainer" style="display: none;">
                        <label class="block text-sm font-medium mb-1">Specify Other Form</label>
                        <input type="text" id="editOtherProductType" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Special Case Product</label>
                    <select id="editIsCritical" onchange="document.getElementById('editCriticalReasonContainer').style.display = this.value === 'true' ? 'block' : 'none';" class="w-full px-3 py-2 border rounded-lg">
                        <option value="false" ${o.isCritical?"":"selected"}>No</option>
                        <option value="true" ${o.isCritical?"selected":""}>Yes</option>
                    </select>
                </div>
                <div id="editCriticalReasonContainer" style="display: ${o.isCritical?"block":"none"};">
                    <label class="block text-sm font-medium mb-1">Reason for Special Case Status</label>
                    <textarea id="editCriticalReason" class="w-full px-3 py-2 border rounded-lg" placeholder="Enter reason...">${o.criticalReason||""}</textarea>
                </div>
                <div class="border-t pt-4 mt-4" style="border-color:var(--border-color);">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium">Add New Ingredients</h4>
                        <button type="button" onclick="addIngredientFormFields('editIngredientsContainer')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button>
                    </div>
                    <div id="editIngredientsContainer" class="space-y-4"></div>
                </div>
            `;let r=t.querySelector("#editIngredientsContainer");r.innerHTML="";let a=t.querySelector("#editProductType"),s=t.querySelector("#editOtherProductType"),i=t.querySelector("#editOtherTypeContainer");Array.from(a.options).map(l=>l.value).includes(o.productType)?(a.value=o.productType,i.style.display="none",s.required=!1):(a.value="Other",s.value=o.productType||"",i.style.display="block",s.required=!0),document.getElementById("editProductModalTitle").textContent=`Edit Product: ${o.name}`,document.getElementById("editProductModal").style.display="flex"}function Nt(e){e.preventDefault();let o=parseInt(document.getElementById("editProductId").value),t=x.find(c=>c.id===o);if(!t){b("Error","Could not find product to update.");return}let n=document.getElementById("editProductType").value;if(n==="Other"){let c=document.getElementById("editOtherProductType").value.trim();if(!c){b("Validation Error","Please specify the 'Other' dosage form.");return}n=c}if(t.productCode=document.getElementById("editProductCode").value,t.name=document.getElementById("editProductName").value,t.date=new Date(document.getElementById("editProductDate").value).toISOString(),t.batchSizeKg=parseFloat(document.getElementById("editBatchSize").value),t.productType=n,t.isCritical=document.getElementById("editIsCritical").value==="true",t.criticalReason=t.isCritical?document.getElementById("editCriticalReason").value:"",x.find(c=>c.id!==o&&c.productCode.toLowerCase()===t.productCode.toLowerCase())){b("Validation Error",`Product code "${t.productCode}" already exists. Please use a unique product code.`);return}let a=[],s=document.querySelectorAll("#editIngredientsContainer .ingredient-edit-row"),i=!0;if(s.forEach(c=>{if(!i)return;let l={id:xe};l.name=c.querySelector('[name="ingredientName"]').value.trim(),l.therapeuticDose=parseFloat(c.querySelector('[name="therapeuticDose"]').value),l.mdd=parseFloat(c.querySelector('[name="mdd"]').value)*1e3,l.solubility=c.querySelector('[name="solubility"]').value,l.cleanability=c.querySelector('[name="cleanability"]').value;let d=c.querySelector('[name="pde"]').value,u=c.querySelector('[name="ld50"]').value;l.pde=d?parseFloat(d):null,l.ld50=u?parseFloat(u):null,!l.name||isNaN(l.therapeuticDose)||isNaN(l.mdd)||!l.solubility||!l.cleanability||l.pde===null&&l.ld50===null?i=!1:(a.push(l),Me(xe+1))}),!i){b("Validation Error","Please fill all required fields for each newly added ingredient."),nextIngredientId-=a.length;return}t.activeIngredients.push(...a),F(),L(),Q("editProductModal"),b("Success","Product updated successfully.")}function yn(e,o){let n=x.find(a=>a.id===e)?.activeIngredients.find(a=>a.id===o);if(!n){b("Error","Could not find ingredient to edit.");return}let r=document.getElementById("editIngredientForm");r.innerHTML=`<input type="hidden" id="editIngredientProductId" value="${e}"><input type="hidden" id="editIngredientId" value="${o}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Ingredient Name</label><input type="text" id="editIngredientName" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">TD (mg)</label><input type="number" step="any" id="editTherapeuticDose" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">MDD (g/day)</label><input type="number" step="any" id="editMdd" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">Solubility</label><select id="editSolubility" class="w-full px-3 py-2 border rounded-lg"></select></div><div><label class="block text-sm font-medium mb-1">Cleanability</label><select id="editCleanability" class="w-full px-3 py-2 border rounded-lg" required></select></div><div><label class="block text-sm font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" id="editPde" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div><div><label class="block text-sm font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" id="editLd50" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div></div>`,document.getElementById("editIngredientModalTitle").textContent=`Edit: ${n.name}`,document.getElementById("editIngredientName").value=n.name,document.getElementById("editTherapeuticDose").value=n.therapeuticDose,document.getElementById("editMdd").value=n.mdd/1e3,document.getElementById("editPde").value=n.pde??"",document.getElementById("editLd50").value=n.ld50??"",At(r),document.getElementById("editSolubility").value=n.solubility,document.getElementById("editCleanability").value=n.cleanability,document.getElementById("editIngredientModal").style.display="flex"}function Lt(e){e.preventDefault();let o=parseInt(document.getElementById("editIngredientProductId").value),t=parseInt(document.getElementById("editIngredientId").value),r=x.find(i=>i.id===o)?.activeIngredients.find(i=>i.id===t);if(!r){b("Error","Save failed. Could not find original ingredient.");return}let a=document.getElementById("editPde").value,s=document.getElementById("editLd50").value;if(r.name=document.getElementById("editIngredientName").value.trim(),r.therapeuticDose=parseFloat(document.getElementById("editTherapeuticDose").value),r.mdd=parseFloat(document.getElementById("editMdd").value)*1e3,r.solubility=document.getElementById("editSolubility").value,r.cleanability=document.getElementById("editCleanability").value,r.pde=a?parseFloat(a):null,r.ld50=s?parseFloat(s):null,!r.name||isNaN(r.therapeuticDose)||isNaN(r.mdd)||!r.solubility||!r.cleanability||r.pde===null&&r.ld50===null){b("Validation Error","Please fill all required fields.");return}F(),Q("editIngredientModal"),L(),b("Success",`${r.name} was updated successfully.`)}function fn(e){if(confirm("Are you sure you want to delete this entire product?")){let o=x.filter(t=>t.id!==e);pe(o),F(),L()}}function xn(e,o){let t=x.find(n=>n.id===e);if(t){if(t.activeIngredients.length===1){b("Cannot Remove","A product must have at least one ingredient. To remove this, please delete the entire product.");return}confirm("Are you sure you want to remove this ingredient?")&&(t.activeIngredients=t.activeIngredients.filter(n=>n.id!==o),F(),L())}}function Bt(){let e=[...new Set(x.map(t=>t.productType))].sort();Ae(document.querySelector(".filterColProductType"),null,!0,e);let o=document.querySelector(".filterColTrainNo");if(o){let t=[...new Set(x.map(n=>K(n)).filter(n=>n!=="N/A"))].sort((n,r)=>n-r);o.innerHTML='<option value="all">All</option>',t.forEach(n=>{o.innerHTML+=`<option value="T${n}">T${n}</option>`})}}function bn(e){let o=document.getElementById(e);o.querySelectorAll('.filter-row input[type="text"], .filter-row input[type="number"]').forEach(t=>t.value=""),o.querySelectorAll(".filter-row select").forEach(t=>t.value="all"),D.key="rpn",D.direction="desc",Pe(e)}function Rt(e){e.preventDefault();let o=document.getElementById("addProductCode").value.trim(),t=document.getElementById("addProductName").value.trim(),n=parseFloat(document.getElementById("addBatchSize").value),r=new Date(document.getElementById("addProductDate").value).toISOString(),a=document.getElementById("addProductType").value;if(a==="Other"){let m=document.getElementById("addOtherProductType").value.trim();if(!m){b("Validation Error","Please specify the 'Other' dosage form or choose a different option.");return}a=m}if(!o||!t||!r||isNaN(n)||n<=0||!a){b("Validation Error","Please fill all required product fields, including Dosage Form.");return}if(x.find(m=>m.productCode.toLowerCase()===o.toLowerCase())){b("Validation Error",`Product code "${o}" already exists. Please use a unique product code.`);return}let i=document.querySelectorAll("#ingredientsContainer > div"),c=[],l=!0;if(i.forEach(m=>{if(!l)return;let g={id:xe};De(xe+1),g.name=m.querySelector('[name="ingredientName"]').value.trim(),g.therapeuticDose=parseFloat(m.querySelector('[name="therapeuticDose"]').value),g.mdd=parseFloat(m.querySelector('[name="mdd"]').value)*1e3,g.solubility=m.querySelector('[name="solubility"]').value,g.cleanability=m.querySelector('[name="cleanability"]').value;let h=m.querySelector('[name="pde"]').value,p=m.querySelector('[name="ld50"]').value;g.pde=h?parseFloat(h):null,g.ld50=p?parseFloat(p):null,!g.name||isNaN(g.therapeuticDose)||isNaN(g.mdd)||!g.solubility||!g.cleanability||g.pde===null&&g.ld50===null?l=!1:c.push(g)}),!l){b("Validation Error","Please fill all required fields for each ingredient."),De(xe-c.length);return}let d={id:ze,productCode:o,name:t,batchSizeKg:n,date:r,productType:a,machineIds:[],activeIngredients:c,isCritical:!1,criticalReason:""};We(ze+1);let u=[...x,d];pe(u),F(),L(),Q("addProductModal")}var Eo=G(()=>{X();Ne();W();$();he()});var Vt={};Z(Vt,{deleteMachine:()=>Cn,exportMachineProductsToExcel:()=>To,printMachineProducts:()=>Po,renderMachinesTable:()=>Ve,saveMachine:()=>Ot,saveProductMachines:()=>_t,saveProductsToMachine:()=>Ht,showAddProductsToMachineModal:()=>En,showAssignMachinesModal:()=>In,showMachineModal:()=>Sn,showMachineProductsModal:()=>Mn,sortMachines:()=>wn});function wn(e){J.key===e?J.direction=J.direction==="asc"?"desc":"asc":(J.key=e,J.direction="asc"),Gt(J),Ve()}function vn(){let e=document.getElementById("machineManagement");e&&e.querySelectorAll(".card th.sortable").forEach(o=>{let t=o.querySelector(".sort-indicator");o.getAttribute("onclick").match(/'(.*?)'/)[1]===J.key?t.textContent=J.direction==="asc"?"\u25B2":"\u25BC":t.textContent=""})}function Ve(){let e=document.getElementById("machinesContainer"),o=document.getElementById("noMachinesMessage");if(e.innerHTML="",M.length===0){o.style.display="block";return}o.style.display="none";let t={};V.forEach(r=>{r!=="Other"&&(t[r]=[])});let n=[];M.forEach(r=>{V.includes(r.stage)?r.stage!=="Other"&&t[r.stage].push(r):(t[r.stage]||(t[r.stage]=[],n.push(r.stage)),t[r.stage].push(r))}),Object.keys(t).forEach(r=>{let a=r.toLowerCase().replace(/\s+/g,""),s=localStorage.getItem(`machineStage-${a}-hidden`)==="true",i=t[r];if(i.length===0)return;let c=[...i].sort((u,m)=>{let g=J.key,h=J.direction==="asc"?1:-1,p,f;return g==="area"?(p=u.area,f=m.area):(p=String(u[g]||"").toLowerCase(),f=String(m[g]||"").toLowerCase()),p<f?-1*h:p>f?1*h:0}),l=document.createElement("div");l.className="card p-6";let d=`
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">${r} Machines (${i.length})</h3>
                <button onclick="toggleStageSection('${a}')" class="text-sm px-3 py-1 rounded border" style="border-color: var(--border-color); color: var(--text-secondary);">
                    ${s?"Show":"Hide"}
                </button>
            </div>
            <div id="stage-${a}" ${s?'style="display: none;"':""}>
                <div class="overflow-x-auto overflow-hidden rounded-md border" style="border-color: var(--border-color);">
                    <table class="w-full text-sm">
                        <thead class="border-b" style="border-color: var(--border-color);">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('machineNumber')">Number <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('name')">Name <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('group')">Group <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('area')">Area (cm\xB2) <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('cleaningSOP')">Cleaning SOP <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Products</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y" style="border-color: var(--border-color);">`;c.forEach(u=>{let m=x.filter(y=>y.machineIds&&y.machineIds.includes(u.id)),g=m.length,h='<div class="flex items-center gap-x-2">';g>0?h+=`
                    <span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color: var(--bg-accent); color: var(--text-primary);">${g}</span>
                    <button onclick="showMachineProductsModal(${u.id})" class="p-1" style="color: var(--text-secondary);" title="View ${g} Product(s)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                    </button>`:h+='<span class="text-xs" style="color: var(--text-secondary);">None</span>',h+=`</div>
                <div class="only-print text-xs" style="display: none; white-space: normal; word-break: break-word;">
                    ${m.map(y=>y.name).join(", ")||"None"}
                </div>`;let p=u.group?"machine-group-cell grouped":"machine-group-cell individual",f=u.group||'<span style="color: var(--text-secondary); font-style: italic;">Individual</span>';d+=`
                <tr>
                    <td class="px-4 py-3 whitespace-nowrap">${u.machineNumber}</td>
                    <td class="px-4 py-3 font-medium">${u.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${p}">${f}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${u.area.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${u.cleaningSOP||""}</td>
                    <td class="px-4 py-3">${h}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center gap-x-2 no-print">
                            <button onclick="showMachineProductsModal(${u.id})" class="p-1 text-blue-500" title="Assign Products to this Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                            <button onclick="showMachineModal(${u.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                            <button onclick="deleteMachine(${u.id})" class="p-1 text-red-500" title="Delete Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg></button>
                        </div>
                    </td>
                </tr>`}),d+="</tbody></table></div></div>",l.innerHTML=d,e.appendChild(l)}),vn()}function Sn(e=null){document.getElementById("machineForm").reset();let t=document.getElementById("machineModalTitle"),n=document.getElementById("machineId"),r=document.getElementById("machineNumber"),a=document.getElementById("machineName"),s=document.getElementById("machineArea"),i=document.getElementById("cleaningSOP"),c=document.getElementById("machineStage"),l=document.getElementById("machineGroup");if(c.innerHTML='<option value="" disabled selected>Select a Stage</option>',V.forEach(d=>{let u=d==="Other"?"Other (Add New Stage)":d;c.innerHTML+=`<option value="${d}">${u}</option>`}),l.innerHTML='<option value="">No Group (Individual Machine)</option>',Ce.forEach(d=>{l.innerHTML+=`<option value="${d}">${d}</option>`}),l.innerHTML+='<option value="Other">Other (Create New Group)</option>',e){let d=M.find(u=>u.id===e);if(d){t.textContent="Edit Machine",n.value=d.id,r.value=d.machineNumber,a.value=d.name,s.value=d.area,i.value=d.cleaningSOP||"";let u=document.getElementById("otherStageContainer"),m=document.getElementById("otherMachineStage");V.filter(p=>p!=="Other").includes(d.stage)?(c.value=d.stage,u.style.display="none",m.required=!1):(c.value="Other",m.value=d.stage,u.style.display="block",m.required=!0);let g=document.getElementById("otherGroupContainer"),h=document.getElementById("otherMachineGroup");!d.group||d.group===""?(l.value="",g.style.display="none",h.required=!1):Ce.includes(d.group)?(l.value=d.group,g.style.display="none",h.required=!1):(l.value="Other",h.value=d.group,g.style.display="block",h.required=!0)}}else t.textContent="Add Machine",n.value="",document.getElementById("otherStageContainer").style.display="none",document.getElementById("otherMachineStage").required=!1,document.getElementById("otherGroupContainer").style.display="none",document.getElementById("otherMachineGroup").required=!1;document.getElementById("machineModal").style.display="flex"}function Ot(e){e.preventDefault();let o=document.getElementById("machineId").value,t=document.getElementById("machineNumber").value.trim(),n=document.getElementById("machineName").value.trim(),r=document.getElementById("machineStage").value,a=parseInt(document.getElementById("machineArea").value,10),s=document.getElementById("cleaningSOP").value.trim(),i=document.getElementById("machineGroup").value;if(r==="Other"){let l=document.getElementById("otherMachineStage").value.trim();if(!l){b("Validation Error","Please specify the new stage name.");return}if(r=l,!V.includes(r)){let d=V.indexOf("Other");d>-1?V.splice(d,0,r):V.push(r),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(V))}}if(i==="Other"){let l=document.getElementById("otherMachineGroup").value.trim();if(!l){b("Validation Error","Please specify the new group name.");return}i=l,Ce.includes(i)||(Ce.push(i),localStorage.setItem("machineGroups",JSON.stringify(Ce)))}if(i&&i!==""){let l=M.filter(d=>d.group===i&&(!o||d.id!==parseInt(o)));if(l.length>0){let d=[...new Set(l.map(u=>u.stage))];if(d.length>0&&!d.includes(r)){let u=d.join(", ");b("Group Stage Mismatch",`Cannot assign this machine to group "${i}". All machines in a group must belong to the same stage.

Current group stage(s): ${u}
New machine stage: ${r}

Please either:
\u2022 Change the machine's stage to match the group
\u2022 Choose a different group
\u2022 Create a new group for this stage`);return}}}if(!t||!n||!r||isNaN(a)||!s){b("Error","All fields are required.");return}if(M.some(l=>{let d=o?parseInt(o,10):null;return l.id!==d&&l.machineNumber.toLowerCase()===t.toLowerCase()})){b("Validation Error","A machine with this number already exists.");return}if(o){let l=M.find(d=>d.id===parseInt(o));l&&(l.machineNumber=t,l.name=n,l.stage=r,l.area=a,l.cleaningSOP=s,l.group=i||"")}else je(Xe+1),M.push({id:Xe,machineNumber:t,name:n,stage:r,area:a,cleaningSOP:s,group:i||""});F(),L(),Q("machineModal"),console.log("Saving machines to Firestore")}function Cn(e){if(confirm("Are you sure you want to delete this machine? It will be removed from all products that use it.")){let o=M.filter(t=>t.id!==e);we(o),x.forEach(t=>{t.machineIds&&(t.machineIds=t.machineIds.filter(n=>n!==e))}),F(),L()}}function Mn(e){let o=M.find(a=>a.id===e);if(!o)return;He=o;let t=document.getElementById("machineProductsModalTitle"),n=document.getElementById("machineProductsList");t.textContent=`Products on: ${o.name} (${o.machineNumber})`;let r=x.filter(a=>a.machineIds&&a.machineIds.includes(e));if(r.length>0){let a='<div class="divide-y" style="border-color: var(--border-color);">';r.forEach((s,i)=>{let c=K(s),l=c!=="N/A"?"T"+c:"N/A",d=s.isCritical?"Yes":"No",u=s.isCritical?"text-red-600 font-bold":"",m=new Date(s.date).toLocaleDateString(),g=ae(),h=0,p="N/A";s.activeIngredients.forEach(y=>{let w=_(y,g);w.rpn>h&&(h=w.rpn,p=w.rpnRatingText)});let f=se(p);a+=`
                        <div class="py-3 px-2">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-lg">${s.name}</h4>
                                <span class="text-xs px-2 py-1 rounded" style="background-color: var(--bg-accent); color: var(--text-secondary);">${s.productCode}</span>
                            </div>
                            <div class="text-xs flex flex-wrap gap-4">
                                <span ><strong>Highest RPN:</strong> <span class="${f}" style="font-weight: bold;">${h.toFixed(1)}</span></span>
                                <span><strong>Special Case Product:</strong> <span class="${u}">${d}</span></span>
                                ${s.isCritical&&s.criticalReason?`<span class="text-xs italic" style="color: var(--text-secondary);">Reason: ${s.criticalReason}</span>`:""}
                            </div>
                        </div>
                    `}),a+="</div>",n.innerHTML=a}else n.innerHTML='<p style="color:var(--text-secondary);">No products are currently assigned to this machine.</p>';document.getElementById("machineProductsModal").style.display="flex"}function To(){if(!He){console.error("No machine data available for export");return}let e=He,o=x.filter(d=>d.machineIds&&d.machineIds.includes(e.id));if(o.length===0){alert("No products to export for this machine.");return}let t=ae(),n=o.map(d=>{let u=d.isCritical?"Yes":"No",m=0;return d.activeIngredients.forEach(g=>{let h=_(g,t);h.rpn>m&&(m=h.rpn)}),{"Product Name":d.name,"Highest RPN":m.toFixed(1),"Special Case Product":u}}),r=XLSX.utils.json_to_sheet(n),a=XLSX.utils.book_new(),s=`${e.name} Products`;XLSX.utils.book_append_sheet(a,r,s);let i=Object.keys(n[0]||{}).map(d=>({wch:Math.max(d.length,...n.map(u=>String(u[d]||"").length))+2}));r["!cols"]=i;let c=new Date().toISOString().slice(0,19).replace(/[:\-T]/g,""),l=`Machine_${e.machineNumber}_Products_${c}.xlsx`;XLSX.writeFile(a,l)}function Po(){if(!He){alert("No machine selected for printing");return}try{let e=He,o=x.filter(a=>a.machineIds&&a.machineIds.includes(e.id));if(!o||o.length===0){alert("No products found for this machine");return}let t=`
            <html>
            <head>
                <title>Machine Products Report</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px;
                        font-size: 12px;
                    }
                    h1 { 
                        color: #333; 
                        border-bottom: 2px solid #ddd; 
                        padding-bottom: 10px;
                    }
                    .info-table {
                        border-collapse: collapse;
                        width: 100%;
                        margin-bottom: 20px;
                    }
                    .info-table th, .info-table td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: left;
                    }
                    .info-table th {
                        background-color: #f5f5f5;
                        font-weight: bold;
                    }
                    @media print {
                        body { margin: 0; }
                        h1 { page-break-after: avoid; }
                    }
                </style>
            </head>
            <body>
                <h1>Machine Products Report</h1>
                
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Highest RPN</th>
                            <th>Special Case</th>
                        </tr>
                    </thead>
                    <tbody>
        `;o.forEach(a=>{let s=a.isCritical?"Yes":"No",i=ae(),c=0;a.activeIngredients.forEach(l=>{let d=_(l,i);d.rpn>c&&(c=d.rpn)}),t+=`
                <tr>
                    <td>${a.name}</td>
                    <td>${c.toFixed(1)}</td>
                    <td>${s}</td>
                </tr>
            `}),t+=`
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; font-size: 10px; color: #666;">
                    Generated on: ${new Date().toLocaleString()}
                </div>
            </body>
            </html>
        `;let n=document.createElement("iframe");n.style.position="absolute",n.style.left="-9999px",n.style.width="0px",n.style.height="0px",document.body.appendChild(n);let r=n.contentWindow.document;r.write(t),r.close(),n.contentWindow.focus(),n.contentWindow.print(),setTimeout(()=>{document.body.removeChild(n)},1e3)}catch(e){console.error("Error printing machine products:",e),alert("Failed to generate print report. Please try again.")}}function In(e){let o=x.find(n=>n.id===e);if(!o)return;document.getElementById("assignMachineProductId").value=e,document.getElementById("assignMachinesModalTitle").textContent=`Assign Machines to: ${o.name}`;let t=document.getElementById("assignMachinesList");t.innerHTML="",V.forEach(n=>{let r=M.filter(a=>a.stage===n);if(n==="Mixing"?r.sort((a,s)=>{let i=a.name.toLowerCase().includes("bin"),c=s.name.toLowerCase().includes("bin");if(i&&!c)return-1;if(!i&&c)return 1;if(i&&c){let l=parseInt((a.name.match(/\d+/)||[0])[0],10),d=parseInt((s.name.match(/\d+/)||[0])[0],10);return l-d}return a.name.localeCompare(s.name)}):r.sort((a,s)=>a.name.localeCompare(s.name)),r.length>0){let a=document.createElement("div"),s=document.createElement("h4");s.className="text-sm font-bold uppercase tracking-wider pb-1 mb-2 border-b",s.style.borderColor="var(--border-color)",s.style.color="var(--text-secondary)",s.textContent=n==="Other"?"Other / Custom Stages":n,a.appendChild(s);let i=document.createElement("div");i.className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 pl-2",r.forEach(c=>{let l=o.machineIds&&o.machineIds.includes(c.id),d=document.createElement("div");d.className="flex items-center",d.innerHTML=`
                            <input type="checkbox" id="machine-check-${c.id}" value="${c.id}" ${l?"checked":""} class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="machine-check-${c.id}" class="ml-2 text-sm font-medium" style="color: var(--text-primary);">${c.name} <span class="text-xs" style="color:var(--text-secondary)">(${c.machineNumber})</span></label>
                        `,i.appendChild(d)}),a.appendChild(i),t.appendChild(a)}}),document.getElementById("assignMachinesModal").style.display="flex"}function _t(e){e.preventDefault();let o=parseInt(document.getElementById("assignMachineProductId").value),t=x.find(r=>r.id===o);if(!t)return;let n=[];document.querySelectorAll('#assignMachinesList input[type="checkbox"]:checked').forEach(r=>{n.push(parseInt(r.value))}),t.machineIds=n,F(),Q("assignMachinesModal"),L(),b("Success","Product machines updated successfully.")}function En(e){let o=M.find(a=>a.id===e);if(!o)return;document.getElementById("addProductsMachineId").value=e,document.getElementById("addProductsToMachineModalTitle").textContent=`Assign Products to: ${o.name}`;let t=document.getElementById("addProductsToMachineList"),n=document.getElementById("noAvailableProductsMessage"),r=document.getElementById("addProductsToMachineSaveBtn");t.innerHTML="",x.length>0?(n.style.display="none",t.style.display="block",r.style.display="block",x.sort((a,s)=>a.name.localeCompare(s.name)).forEach(a=>{let s=a.machineIds&&a.machineIds.includes(e),i=a.machineIds&&a.machineIds.some(d=>d!==e),c="";i&&(c='<span class="ml-auto text-xs font-semibold px-1.5 py-0.5 rounded" style="background-color: var(--bg-accent); color: var(--text-secondary);" title="This product is also assigned to other machines.">Linked</span>');let l=document.createElement("div");l.className="flex items-center",l.innerHTML=`
                        <input type="checkbox" id="product-assign-check-${a.id}" value="${a.id}" ${s?"checked":""} class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="product-assign-check-${a.id}" class="ml-3 flex-1 flex items-center text-sm font-medium" style="color: var(--text-primary);">
                            <span>${a.name} <span class="text-xs" style="color:var(--text-secondary)">(${a.productCode})</span></span>
                            ${c}
                        </label>
                    `,t.appendChild(l)})):(n.textContent="There are no products registered in the system.",n.style.display="block",t.style.display="none",r.style.display="none"),document.getElementById("addProductsToMachineModal").style.display="flex"}function Ht(e){e.preventDefault();let o=parseInt(document.getElementById("addProductsMachineId").value);if(isNaN(o))return;let t=[];document.querySelectorAll('#addProductsToMachineList input[type="checkbox"]:checked').forEach(n=>{t.push(parseInt(n.value))}),x.forEach(n=>{n.machineIds||(n.machineIds=[]);let r=n.machineIds.includes(o),a=t.includes(n.id);a&&!r?n.machineIds.push(o):!a&&r&&(n.machineIds=n.machineIds.filter(s=>s!==o))}),F(),L(),Q("addProductsToMachineModal"),b("Success","Machine assignments updated.")}var He,ko=G(()=>{X();Ne();W();$();He=null;window.exportMachineProductsToExcel=To;window.printMachineProducts=Po});var qt={};Z(qt,{renderSummaryReport:()=>dt});function dt(){let e=document.getElementById("topRpnTableBody"),o=document.getElementById("criticalProductsTableBody"),t=document.getElementById("topRpnTableContainer"),n=document.getElementById("criticalProductsTableContainer"),r=document.getElementById("noTopRpnMessage"),a=document.getElementById("noCriticalMessage");e.innerHTML="",o.innerHTML="";let s=x.flatMap(c=>{let l=K(c);return c.activeIngredients.map(d=>({productName:c.name,ingredientName:d.name,rpn:_(d).rpn,trainId:l!=="N/A"?`T${l}`:""}))}).sort((c,l)=>l.rpn-c.rpn).slice(0,10);s.length>0?(r.style.display="none",t.style.display="block",s.forEach((c,l)=>{let d=e.insertRow();d.innerHTML=`<td class="px-4 py-3">${l+1}</td><td class="px-4 py-3">${c.productName}</td><td class="px-4 py-3">${c.trainId||"N/A"}</td><td class="px-4 py-3">${c.ingredientName}</td><td class="px-4 py-3 font-bold" style="color: var(--gradient-mid);">${c.rpn}</td>`})):(r.style.display="block",t.style.display="none");let i=x.filter(c=>c.isCritical);i.length>0?(a.style.display="none",n.style.display="block",i.forEach(c=>{let l=o.insertRow();l.innerHTML=`<td class="px-4 py-3">${c.name}</td><td class="px-4 py-3" style="white-space: pre-wrap; word-break: break-word;">${c.criticalReason||"No reason provided"}</td>`})):(a.style.display="block",n.style.display="none")}var Do=G(()=>{X();$()});function $o(){document.querySelectorAll("#maco-product-trains-container .train-container").forEach(o=>{if(o.querySelector(".print-train-btn"))return;let t=o.id,n=document.createElement("button");n.textContent="Print Train",n.className="btn print-train-btn",n.style.margin="10px",n.onclick=()=>zt(t);let r=o.querySelector(".train-details");r&&r.appendChild(n)})}function zt(e){if(!document.getElementById(e)){console.error("Could not find train content to print:",e);return}document.body.classList.add("printing-maco-train"),setTimeout(()=>{window.print()},100)}function L(){try{$e(),Pe("productRegister"),Le("worstCaseProducts"),Ve(),Ye(),Re(),$o(),Se(),Fe(),dt(),Je(),Bt()}catch(e){console.error("Error during full application render:",e),S()}}function Ao(e,o){Kt(e),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active-tab-content")),document.getElementById(e).classList.add("active-tab-content"),document.querySelectorAll(".tab-button").forEach(t=>t.classList.remove("active-tab")),o.classList.add("active-tab"),e==="dashboard"&&Ye(),e==="summaryReport"&&dt(),e==="trainSummary"&&at(),e==="machineManagement"&&Ve(),e==="macoForTrains"&&(Re(),$o()),e==="detergentMaco"&&Se(),(e==="productRegister"||e==="worstCaseProducts")&&Pe(e)}function Tn(){R();try{let e=localStorage.getItem("orgId")||prompt("Enter your organization ID:"),o=localStorage.getItem("userId")||prompt("Enter your user ID:");if(e||(e="defaultOrg"),o||(o="defaultUser"),localStorage.setItem("orgId",e),localStorage.setItem("userId",o),window.orgId=e,window.userId=o,localStorage.getItem("theme")==="dark"?_e(!0):_e(!1),it(),x.length>0){We(Math.max(0,...x.map(n=>n.id))+1);let t=x.flatMap(n=>n.activeIngredients.map(r=>r.id));De(t.length>0?Math.max(0,...t)+1:1)}M.length>0&&je(Math.max(0,...M.map(t=>t.id))+1),A.length>0&&Me(Math.max(0,...A.map(t=>t.id))+1),x.forEach(t=>{t.isCritical===void 0&&(t.isCritical=!1)}),F(),L(),te("productRegister"),ee(!1),S()}catch(e){console.error("Error during application initialization:",e),S()}}var Ne=G(()=>{X();W();$();Eo();ko();he();It();nt();Ct();Do();Pt();bt();window.changeTab=Ao;window.printTrain=zt;document.addEventListener("DOMContentLoaded",function(){window.changeTab=Ao,window.printTrain=zt,window.saveAllDataToLocalStorage=Te,window.loadAllDataFromLocalStorage=it,window.handleSearchAndFilter=function(s){s==="worstCaseProducts"?Le(s):Pe(s)},window.sortData=function(s,i){i==="worstCaseProducts"?Ze(s,i):$t(s,i)};let{printReport:e,...o}=tt,{handleSearchAndFilter:t,...n}=Ft,{handleSearchAndFilter:r,...a}=Ee;Object.assign(window,ce,U,n,Vt,a,o,Oe,St,qt,st,xt),document.getElementById("theme-toggle").addEventListener("click",()=>{let s=document.documentElement.classList.contains("dark");_e(!s),localStorage.setItem("theme",s?"light":"dark")}),window.addEventListener("beforeprint",()=>{window.printingView=null,document.body.classList.contains("printing-worstCaseProducts")?window.printingView="worstCaseProducts":document.body.classList.contains("printing-macoForTrains")?window.printingView="macoForTrains":document.body.classList.contains("printing-trainSummary")&&(window.printingView="trainSummary")}),window.addEventListener("afterprint",()=>{let s=document.body.classList.contains("printing-worstCaseProducts"),i=document.body.classList.contains("printing-macoForTrains"),c=document.body.classList.contains("printing-trainSummary");document.body.className=document.body.className.replace(/printing-[\w-]+/g,""),mt&&(ee(!0),Ke(!1)),(s||i||c)&&(R(),window.printSelectedTrain=null,s?ge():i?Re():c&&at()),window.printingView=null}),window.addEventListener("focus",()=>{window.printingView&&!document.body.className.includes("printing-")&&setTimeout(()=>{window.printingView&&!document.body.className.includes("printing-")&&(S(),window.printSelectedTrain=null,window.printingView=null)},500)}),document.addEventListener("keydown",function(s){s.ctrlKey&&s.key==="z"&&(s.preventDefault(),kt()),s.ctrlKey&&s.key==="y"&&(s.preventDefault(),Dt())}),document.addEventListener("input",function(s){s.target.matches(".filterColProductCode, .filterColProductName")&&handleSearchAndFilter("productRegister"),s.target.matches("#worstCaseProductNameFilter")&&wt()}),document.addEventListener("change",function(s){s.target.matches(".filterColTrainNo, .filterColProductType, .filterColIsCritical")&&handleSearchAndFilter("productRegister")}),document.getElementById("addProductForm").addEventListener("submit",Rt),document.getElementById("editProductForm").addEventListener("submit",Nt),document.getElementById("editIngredientForm").addEventListener("submit",Lt),document.getElementById("machineForm").addEventListener("submit",Ot),document.getElementById("assignMachinesForm").addEventListener("submit",_t),document.getElementById("addProductsToMachineForm").addEventListener("submit",Ht),document.getElementById("customAlertButton").onclick=()=>Q("customAlertModal"),document.getElementById("editScoringBtn").addEventListener("click",()=>ee(!oe)),Tn()})});Ne();})();
