(()=>{var Jm=Object.defineProperty;var ne=(n,e)=>()=>(n&&(e=n(n=0)),e);var Ge=(n,e)=>{for(var t in e)Jm(n,t,{get:e[t],enumerable:!0})};function dt(n){B=n}function Ot(n){Q=n}function ht(n){ce=n}function Ft(n){re=n}function Ps(n){As=n}function br(n){tn=n}function Ds(n){Cs=n}function Tn(n){Ss=n}function Ou(n){Vt=n}function Fu(n){Lt=n}function Bu(n){ct=n}function $u(n){Ue=n}function qu(n){Ym=n}function Rs(n,e){lt=n,ut=e}function vo(n){ke=n}function Ns(n){bo=n}function Eo(n){_o=n}var B,Q,ke,xn,ce,Ss,le,wo,Me,As,tn,Cs,_o,Vt,Lt,ct,ue,Ue,Ym,nn,lt,ut,re,bo,Fe=ne(()=>{B=[{id:1,productCode:"1ATC50001AP",name:"Acetaminophen 500mg",batchSizeKg:51.08,date:"2023-01-15T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,2,6,11,13,16],activeIngredients:[{id:1,name:"Acetaminophen",therapeuticDose:500,mdd:4e3,solubility:"Freely soluble",cleanability:"Easy",pde:12.5,ld50:1944}]},{id:2,productCode:"2IBU20011PN",name:"Ibuprofen 200mg",batchSizeKg:113.51,date:"2023-02-20T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,3,5,12,16],activeIngredients:[{id:2,name:"Ibuprofen",therapeuticDose:200,mdd:1200,solubility:"Practically insoluble",cleanability:"Medium",pde:1.2,ld50:636}]},{id:3,productCode:"3CFR18003MX",name:"Cold & Flu Relief",batchSizeKg:180,date:"2023-03-10T10:00:00.000Z",isCritical:!0,criticalReason:"Stains equipment yellow",productType:"Tablets",machineIds:[1,2,6,11,13,16],activeIngredients:[{id:3,name:"Acetaminophen",therapeuticDose:650,mdd:3900,solubility:"Freely soluble",cleanability:"Easy",pde:12.5,ld50:1944},{id:4,name:"Phenylephrine HCl",therapeuticDose:10,mdd:60,solubility:"Very soluble",cleanability:"Easy",pde:.6,ld50:350},{id:5,name:"Dextromethorphan HBr",therapeuticDose:30,mdd:120,solubility:"Slightly soluble",cleanability:"Medium",pde:1,ld50:750}]},{id:4,productCode:"4ASA32504AC",name:"Aspirin 325mg",batchSizeKg:75.5,date:"2023-04-05T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Tablets",machineIds:[1,4,7,12,16],activeIngredients:[{id:6,name:"Aspirin",therapeuticDose:325,mdd:4e3,solubility:"Slightly soluble",cleanability:"Medium",pde:.5,ld50:null}]},{id:5,productCode:"5OME02005PR",name:"Omeprazole 20mg",batchSizeKg:25.2,date:"2023-05-25T10:00:00.000Z",isCritical:!0,criticalReason:"New API",productType:"Capsules",machineIds:[1,5,9,14,15],activeIngredients:[{id:7,name:"Omeprazole",therapeuticDose:20,mdd:40,solubility:"Practically insoluble",cleanability:"Hard",pde:.013,ld50:null}]},{id:6,productCode:"6PCX00506XP",name:"Potent Compound X",batchSizeKg:5,date:"2023-06-30T10:00:00.000Z",isCritical:!1,criticalReason:"",productType:"Sterile Products",machineIds:[1,5,10,14,15],activeIngredients:[{id:8,name:"Potent Compound X",therapeuticDose:1,mdd:2,solubility:"Slightly soluble",cleanability:"Hard",pde:5e-4,ld50:25}]}],Q=[{id:1,machineNumber:"M-001",name:"weighing tool",stage:"Weighing",area:55e3,group:""},{id:2,machineNumber:"M-002",name:"nin mill",stage:"Milling",area:35e3,group:""},{id:3,machineNumber:"M-003",name:"fitz mill",stage:"Milling",area:42e3,group:""},{id:4,machineNumber:"M-004",name:"FBD",stage:"Mixing",area:12e4,group:""},{id:5,machineNumber:"M-005",name:"Glatt",stage:"Mixing",area:95e3,group:""},{id:6,machineNumber:"M-006",name:"Compactor",stage:"Mixing",area:85e3,group:""},{id:7,machineNumber:"M-007",name:"Bin 200",stage:"Mixing",area:45e3,group:"Mixing Bins"},{id:8,machineNumber:"M-008",name:"Bin 400",stage:"Mixing",area:65e3,group:"Mixing Bins"},{id:9,machineNumber:"M-009",name:"Bin 600",stage:"Mixing",area:85e3,group:"Mixing Bins"},{id:10,machineNumber:"M-010",name:"Bin 800",stage:"Mixing",area:105e3,group:"Mixing Bins"},{id:11,machineNumber:"M-011",name:"Jcmco",stage:"Compression",area:15e4,group:"Compression Machines"},{id:12,machineNumber:"M-012",name:"Natoli",stage:"Compression",area:165e3,group:"Compression Machines"},{id:13,machineNumber:"M-013",name:"Korsch",stage:"Compression",area:18e4,group:"Compression Machines"},{id:14,machineNumber:"M-014",name:"Coat",stage:"Coating",area:11e4,group:""},{id:15,machineNumber:"M-015",name:"jar filling",stage:"Filling",area:75e3,group:""},{id:16,machineNumber:"M-016",name:"Bliste",stage:"Packing",area:22e4,group:""}],ke=["Weighing","Mixing","Milling","Compression","Coating","Filling","Packing","Other"],xn=["Mixing Bins","Compression Machines","Milling Equipment","Granulators","Coating Equipment","Packaging Equipment","Weighing Equipment","Filling Equipment"],ce=[{id:1,name:"Default Detergent",ld50:5e3}],Ss=2,le={"Sterile Products":{min:1e3,max:1e4,route:"Sterile"},Semisolids:{min:10,max:100,route:"Topical"},Tablets:{min:100,max:1e3,route:"Oral"},Capsules:{min:100,max:1e3,route:"Oral"},Liquids:{min:100,max:1e3,route:"Oral"},Other:{min:100,max:1e3,route:"Oral"}},wo=["Sterile Products","Semisolids","Tablets","Capsules","Liquids","Other"],Me={productRegister:[],worstCaseProducts:[]},As=B.length>0?Math.max(...B.map(n=>n.id))+1:1,tn=B.length>0?Math.max(...B.flatMap(n=>n.activeIngredients.map(e=>e.id)))+1:1,Cs=Q.length>0?Math.max(...Q.map(n=>n.id))+1:1,_o=0,ct=!1,ue={key:"rpn",direction:"desc"},Ue={key:"name",direction:"asc"},Ym="dashboard",nn=new Map,lt=[],ut=-1,re={solubility:{title:"Solubility Rating",defaultScore:3,type:"exactMatch",criteria:[{text:"Very soluble",score:1},{text:"Freely soluble",score:2},{text:"Soluble",score:3},{text:"Sparingly soluble",score:4},{text:"Slightly soluble",score:5},{text:"Very slightly soluble",score:6},{text:"Practically insoluble",score:7},{text:"Insoluble",score:7}]},therapeuticDose:{title:"Therapeutic Dose Rating",defaultScore:3,type:"range",criteria:[{text:">1000 mg",score:1,lowerBound:1e3,comparison:"greater_exclusive"},{text:"100-1000 mg",score:2,lowerBound:100,upperBound:1e3,comparison:"between_inclusive_both"},{text:"10-99 mg",score:3,lowerBound:10,upperBound:99,comparison:"between_inclusive_both"},{text:"1-9 mg",score:4,lowerBound:1,upperBound:9,comparison:"between_inclusive_both"},{text:"<1 mg",score:5,upperBound:1,comparison:"less_exclusive"}]},cleanability:{title:"Cleanability Rating",defaultScore:2,type:"exactMatch",criteria:[{text:"Easy",score:1},{text:"Medium",score:2},{text:"Hard",score:3}]},toxicityLd50:{title:"Toxicity Rating (LD50)",defaultScore:3,type:"range",criteria:[{text:">5000 mg/kg",score:1,lowerBound:5e3,comparison:"greater_exclusive"},{text:"500-5000 mg/kg",score:2,lowerBound:500,upperBound:5e3,comparison:"between_inclusive_both"},{text:"50-499 mg/kg",score:3,lowerBound:50,upperBound:499,comparison:"between_inclusive_both"},{text:"1-49 mg/kg",score:4,lowerBound:1,upperBound:49,comparison:"between_inclusive_both"},{text:"<1 mg/kg",score:5,upperBound:1,comparison:"less_exclusive"}]},toxicityPde:{title:"PDE Rating (mg/day)",defaultScore:3,type:"range",criteria:[{text:"\u2264 0.001",score:10,upperBound:.001,comparison:"less_inclusive"},{text:">0.001 \u2013 \u22640.01",score:9,lowerBound:.001,upperBound:.01,comparison:"between_exclusive_lower_inclusive_upper"},{text:">0.01 \u2013 \u22640.1",score:8,lowerBound:.01,upperBound:.1,comparison:"between_exclusive_lower_inclusive_upper"},{text:">0.1 \u2013 \u22641",score:7,lowerBound:.1,upperBound:1,comparison:"between_exclusive_lower_inclusive_upper"},{text:">1 \u2013 \u226410",score:6,lowerBound:1,upperBound:10,comparison:"between_exclusive_lower_inclusive_upper"},{text:">10 \u2013 \u2264100",score:5,lowerBound:10,upperBound:100,comparison:"between_exclusive_lower_inclusive_upper"},{text:">100 \u2013 \u22641000",score:4,lowerBound:100,upperBound:1e3,comparison:"between_exclusive_lower_inclusive_upper"},{text:">1000",score:3,lowerBound:1e3,comparison:"greater_exclusive"}]},rpnRating:{title:"RPN Rating",type:"rpn_threshold",criteria:[{rangeDescription:"1-20",rating:"Low",min:1,max:20},{rangeDescription:"21-50",rating:"Medium",min:21,max:50},{rangeDescription:"51 and more",rating:"High",min:51,max:1/0}]}},bo=!1});var Uu,zu=ne(()=>{Uu=()=>{}});function Qu(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}function Ms(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Ju(n){return(await fetch(n,{credentials:"include"})).ok}function Yu(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');let t={alg:"none",type:"JWT"},r=e||"demo-project",s=n.iat||0,o=n.sub||n.user_id;if(!o)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");let a={iss:`https://securetoken.google.com/${r}`,aud:r,iat:s,exp:s+3600,auth_time:s,sub:o,user_id:o,firebase:{sign_in_provider:"custom",identities:{}},...n};return[Er(JSON.stringify(t)),Er(JSON.stringify(a)),""].join(".")}function of(){let n={prod:[],emulator:[]};for(let e of Object.keys(vr))vr[e]?n.emulator.push(e):n.prod.push(e);return n}function af(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}function Zu(n,e){if(typeof window>"u"||typeof document>"u"||!Ms(window.location.host)||vr[n]===e||vr[n]||ju)return;vr[n]=e;function t(g){return`__firebase__banner__${g}`}let r="__firebase__banner",o=of().prod.length>0;function a(){let g=document.getElementById(r);g&&g.remove()}function c(g){g.style.display="flex",g.style.background="#7faaf0",g.style.position="fixed",g.style.bottom="5px",g.style.left="5px",g.style.padding=".5em",g.style.borderRadius="5px",g.style.alignItems="center"}function u(g,b){g.setAttribute("width","24"),g.setAttribute("id",b),g.setAttribute("height","24"),g.setAttribute("viewBox","0 0 24 24"),g.setAttribute("fill","none"),g.style.marginLeft="-6px"}function d(){let g=document.createElement("span");return g.style.cursor="pointer",g.style.marginLeft="16px",g.style.fontSize="24px",g.innerHTML=" &times;",g.onclick=()=>{ju=!0,a()},g}function p(g,b){g.setAttribute("id",b),g.innerText="Learn more",g.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",g.setAttribute("target","__blank"),g.style.paddingLeft="5px",g.style.textDecoration="underline"}function m(){let g=af(r),b=t("text"),S=document.getElementById(b)||document.createElement("span"),v=t("learnmore"),C=document.getElementById(v)||document.createElement("a"),D=t("preprendIcon"),k=document.getElementById(D)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(g.created){let L=g.element;c(L),p(C,v);let H=d();u(k,D),L.append(k,S,C,H),document.body.appendChild(L)}o?(S.innerText="Preview backend disconnected.",k.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(k.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,S.innerText="Preview backend running in this workspace."),S.setAttribute("id",b)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",m):m()}function ed(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function cf(){let n=xo()?.forceEnvironment;if(n==="node")return!0;if(n==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function td(){return!cf()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function So(){try{return typeof indexedDB=="object"}catch{return!1}}function nd(){return new Promise((n,e)=>{try{let t=!0,r="validate-browser-context-for-indexeddb-analytics-module",s=self.indexedDB.open(r);s.onsuccess=()=>{s.result.close(),t||self.indexedDB.deleteDatabase(r),n(!0)},s.onupgradeneeded=()=>{t=!1},s.onerror=()=>{e(s.error?.message||"")}}catch(t){e(t)}})}function uf(n,e){return n.replace(df,(t,r)=>{let s=e[r];return s!=null?String(s):`<${r}?>`})}function Sn(n,e){if(n===e)return!0;let t=Object.keys(n),r=Object.keys(e);for(let s of t){if(!r.includes(s))return!1;let o=n[s],a=e[s];if(Gu(o)&&Gu(a)){if(!Sn(o,a))return!1}else if(o!==a)return!1}for(let s of r)if(!t.includes(s))return!1;return!0}function Gu(n){return n!==null&&typeof n=="object"}function xr(n){return n&&n._delegate?n._delegate:n}var Hu,Zm,Ku,Io,ef,Er,Wu,tf,nf,rf,xo,sf,Xu,To,ks,vr,ju,lf,pt,Ir,df,Ew,Tr=ne(()=>{zu();Hu=function(n){let e=[],t=0;for(let r=0;r<n.length;r++){let s=n.charCodeAt(r);s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&r+1<n.length&&(n.charCodeAt(r+1)&64512)===56320?(s=65536+((s&1023)<<10)+(n.charCodeAt(++r)&1023),e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128)}return e},Zm=function(n){let e=[],t=0,r=0;for(;t<n.length;){let s=n[t++];if(s<128)e[r++]=String.fromCharCode(s);else if(s>191&&s<224){let o=n[t++];e[r++]=String.fromCharCode((s&31)<<6|o&63)}else if(s>239&&s<365){let o=n[t++],a=n[t++],c=n[t++],u=((s&7)<<18|(o&63)<<12|(a&63)<<6|c&63)-65536;e[r++]=String.fromCharCode(55296+(u>>10)),e[r++]=String.fromCharCode(56320+(u&1023))}else{let o=n[t++],a=n[t++];e[r++]=String.fromCharCode((s&15)<<12|(o&63)<<6|a&63)}}return e.join("")},Ku={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();let t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let s=0;s<n.length;s+=3){let o=n[s],a=s+1<n.length,c=a?n[s+1]:0,u=s+2<n.length,d=u?n[s+2]:0,p=o>>2,m=(o&3)<<4|c>>4,g=(c&15)<<2|d>>6,b=d&63;u||(b=64,a||(g=64)),r.push(t[p],t[m],t[g],t[b])}return r.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Hu(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Zm(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();let t=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let s=0;s<n.length;){let o=t[n.charAt(s++)],c=s<n.length?t[n.charAt(s)]:0;++s;let d=s<n.length?t[n.charAt(s)]:64;++s;let m=s<n.length?t[n.charAt(s)]:64;if(++s,o==null||c==null||d==null||m==null)throw new Io;let g=o<<2|c>>4;if(r.push(g),d!==64){let b=c<<4&240|d>>2;if(r.push(b),m!==64){let S=d<<6&192|m;r.push(S)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}},Io=class extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}},ef=function(n){let e=Hu(n);return Ku.encodeByteArray(e,!0)},Er=function(n){return ef(n).replace(/\./g,"")},Wu=function(n){try{return Ku.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};tf=()=>Qu().__FIREBASE_DEFAULTS__,nf=()=>{if(typeof process>"u"||typeof process.env>"u")return;let n=process.env.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},rf=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}let e=n&&Wu(n[1]);return e&&JSON.parse(e)},xo=()=>{try{return Uu()||tf()||nf()||rf()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},sf=n=>xo()?.emulatorHosts?.[n],Xu=n=>{let e=sf(n);if(!e)return;let t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);let r=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),r]:[e.substring(0,t),r]},To=()=>xo()?.config;ks=class{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,r)=>{t?this.reject(t):this.resolve(r),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,r))}}};vr={};ju=!1;lf="FirebaseError",pt=class n extends Error{constructor(e,t,r){super(t),this.code=e,this.customData=r,this.name=lf,Object.setPrototypeOf(this,n.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Ir.prototype.create)}},Ir=class{constructor(e,t,r){this.service=e,this.serviceName=t,this.errors=r}create(e,...t){let r=t[0]||{},s=`${this.service}/${e}`,o=this.errors[e],a=o?uf(o,r):"Error",c=`${this.serviceName}: ${a} (${s}).`;return new pt(s,c,r)}};df=/\{\$([^}]+)}/g;Ew=4*60*60*1e3;});function hf(n){return n===rn?void 0:n}function pf(n){return n.instantiationMode==="EAGER"}var mt,rn,Ao,Vs,Co=ne(()=>{Tr();mt=class{constructor(e,t,r){this.name=e,this.instanceFactory=t,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}};rn="[DEFAULT]";Ao=class{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){let t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){let r=new ks;if(this.instancesDeferred.set(t,r),this.isInitialized(t)||this.shouldAutoInitialize())try{let s=this.getOrInitializeService({instanceIdentifier:t});s&&r.resolve(s)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){let t=this.normalizeInstanceIdentifier(e?.identifier),r=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(s){if(r)return null;throw s}else{if(r)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(pf(e))try{this.getOrInitializeService({instanceIdentifier:rn})}catch{}for(let[t,r]of this.instancesDeferred.entries()){let s=this.normalizeInstanceIdentifier(t);try{let o=this.getOrInitializeService({instanceIdentifier:s});r.resolve(o)}catch{}}}}clearInstance(e=rn){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){let e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=rn){return this.instances.has(e)}getOptions(e=rn){return this.instancesOptions.get(e)||{}}initialize(e={}){let{options:t={}}=e,r=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(r))throw Error(`${this.name}(${r}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);let s=this.getOrInitializeService({instanceIdentifier:r,options:t});for(let[o,a]of this.instancesDeferred.entries()){let c=this.normalizeInstanceIdentifier(o);r===c&&a.resolve(s)}return s}onInit(e,t){let r=this.normalizeInstanceIdentifier(t),s=this.onInitCallbacks.get(r)??new Set;s.add(e),this.onInitCallbacks.set(r,s);let o=this.instances.get(r);return o&&e(o,r),()=>{s.delete(e)}}invokeOnInitCallbacks(e,t){let r=this.onInitCallbacks.get(t);if(r)for(let s of r)try{s(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let r=this.instances.get(e);if(!r&&this.component&&(r=this.component.instanceFactory(this.container,{instanceIdentifier:hf(e),options:t}),this.instances.set(e,r),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(r,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,r)}catch{}return r||null}normalizeInstanceIdentifier(e=rn){return this.component?this.component.multipleInstances?e:rn:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}};Vs=class{constructor(e){this.name=e,this.providers=new Map}addComponent(e){let t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);let t=new Ao(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}});var mf,Y,ff,gf,yf,wf,An,Po=ne(()=>{mf=[];(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(Y||(Y={}));ff={debug:Y.DEBUG,verbose:Y.VERBOSE,info:Y.INFO,warn:Y.WARN,error:Y.ERROR,silent:Y.SILENT},gf=Y.INFO,yf={[Y.DEBUG]:"log",[Y.VERBOSE]:"log",[Y.INFO]:"info",[Y.WARN]:"warn",[Y.ERROR]:"error"},wf=(n,e,...t)=>{if(e<n.logLevel)return;let r=new Date().toISOString(),s=yf[e];if(s)console[s](`[${r}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)},An=class{constructor(e){this.name=e,this._logLevel=gf,this._logHandler=wf,this._userLogHandler=null,mf.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in Y))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?ff[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,Y.DEBUG,...e),this._logHandler(this,Y.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,Y.VERBOSE,...e),this._logHandler(this,Y.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,Y.INFO,...e),this._logHandler(this,Y.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,Y.WARN,...e),this._logHandler(this,Y.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,Y.ERROR,...e),this._logHandler(this,Y.ERROR,...e)}}});function bf(){return rd||(rd=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function vf(){return sd||(sd=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function Ef(n){let e=new Promise((t,r)=>{let s=()=>{n.removeEventListener("success",o),n.removeEventListener("error",a)},o=()=>{t(Ye(n.result)),s()},a=()=>{r(n.error),s()};n.addEventListener("success",o),n.addEventListener("error",a)});return e.then(t=>{t instanceof IDBCursor&&id.set(t,n)}).catch(()=>{}),ko.set(e,n),e}function If(n){if(Ro.has(n))return;let e=new Promise((t,r)=>{let s=()=>{n.removeEventListener("complete",o),n.removeEventListener("error",a),n.removeEventListener("abort",a)},o=()=>{t(),s()},a=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",o),n.addEventListener("error",a),n.addEventListener("abort",a)});Ro.set(n,e)}function ad(n){No=n(No)}function xf(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){let r=n.call(Ls(this),e,...t);return od.set(r,e.sort?e.sort():[e]),Ye(r)}:vf().includes(n)?function(...e){return n.apply(Ls(this),e),Ye(id.get(this))}:function(...e){return Ye(n.apply(Ls(this),e))}}function Tf(n){return typeof n=="function"?xf(n):(n instanceof IDBTransaction&&If(n),_f(n,bf())?new Proxy(n,No):n)}function Ye(n){if(n instanceof IDBRequest)return Ef(n);if(Do.has(n))return Do.get(n);let e=Tf(n);return e!==n&&(Do.set(n,e),ko.set(e,n)),e}var _f,rd,sd,id,Ro,od,Do,ko,No,Ls,Mo=ne(()=>{_f=(n,e)=>e.some(t=>n instanceof t);id=new WeakMap,Ro=new WeakMap,od=new WeakMap,Do=new WeakMap,ko=new WeakMap;No={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Ro.get(n);if(e==="objectStoreNames")return n.objectStoreNames||od.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Ye(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};Ls=n=>ko.get(n)});function ld(n,e,{blocked:t,upgrade:r,blocking:s,terminated:o}={}){let a=indexedDB.open(n,e),c=Ye(a);return r&&a.addEventListener("upgradeneeded",u=>{r(Ye(a.result),u.oldVersion,u.newVersion,Ye(a.transaction),u)}),t&&a.addEventListener("blocked",u=>t(u.oldVersion,u.newVersion,u)),c.then(u=>{o&&u.addEventListener("close",()=>o()),s&&u.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}function cd(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(Vo.get(e))return Vo.get(e);let t=e.replace(/FromIndex$/,""),r=e!==t,s=Af.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Sf.includes(t)))return;let o=async function(a,...c){let u=this.transaction(a,s?"readwrite":"readonly"),d=u.store;return r&&(d=d.index(c.shift())),(await Promise.all([d[t](...c),s&&u.done]))[0]};return Vo.set(e,o),o}var Sf,Af,Vo,ud=ne(()=>{Mo();Mo();Sf=["get","getKey","getAll","getAllKeys","count"],Af=["put","add","delete","clear"],Vo=new Map;ad(n=>({...n,get:(e,t,r)=>cd(e,t)||n.get(e,t,r),has:(e,t)=>!!cd(e,t)||n.has(e,t)}))});function Cf(n){return n.getComponent()?.type==="VERSION"}function hd(n,e){try{n.container.addComponent(e)}catch(t){ft.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Sr(n){let e=n.name;if($o.has(e))return ft.debug(`There were multiple attempts to register component ${e}.`),!1;$o.set(e,n);for(let t of Os.values())hd(t,n);for(let t of rg.values())hd(t,n);return!0}function gd(n,e){let t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function yd(n){return n==null?!1:n.settings!==void 0}function jo(n,e={}){let t=n;typeof e!="object"&&(e={name:e});let r={name:Bo,automaticDataCollectionEnabled:!0,...e},s=r.name;if(typeof s!="string"||!s)throw Bt.create("bad-app-name",{appName:String(s)});if(t||(t=To()),!t)throw Bt.create("no-options");let o=Os.get(s);if(o){if(Sn(t,o.options)&&Sn(r,o.config))return o;throw Bt.create("duplicate-app",{appName:s})}let a=new Vs(s);for(let u of $o.values())a.addComponent(u);let c=new qo(t,r,a);return Os.set(s,c),c}function _d(n=Bo){let e=Os.get(n);if(!e&&n===Bo&&To())return jo();if(!e)throw Bt.create("no-app",{appName:n});return e}function $t(n,e,t){let r=ng[n]??n;t&&(r+=`-${t}`);let s=r.match(/\s|\//),o=e.match(/\s|\//);if(s||o){let a=[`Unable to register library "${r}" with version "${e}":`];s&&a.push(`library name "${r}" contains illegal characters (whitespace or "/")`),s&&o&&a.push("and"),o&&a.push(`version name "${e}" contains illegal characters (whitespace or "/")`),ft.warn(a.join(" "));return}Sr(new mt(`${r}-version`,()=>({library:r,version:e}),"VERSION"))}function bd(){return Lo||(Lo=ld(ig,og,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(Ar)}catch(t){console.warn(t)}}}}).catch(n=>{throw Bt.create("idb-open",{originalErrorMessage:n.message})})),Lo}async function ag(n){try{let t=(await bd()).transaction(Ar),r=await t.objectStore(Ar).get(vd(n));return await t.done,r}catch(e){if(e instanceof pt)ft.warn(e.message);else{let t=Bt.create("idb-get",{originalErrorMessage:e?.message});ft.warn(t.message)}}}async function pd(n,e){try{let r=(await bd()).transaction(Ar,"readwrite");await r.objectStore(Ar).put(e,vd(n)),await r.done}catch(t){if(t instanceof pt)ft.warn(t.message);else{let r=Bt.create("idb-set",{originalErrorMessage:t?.message});ft.warn(r.message)}}}function vd(n){return`${n.name}!${n.options.appId}`}function md(){return new Date().toISOString().substring(0,10)}function ug(n,e=cg){let t=[],r=n.slice();for(let s of n){let o=t.find(a=>a.agent===s.agent);if(o){if(o.dates.push(s.date),fd(t)>e){o.dates.pop();break}}else if(t.push({agent:s.agent,dates:[s.date]}),fd(t)>e){t.pop();break}r=r.slice(1)}return{heartbeatsToSend:t,unsentEntries:r}}function fd(n){return Er(JSON.stringify({version:2,heartbeats:n})).length}function dg(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let r=1;r<n.length;r++)n[r].date<t&&(t=n[r].date,e=r);return e}function hg(n){Sr(new mt("platform-logger",e=>new Oo(e),"PRIVATE")),Sr(new mt("heartbeat",e=>new Uo(e),"PRIVATE")),$t(Fo,dd,n),$t(Fo,dd,"esm2020"),$t("fire-js","")}var Oo,Fo,dd,ft,Pf,Df,Rf,Nf,kf,Mf,Vf,Lf,Of,Ff,Bf,$f,qf,Uf,zf,jf,Gf,Hf,Kf,Wf,Qf,Xf,Jf,Yf,Zf,eg,tg,Bo,ng,Os,rg,$o,sg,Bt,qo,wd,ig,og,Ar,Lo,cg,lg,Uo,zo,Fs=ne(()=>{Co();Po();Tr();Tr();ud();Oo=class{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(Cf(t)){let r=t.getImmediate();return`${r.library}/${r.version}`}else return null}).filter(t=>t).join(" ")}};Fo="@firebase/app",dd="0.14.3";ft=new An("@firebase/app"),Pf="@firebase/app-compat",Df="@firebase/analytics-compat",Rf="@firebase/analytics",Nf="@firebase/app-check-compat",kf="@firebase/app-check",Mf="@firebase/auth",Vf="@firebase/auth-compat",Lf="@firebase/database",Of="@firebase/data-connect",Ff="@firebase/database-compat",Bf="@firebase/functions",$f="@firebase/functions-compat",qf="@firebase/installations",Uf="@firebase/installations-compat",zf="@firebase/messaging",jf="@firebase/messaging-compat",Gf="@firebase/performance",Hf="@firebase/performance-compat",Kf="@firebase/remote-config",Wf="@firebase/remote-config-compat",Qf="@firebase/storage",Xf="@firebase/storage-compat",Jf="@firebase/firestore",Yf="@firebase/ai",Zf="@firebase/firestore-compat",eg="firebase",tg="12.3.0";Bo="[DEFAULT]",ng={[Fo]:"fire-core",[Pf]:"fire-core-compat",[Rf]:"fire-analytics",[Df]:"fire-analytics-compat",[kf]:"fire-app-check",[Nf]:"fire-app-check-compat",[Mf]:"fire-auth",[Vf]:"fire-auth-compat",[Lf]:"fire-rtdb",[Of]:"fire-data-connect",[Ff]:"fire-rtdb-compat",[Bf]:"fire-fn",[$f]:"fire-fn-compat",[qf]:"fire-iid",[Uf]:"fire-iid-compat",[zf]:"fire-fcm",[jf]:"fire-fcm-compat",[Gf]:"fire-perf",[Hf]:"fire-perf-compat",[Kf]:"fire-rc",[Wf]:"fire-rc-compat",[Qf]:"fire-gcs",[Xf]:"fire-gcs-compat",[Jf]:"fire-fst",[Zf]:"fire-fst-compat",[Yf]:"fire-vertex","fire-js":"fire-js",[eg]:"fire-js-all"};Os=new Map,rg=new Map,$o=new Map;sg={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Bt=new Ir("app","Firebase",sg);qo=class{constructor(e,t,r){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=r,this.container.addComponent(new mt("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Bt.create("app-deleted",{appName:this._name})}};wd=tg;ig="firebase-heartbeat-database",og=1,Ar="firebase-heartbeat-store",Lo=null;cg=1024,lg=30,Uo=class{constructor(e){this.container=e,this._heartbeatsCache=null;let t=this.container.getProvider("app").getImmediate();this._storage=new zo(t),this._heartbeatsCachePromise=this._storage.read().then(r=>(this._heartbeatsCache=r,r))}async triggerHeartbeat(){try{let t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=md();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(s=>s.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:t}),this._heartbeatsCache.heartbeats.length>lg){let s=dg(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(s,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){ft.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";let e=md(),{heartbeatsToSend:t,unsentEntries:r}=ug(this._heartbeatsCache.heartbeats),s=Er(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),s}catch(e){return ft.warn(e),""}}};zo=class{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return So()?nd().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){let t=await ag(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){let r=await this.read();return pd(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){let r=await this.read();return pd(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??r.lastSentHeartbeatDate,heartbeats:[...r.heartbeats,...e.heartbeats]})}else return}};hg("")});var pg,mg,Ed=ne(()=>{Fs();Fs();pg="firebase",mg="12.3.0";$t(pg,mg,"app")});var Id,xd,gt,Go,Td=ne(()=>{Id=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},xd={};(function(){var n;function e(E,y){function _(){}_.prototype=y.prototype,E.F=y.prototype,E.prototype=new _,E.prototype.constructor=E,E.D=function(T,x,I){for(var w=Array(arguments.length-2),oe=2;oe<arguments.length;oe++)w[oe-2]=arguments[oe];return y.prototype[x].apply(T,w)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.C=Array(this.blockSize),this.o=this.h=0,this.u()}e(r,t),r.prototype.u=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function s(E,y,_){_||(_=0);let T=Array(16);if(typeof y=="string")for(var x=0;x<16;++x)T[x]=y.charCodeAt(_++)|y.charCodeAt(_++)<<8|y.charCodeAt(_++)<<16|y.charCodeAt(_++)<<24;else for(x=0;x<16;++x)T[x]=y[_++]|y[_++]<<8|y[_++]<<16|y[_++]<<24;y=E.g[0],_=E.g[1],x=E.g[2];let I=E.g[3],w;w=y+(I^_&(x^I))+T[0]+3614090360&4294967295,y=_+(w<<7&4294967295|w>>>25),w=I+(x^y&(_^x))+T[1]+3905402710&4294967295,I=y+(w<<12&4294967295|w>>>20),w=x+(_^I&(y^_))+T[2]+606105819&4294967295,x=I+(w<<17&4294967295|w>>>15),w=_+(y^x&(I^y))+T[3]+3250441966&4294967295,_=x+(w<<22&4294967295|w>>>10),w=y+(I^_&(x^I))+T[4]+4118548399&4294967295,y=_+(w<<7&4294967295|w>>>25),w=I+(x^y&(_^x))+T[5]+1200080426&4294967295,I=y+(w<<12&4294967295|w>>>20),w=x+(_^I&(y^_))+T[6]+2821735955&4294967295,x=I+(w<<17&4294967295|w>>>15),w=_+(y^x&(I^y))+T[7]+4249261313&4294967295,_=x+(w<<22&4294967295|w>>>10),w=y+(I^_&(x^I))+T[8]+1770035416&4294967295,y=_+(w<<7&4294967295|w>>>25),w=I+(x^y&(_^x))+T[9]+2336552879&4294967295,I=y+(w<<12&4294967295|w>>>20),w=x+(_^I&(y^_))+T[10]+4294925233&4294967295,x=I+(w<<17&4294967295|w>>>15),w=_+(y^x&(I^y))+T[11]+2304563134&4294967295,_=x+(w<<22&4294967295|w>>>10),w=y+(I^_&(x^I))+T[12]+1804603682&4294967295,y=_+(w<<7&4294967295|w>>>25),w=I+(x^y&(_^x))+T[13]+4254626195&4294967295,I=y+(w<<12&4294967295|w>>>20),w=x+(_^I&(y^_))+T[14]+2792965006&4294967295,x=I+(w<<17&4294967295|w>>>15),w=_+(y^x&(I^y))+T[15]+1236535329&4294967295,_=x+(w<<22&4294967295|w>>>10),w=y+(x^I&(_^x))+T[1]+4129170786&4294967295,y=_+(w<<5&4294967295|w>>>27),w=I+(_^x&(y^_))+T[6]+3225465664&4294967295,I=y+(w<<9&4294967295|w>>>23),w=x+(y^_&(I^y))+T[11]+643717713&4294967295,x=I+(w<<14&4294967295|w>>>18),w=_+(I^y&(x^I))+T[0]+3921069994&4294967295,_=x+(w<<20&4294967295|w>>>12),w=y+(x^I&(_^x))+T[5]+3593408605&4294967295,y=_+(w<<5&4294967295|w>>>27),w=I+(_^x&(y^_))+T[10]+38016083&4294967295,I=y+(w<<9&4294967295|w>>>23),w=x+(y^_&(I^y))+T[15]+3634488961&4294967295,x=I+(w<<14&4294967295|w>>>18),w=_+(I^y&(x^I))+T[4]+3889429448&4294967295,_=x+(w<<20&4294967295|w>>>12),w=y+(x^I&(_^x))+T[9]+568446438&4294967295,y=_+(w<<5&4294967295|w>>>27),w=I+(_^x&(y^_))+T[14]+3275163606&4294967295,I=y+(w<<9&4294967295|w>>>23),w=x+(y^_&(I^y))+T[3]+4107603335&4294967295,x=I+(w<<14&4294967295|w>>>18),w=_+(I^y&(x^I))+T[8]+1163531501&4294967295,_=x+(w<<20&4294967295|w>>>12),w=y+(x^I&(_^x))+T[13]+2850285829&4294967295,y=_+(w<<5&4294967295|w>>>27),w=I+(_^x&(y^_))+T[2]+4243563512&4294967295,I=y+(w<<9&4294967295|w>>>23),w=x+(y^_&(I^y))+T[7]+1735328473&4294967295,x=I+(w<<14&4294967295|w>>>18),w=_+(I^y&(x^I))+T[12]+2368359562&4294967295,_=x+(w<<20&4294967295|w>>>12),w=y+(_^x^I)+T[5]+4294588738&4294967295,y=_+(w<<4&4294967295|w>>>28),w=I+(y^_^x)+T[8]+2272392833&4294967295,I=y+(w<<11&4294967295|w>>>21),w=x+(I^y^_)+T[11]+1839030562&4294967295,x=I+(w<<16&4294967295|w>>>16),w=_+(x^I^y)+T[14]+4259657740&4294967295,_=x+(w<<23&4294967295|w>>>9),w=y+(_^x^I)+T[1]+2763975236&4294967295,y=_+(w<<4&4294967295|w>>>28),w=I+(y^_^x)+T[4]+1272893353&4294967295,I=y+(w<<11&4294967295|w>>>21),w=x+(I^y^_)+T[7]+4139469664&4294967295,x=I+(w<<16&4294967295|w>>>16),w=_+(x^I^y)+T[10]+3200236656&4294967295,_=x+(w<<23&4294967295|w>>>9),w=y+(_^x^I)+T[13]+681279174&4294967295,y=_+(w<<4&4294967295|w>>>28),w=I+(y^_^x)+T[0]+3936430074&4294967295,I=y+(w<<11&4294967295|w>>>21),w=x+(I^y^_)+T[3]+3572445317&4294967295,x=I+(w<<16&4294967295|w>>>16),w=_+(x^I^y)+T[6]+76029189&4294967295,_=x+(w<<23&4294967295|w>>>9),w=y+(_^x^I)+T[9]+3654602809&4294967295,y=_+(w<<4&4294967295|w>>>28),w=I+(y^_^x)+T[12]+3873151461&4294967295,I=y+(w<<11&4294967295|w>>>21),w=x+(I^y^_)+T[15]+530742520&4294967295,x=I+(w<<16&4294967295|w>>>16),w=_+(x^I^y)+T[2]+3299628645&4294967295,_=x+(w<<23&4294967295|w>>>9),w=y+(x^(_|~I))+T[0]+4096336452&4294967295,y=_+(w<<6&4294967295|w>>>26),w=I+(_^(y|~x))+T[7]+1126891415&4294967295,I=y+(w<<10&4294967295|w>>>22),w=x+(y^(I|~_))+T[14]+2878612391&4294967295,x=I+(w<<15&4294967295|w>>>17),w=_+(I^(x|~y))+T[5]+4237533241&4294967295,_=x+(w<<21&4294967295|w>>>11),w=y+(x^(_|~I))+T[12]+1700485571&4294967295,y=_+(w<<6&4294967295|w>>>26),w=I+(_^(y|~x))+T[3]+2399980690&4294967295,I=y+(w<<10&4294967295|w>>>22),w=x+(y^(I|~_))+T[10]+4293915773&4294967295,x=I+(w<<15&4294967295|w>>>17),w=_+(I^(x|~y))+T[1]+2240044497&4294967295,_=x+(w<<21&4294967295|w>>>11),w=y+(x^(_|~I))+T[8]+1873313359&4294967295,y=_+(w<<6&4294967295|w>>>26),w=I+(_^(y|~x))+T[15]+4264355552&4294967295,I=y+(w<<10&4294967295|w>>>22),w=x+(y^(I|~_))+T[6]+2734768916&4294967295,x=I+(w<<15&4294967295|w>>>17),w=_+(I^(x|~y))+T[13]+1309151649&4294967295,_=x+(w<<21&4294967295|w>>>11),w=y+(x^(_|~I))+T[4]+4149444226&4294967295,y=_+(w<<6&4294967295|w>>>26),w=I+(_^(y|~x))+T[11]+3174756917&4294967295,I=y+(w<<10&4294967295|w>>>22),w=x+(y^(I|~_))+T[2]+718787259&4294967295,x=I+(w<<15&4294967295|w>>>17),w=_+(I^(x|~y))+T[9]+3951481745&4294967295,E.g[0]=E.g[0]+y&4294967295,E.g[1]=E.g[1]+(x+(w<<21&4294967295|w>>>11))&4294967295,E.g[2]=E.g[2]+x&4294967295,E.g[3]=E.g[3]+I&4294967295}r.prototype.v=function(E,y){y===void 0&&(y=E.length);let _=y-this.blockSize,T=this.C,x=this.h,I=0;for(;I<y;){if(x==0)for(;I<=_;)s(this,E,I),I+=this.blockSize;if(typeof E=="string"){for(;I<y;)if(T[x++]=E.charCodeAt(I++),x==this.blockSize){s(this,T),x=0;break}}else for(;I<y;)if(T[x++]=E[I++],x==this.blockSize){s(this,T),x=0;break}}this.h=x,this.o+=y},r.prototype.A=function(){var E=Array((this.h<56?this.blockSize:this.blockSize*2)-this.h);E[0]=128;for(var y=1;y<E.length-8;++y)E[y]=0;y=this.o*8;for(var _=E.length-8;_<E.length;++_)E[_]=y&255,y/=256;for(this.v(E),E=Array(16),y=0,_=0;_<4;++_)for(let T=0;T<32;T+=8)E[y++]=this.g[_]>>>T&255;return E};function o(E,y){var _=c;return Object.prototype.hasOwnProperty.call(_,E)?_[E]:_[E]=y(E)}function a(E,y){this.h=y;let _=[],T=!0;for(let x=E.length-1;x>=0;x--){let I=E[x]|0;T&&I==y||(_[x]=I,T=!1)}this.g=_}var c={};function u(E){return-128<=E&&E<128?o(E,function(y){return new a([y|0],y<0?-1:0)}):new a([E|0],E<0?-1:0)}function d(E){if(isNaN(E)||!isFinite(E))return m;if(E<0)return C(d(-E));let y=[],_=1;for(let T=0;E>=_;T++)y[T]=E/_|0,_*=4294967296;return new a(y,0)}function p(E,y){if(E.length==0)throw Error("number format error: empty string");if(y=y||10,y<2||36<y)throw Error("radix out of range: "+y);if(E.charAt(0)=="-")return C(p(E.substring(1),y));if(E.indexOf("-")>=0)throw Error('number format error: interior "-" character');let _=d(Math.pow(y,8)),T=m;for(let I=0;I<E.length;I+=8){var x=Math.min(8,E.length-I);let w=parseInt(E.substring(I,I+x),y);x<8?(x=d(Math.pow(y,x)),T=T.j(x).add(d(w))):(T=T.j(_),T=T.add(d(w)))}return T}var m=u(0),g=u(1),b=u(16777216);n=a.prototype,n.m=function(){if(v(this))return-C(this).m();let E=0,y=1;for(let _=0;_<this.g.length;_++){let T=this.i(_);E+=(T>=0?T:4294967296+T)*y,y*=4294967296}return E},n.toString=function(E){if(E=E||10,E<2||36<E)throw Error("radix out of range: "+E);if(S(this))return"0";if(v(this))return"-"+C(this).toString(E);let y=d(Math.pow(E,6));var _=this;let T="";for(;;){let x=H(_,y).g;_=D(_,x.j(y));let I=((_.g.length>0?_.g[0]:_.h)>>>0).toString(E);if(_=x,S(_))return I+T;for(;I.length<6;)I="0"+I;T=I+T}},n.i=function(E){return E<0?0:E<this.g.length?this.g[E]:this.h};function S(E){if(E.h!=0)return!1;for(let y=0;y<E.g.length;y++)if(E.g[y]!=0)return!1;return!0}function v(E){return E.h==-1}n.l=function(E){return E=D(this,E),v(E)?-1:S(E)?0:1};function C(E){let y=E.g.length,_=[];for(let T=0;T<y;T++)_[T]=~E.g[T];return new a(_,~E.h).add(g)}n.abs=function(){return v(this)?C(this):this},n.add=function(E){let y=Math.max(this.g.length,E.g.length),_=[],T=0;for(let x=0;x<=y;x++){let I=T+(this.i(x)&65535)+(E.i(x)&65535),w=(I>>>16)+(this.i(x)>>>16)+(E.i(x)>>>16);T=w>>>16,I&=65535,w&=65535,_[x]=w<<16|I}return new a(_,_[_.length-1]&-2147483648?-1:0)};function D(E,y){return E.add(C(y))}n.j=function(E){if(S(this)||S(E))return m;if(v(this))return v(E)?C(this).j(C(E)):C(C(this).j(E));if(v(E))return C(this.j(C(E)));if(this.l(b)<0&&E.l(b)<0)return d(this.m()*E.m());let y=this.g.length+E.g.length,_=[];for(var T=0;T<2*y;T++)_[T]=0;for(T=0;T<this.g.length;T++)for(let x=0;x<E.g.length;x++){let I=this.i(T)>>>16,w=this.i(T)&65535,oe=E.i(x)>>>16,Qe=E.i(x)&65535;_[2*T+2*x]+=w*Qe,k(_,2*T+2*x),_[2*T+2*x+1]+=I*Qe,k(_,2*T+2*x+1),_[2*T+2*x+1]+=w*oe,k(_,2*T+2*x+1),_[2*T+2*x+2]+=I*oe,k(_,2*T+2*x+2)}for(E=0;E<y;E++)_[E]=_[2*E+1]<<16|_[2*E];for(E=y;E<2*y;E++)_[E]=0;return new a(_,0)};function k(E,y){for(;(E[y]&65535)!=E[y];)E[y+1]+=E[y]>>>16,E[y]&=65535,y++}function L(E,y){this.g=E,this.h=y}function H(E,y){if(S(y))throw Error("division by zero");if(S(E))return new L(m,m);if(v(E))return y=H(C(E),y),new L(C(y.g),C(y.h));if(v(y))return y=H(E,C(y)),new L(C(y.g),y.h);if(E.g.length>30){if(v(E)||v(y))throw Error("slowDivide_ only works with positive integers.");for(var _=g,T=y;T.l(E)<=0;)_=F(_),T=F(T);var x=W(_,1),I=W(T,1);for(T=W(T,2),_=W(_,2);!S(T);){var w=I.add(T);w.l(E)<=0&&(x=x.add(_),I=w),T=W(T,1),_=W(_,1)}return y=D(E,x.j(y)),new L(x,y)}for(x=m;E.l(y)>=0;){for(_=Math.max(1,Math.floor(E.m()/y.m())),T=Math.ceil(Math.log(_)/Math.LN2),T=T<=48?1:Math.pow(2,T-48),I=d(_),w=I.j(y);v(w)||w.l(E)>0;)_-=T,I=d(_),w=I.j(y);S(I)&&(I=g),x=x.add(I),E=D(E,w)}return new L(x,E)}n.B=function(E){return H(this,E).h},n.and=function(E){let y=Math.max(this.g.length,E.g.length),_=[];for(let T=0;T<y;T++)_[T]=this.i(T)&E.i(T);return new a(_,this.h&E.h)},n.or=function(E){let y=Math.max(this.g.length,E.g.length),_=[];for(let T=0;T<y;T++)_[T]=this.i(T)|E.i(T);return new a(_,this.h|E.h)},n.xor=function(E){let y=Math.max(this.g.length,E.g.length),_=[];for(let T=0;T<y;T++)_[T]=this.i(T)^E.i(T);return new a(_,this.h^E.h)};function F(E){let y=E.g.length+1,_=[];for(let T=0;T<y;T++)_[T]=E.i(T)<<1|E.i(T-1)>>>31;return new a(_,E.h)}function W(E,y){let _=y>>5;y%=32;let T=E.g.length-_,x=[];for(let I=0;I<T;I++)x[I]=y>0?E.i(I+_)>>>y|E.i(I+_+1)<<32-y:E.i(I+_);return new a(x,E.h)}r.prototype.digest=r.prototype.A,r.prototype.reset=r.prototype.u,r.prototype.update=r.prototype.v,Go=xd.Md5=r,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.B,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=p,gt=xd.Integer=a}).apply(typeof Id<"u"?Id:typeof self<"u"?self:typeof window<"u"?window:{})});var Bs,yt,Ho,fg,Cn,Ko,Cr,$s,Wo,Qo,Xo,Sd=ne(()=>{Bs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},yt={};(function(){var n,e=Object.defineProperty;function t(i){i=[typeof globalThis=="object"&&globalThis,i,typeof window=="object"&&window,typeof self=="object"&&self,typeof Bs=="object"&&Bs];for(var l=0;l<i.length;++l){var h=i[l];if(h&&h.Math==Math)return h}throw Error("Cannot find global object")}var r=t(this);function s(i,l){if(l)e:{var h=r;i=i.split(".");for(var f=0;f<i.length-1;f++){var A=i[f];if(!(A in h))break e;h=h[A]}i=i[i.length-1],f=h[i],l=l(f),l!=f&&l!=null&&e(h,i,{configurable:!0,writable:!0,value:l})}}s("Symbol.dispose",function(i){return i||Symbol("Symbol.dispose")}),s("Array.prototype.values",function(i){return i||function(){return this[Symbol.iterator]()}}),s("Object.entries",function(i){return i||function(l){var h=[],f;for(f in l)Object.prototype.hasOwnProperty.call(l,f)&&h.push([f,l[f]]);return h}});var o=o||{},a=this||self;function c(i){var l=typeof i;return l=="object"&&i!=null||l=="function"}function u(i,l,h){return i.call.apply(i.bind,arguments)}function d(i,l,h){return d=u,d.apply(null,arguments)}function p(i,l){var h=Array.prototype.slice.call(arguments,1);return function(){var f=h.slice();return f.push.apply(f,arguments),i.apply(this,f)}}function m(i,l){function h(){}h.prototype=l.prototype,i.Z=l.prototype,i.prototype=new h,i.prototype.constructor=i,i.Ob=function(f,A,P){for(var M=Array(arguments.length-2),K=2;K<arguments.length;K++)M[K-2]=arguments[K];return l.prototype[A].apply(f,M)}}var g=typeof AsyncContext<"u"&&typeof AsyncContext.Snapshot=="function"?i=>i&&AsyncContext.Snapshot.wrap(i):i=>i;function b(i){let l=i.length;if(l>0){let h=Array(l);for(let f=0;f<l;f++)h[f]=i[f];return h}return[]}function S(i,l){for(let f=1;f<arguments.length;f++){let A=arguments[f];var h=typeof A;if(h=h!="object"?h:A?Array.isArray(A)?"array":h:"null",h=="array"||h=="object"&&typeof A.length=="number"){h=i.length||0;let P=A.length||0;i.length=h+P;for(let M=0;M<P;M++)i[h+M]=A[M]}else i.push(A)}}class v{constructor(l,h){this.i=l,this.j=h,this.h=0,this.g=null}get(){let l;return this.h>0?(this.h--,l=this.g,this.g=l.next,l.next=null):l=this.i(),l}}function C(i){a.setTimeout(()=>{throw i},0)}function D(){var i=E;let l=null;return i.g&&(l=i.g,i.g=i.g.next,i.g||(i.h=null),l.next=null),l}class k{constructor(){this.h=this.g=null}add(l,h){let f=L.get();f.set(l,h),this.h?this.h.next=f:this.g=f,this.h=f}}var L=new v(()=>new H,i=>i.reset());class H{constructor(){this.next=this.g=this.h=null}set(l,h){this.h=l,this.g=h,this.next=null}reset(){this.next=this.g=this.h=null}}let F,W=!1,E=new k,y=()=>{let i=Promise.resolve(void 0);F=()=>{i.then(_)}};function _(){for(var i;i=D();){try{i.h.call(i.g)}catch(h){C(h)}var l=L;l.j(i),l.h<100&&(l.h++,i.next=l.g,l.g=i)}W=!1}function T(){this.u=this.u,this.C=this.C}T.prototype.u=!1,T.prototype.dispose=function(){this.u||(this.u=!0,this.N())},T.prototype[Symbol.dispose]=function(){this.dispose()},T.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function x(i,l){this.type=i,this.g=this.target=l,this.defaultPrevented=!1}x.prototype.h=function(){this.defaultPrevented=!0};var I=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var i=!1,l=Object.defineProperty({},"passive",{get:function(){i=!0}});try{let h=()=>{};a.addEventListener("test",h,l),a.removeEventListener("test",h,l)}catch{}return i}();function w(i){return/^[\s\xa0]*$/.test(i)}function oe(i,l){x.call(this,i?i.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,i&&this.init(i,l)}m(oe,x),oe.prototype.init=function(i,l){let h=this.type=i.type,f=i.changedTouches&&i.changedTouches.length?i.changedTouches[0]:null;this.target=i.target||i.srcElement,this.g=l,l=i.relatedTarget,l||(h=="mouseover"?l=i.fromElement:h=="mouseout"&&(l=i.toElement)),this.relatedTarget=l,f?(this.clientX=f.clientX!==void 0?f.clientX:f.pageX,this.clientY=f.clientY!==void 0?f.clientY:f.pageY,this.screenX=f.screenX||0,this.screenY=f.screenY||0):(this.clientX=i.clientX!==void 0?i.clientX:i.pageX,this.clientY=i.clientY!==void 0?i.clientY:i.pageY,this.screenX=i.screenX||0,this.screenY=i.screenY||0),this.button=i.button,this.key=i.key||"",this.ctrlKey=i.ctrlKey,this.altKey=i.altKey,this.shiftKey=i.shiftKey,this.metaKey=i.metaKey,this.pointerId=i.pointerId||0,this.pointerType=i.pointerType,this.state=i.state,this.i=i,i.defaultPrevented&&oe.Z.h.call(this)},oe.prototype.h=function(){oe.Z.h.call(this);let i=this.i;i.preventDefault?i.preventDefault():i.returnValue=!1};var Qe="closure_listenable_"+(Math.random()*1e6|0),Ie=0;function Qt(i,l,h,f,A){this.listener=i,this.proxy=null,this.src=l,this.type=h,this.capture=!!f,this.ha=A,this.key=++Ie,this.da=this.fa=!1}function bn(i){i.da=!0,i.listener=null,i.proxy=null,i.src=null,i.ha=null}function ds(i,l,h){for(let f in i)l.call(h,i[f],f,i)}function Em(i,l){for(let h in i)l.call(void 0,i[h],h,i)}function Vl(i){let l={};for(let h in i)l[h]=i[h];return l}let Ll="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Ol(i,l){let h,f;for(let A=1;A<arguments.length;A++){f=arguments[A];for(h in f)i[h]=f[h];for(let P=0;P<Ll.length;P++)h=Ll[P],Object.prototype.hasOwnProperty.call(f,h)&&(i[h]=f[h])}}function hs(i){this.src=i,this.g={},this.h=0}hs.prototype.add=function(i,l,h,f,A){let P=i.toString();i=this.g[P],i||(i=this.g[P]=[],this.h++);let M=Wi(i,l,f,A);return M>-1?(l=i[M],h||(l.fa=!1)):(l=new Qt(l,this.src,P,!!f,A),l.fa=h,i.push(l)),l};function Ki(i,l){let h=l.type;if(h in i.g){var f=i.g[h],A=Array.prototype.indexOf.call(f,l,void 0),P;(P=A>=0)&&Array.prototype.splice.call(f,A,1),P&&(bn(l),i.g[h].length==0&&(delete i.g[h],i.h--))}}function Wi(i,l,h,f){for(let A=0;A<i.length;++A){let P=i[A];if(!P.da&&P.listener==l&&P.capture==!!h&&P.ha==f)return A}return-1}var Qi="closure_lm_"+(Math.random()*1e6|0),Xi={};function Fl(i,l,h,f,A){if(f&&f.once)return $l(i,l,h,f,A);if(Array.isArray(l)){for(let P=0;P<l.length;P++)Fl(i,l[P],h,f,A);return null}return h=eo(h),i&&i[Qe]?i.J(l,h,c(f)?!!f.capture:!!f,A):Bl(i,l,h,!1,f,A)}function Bl(i,l,h,f,A,P){if(!l)throw Error("Invalid event type");let M=c(A)?!!A.capture:!!A,K=Yi(i);if(K||(i[Qi]=K=new hs(i)),h=K.add(l,h,f,M,P),h.proxy)return h;if(f=Im(),h.proxy=f,f.src=i,f.listener=h,i.addEventListener)I||(A=M),A===void 0&&(A=!1),i.addEventListener(l.toString(),f,A);else if(i.attachEvent)i.attachEvent(Ul(l.toString()),f);else if(i.addListener&&i.removeListener)i.addListener(f);else throw Error("addEventListener and attachEvent are unavailable.");return h}function Im(){function i(h){return l.call(i.src,i.listener,h)}let l=xm;return i}function $l(i,l,h,f,A){if(Array.isArray(l)){for(let P=0;P<l.length;P++)$l(i,l[P],h,f,A);return null}return h=eo(h),i&&i[Qe]?i.K(l,h,c(f)?!!f.capture:!!f,A):Bl(i,l,h,!0,f,A)}function ql(i,l,h,f,A){if(Array.isArray(l))for(var P=0;P<l.length;P++)ql(i,l[P],h,f,A);else f=c(f)?!!f.capture:!!f,h=eo(h),i&&i[Qe]?(i=i.i,P=String(l).toString(),P in i.g&&(l=i.g[P],h=Wi(l,h,f,A),h>-1&&(bn(l[h]),Array.prototype.splice.call(l,h,1),l.length==0&&(delete i.g[P],i.h--)))):i&&(i=Yi(i))&&(l=i.g[l.toString()],i=-1,l&&(i=Wi(l,h,f,A)),(h=i>-1?l[i]:null)&&Ji(h))}function Ji(i){if(typeof i!="number"&&i&&!i.da){var l=i.src;if(l&&l[Qe])Ki(l.i,i);else{var h=i.type,f=i.proxy;l.removeEventListener?l.removeEventListener(h,f,i.capture):l.detachEvent?l.detachEvent(Ul(h),f):l.addListener&&l.removeListener&&l.removeListener(f),(h=Yi(l))?(Ki(h,i),h.h==0&&(h.src=null,l[Qi]=null)):bn(i)}}}function Ul(i){return i in Xi?Xi[i]:Xi[i]="on"+i}function xm(i,l){if(i.da)i=!0;else{l=new oe(l,this);let h=i.listener,f=i.ha||i.src;i.fa&&Ji(i),i=h.call(f,l)}return i}function Yi(i){return i=i[Qi],i instanceof hs?i:null}var Zi="__closure_events_fn_"+(Math.random()*1e9>>>0);function eo(i){return typeof i=="function"?i:(i[Zi]||(i[Zi]=function(l){return i.handleEvent(l)}),i[Zi])}function Se(){T.call(this),this.i=new hs(this),this.M=this,this.G=null}m(Se,T),Se.prototype[Qe]=!0,Se.prototype.removeEventListener=function(i,l,h,f){ql(this,i,l,h,f)};function Re(i,l){var h,f=i.G;if(f)for(h=[];f;f=f.G)h.push(f);if(i=i.M,f=l.type||l,typeof l=="string")l=new x(l,i);else if(l instanceof x)l.target=l.target||i;else{var A=l;l=new x(f,i),Ol(l,A)}A=!0;let P,M;if(h)for(M=h.length-1;M>=0;M--)P=l.g=h[M],A=ps(P,f,!0,l)&&A;if(P=l.g=i,A=ps(P,f,!0,l)&&A,A=ps(P,f,!1,l)&&A,h)for(M=0;M<h.length;M++)P=l.g=h[M],A=ps(P,f,!1,l)&&A}Se.prototype.N=function(){if(Se.Z.N.call(this),this.i){var i=this.i;for(let l in i.g){let h=i.g[l];for(let f=0;f<h.length;f++)bn(h[f]);delete i.g[l],i.h--}}this.G=null},Se.prototype.J=function(i,l,h,f){return this.i.add(String(i),l,!1,h,f)},Se.prototype.K=function(i,l,h,f){return this.i.add(String(i),l,!0,h,f)};function ps(i,l,h,f){if(l=i.i.g[String(l)],!l)return!0;l=l.concat();let A=!0;for(let P=0;P<l.length;++P){let M=l[P];if(M&&!M.da&&M.capture==h){let K=M.listener,we=M.ha||M.src;M.fa&&Ki(i.i,M),A=K.call(we,f)!==!1&&A}}return A&&!f.defaultPrevented}function Tm(i,l){if(typeof i!="function")if(i&&typeof i.handleEvent=="function")i=d(i.handleEvent,i);else throw Error("Invalid listener argument");return Number(l)>2147483647?-1:a.setTimeout(i,l||0)}function zl(i){i.g=Tm(()=>{i.g=null,i.i&&(i.i=!1,zl(i))},i.l);let l=i.h;i.h=null,i.m.apply(null,l)}class Sm extends T{constructor(l,h){super(),this.m=l,this.l=h,this.h=null,this.i=!1,this.g=null}j(l){this.h=arguments,this.g?this.i=!0:zl(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function sr(i){T.call(this),this.h=i,this.g={}}m(sr,T);var jl=[];function Gl(i){ds(i.g,function(l,h){this.g.hasOwnProperty(h)&&Ji(l)},i),i.g={}}sr.prototype.N=function(){sr.Z.N.call(this),Gl(this)},sr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var to=a.JSON.stringify,Am=a.JSON.parse,Cm=class{stringify(i){return a.JSON.stringify(i,void 0)}parse(i){return a.JSON.parse(i,void 0)}};function Hl(){}function Kl(){}var ir={OPEN:"a",hb:"b",ERROR:"c",tb:"d"};function no(){x.call(this,"d")}m(no,x);function ro(){x.call(this,"c")}m(ro,x);var Xt={},Wl=null;function ms(){return Wl=Wl||new Se}Xt.Ia="serverreachability";function Ql(i){x.call(this,Xt.Ia,i)}m(Ql,x);function or(i){let l=ms();Re(l,new Ql(l))}Xt.STAT_EVENT="statevent";function Xl(i,l){x.call(this,Xt.STAT_EVENT,i),this.stat=l}m(Xl,x);function Ne(i){let l=ms();Re(l,new Xl(l,i))}Xt.Ja="timingevent";function Jl(i,l){x.call(this,Xt.Ja,i),this.size=l}m(Jl,x);function ar(i,l){if(typeof i!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){i()},l)}function cr(){this.g=!0}cr.prototype.ua=function(){this.g=!1};function Pm(i,l,h,f,A,P){i.info(function(){if(i.g)if(P){var M="",K=P.split("&");for(let te=0;te<K.length;te++){var we=K[te].split("=");if(we.length>1){let be=we[0];we=we[1];let Je=be.split("_");M=Je.length>=2&&Je[1]=="type"?M+(be+"="+we+"&"):M+(be+"=redacted&")}}}else M=null;else M=P;return"XMLHTTP REQ ("+f+") [attempt "+A+"]: "+l+`
`+h+`
`+M})}function Dm(i,l,h,f,A,P,M){i.info(function(){return"XMLHTTP RESP ("+f+") [ attempt "+A+"]: "+l+`
`+h+`
`+P+" "+M})}function vn(i,l,h,f){i.info(function(){return"XMLHTTP TEXT ("+l+"): "+Nm(i,h)+(f?" "+f:"")})}function Rm(i,l){i.info(function(){return"TIMEOUT: "+l})}cr.prototype.info=function(){};function Nm(i,l){if(!i.g)return l;if(!l)return null;try{let P=JSON.parse(l);if(P){for(i=0;i<P.length;i++)if(Array.isArray(P[i])){var h=P[i];if(!(h.length<2)){var f=h[1];if(Array.isArray(f)&&!(f.length<1)){var A=f[0];if(A!="noop"&&A!="stop"&&A!="close")for(let M=1;M<f.length;M++)f[M]=""}}}}return to(P)}catch{return l}}var fs={NO_ERROR:0,cb:1,qb:2,pb:3,kb:4,ob:5,rb:6,Ga:7,TIMEOUT:8,ub:9},Yl={ib:"complete",Fb:"success",ERROR:"error",Ga:"abort",xb:"ready",yb:"readystatechange",TIMEOUT:"timeout",sb:"incrementaldata",wb:"progress",lb:"downloadprogress",Nb:"uploadprogress"},Zl;function so(){}m(so,Hl),so.prototype.g=function(){return new XMLHttpRequest},Zl=new so;function lr(i){return encodeURIComponent(String(i))}function km(i){var l=1;i=i.split(":");let h=[];for(;l>0&&i.length;)h.push(i.shift()),l--;return i.length&&h.push(i.join(":")),h}function Pt(i,l,h,f){this.j=i,this.i=l,this.l=h,this.S=f||1,this.V=new sr(this),this.H=45e3,this.J=null,this.o=!1,this.u=this.B=this.A=this.M=this.F=this.T=this.D=null,this.G=[],this.g=null,this.C=0,this.m=this.v=null,this.X=-1,this.K=!1,this.P=0,this.O=null,this.W=this.L=this.U=this.R=!1,this.h=new eu}function eu(){this.i=null,this.g="",this.h=!1}var tu={},io={};function oo(i,l,h){i.M=1,i.A=ys(Xe(l)),i.u=h,i.R=!0,nu(i,null)}function nu(i,l){i.F=Date.now(),gs(i),i.B=Xe(i.A);var h=i.B,f=i.S;Array.isArray(f)||(f=[String(f)]),fu(h.i,"t",f),i.C=0,h=i.j.L,i.h=new eu,i.g=ku(i.j,h?l:null,!i.u),i.P>0&&(i.O=new Sm(d(i.Y,i,i.g),i.P)),l=i.V,h=i.g,f=i.ba;var A="readystatechange";Array.isArray(A)||(A&&(jl[0]=A.toString()),A=jl);for(let P=0;P<A.length;P++){let M=Fl(h,A[P],f||l.handleEvent,!1,l.h||l);if(!M)break;l.g[M.key]=M}l=i.J?Vl(i.J):{},i.u?(i.v||(i.v="POST"),l["Content-Type"]="application/x-www-form-urlencoded",i.g.ea(i.B,i.v,i.u,l)):(i.v="GET",i.g.ea(i.B,i.v,null,l)),or(),Pm(i.i,i.v,i.B,i.l,i.S,i.u)}Pt.prototype.ba=function(i){i=i.target;let l=this.O;l&&Nt(i)==3?l.j():this.Y(i)},Pt.prototype.Y=function(i){try{if(i==this.g)e:{let K=Nt(this.g),we=this.g.ya(),te=this.g.ca();if(!(K<3)&&(K!=3||this.g&&(this.h.h||this.g.la()||Eu(this.g)))){this.K||K!=4||we==7||(we==8||te<=0?or(3):or(2)),ao(this);var l=this.g.ca();this.X=l;var h=Mm(this);if(this.o=l==200,Dm(this.i,this.v,this.B,this.l,this.S,K,l),this.o){if(this.U&&!this.L){t:{if(this.g){var f,A=this.g;if((f=A.g?A.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!w(f)){var P=f;break t}}P=null}if(i=P)vn(this.i,this.l,i,"Initial handshake response via X-HTTP-Initial-Response"),this.L=!0,co(this,i);else{this.o=!1,this.m=3,Ne(12),Jt(this),ur(this);break e}}if(this.R){i=!0;let be;for(;!this.K&&this.C<h.length;)if(be=Vm(this,h),be==io){K==4&&(this.m=4,Ne(14),i=!1),vn(this.i,this.l,null,"[Incomplete Response]");break}else if(be==tu){this.m=4,Ne(15),vn(this.i,this.l,h,"[Invalid Chunk]"),i=!1;break}else vn(this.i,this.l,be,null),co(this,be);if(ru(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),K!=4||h.length!=0||this.h.h||(this.m=1,Ne(16),i=!1),this.o=this.o&&i,!i)vn(this.i,this.l,h,"[Invalid Chunked Response]"),Jt(this),ur(this);else if(h.length>0&&!this.W){this.W=!0;var M=this.j;M.g==this&&M.aa&&!M.P&&(M.j.info("Great, no buffering proxy detected. Bytes received: "+h.length),go(M),M.P=!0,Ne(11))}}else vn(this.i,this.l,h,null),co(this,h);K==4&&Jt(this),this.o&&!this.K&&(K==4?Pu(this.j,this):(this.o=!1,gs(this)))}else Qm(this.g),l==400&&h.indexOf("Unknown SID")>0?(this.m=3,Ne(12)):(this.m=0,Ne(13)),Jt(this),ur(this)}}}catch{}finally{}};function Mm(i){if(!ru(i))return i.g.la();let l=Eu(i.g);if(l==="")return"";let h="",f=l.length,A=Nt(i.g)==4;if(!i.h.i){if(typeof TextDecoder>"u")return Jt(i),ur(i),"";i.h.i=new a.TextDecoder}for(let P=0;P<f;P++)i.h.h=!0,h+=i.h.i.decode(l[P],{stream:!(A&&P==f-1)});return l.length=0,i.h.g+=h,i.C=0,i.h.g}function ru(i){return i.g?i.v=="GET"&&i.M!=2&&i.j.Aa:!1}function Vm(i,l){var h=i.C,f=l.indexOf(`
`,h);return f==-1?io:(h=Number(l.substring(h,f)),isNaN(h)?tu:(f+=1,f+h>l.length?io:(l=l.slice(f,f+h),i.C=f+h,l)))}Pt.prototype.cancel=function(){this.K=!0,Jt(this)};function gs(i){i.T=Date.now()+i.H,su(i,i.H)}function su(i,l){if(i.D!=null)throw Error("WatchDog timer not null");i.D=ar(d(i.aa,i),l)}function ao(i){i.D&&(a.clearTimeout(i.D),i.D=null)}Pt.prototype.aa=function(){this.D=null;let i=Date.now();i-this.T>=0?(Rm(this.i,this.B),this.M!=2&&(or(),Ne(17)),Jt(this),this.m=2,ur(this)):su(this,this.T-i)};function ur(i){i.j.I==0||i.K||Pu(i.j,i)}function Jt(i){ao(i);var l=i.O;l&&typeof l.dispose=="function"&&l.dispose(),i.O=null,Gl(i.V),i.g&&(l=i.g,i.g=null,l.abort(),l.dispose())}function co(i,l){try{var h=i.j;if(h.I!=0&&(h.g==i||lo(h.h,i))){if(!i.L&&lo(h.h,i)&&h.I==3){try{var f=h.Ba.g.parse(l)}catch{f=null}if(Array.isArray(f)&&f.length==3){var A=f;if(A[0]==0){e:if(!h.v){if(h.g)if(h.g.F+3e3<i.F)Is(h),vs(h);else break e;fo(h),Ne(18)}}else h.xa=A[1],0<h.xa-h.K&&A[2]<37500&&h.F&&h.A==0&&!h.C&&(h.C=ar(d(h.Va,h),6e3));au(h.h)<=1&&h.ta&&(h.ta=void 0)}else Zt(h,11)}else if((i.L||h.g==i)&&Is(h),!w(l))for(A=h.Ba.g.parse(l),l=0;l<A.length;l++){let te=A[l],be=te[0];if(!(be<=h.K))if(h.K=be,te=te[1],h.I==2)if(te[0]=="c"){h.M=te[1],h.ba=te[2];let Je=te[3];Je!=null&&(h.ka=Je,h.j.info("VER="+h.ka));let en=te[4];en!=null&&(h.za=en,h.j.info("SVER="+h.za));let kt=te[5];kt!=null&&typeof kt=="number"&&kt>0&&(f=1.5*kt,h.O=f,h.j.info("backChannelRequestTimeoutMs_="+f)),f=h;let Mt=i.g;if(Mt){let Ts=Mt.g?Mt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Ts){var P=f.h;P.g||Ts.indexOf("spdy")==-1&&Ts.indexOf("quic")==-1&&Ts.indexOf("h2")==-1||(P.j=P.l,P.g=new Set,P.h&&(uo(P,P.h),P.h=null))}if(f.G){let yo=Mt.g?Mt.g.getResponseHeader("X-HTTP-Session-Id"):null;yo&&(f.wa=yo,se(f.J,f.G,yo))}}h.I=3,h.l&&h.l.ra(),h.aa&&(h.T=Date.now()-i.F,h.j.info("Handshake RTT: "+h.T+"ms")),f=h;var M=i;if(f.na=Nu(f,f.L?f.ba:null,f.W),M.L){cu(f.h,M);var K=M,we=f.O;we&&(K.H=we),K.D&&(ao(K),gs(K)),f.g=M}else Au(f);h.i.length>0&&Es(h)}else te[0]!="stop"&&te[0]!="close"||Zt(h,7);else h.I==3&&(te[0]=="stop"||te[0]=="close"?te[0]=="stop"?Zt(h,7):mo(h):te[0]!="noop"&&h.l&&h.l.qa(te),h.A=0)}}or(4)}catch{}}var Lm=class{constructor(i,l){this.g=i,this.map=l}};function iu(i){this.l=i||10,a.PerformanceNavigationTiming?(i=a.performance.getEntriesByType("navigation"),i=i.length>0&&(i[0].nextHopProtocol=="hq"||i[0].nextHopProtocol=="h2")):i=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=i?this.l:1,this.g=null,this.j>1&&(this.g=new Set),this.h=null,this.i=[]}function ou(i){return i.h?!0:i.g?i.g.size>=i.j:!1}function au(i){return i.h?1:i.g?i.g.size:0}function lo(i,l){return i.h?i.h==l:i.g?i.g.has(l):!1}function uo(i,l){i.g?i.g.add(l):i.h=l}function cu(i,l){i.h&&i.h==l?i.h=null:i.g&&i.g.has(l)&&i.g.delete(l)}iu.prototype.cancel=function(){if(this.i=lu(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let i of this.g.values())i.cancel();this.g.clear()}};function lu(i){if(i.h!=null)return i.i.concat(i.h.G);if(i.g!=null&&i.g.size!==0){let l=i.i;for(let h of i.g.values())l=l.concat(h.G);return l}return b(i.i)}var uu=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Om(i,l){if(i){i=i.split("&");for(let h=0;h<i.length;h++){let f=i[h].indexOf("="),A,P=null;f>=0?(A=i[h].substring(0,f),P=i[h].substring(f+1)):A=i[h],l(A,P?decodeURIComponent(P.replace(/\+/g," ")):"")}}}function Dt(i){this.g=this.o=this.j="",this.u=null,this.m=this.h="",this.l=!1;let l;i instanceof Dt?(this.l=i.l,dr(this,i.j),this.o=i.o,this.g=i.g,hr(this,i.u),this.h=i.h,ho(this,gu(i.i)),this.m=i.m):i&&(l=String(i).match(uu))?(this.l=!1,dr(this,l[1]||"",!0),this.o=pr(l[2]||""),this.g=pr(l[3]||"",!0),hr(this,l[4]),this.h=pr(l[5]||"",!0),ho(this,l[6]||"",!0),this.m=pr(l[7]||"")):(this.l=!1,this.i=new fr(null,this.l))}Dt.prototype.toString=function(){let i=[];var l=this.j;l&&i.push(mr(l,du,!0),":");var h=this.g;return(h||l=="file")&&(i.push("//"),(l=this.o)&&i.push(mr(l,du,!0),"@"),i.push(lr(h).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),h=this.u,h!=null&&i.push(":",String(h))),(h=this.h)&&(this.g&&h.charAt(0)!="/"&&i.push("/"),i.push(mr(h,h.charAt(0)=="/"?$m:Bm,!0))),(h=this.i.toString())&&i.push("?",h),(h=this.m)&&i.push("#",mr(h,Um)),i.join("")},Dt.prototype.resolve=function(i){let l=Xe(this),h=!!i.j;h?dr(l,i.j):h=!!i.o,h?l.o=i.o:h=!!i.g,h?l.g=i.g:h=i.u!=null;var f=i.h;if(h)hr(l,i.u);else if(h=!!i.h){if(f.charAt(0)!="/")if(this.g&&!this.h)f="/"+f;else{var A=l.h.lastIndexOf("/");A!=-1&&(f=l.h.slice(0,A+1)+f)}if(A=f,A==".."||A==".")f="";else if(A.indexOf("./")!=-1||A.indexOf("/.")!=-1){f=A.lastIndexOf("/",0)==0,A=A.split("/");let P=[];for(let M=0;M<A.length;){let K=A[M++];K=="."?f&&M==A.length&&P.push(""):K==".."?((P.length>1||P.length==1&&P[0]!="")&&P.pop(),f&&M==A.length&&P.push("")):(P.push(K),f=!0)}f=P.join("/")}else f=A}return h?l.h=f:h=i.i.toString()!=="",h?ho(l,gu(i.i)):h=!!i.m,h&&(l.m=i.m),l};function Xe(i){return new Dt(i)}function dr(i,l,h){i.j=h?pr(l,!0):l,i.j&&(i.j=i.j.replace(/:$/,""))}function hr(i,l){if(l){if(l=Number(l),isNaN(l)||l<0)throw Error("Bad port number "+l);i.u=l}else i.u=null}function ho(i,l,h){l instanceof fr?(i.i=l,zm(i.i,i.l)):(h||(l=mr(l,qm)),i.i=new fr(l,i.l))}function se(i,l,h){i.i.set(l,h)}function ys(i){return se(i,"zx",Math.floor(Math.random()*2147483648).toString(36)+Math.abs(Math.floor(Math.random()*2147483648)^Date.now()).toString(36)),i}function pr(i,l){return i?l?decodeURI(i.replace(/%25/g,"%2525")):decodeURIComponent(i):""}function mr(i,l,h){return typeof i=="string"?(i=encodeURI(i).replace(l,Fm),h&&(i=i.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),i):null}function Fm(i){return i=i.charCodeAt(0),"%"+(i>>4&15).toString(16)+(i&15).toString(16)}var du=/[#\/\?@]/g,Bm=/[#\?:]/g,$m=/[#\?]/g,qm=/[#\?@]/g,Um=/#/g;function fr(i,l){this.h=this.g=null,this.i=i||null,this.j=!!l}function Yt(i){i.g||(i.g=new Map,i.h=0,i.i&&Om(i.i,function(l,h){i.add(decodeURIComponent(l.replace(/\+/g," ")),h)}))}n=fr.prototype,n.add=function(i,l){Yt(this),this.i=null,i=En(this,i);let h=this.g.get(i);return h||this.g.set(i,h=[]),h.push(l),this.h+=1,this};function hu(i,l){Yt(i),l=En(i,l),i.g.has(l)&&(i.i=null,i.h-=i.g.get(l).length,i.g.delete(l))}function pu(i,l){return Yt(i),l=En(i,l),i.g.has(l)}n.forEach=function(i,l){Yt(this),this.g.forEach(function(h,f){h.forEach(function(A){i.call(l,A,f,this)},this)},this)};function mu(i,l){Yt(i);let h=[];if(typeof l=="string")pu(i,l)&&(h=h.concat(i.g.get(En(i,l))));else for(i=Array.from(i.g.values()),l=0;l<i.length;l++)h=h.concat(i[l]);return h}n.set=function(i,l){return Yt(this),this.i=null,i=En(this,i),pu(this,i)&&(this.h-=this.g.get(i).length),this.g.set(i,[l]),this.h+=1,this},n.get=function(i,l){return i?(i=mu(this,i),i.length>0?String(i[0]):l):l};function fu(i,l,h){hu(i,l),h.length>0&&(i.i=null,i.g.set(En(i,l),b(h)),i.h+=h.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let i=[],l=Array.from(this.g.keys());for(let f=0;f<l.length;f++){var h=l[f];let A=lr(h);h=mu(this,h);for(let P=0;P<h.length;P++){let M=A;h[P]!==""&&(M+="="+lr(h[P])),i.push(M)}}return this.i=i.join("&")};function gu(i){let l=new fr;return l.i=i.i,i.g&&(l.g=new Map(i.g),l.h=i.h),l}function En(i,l){return l=String(l),i.j&&(l=l.toLowerCase()),l}function zm(i,l){l&&!i.j&&(Yt(i),i.i=null,i.g.forEach(function(h,f){let A=f.toLowerCase();f!=A&&(hu(this,f),fu(this,A,h))},i)),i.j=l}function jm(i,l){let h=new cr;if(a.Image){let f=new Image;f.onload=p(Rt,h,"TestLoadImage: loaded",!0,l,f),f.onerror=p(Rt,h,"TestLoadImage: error",!1,l,f),f.onabort=p(Rt,h,"TestLoadImage: abort",!1,l,f),f.ontimeout=p(Rt,h,"TestLoadImage: timeout",!1,l,f),a.setTimeout(function(){f.ontimeout&&f.ontimeout()},1e4),f.src=i}else l(!1)}function Gm(i,l){let h=new cr,f=new AbortController,A=setTimeout(()=>{f.abort(),Rt(h,"TestPingServer: timeout",!1,l)},1e4);fetch(i,{signal:f.signal}).then(P=>{clearTimeout(A),P.ok?Rt(h,"TestPingServer: ok",!0,l):Rt(h,"TestPingServer: server error",!1,l)}).catch(()=>{clearTimeout(A),Rt(h,"TestPingServer: error",!1,l)})}function Rt(i,l,h,f,A){try{A&&(A.onload=null,A.onerror=null,A.onabort=null,A.ontimeout=null),f(h)}catch{}}function Hm(){this.g=new Cm}function ws(i){this.i=i.Sb||null,this.h=i.ab||!1}m(ws,Hl),ws.prototype.g=function(){return new _s(this.i,this.h)};function _s(i,l){Se.call(this),this.H=i,this.o=l,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.A=new Headers,this.h=null,this.F="GET",this.D="",this.g=!1,this.B=this.j=this.l=null,this.v=new AbortController}m(_s,Se),n=_s.prototype,n.open=function(i,l){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.F=i,this.D=l,this.readyState=1,yr(this)},n.send=function(i){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");if(this.v.signal.aborted)throw this.abort(),Error("Request was aborted.");this.g=!0;let l={headers:this.A,method:this.F,credentials:this.m,cache:void 0,signal:this.v.signal};i&&(l.body=i),(this.H||a).fetch(new Request(this.D,l)).then(this.Pa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.A=new Headers,this.status=0,this.v.abort(),this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),this.readyState>=1&&this.g&&this.readyState!=4&&(this.g=!1,gr(this)),this.readyState=0},n.Pa=function(i){if(this.g&&(this.l=i,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=i.headers,this.readyState=2,yr(this)),this.g&&(this.readyState=3,yr(this),this.g)))if(this.responseType==="arraybuffer")i.arrayBuffer().then(this.Na.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in i){if(this.j=i.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.B=new TextDecoder;yu(this)}else i.text().then(this.Oa.bind(this),this.ga.bind(this))};function yu(i){i.j.read().then(i.Ma.bind(i)).catch(i.ga.bind(i))}n.Ma=function(i){if(this.g){if(this.o&&i.value)this.response.push(i.value);else if(!this.o){var l=i.value?i.value:new Uint8Array(0);(l=this.B.decode(l,{stream:!i.done}))&&(this.response=this.responseText+=l)}i.done?gr(this):yr(this),this.readyState==3&&yu(this)}},n.Oa=function(i){this.g&&(this.response=this.responseText=i,gr(this))},n.Na=function(i){this.g&&(this.response=i,gr(this))},n.ga=function(){this.g&&gr(this)};function gr(i){i.readyState=4,i.l=null,i.j=null,i.B=null,yr(i)}n.setRequestHeader=function(i,l){this.A.append(i,l)},n.getResponseHeader=function(i){return this.h&&this.h.get(i.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let i=[],l=this.h.entries();for(var h=l.next();!h.done;)h=h.value,i.push(h[0]+": "+h[1]),h=l.next();return i.join(`\r
`)};function yr(i){i.onreadystatechange&&i.onreadystatechange.call(i)}Object.defineProperty(_s.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(i){this.m=i?"include":"same-origin"}});function wu(i){let l="";return ds(i,function(h,f){l+=f,l+=":",l+=h,l+=`\r
`}),l}function po(i,l,h){e:{for(f in h){var f=!1;break e}f=!0}f||(h=wu(h),typeof i=="string"?h!=null&&lr(h):se(i,l,h))}function ae(i){Se.call(this),this.headers=new Map,this.L=i||null,this.h=!1,this.g=null,this.D="",this.o=0,this.l="",this.j=this.B=this.v=this.A=!1,this.m=null,this.F="",this.H=!1}m(ae,Se);var Km=/^https?$/i,Wm=["POST","PUT"];n=ae.prototype,n.Fa=function(i){this.H=i},n.ea=function(i,l,h,f){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+i);l=l?l.toUpperCase():"GET",this.D=i,this.l="",this.o=0,this.A=!1,this.h=!0,this.g=this.L?this.L.g():Zl.g(),this.g.onreadystatechange=g(d(this.Ca,this));try{this.B=!0,this.g.open(l,String(i),!0),this.B=!1}catch(P){_u(this,P);return}if(i=h||"",h=new Map(this.headers),f)if(Object.getPrototypeOf(f)===Object.prototype)for(var A in f)h.set(A,f[A]);else if(typeof f.keys=="function"&&typeof f.get=="function")for(let P of f.keys())h.set(P,f.get(P));else throw Error("Unknown input type for opt_headers: "+String(f));f=Array.from(h.keys()).find(P=>P.toLowerCase()=="content-type"),A=a.FormData&&i instanceof a.FormData,!(Array.prototype.indexOf.call(Wm,l,void 0)>=0)||f||A||h.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[P,M]of h)this.g.setRequestHeader(P,M);this.F&&(this.g.responseType=this.F),"withCredentials"in this.g&&this.g.withCredentials!==this.H&&(this.g.withCredentials=this.H);try{this.m&&(clearTimeout(this.m),this.m=null),this.v=!0,this.g.send(i),this.v=!1}catch(P){_u(this,P)}};function _u(i,l){i.h=!1,i.g&&(i.j=!0,i.g.abort(),i.j=!1),i.l=l,i.o=5,bu(i),bs(i)}function bu(i){i.A||(i.A=!0,Re(i,"complete"),Re(i,"error"))}n.abort=function(i){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.o=i||7,Re(this,"complete"),Re(this,"abort"),bs(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),bs(this,!0)),ae.Z.N.call(this)},n.Ca=function(){this.u||(this.B||this.v||this.j?vu(this):this.Xa())},n.Xa=function(){vu(this)};function vu(i){if(i.h&&typeof o<"u"){if(i.v&&Nt(i)==4)setTimeout(i.Ca.bind(i),0);else if(Re(i,"readystatechange"),Nt(i)==4){i.h=!1;try{let P=i.ca();e:switch(P){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var l=!0;break e;default:l=!1}var h;if(!(h=l)){var f;if(f=P===0){let M=String(i.D).match(uu)[1]||null;!M&&a.self&&a.self.location&&(M=a.self.location.protocol.slice(0,-1)),f=!Km.test(M?M.toLowerCase():"")}h=f}if(h)Re(i,"complete"),Re(i,"success");else{i.o=6;try{var A=Nt(i)>2?i.g.statusText:""}catch{A=""}i.l=A+" ["+i.ca()+"]",bu(i)}}finally{bs(i)}}}}function bs(i,l){if(i.g){i.m&&(clearTimeout(i.m),i.m=null);let h=i.g;i.g=null,l||Re(i,"ready");try{h.onreadystatechange=null}catch{}}}n.isActive=function(){return!!this.g};function Nt(i){return i.g?i.g.readyState:0}n.ca=function(){try{return Nt(this)>2?this.g.status:-1}catch{return-1}},n.la=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.La=function(i){if(this.g){var l=this.g.responseText;return i&&l.indexOf(i)==0&&(l=l.substring(i.length)),Am(l)}};function Eu(i){try{if(!i.g)return null;if("response"in i.g)return i.g.response;switch(i.F){case"":case"text":return i.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in i.g)return i.g.mozResponseArrayBuffer}return null}catch{return null}}function Qm(i){let l={};i=(i.g&&Nt(i)>=2&&i.g.getAllResponseHeaders()||"").split(`\r
`);for(let f=0;f<i.length;f++){if(w(i[f]))continue;var h=km(i[f]);let A=h[0];if(h=h[1],typeof h!="string")continue;h=h.trim();let P=l[A]||[];l[A]=P,P.push(h)}Em(l,function(f){return f.join(", ")})}n.ya=function(){return this.o},n.Ha=function(){return typeof this.l=="string"?this.l:String(this.l)};function wr(i,l,h){return h&&h.internalChannelParams&&h.internalChannelParams[i]||l}function Iu(i){this.za=0,this.i=[],this.j=new cr,this.ba=this.na=this.J=this.W=this.g=this.wa=this.G=this.H=this.u=this.U=this.o=null,this.Ya=this.V=0,this.Sa=wr("failFast",!1,i),this.F=this.C=this.v=this.m=this.l=null,this.X=!0,this.xa=this.K=-1,this.Y=this.A=this.D=0,this.Qa=wr("baseRetryDelayMs",5e3,i),this.Za=wr("retryDelaySeedMs",1e4,i),this.Ta=wr("forwardChannelMaxRetries",2,i),this.va=wr("forwardChannelRequestTimeoutMs",2e4,i),this.ma=i&&i.xmlHttpFactory||void 0,this.Ua=i&&i.Rb||void 0,this.Aa=i&&i.useFetchStreams||!1,this.O=void 0,this.L=i&&i.supportsCrossDomainXhr||!1,this.M="",this.h=new iu(i&&i.concurrentRequestLimit),this.Ba=new Hm,this.S=i&&i.fastHandshake||!1,this.R=i&&i.encodeInitMessageHeaders||!1,this.S&&this.R&&(this.R=!1),this.Ra=i&&i.Pb||!1,i&&i.ua&&this.j.ua(),i&&i.forceLongPolling&&(this.X=!1),this.aa=!this.S&&this.X&&i&&i.detectBufferingProxy||!1,this.ia=void 0,i&&i.longPollingTimeout&&i.longPollingTimeout>0&&(this.ia=i.longPollingTimeout),this.ta=void 0,this.T=0,this.P=!1,this.ja=this.B=null}n=Iu.prototype,n.ka=8,n.I=1,n.connect=function(i,l,h,f){Ne(0),this.W=i,this.H=l||{},h&&f!==void 0&&(this.H.OSID=h,this.H.OAID=f),this.F=this.X,this.J=Nu(this,null,this.W),Es(this)};function mo(i){if(xu(i),i.I==3){var l=i.V++,h=Xe(i.J);if(se(h,"SID",i.M),se(h,"RID",l),se(h,"TYPE","terminate"),_r(i,h),l=new Pt(i,i.j,l),l.M=2,l.A=ys(Xe(h)),h=!1,a.navigator&&a.navigator.sendBeacon)try{h=a.navigator.sendBeacon(l.A.toString(),"")}catch{}!h&&a.Image&&(new Image().src=l.A,h=!0),h||(l.g=ku(l.j,null),l.g.ea(l.A)),l.F=Date.now(),gs(l)}Ru(i)}function vs(i){i.g&&(go(i),i.g.cancel(),i.g=null)}function xu(i){vs(i),i.v&&(a.clearTimeout(i.v),i.v=null),Is(i),i.h.cancel(),i.m&&(typeof i.m=="number"&&a.clearTimeout(i.m),i.m=null)}function Es(i){if(!ou(i.h)&&!i.m){i.m=!0;var l=i.Ea;F||y(),W||(F(),W=!0),E.add(l,i),i.D=0}}function Xm(i,l){return au(i.h)>=i.h.j-(i.m?1:0)?!1:i.m?(i.i=l.G.concat(i.i),!0):i.I==1||i.I==2||i.D>=(i.Sa?0:i.Ta)?!1:(i.m=ar(d(i.Ea,i,l),Du(i,i.D)),i.D++,!0)}n.Ea=function(i){if(this.m)if(this.m=null,this.I==1){if(!i){this.V=Math.floor(Math.random()*1e5),i=this.V++;let A=new Pt(this,this.j,i),P=this.o;if(this.U&&(P?(P=Vl(P),Ol(P,this.U)):P=this.U),this.u!==null||this.R||(A.J=P,P=null),this.S)e:{for(var l=0,h=0;h<this.i.length;h++){t:{var f=this.i[h];if("__data__"in f.map&&(f=f.map.__data__,typeof f=="string")){f=f.length;break t}f=void 0}if(f===void 0)break;if(l+=f,l>4096){l=h;break e}if(l===4096||h===this.i.length-1){l=h+1;break e}}l=1e3}else l=1e3;l=Su(this,A,l),h=Xe(this.J),se(h,"RID",i),se(h,"CVER",22),this.G&&se(h,"X-HTTP-Session-Id",this.G),_r(this,h),P&&(this.R?l="headers="+lr(wu(P))+"&"+l:this.u&&po(h,this.u,P)),uo(this.h,A),this.Ra&&se(h,"TYPE","init"),this.S?(se(h,"$req",l),se(h,"SID","null"),A.U=!0,oo(A,h,null)):oo(A,h,l),this.I=2}}else this.I==3&&(i?Tu(this,i):this.i.length==0||ou(this.h)||Tu(this))};function Tu(i,l){var h;l?h=l.l:h=i.V++;let f=Xe(i.J);se(f,"SID",i.M),se(f,"RID",h),se(f,"AID",i.K),_r(i,f),i.u&&i.o&&po(f,i.u,i.o),h=new Pt(i,i.j,h,i.D+1),i.u===null&&(h.J=i.o),l&&(i.i=l.G.concat(i.i)),l=Su(i,h,1e3),h.H=Math.round(i.va*.5)+Math.round(i.va*.5*Math.random()),uo(i.h,h),oo(h,f,l)}function _r(i,l){i.H&&ds(i.H,function(h,f){se(l,f,h)}),i.l&&ds({},function(h,f){se(l,f,h)})}function Su(i,l,h){h=Math.min(i.i.length,h);let f=i.l?d(i.l.Ka,i.l,i):null;e:{var A=i.i;let K=-1;for(;;){let we=["count="+h];K==-1?h>0?(K=A[0].g,we.push("ofs="+K)):K=0:we.push("ofs="+K);let te=!0;for(let be=0;be<h;be++){var P=A[be].g;let Je=A[be].map;if(P-=K,P<0)K=Math.max(0,A[be].g-100),te=!1;else try{P="req"+P+"_"||"";try{var M=Je instanceof Map?Je:Object.entries(Je);for(let[en,kt]of M){let Mt=kt;c(kt)&&(Mt=to(kt)),we.push(P+en+"="+encodeURIComponent(Mt))}}catch(en){throw we.push(P+"type="+encodeURIComponent("_badmap")),en}}catch{f&&f(Je)}}if(te){M=we.join("&");break e}}M=void 0}return i=i.i.splice(0,h),l.G=i,M}function Au(i){if(!i.g&&!i.v){i.Y=1;var l=i.Da;F||y(),W||(F(),W=!0),E.add(l,i),i.A=0}}function fo(i){return i.g||i.v||i.A>=3?!1:(i.Y++,i.v=ar(d(i.Da,i),Du(i,i.A)),i.A++,!0)}n.Da=function(){if(this.v=null,Cu(this),this.aa&&!(this.P||this.g==null||this.T<=0)){var i=4*this.T;this.j.info("BP detection timer enabled: "+i),this.B=ar(d(this.Wa,this),i)}},n.Wa=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.P=!0,Ne(10),vs(this),Cu(this))};function go(i){i.B!=null&&(a.clearTimeout(i.B),i.B=null)}function Cu(i){i.g=new Pt(i,i.j,"rpc",i.Y),i.u===null&&(i.g.J=i.o),i.g.P=0;var l=Xe(i.na);se(l,"RID","rpc"),se(l,"SID",i.M),se(l,"AID",i.K),se(l,"CI",i.F?"0":"1"),!i.F&&i.ia&&se(l,"TO",i.ia),se(l,"TYPE","xmlhttp"),_r(i,l),i.u&&i.o&&po(l,i.u,i.o),i.O&&(i.g.H=i.O);var h=i.g;i=i.ba,h.M=1,h.A=ys(Xe(l)),h.u=null,h.R=!0,nu(h,i)}n.Va=function(){this.C!=null&&(this.C=null,vs(this),fo(this),Ne(19))};function Is(i){i.C!=null&&(a.clearTimeout(i.C),i.C=null)}function Pu(i,l){var h=null;if(i.g==l){Is(i),go(i),i.g=null;var f=2}else if(lo(i.h,l))h=l.G,cu(i.h,l),f=1;else return;if(i.I!=0){if(l.o)if(f==1){h=l.u?l.u.length:0,l=Date.now()-l.F;var A=i.D;f=ms(),Re(f,new Jl(f,h)),Es(i)}else Au(i);else if(A=l.m,A==3||A==0&&l.X>0||!(f==1&&Xm(i,l)||f==2&&fo(i)))switch(h&&h.length>0&&(l=i.h,l.i=l.i.concat(h)),A){case 1:Zt(i,5);break;case 4:Zt(i,10);break;case 3:Zt(i,6);break;default:Zt(i,2)}}}function Du(i,l){let h=i.Qa+Math.floor(Math.random()*i.Za);return i.isActive()||(h*=2),h*l}function Zt(i,l){if(i.j.info("Error code "+l),l==2){var h=d(i.bb,i),f=i.Ua;let A=!f;f=new Dt(f||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||dr(f,"https"),ys(f),A?jm(f.toString(),h):Gm(f.toString(),h)}else Ne(2);i.I=0,i.l&&i.l.pa(l),Ru(i),xu(i)}n.bb=function(i){i?(this.j.info("Successfully pinged google.com"),Ne(2)):(this.j.info("Failed to ping google.com"),Ne(1))};function Ru(i){if(i.I=0,i.ja=[],i.l){let l=lu(i.h);(l.length!=0||i.i.length!=0)&&(S(i.ja,l),S(i.ja,i.i),i.h.i.length=0,b(i.i),i.i.length=0),i.l.oa()}}function Nu(i,l,h){var f=h instanceof Dt?Xe(h):new Dt(h);if(f.g!="")l&&(f.g=l+"."+f.g),hr(f,f.u);else{var A=a.location;f=A.protocol,l=l?l+"."+A.hostname:A.hostname,A=+A.port;let P=new Dt(null);f&&dr(P,f),l&&(P.g=l),A&&hr(P,A),h&&(P.h=h),f=P}return h=i.G,l=i.wa,h&&l&&se(f,h,l),se(f,"VER",i.ka),_r(i,f),f}function ku(i,l,h){if(l&&!i.L)throw Error("Can't create secondary domain capable XhrIo object.");return l=i.Aa&&!i.ma?new ae(new ws({ab:h})):new ae(i.ma),l.Fa(i.L),l}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function Mu(){}n=Mu.prototype,n.ra=function(){},n.qa=function(){},n.pa=function(){},n.oa=function(){},n.isActive=function(){return!0},n.Ka=function(){};function xs(){}xs.prototype.g=function(i,l){return new Be(i,l)};function Be(i,l){Se.call(this),this.g=new Iu(l),this.l=i,this.h=l&&l.messageUrlParams||null,i=l&&l.messageHeaders||null,l&&l.clientProtocolHeaderRequired&&(i?i["X-Client-Protocol"]="webchannel":i={"X-Client-Protocol":"webchannel"}),this.g.o=i,i=l&&l.initMessageHeaders||null,l&&l.messageContentType&&(i?i["X-WebChannel-Content-Type"]=l.messageContentType:i={"X-WebChannel-Content-Type":l.messageContentType}),l&&l.sa&&(i?i["X-WebChannel-Client-Profile"]=l.sa:i={"X-WebChannel-Client-Profile":l.sa}),this.g.U=i,(i=l&&l.Qb)&&!w(i)&&(this.g.u=i),this.A=l&&l.supportsCrossDomainXhr||!1,this.v=l&&l.sendRawJson||!1,(l=l&&l.httpSessionIdParam)&&!w(l)&&(this.g.G=l,i=this.h,i!==null&&l in i&&(i=this.h,l in i&&delete i[l])),this.j=new In(this)}m(Be,Se),Be.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.L=!0),this.g.connect(this.l,this.h||void 0)},Be.prototype.close=function(){mo(this.g)},Be.prototype.o=function(i){var l=this.g;if(typeof i=="string"){var h={};h.__data__=i,i=h}else this.v&&(h={},h.__data__=to(i),i=h);l.i.push(new Lm(l.Ya++,i)),l.I==3&&Es(l)},Be.prototype.N=function(){this.g.l=null,delete this.j,mo(this.g),delete this.g,Be.Z.N.call(this)};function Vu(i){no.call(this),i.__headers__&&(this.headers=i.__headers__,this.statusCode=i.__status__,delete i.__headers__,delete i.__status__);var l=i.__sm__;if(l){e:{for(let h in l){i=h;break e}i=void 0}(this.i=i)&&(i=this.i,l=l!==null&&i in l?l[i]:void 0),this.data=l}else this.data=i}m(Vu,no);function Lu(){ro.call(this),this.status=1}m(Lu,ro);function In(i){this.g=i}m(In,Mu),In.prototype.ra=function(){Re(this.g,"a")},In.prototype.qa=function(i){Re(this.g,new Vu(i))},In.prototype.pa=function(i){Re(this.g,new Lu)},In.prototype.oa=function(){Re(this.g,"b")},xs.prototype.createWebChannel=xs.prototype.g,Be.prototype.send=Be.prototype.o,Be.prototype.open=Be.prototype.m,Be.prototype.close=Be.prototype.close,Xo=yt.createWebChannelTransport=function(){return new xs},Qo=yt.getStatEventTarget=function(){return ms()},Wo=yt.Event=Xt,$s=yt.Stat={jb:0,mb:1,nb:2,Hb:3,Mb:4,Jb:5,Kb:6,Ib:7,Gb:8,Lb:9,PROXY:10,NOPROXY:11,Eb:12,Ab:13,Bb:14,zb:15,Cb:16,Db:17,fb:18,eb:19,gb:20},fs.NO_ERROR=0,fs.TIMEOUT=8,fs.HTTP_ERROR=6,Cr=yt.ErrorCode=fs,Yl.COMPLETE="complete",Ko=yt.EventType=Yl,Kl.EventType=ir,ir.OPEN="a",ir.CLOSE="b",ir.ERROR="c",ir.MESSAGE="d",Se.prototype.listen=Se.prototype.J,Cn=yt.WebChannel=Kl,fg=yt.FetchXmlHttpFactory=ws,ae.prototype.listenOnce=ae.prototype.K,ae.prototype.getLastError=ae.prototype.Ha,ae.prototype.getLastErrorCode=ae.prototype.ya,ae.prototype.getStatus=ae.prototype.ca,ae.prototype.getResponseJson=ae.prototype.La,ae.prototype.getResponseText=ae.prototype.la,ae.prototype.send=ae.prototype.ea,ae.prototype.setWithCredentials=ae.prototype.Fa,Ho=yt.XhrIo=ae}).apply(typeof Bs<"u"?Bs:typeof self<"u"?self:typeof window<"u"?window:{})});function Pn(){return un.logLevel}function V(n,...e){if(un.logLevel<=Y.DEBUG){let t=e.map(Bc);un.debug(`Firestore (${Jn}): ${n}`,...t)}}function wt(n,...e){if(un.logLevel<=Y.ERROR){let t=e.map(Bc);un.error(`Firestore (${Jn}): ${n}`,...t)}}function Ln(n,...e){if(un.logLevel<=Y.WARN){let t=e.map(Bc);un.warn(`Firestore (${Jn}): ${n}`,...t)}}function Bc(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function q(n,e,t){let r="Unexpected state";typeof e=="string"?r=e:t=e,ph(n,r,t)}function ph(n,e,t){let r=`FIRESTORE (${Jn}) INTERNAL ASSERTION FAILED: ${e} (ID: ${n.toString(16)})`;if(t!==void 0)try{r+=" CONTEXT: "+JSON.stringify(t)}catch{r+=" CONTEXT: "+t}throw wt(r),new Error(r)}function ee(n,e,t,r){let s="Unexpected state";typeof t=="string"?s=t:r=t,n||ph(e,s,r)}function j(n,e){return n}function gg(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}function X(n,e){return n<e?-1:n>e?1:0}function ca(n,e){let t=Math.min(n.length,e.length);for(let r=0;r<t;r++){let s=n.charAt(r),o=e.charAt(r);if(s!==o)return Jo(s)===Jo(o)?X(s,o):Jo(s)?1:-1}return X(n.length,e.length)}function Jo(n){let e=n.charCodeAt(0);return e>=yg&&e<=wg}function On(n,e,t){return n.length===e.length&&n.every((r,s)=>t(r,e[s]))}function bg(n,e,t){if(!t)throw new $(R.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function vg(n,e,t,r){if(e===!0&&r===!0)throw new $(R.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function Dd(n){if(!U.isDocumentKey(n))throw new $(R.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function mh(n){return typeof n=="object"&&n!==null&&(Object.getPrototypeOf(n)===Object.prototype||Object.getPrototypeOf(n)===null)}function $c(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":q(12329,{type:typeof n})}function Lr(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new $(R.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=$c(n);throw new $(R.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function ge(n,e){let t={typeString:n};return e&&(t.value=e),t}function Xr(n,e){if(!mh(n))throw new $(R.INVALID_ARGUMENT,"JSON must be an object");let t;for(let r in e)if(e[r]){let s=e[r].typeString,o="value"in e[r]?{value:e[r].value}:void 0;if(!(r in n)){t=`JSON missing required field: '${r}'`;break}let a=n[r];if(s&&typeof a!==s){t=`JSON field '${r}' must be a ${s}.`;break}if(o!==void 0&&a!==o.value){t=`Expected '${r}' field to equal '${o.value}'`;break}}if(t)throw new $(R.INVALID_ARGUMENT,t);return!0}function Eg(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,s=G.fromTimestamp(r===1e9?new ye(t+1,0):new ye(t,r));return new dn(s,U.empty(),e)}function Ig(n){return new dn(n.readTime,n.key,Or)}function xg(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=U.comparator(n.documentKey,e.documentKey),t!==0?t:X(n.largestBatchId,e.largestBatchId))}async function Yn(n){if(n.code!==R.FAILED_PRECONDITION||n.message!==Tg)throw n;V("LocalStore","Unexpectedly lost primary lease")}function Sg(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}function Zn(n){return n.name==="IndexedDbTransactionError"}function xi(n){return n==null}function Fr(n){return n===0&&1/n==-1/0}function Ag(n){return typeof n=="number"&&Number.isInteger(n)&&!Fr(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function Cg(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=kd(e)),e=Pg(n.get(t),e);return kd(e)}function Pg(n,e){let t=e,r=n.length;for(let s=0;s<r;s++){let o=n.charAt(s);switch(o){case"\0":t+="";break;case fh:t+="";break;default:t+=o}}return t}function kd(n){return n+fh+""}function Md(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function gn(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function Ph(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function _t(n){if(ee(!!n,39018),typeof n=="string"){let e=0,t=$g.exec(n);if(ee(!!t,46558,{timestamp:n}),t[1]){let s=t[1];s=(s+"000000000").substr(0,9),e=Number(s)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:ie(n.seconds),nanos:ie(n.nanos)}}function ie(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function bt(n){return typeof n=="string"?Ce.fromBase64String(n):Ce.fromUint8Array(n)}function Uc(n){return(n?.mapValue?.fields||{})[Rh]?.stringValue===Dh}function Ti(n){let e=n.mapValue.fields[Nh];return Uc(e)?Ti(e):e}function Br(n){let e=_t(n.mapValue.fields[kh].timestampValue);return new ye(e.seconds,e.nanos)}function jt(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?Uc(n)?4:Lh(n)?9007199254740991:Vh(n)?10:11:q(28295,{value:n})}function st(n,e){if(n===e)return!0;let t=jt(n);if(t!==jt(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return Br(n).isEqual(Br(e));case 3:return function(s,o){if(typeof s.timestampValue=="string"&&typeof o.timestampValue=="string"&&s.timestampValue.length===o.timestampValue.length)return s.timestampValue===o.timestampValue;let a=_t(s.timestampValue),c=_t(o.timestampValue);return a.seconds===c.seconds&&a.nanos===c.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(s,o){return bt(s.bytesValue).isEqual(bt(o.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(s,o){return ie(s.geoPointValue.latitude)===ie(o.geoPointValue.latitude)&&ie(s.geoPointValue.longitude)===ie(o.geoPointValue.longitude)}(n,e);case 2:return function(s,o){if("integerValue"in s&&"integerValue"in o)return ie(s.integerValue)===ie(o.integerValue);if("doubleValue"in s&&"doubleValue"in o){let a=ie(s.doubleValue),c=ie(o.doubleValue);return a===c?Fr(a)===Fr(c):isNaN(a)&&isNaN(c)}return!1}(n,e);case 9:return On(n.arrayValue.values||[],e.arrayValue.values||[],st);case 10:case 11:return function(s,o){let a=s.mapValue.fields||{},c=o.mapValue.fields||{};if(Md(a)!==Md(c))return!1;for(let u in a)if(a.hasOwnProperty(u)&&(c[u]===void 0||!st(a[u],c[u])))return!1;return!0}(n,e);default:return q(52216,{left:n})}}function $r(n,e){return(n.values||[]).find(t=>st(t,e))!==void 0}function $n(n,e){if(n===e)return 0;let t=jt(n),r=jt(e);if(t!==r)return X(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return X(n.booleanValue,e.booleanValue);case 2:return function(o,a){let c=ie(o.integerValue||o.doubleValue),u=ie(a.integerValue||a.doubleValue);return c<u?-1:c>u?1:c===u?0:isNaN(c)?isNaN(u)?0:-1:1}(n,e);case 3:return Vd(n.timestampValue,e.timestampValue);case 4:return Vd(Br(n),Br(e));case 5:return ca(n.stringValue,e.stringValue);case 6:return function(o,a){let c=bt(o),u=bt(a);return c.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(o,a){let c=o.split("/"),u=a.split("/");for(let d=0;d<c.length&&d<u.length;d++){let p=X(c[d],u[d]);if(p!==0)return p}return X(c.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(o,a){let c=X(ie(o.latitude),ie(a.latitude));return c!==0?c:X(ie(o.longitude),ie(a.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return Ld(n.arrayValue,e.arrayValue);case 10:return function(o,a){let c=o.fields||{},u=a.fields||{},d=c[Bn]?.arrayValue,p=u[Bn]?.arrayValue,m=X(d?.values?.length||0,p?.values?.length||0);return m!==0?m:Ld(d,p)}(n.mapValue,e.mapValue);case 11:return function(o,a){if(o===qs.mapValue&&a===qs.mapValue)return 0;if(o===qs.mapValue)return 1;if(a===qs.mapValue)return-1;let c=o.fields||{},u=Object.keys(c),d=a.fields||{},p=Object.keys(d);u.sort(),p.sort();for(let m=0;m<u.length&&m<p.length;++m){let g=ca(u[m],p[m]);if(g!==0)return g;let b=$n(c[u[m]],d[p[m]]);if(b!==0)return b}return X(u.length,p.length)}(n.mapValue,e.mapValue);default:throw q(23264,{he:t})}}function Vd(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return X(n,e);let t=_t(n),r=_t(e),s=X(t.seconds,r.seconds);return s!==0?s:X(t.nanos,r.nanos)}function Ld(n,e){let t=n.values||[],r=e.values||[];for(let s=0;s<t.length&&s<r.length;++s){let o=$n(t[s],r[s]);if(o)return o}return X(t.length,r.length)}function qn(n){return ha(n)}function ha(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=_t(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return bt(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return U.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",s=!0;for(let o of t.values||[])s?s=!1:r+=",",r+=ha(o);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),s="{",o=!0;for(let a of r)o?o=!1:s+=",",s+=`${a}:${ha(t.fields[a])}`;return s+"}"}(n.mapValue):q(61005,{value:n})}function js(n){switch(jt(n)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let e=Ti(n);return e?16+js(e):16;case 5:return 2*n.stringValue.length;case 6:return bt(n.bytesValue).approximateByteSize();case 7:return n.referenceValue.length;case 9:return function(r){return(r.values||[]).reduce((s,o)=>s+js(o),0)}(n.arrayValue);case 10:case 11:return function(r){let s=0;return gn(r.fields,(o,a)=>{s+=o.length+js(a)}),s}(n.mapValue);default:throw q(13486,{value:n})}}function pa(n){return!!n&&"integerValue"in n}function Gc(n){return!!n&&"arrayValue"in n}function Od(n){return!!n&&"nullValue"in n}function Fd(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function Gs(n){return!!n&&"mapValue"in n}function Vh(n){return(n?.mapValue?.fields||{})[zc]?.stringValue===jc}function Dr(n){if(n.geoPointValue)return{geoPointValue:{...n.geoPointValue}};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:{...n.timestampValue}};if(n.mapValue){let e={mapValue:{fields:{}}};return gn(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=Dr(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=Dr(n.arrayValue.values[t]);return e}return{...n}}function Lh(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue===Mh}function Oh(n){let e=[];return gn(n.fields,(t,r)=>{let s=new $e([t]);if(Gs(r)){let o=Oh(r.mapValue).fields;if(o.length===0)e.push(s);else for(let a of o)e.push(s.child(a))}else e.push(s)}),new Ze(e)}function Bd(n,e,t){let r=0;for(let s=0;s<n.position.length;s++){let o=e[s],a=n.position[s];if(o.field.isKeyField()?r=U.comparator(U.fromName(a.referenceValue),t.key):r=$n(a,t.data.field(o.field)),o.dir==="desc"&&(r*=-1),r!==0)break}return r}function $d(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!st(n.position[t],e.position[t]))return!1;return!0}function qg(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}function Fh(n){return n.op==="and"}function Bh(n){return Ug(n)&&Fh(n)}function Ug(n){for(let e of n.filters)if(e instanceof it)return!1;return!0}function ma(n){if(n instanceof _e)return n.field.canonicalString()+n.op.toString()+qn(n.value);if(Bh(n))return n.filters.map(e=>ma(e)).join(",");{let e=n.filters.map(t=>ma(t)).join(",");return`${n.op}(${e})`}}function $h(n,e){return n instanceof _e?function(r,s){return s instanceof _e&&r.op===s.op&&r.field.isEqual(s.field)&&st(r.value,s.value)}(n,e):n instanceof it?function(r,s){return s instanceof it&&r.op===s.op&&r.filters.length===s.filters.length?r.filters.reduce((o,a,c)=>o&&$h(a,s.filters[c]),!0):!1}(n,e):void q(19439)}function qh(n){return n instanceof _e?function(t){return`${t.field.canonicalString()} ${t.op} ${qn(t.value)}`}(n):n instanceof it?function(t){return t.op.toString()+" {"+t.getFilters().map(qh).join(" ,")+"}"}(n):"Filter"}function Uh(n,e){return(e.arrayValue?.values||[]).map(t=>U.fromName(t.referenceValue))}function qd(n,e=null,t=[],r=[],s=null,o=null,a=null){return new Ea(n,e,t,r,s,o,a)}function Hc(n){let e=j(n);if(e.Te===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>ma(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(o){return o.field.canonicalString()+o.dir}(r)).join(","),xi(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>qn(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>qn(r)).join(",")),e.Te=t}return e.Te}function Kc(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!qg(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!$h(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!$d(n.startAt,e.startAt)&&$d(n.endAt,e.endAt)}function Ia(n){return U.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function zg(n,e,t,r,s,o,a,c){return new jn(n,e,t,r,s,o,a,c)}function Wc(n){return new jn(n)}function Ud(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function jg(n){return n.collectionGroup!==null}function Rr(n){let e=j(n);if(e.Ie===null){e.Ie=[];let t=new Set;for(let o of e.explicitOrderBy)e.Ie.push(o),t.add(o.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(a){let c=new Ee($e.comparator);return a.filters.forEach(u=>{u.getFlattenedFilters().forEach(d=>{d.isInequality()&&(c=c.add(d.field))})}),c})(e).forEach(o=>{t.has(o.canonicalString())||o.isKeyField()||e.Ie.push(new zn(o,r))}),t.has($e.keyField().canonicalString())||e.Ie.push(new zn($e.keyField(),r))}return e.Ie}function nt(n){let e=j(n);return e.Ee||(e.Ee=Gg(e,Rr(n))),e.Ee}function Gg(n,e){if(n.limitType==="F")return qd(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(s=>{let o=s.dir==="desc"?"asc":"desc";return new zn(s.field,o)});let t=n.endAt?new Un(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Un(n.startAt.position,n.startAt.inclusive):null;return qd(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function xa(n,e,t){return new jn(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function Si(n,e){return Kc(nt(n),nt(e))&&n.limitType===e.limitType}function zh(n){return`${Hc(nt(n))}|lt:${n.limitType}`}function Dn(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(s=>qh(s)).join(", ")}]`),xi(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(s=>function(a){return`${a.field.canonicalString()} (${a.dir})`}(s)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(s=>qn(s)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(s=>qn(s)).join(",")),`Target(${r})`}(nt(n))}; limitType=${n.limitType})`}function Ai(n,e){return e.isFoundDocument()&&function(r,s){let o=s.key.path;return r.collectionGroup!==null?s.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(o):U.isDocumentKey(r.path)?r.path.isEqual(o):r.path.isImmediateParentOf(o)}(n,e)&&function(r,s){for(let o of Rr(r))if(!o.field.isKeyField()&&s.data.field(o.field)===null)return!1;return!0}(n,e)&&function(r,s){for(let o of r.filters)if(!o.matches(s))return!1;return!0}(n,e)&&function(r,s){return!(r.startAt&&!function(a,c,u){let d=Bd(a,c,u);return a.inclusive?d<=0:d<0}(r.startAt,Rr(r),s)||r.endAt&&!function(a,c,u){let d=Bd(a,c,u);return a.inclusive?d>=0:d>0}(r.endAt,Rr(r),s))}(n,e)}function Hg(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function jh(n){return(e,t)=>{let r=!1;for(let s of Rr(n)){let o=Kg(s,e,t);if(o!==0)return o;r=r||s.field.isKeyField()}return 0}}function Kg(n,e,t){let r=n.field.isKeyField()?U.comparator(e.key,t.key):function(o,a,c){let u=a.data.field(o),d=c.data.field(o);return u!==null&&d!==null?$n(u,d):q(42886)}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return q(19790,{direction:n.dir})}}function Et(){return Wg}function Pr(...n){let e=Gh;for(let t of n)e=e.insert(t.key,t);return e}function Hh(n){let e=Gh;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function sn(){return Nr()}function Kh(){return Nr()}function Nr(){return new vt(n=>n.toString(),(n,e)=>n.isEqual(e))}function J(...n){let e=Xg;for(let t of n)e=e.add(t);return e}function Yg(){return Jg}function Qc(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Fr(e)?"-0":e}}function Wh(n){return{integerValue:""+n}}function Zg(n,e){return Ag(e)?Wh(e):Qc(n,e)}function ey(n,e,t){return n instanceof Hn?function(s,o){let a={fields:{[Rh]:{stringValue:Dh},[kh]:{timestampValue:{seconds:s.seconds,nanos:s.nanoseconds}}}};return o&&Uc(o)&&(o=Ti(o)),o&&(a.fields[Nh]=o),{mapValue:a}}(t,e):n instanceof hn?Xh(n,e):n instanceof pn?Jh(n,e):function(s,o){let a=Qh(s,o),c=zd(a)+zd(s.Ae);return pa(a)&&pa(s.Ae)?Wh(c):Qc(s.serializer,c)}(n,e)}function ty(n,e,t){return n instanceof hn?Xh(n,e):n instanceof pn?Jh(n,e):t}function Qh(n,e){return n instanceof Kn?function(r){return pa(r)||function(o){return!!o&&"doubleValue"in o}(r)}(e)?e:{integerValue:0}:null}function Xh(n,e){let t=Yh(e);for(let r of n.elements)t.some(s=>st(s,r))||t.push(r);return{arrayValue:{values:t}}}function Jh(n,e){let t=Yh(e);for(let r of n.elements)t=t.filter(s=>!st(s,r));return{arrayValue:{values:t}}}function zd(n){return ie(n.integerValue||n.doubleValue)}function Yh(n){return Gc(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}function ny(n,e){return n.field.isEqual(e.field)&&function(r,s){return r instanceof hn&&s instanceof hn||r instanceof pn&&s instanceof pn?On(r.elements,s.elements,st):r instanceof Kn&&s instanceof Kn?st(r.Ae,s.Ae):r instanceof Hn&&s instanceof Hn}(n.transform,e.transform)}function Hs(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}function Zh(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new ti(n.key,cn.none()):new mn(n.key,n.data,cn.none());{let t=n.data,r=Ke.empty(),s=new Ee($e.comparator);for(let o of e.fields)if(!s.has(o)){let a=t.field(o);a===null&&o.length>1&&(o=o.popLast(),a=t.field(o)),a===null?r.delete(o):r.set(o,a),s=s.add(o)}return new It(n.key,r,new Ze(s.toArray()),cn.none())}}function ry(n,e,t){n instanceof mn?function(s,o,a){let c=s.value.clone(),u=Gd(s.fieldTransforms,o,a.transformResults);c.setAll(u),o.convertToFoundDocument(a.version,c).setHasCommittedMutations()}(n,e,t):n instanceof It?function(s,o,a){if(!Hs(s.precondition,o))return void o.convertToUnknownDocument(a.version);let c=Gd(s.fieldTransforms,o,a.transformResults),u=o.data;u.setAll(ep(s)),u.setAll(c),o.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(n,e,t):function(s,o,a){o.convertToNoDocument(a.version).setHasCommittedMutations()}(0,e,t)}function kr(n,e,t,r){return n instanceof mn?function(o,a,c,u){if(!Hs(o.precondition,a))return c;let d=o.value.clone(),p=Hd(o.fieldTransforms,u,a);return d.setAll(p),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(n,e,t,r):n instanceof It?function(o,a,c,u){if(!Hs(o.precondition,a))return c;let d=Hd(o.fieldTransforms,u,a),p=a.data;return p.setAll(ep(o)),p.setAll(d),a.convertToFoundDocument(a.version,p).setHasLocalMutations(),c===null?null:c.unionWith(o.fieldMask.fields).unionWith(o.fieldTransforms.map(m=>m.field))}(n,e,t,r):function(o,a,c){return Hs(o.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):c}(n,e,t)}function sy(n,e){let t=null;for(let r of n.fieldTransforms){let s=e.data.field(r.field),o=Qh(r.transform,s||null);o!=null&&(t===null&&(t=Ke.empty()),t.set(r.field,o))}return t||null}function jd(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,s){return r===void 0&&s===void 0||!(!r||!s)&&On(r,s,(o,a)=>ny(o,a))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}function ep(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function Gd(n,e,t){let r=new Map;ee(n.length===t.length,32656,{Re:t.length,Ve:n.length});for(let s=0;s<t.length;s++){let o=n[s],a=o.transform,c=e.data.field(o.field);r.set(o.field,ty(a,c,t[s]))}return r}function Hd(n,e,t){let r=new Map;for(let s of n){let o=s.transform,a=t.data.field(s.field);r.set(s.field,ey(o,a,e))}return r}function iy(n){switch(n){case R.OK:return q(64938);case R.CANCELLED:case R.UNKNOWN:case R.DEADLINE_EXCEEDED:case R.RESOURCE_EXHAUSTED:case R.INTERNAL:case R.UNAVAILABLE:case R.UNAUTHENTICATED:return!1;case R.INVALID_ARGUMENT:case R.NOT_FOUND:case R.ALREADY_EXISTS:case R.PERMISSION_DENIED:case R.FAILED_PRECONDITION:case R.ABORTED:case R.OUT_OF_RANGE:case R.UNIMPLEMENTED:case R.DATA_LOSS:return!0;default:return q(15467,{code:n})}}function tp(n){if(n===void 0)return wt("GRPC error has no .code"),R.UNKNOWN;switch(n){case me.OK:return R.OK;case me.CANCELLED:return R.CANCELLED;case me.UNKNOWN:return R.UNKNOWN;case me.DEADLINE_EXCEEDED:return R.DEADLINE_EXCEEDED;case me.RESOURCE_EXHAUSTED:return R.RESOURCE_EXHAUSTED;case me.INTERNAL:return R.INTERNAL;case me.UNAVAILABLE:return R.UNAVAILABLE;case me.UNAUTHENTICATED:return R.UNAUTHENTICATED;case me.INVALID_ARGUMENT:return R.INVALID_ARGUMENT;case me.NOT_FOUND:return R.NOT_FOUND;case me.ALREADY_EXISTS:return R.ALREADY_EXISTS;case me.PERMISSION_DENIED:return R.PERMISSION_DENIED;case me.FAILED_PRECONDITION:return R.FAILED_PRECONDITION;case me.ABORTED:return R.ABORTED;case me.OUT_OF_RANGE:return R.OUT_OF_RANGE;case me.UNIMPLEMENTED:return R.UNIMPLEMENTED;case me.DATA_LOSS:return R.DATA_LOSS;default:return q(39323,{code:n})}}function ay(){return new TextEncoder}function Kd(n){let e=ay().encode(n),t=new Go;return t.update(e),new Uint8Array(t.digest())}function Wd(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),s=e.getUint32(8,!0),o=e.getUint32(12,!0);return[new gt([t,r],0),new gt([s,o],0)]}function Us(){return new de(U.comparator)}function Qd(){return new de(U.comparator)}function Ma(n,e){return n.useProto3Json||xi(e)?e:{value:e}}function oi(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function np(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function hy(n,e){return oi(n,e.toTimestamp())}function rt(n){return ee(!!n,49232),G.fromTimestamp(function(t){let r=_t(t);return new ye(r.seconds,r.nanos)}(n))}function Xc(n,e){return Va(n,e).canonicalString()}function Va(n,e){let t=function(s){return new pe(["projects",s.projectId,"databases",s.database])}(n).child("documents");return e===void 0?t:t.child(e)}function rp(n){let e=pe.fromString(n);return ee(cp(e),10190,{key:e.toString()}),e}function La(n,e){return Xc(n.databaseId,e.path)}function Yo(n,e){let t=rp(e);if(t.get(1)!==n.databaseId.projectId)throw new $(R.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new $(R.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new U(ip(t))}function sp(n,e){return Xc(n.databaseId,e)}function py(n){let e=rp(n);return e.length===4?pe.emptyPath():ip(e)}function Oa(n){return new pe(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function ip(n){return ee(n.length>4&&n.get(4)==="documents",29091,{key:n.toString()}),n.popFirst(5)}function Xd(n,e,t){return{name:La(n,e),fields:t.value.mapValue.fields}}function my(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(d){return d==="NO_CHANGE"?0:d==="ADD"?1:d==="REMOVE"?2:d==="CURRENT"?3:d==="RESET"?4:q(39313,{state:d})}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],o=function(d,p){return d.useProto3Json?(ee(p===void 0||typeof p=="string",58123),Ce.fromBase64String(p||"")):(ee(p===void 0||p instanceof Buffer||p instanceof Uint8Array,16193),Ce.fromUint8Array(p||new Uint8Array))}(n,e.targetChange.resumeToken),a=e.targetChange.cause,c=a&&function(d){let p=d.code===void 0?R.UNKNOWN:tp(d.code);return new $(p,d.message||"")}(a);t=new si(r,s,o,c||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let s=Yo(n,r.document.name),o=rt(r.document.updateTime),a=r.document.createTime?rt(r.document.createTime):G.min(),c=new Ke({mapValue:{fields:r.document.fields}}),u=We.newFoundDocument(s,o,a,c),d=r.targetIds||[],p=r.removedTargetIds||[];t=new Mn(d,p,u.key,u)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let s=Yo(n,r.document),o=r.readTime?rt(r.readTime):G.min(),a=We.newNoDocument(s,o),c=r.removedTargetIds||[];t=new Mn([],c,a.key,a)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let s=Yo(n,r.document),o=r.removedTargetIds||[];t=new Mn([],o,s,null)}else{if(!("filter"in e))return q(11601,{Rt:e});{e.filter;let r=e.filter;r.targetId;let{count:s=0,unchangedNames:o}=r,a=new Da(s,o),c=r.targetId;t=new ri(c,a)}}return t}function fy(n,e){let t;if(e instanceof mn)t={update:Xd(n,e.key,e.value)};else if(e instanceof ti)t={delete:La(n,e.key)};else if(e instanceof It)t={update:Xd(n,e.key,e.data),updateMask:xy(e.fieldMask)};else{if(!(e instanceof Sa))return q(16599,{Vt:e.type});t={verify:La(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(o,a){let c=a.transform;if(c instanceof Hn)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(c instanceof hn)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:c.elements}};if(c instanceof pn)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:c.elements}};if(c instanceof Kn)return{fieldPath:a.field.canonicalString(),increment:c.Ae};throw q(20930,{transform:a.transform})}(0,r))),e.precondition.isNone||(t.currentDocument=function(s,o){return o.updateTime!==void 0?{updateTime:hy(s,o.updateTime)}:o.exists!==void 0?{exists:o.exists}:q(27497)}(n,e.precondition)),t}function gy(n,e){return n&&n.length>0?(ee(e!==void 0,14353),n.map(t=>function(s,o){let a=s.updateTime?rt(s.updateTime):rt(o);return a.isEqual(G.min())&&(a=rt(o)),new Ta(a,s.transformResults||[])}(t,e))):[]}function yy(n,e){return{documents:[sp(n,e.path)]}}function wy(n,e){let t={structuredQuery:{}},r=e.path,s;e.collectionGroup!==null?(s=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(s=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=sp(n,s);let o=function(d){if(d.length!==0)return ap(it.create(d,"and"))}(e.filters);o&&(t.structuredQuery.where=o);let a=function(d){if(d.length!==0)return d.map(p=>function(g){return{field:Rn(g.field),direction:vy(g.dir)}}(p))}(e.orderBy);a&&(t.structuredQuery.orderBy=a);let c=Ma(n,e.limit);return c!==null&&(t.structuredQuery.limit=c),e.startAt&&(t.structuredQuery.startAt=function(d){return{before:d.inclusive,values:d.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(d){return{before:!d.inclusive,values:d.position}}(e.endAt)),{ft:t,parent:s}}function _y(n){let e=py(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,s=null;if(r>0){ee(r===1,65062);let p=t.from[0];p.allDescendants?s=p.collectionId:e=e.child(p.collectionId)}let o=[];t.where&&(o=function(m){let g=op(m);return g instanceof it&&Bh(g)?g.getFilters():[g]}(t.where));let a=[];t.orderBy&&(a=function(m){return m.map(g=>function(S){return new zn(Nn(S.field),function(C){switch(C){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(S.direction))}(g))}(t.orderBy));let c=null;t.limit&&(c=function(m){let g;return g=typeof m=="object"?m.value:m,xi(g)?null:g}(t.limit));let u=null;t.startAt&&(u=function(m){let g=!!m.before,b=m.values||[];return new Un(b,g)}(t.startAt));let d=null;return t.endAt&&(d=function(m){let g=!m.before,b=m.values||[];return new Un(b,g)}(t.endAt)),zg(e,s,a,o,c,"F",u,d)}function by(n,e){let t=function(s){switch(s){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return q(28987,{purpose:s})}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function op(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=Nn(t.unaryFilter.field);return _e.create(r,"==",{doubleValue:NaN});case"IS_NULL":let s=Nn(t.unaryFilter.field);return _e.create(s,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let o=Nn(t.unaryFilter.field);return _e.create(o,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let a=Nn(t.unaryFilter.field);return _e.create(a,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return q(61313);default:return q(60726)}}(n):n.fieldFilter!==void 0?function(t){return _e.create(Nn(t.fieldFilter.field),function(s){switch(s){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return q(58110);default:return q(50506)}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return it.create(t.compositeFilter.filters.map(r=>op(r)),function(s){switch(s){case"AND":return"and";case"OR":return"or";default:return q(1026)}}(t.compositeFilter.op))}(n):q(30097,{filter:n})}function vy(n){return ly[n]}function Ey(n){return uy[n]}function Iy(n){return dy[n]}function Rn(n){return{fieldPath:n.canonicalString()}}function Nn(n){return $e.fromServerFormat(n.fieldPath)}function ap(n){return n instanceof _e?function(t){if(t.op==="=="){if(Fd(t.value))return{unaryFilter:{field:Rn(t.field),op:"IS_NAN"}};if(Od(t.value))return{unaryFilter:{field:Rn(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(Fd(t.value))return{unaryFilter:{field:Rn(t.field),op:"IS_NOT_NAN"}};if(Od(t.value))return{unaryFilter:{field:Rn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Rn(t.field),op:Ey(t.op),value:t.value}}}(n):n instanceof it?function(t){let r=t.getFilters().map(s=>ap(s));return r.length===1?r[0]:{compositeFilter:{op:Iy(t.op),filters:r}}}(n):q(54877,{filter:n})}function xy(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function cp(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}function Ty(n){let e=_y({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?xa(e,e.limit,"L"):e}function Zd([n,e],[t,r]){let s=X(n,t);return s===0?X(e,r):s}function Ay(n,e){return new za(n,e)}function Py(n,e,t,r){return new ic(n,e,t,r)}async function up(n,e){let t=j(n);return await t.persistence.runTransaction("Handle user change","readonly",r=>{let s;return t.mutationQueue.getAllMutationBatches(r).next(o=>(s=o,t.Bs(e),t.mutationQueue.getAllMutationBatches(r))).next(o=>{let a=[],c=[],u=J();for(let d of s){a.push(d.batchId);for(let p of d.mutations)u=u.add(p.key)}for(let d of o){c.push(d.batchId);for(let p of d.mutations)u=u.add(p.key)}return t.localDocuments.getDocuments(r,u).next(d=>({Ls:d,removedBatchIds:a,addedBatchIds:c}))})})}function Dy(n,e){let t=j(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let s=e.batch.keys(),o=t.Ns.newChangeBuffer({trackRemovals:!0});return function(c,u,d,p){let m=d.batch,g=m.keys(),b=N.resolve();return g.forEach(S=>{b=b.next(()=>p.getEntry(u,S)).next(v=>{let C=d.docVersions.get(S);ee(C!==null,48541),v.version.compareTo(C)<0&&(m.applyToRemoteDocument(v,d),v.isValidDocument()&&(v.setReadTime(d.commitVersion),p.addEntry(v)))})}),b.next(()=>c.mutationQueue.removeMutationBatch(u,m))}(t,r,e,o).next(()=>o.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,s,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(c){let u=J();for(let d=0;d<c.mutationResults.length;++d)c.mutationResults[d].transformResults.length>0&&(u=u.add(c.batch.mutations[d].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,s))})}function dp(n){let e=j(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Pi.getLastRemoteSnapshotVersion(t))}function Ry(n,e){let t=j(n),r=e.snapshotVersion,s=t.Ms;return t.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{let a=t.Ns.newChangeBuffer({trackRemovals:!0});s=t.Ms;let c=[];e.targetChanges.forEach((p,m)=>{let g=s.get(m);if(!g)return;c.push(t.Pi.removeMatchingKeys(o,p.removedDocuments,m).next(()=>t.Pi.addMatchingKeys(o,p.addedDocuments,m)));let b=g.withSequenceNumber(o.currentSequenceNumber);e.targetMismatches.get(m)!==null?b=b.withResumeToken(Ce.EMPTY_BYTE_STRING,G.min()).withLastLimboFreeSnapshotVersion(G.min()):p.resumeToken.approximateByteSize()>0&&(b=b.withResumeToken(p.resumeToken,r)),s=s.insert(m,b),function(v,C,D){return v.resumeToken.approximateByteSize()===0||C.snapshotVersion.toMicroseconds()-v.snapshotVersion.toMicroseconds()>=Cy?!0:D.addedDocuments.size+D.modifiedDocuments.size+D.removedDocuments.size>0}(g,b,p)&&c.push(t.Pi.updateTargetData(o,b))});let u=Et(),d=J();if(e.documentUpdates.forEach(p=>{e.resolvedLimboDocuments.has(p)&&c.push(t.persistence.referenceDelegate.updateLimboDocument(o,p))}),c.push(Ny(o,a,e.documentUpdates).next(p=>{u=p.ks,d=p.qs})),!r.isEqual(G.min())){let p=t.Pi.getLastRemoteSnapshotVersion(o).next(m=>t.Pi.setTargetsMetadata(o,o.currentSequenceNumber,r));c.push(p)}return N.waitFor(c).next(()=>a.apply(o)).next(()=>t.localDocuments.getLocalViewOfDocuments(o,u,d)).next(()=>u)}).then(o=>(t.Ms=s,o))}function Ny(n,e,t){let r=J(),s=J();return t.forEach(o=>r=r.add(o)),e.getEntries(n,r).next(o=>{let a=Et();return t.forEach((c,u)=>{let d=o.get(c);u.isFoundDocument()!==d.isFoundDocument()&&(s=s.add(c)),u.isNoDocument()&&u.version.isEqual(G.min())?(e.removeEntry(c,u.readTime),a=a.insert(c,u)):!d.isValidDocument()||u.version.compareTo(d.version)>0||u.version.compareTo(d.version)===0&&d.hasPendingWrites?(e.addEntry(u),a=a.insert(c,u)):V(Jc,"Ignoring outdated watch update for ",c,". Current version:",d.version," Watch version:",u.version)}),{ks:a,qs:s}})}function ky(n,e){let t=j(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=qc),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function My(n,e){let t=j(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let s;return t.Pi.getTargetData(r,e).next(o=>o?(s=o,N.resolve(s)):t.Pi.allocateTargetId(r).next(a=>(s=new Ur(e,a,"TargetPurposeListen",r.currentSequenceNumber),t.Pi.addTargetData(r,s).next(()=>s))))}).then(r=>{let s=t.Ms.get(r.targetId);return(s===null||r.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(t.Ms=t.Ms.insert(r.targetId,r),t.xs.set(e,r.targetId)),r})}async function oc(n,e,t){let r=j(n),s=r.Ms.get(e),o=t?"readwrite":"readwrite-primary";try{t||await r.persistence.runTransaction("Release target",o,a=>r.persistence.referenceDelegate.removeTarget(a,s))}catch(a){if(!Zn(a))throw a;V(Jc,`Failed to update sequence numbers for target ${e}: ${a}`)}r.Ms=r.Ms.remove(e),r.xs.delete(s.target)}function eh(n,e,t){let r=j(n),s=G.min(),o=J();return r.persistence.runTransaction("Execute query","readwrite",a=>function(u,d,p){let m=j(u),g=m.xs.get(p);return g!==void 0?N.resolve(m.Ms.get(g)):m.Pi.getTargetData(d,p)}(r,a,nt(e)).next(c=>{if(c)return s=c.lastLimboFreeSnapshotVersion,r.Pi.getMatchingKeysForTargetId(a,c.targetId).next(u=>{o=u})}).next(()=>r.Fs.getDocumentsMatchingQuery(a,e,t?s:G.min(),t?o:J())).next(c=>(Vy(r,Hg(e),c),{documents:c,Qs:o})))}function Vy(n,e,t){let r=n.Os.get(e)||G.min();t.forEach((s,o)=>{o.readTime.compareTo(r)>0&&(r=o.readTime)}),n.Os.set(e,r)}function lc(){return zs===null?zs=function(){return 268435456+Math.round(2147483648*Math.random())}():zs++,"0x"+zs.toString(16)}function ea(){return typeof document<"u"?document:null}function Ci(n){return new ka(n,!0)}async function Pi(n){if(yn(n))for(let e of n.da)await e(!0)}async function Jr(n){for(let e of n.da)await e(!1)}function hp(n,e){let t=j(n);t.Ia.has(e.targetId)||(t.Ia.set(e.targetId,e),tl(t)?el(t):er(t).O_()&&Zc(t,e))}function Yc(n,e){let t=j(n),r=er(t);t.Ia.delete(e),r.O_()&&pp(t,e),t.Ia.size===0&&(r.O_()?r.L_():yn(t)&&t.Ra.set("Unknown"))}function Zc(n,e){if(n.Va.Ue(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(G.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}er(n).Y_(e)}function pp(n,e){n.Va.Ue(e),er(n).Z_(e)}function el(n){n.Va=new Na({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),At:e=>n.Ia.get(e)||null,ht:()=>n.datastore.serializer.databaseId}),er(n).start(),n.Ra.ua()}function tl(n){return yn(n)&&!er(n).x_()&&n.Ia.size>0}function yn(n){return j(n).Ea.size===0}function mp(n){n.Va=void 0}async function Oy(n){n.Ra.set("Online")}async function Fy(n){n.Ia.forEach((e,t)=>{Zc(n,e)})}async function By(n,e){mp(n),tl(n)?(n.Ra.ha(e),el(n)):n.Ra.set("Unknown")}async function $y(n,e,t){if(n.Ra.set("Online"),e instanceof si&&e.state===2&&e.cause)try{await async function(s,o){let a=o.cause;for(let c of o.targetIds)s.Ia.has(c)&&(await s.remoteSyncer.rejectListen(c,a),s.Ia.delete(c),s.Va.removeTarget(c))}(n,e)}catch(r){V(fn,"Failed to remove targets %s: %s ",e.targetIds.join(","),r),await mi(n,r)}else if(e instanceof Mn?n.Va.Ze(e):e instanceof ri?n.Va.st(e):n.Va.tt(e),!t.isEqual(G.min()))try{let r=await dp(n.localStore);t.compareTo(r)>=0&&await function(o,a){let c=o.Va.Tt(a);return c.targetChanges.forEach((u,d)=>{if(u.resumeToken.approximateByteSize()>0){let p=o.Ia.get(d);p&&o.Ia.set(d,p.withResumeToken(u.resumeToken,a))}}),c.targetMismatches.forEach((u,d)=>{let p=o.Ia.get(u);if(!p)return;o.Ia.set(u,p.withResumeToken(Ce.EMPTY_BYTE_STRING,p.snapshotVersion)),pp(o,u);let m=new Ur(p.target,u,d,p.sequenceNumber);Zc(o,m)}),o.remoteSyncer.applyRemoteEvent(c)}(n,t)}catch(r){V(fn,"Failed to raise snapshot:",r),await mi(n,r)}}async function mi(n,e,t){if(!Zn(e))throw e;n.Ea.add(1),await Jr(n),n.Ra.set("Offline"),t||(t=()=>dp(n.localStore)),n.asyncQueue.enqueueRetryable(async()=>{V(fn,"Retrying IndexedDB access"),await t(),n.Ea.delete(1),await Pi(n)})}function fp(n,e){return e().catch(t=>mi(n,t,e))}async function Di(n){let e=j(n),t=Gt(e),r=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:qc;for(;qy(e);)try{let s=await ky(e.localStore,r);if(s===null){e.Ta.length===0&&t.L_();break}r=s.batchId,Uy(e,s)}catch(s){await mi(e,s)}gp(e)&&yp(e)}function qy(n){return yn(n)&&n.Ta.length<10}function Uy(n,e){n.Ta.push(e);let t=Gt(n);t.O_()&&t.X_&&t.ea(e.mutations)}function gp(n){return yn(n)&&!Gt(n).x_()&&n.Ta.length>0}function yp(n){Gt(n).start()}async function zy(n){Gt(n).ra()}async function jy(n){let e=Gt(n);for(let t of n.Ta)e.ea(t.mutations)}async function Gy(n,e,t){let r=n.Ta.shift(),s=Ca.from(r,e,t);await fp(n,()=>n.remoteSyncer.applySuccessfulWrite(s)),await Di(n)}async function Hy(n,e){e&&Gt(n).X_&&await async function(r,s){if(function(a){return iy(a)&&a!==R.ABORTED}(s.code)){let o=r.Ta.shift();Gt(r).B_(),await fp(r,()=>r.remoteSyncer.rejectFailedWrite(o.batchId,s)),await Di(r)}}(n,e),gp(n)&&yp(n)}async function rh(n,e){let t=j(n);t.asyncQueue.verifyOperationInProgress(),V(fn,"RemoteStore received new credentials");let r=yn(t);t.Ea.add(3),await Jr(t),r&&t.Ra.set("Unknown"),await t.remoteSyncer.handleCredentialChange(e),t.Ea.delete(3),await Pi(t)}async function Ky(n,e){let t=j(n);e?(t.Ea.delete(2),await Pi(t)):e||(t.Ea.add(2),await Jr(t),t.Ra.set("Unknown"))}function er(n){return n.ma||(n.ma=function(t,r,s){let o=j(t);return o.sa(),new pc(r,o.connection,o.authCredentials,o.appCheckCredentials,o.serializer,s)}(n.datastore,n.asyncQueue,{Xo:Oy.bind(null,n),t_:Fy.bind(null,n),r_:By.bind(null,n),H_:$y.bind(null,n)}),n.da.push(async e=>{e?(n.ma.B_(),tl(n)?el(n):n.Ra.set("Unknown")):(await n.ma.stop(),mp(n))})),n.ma}function Gt(n){return n.fa||(n.fa=function(t,r,s){let o=j(t);return o.sa(),new mc(r,o.connection,o.authCredentials,o.appCheckCredentials,o.serializer,s)}(n.datastore,n.asyncQueue,{Xo:()=>Promise.resolve(),t_:zy.bind(null,n),r_:Hy.bind(null,n),ta:jy.bind(null,n),na:Gy.bind(null,n)}),n.da.push(async e=>{e?(n.fa.B_(),await Di(n)):(await n.fa.stop(),n.Ta.length>0&&(V(fn,`Stopping write stream with ${n.Ta.length} pending writes`),n.Ta=[]))})),n.fa}function nl(n,e){if(wt("AsyncQueue",`${e}: ${n}`),Zn(n))return new $(R.UNAVAILABLE,`${e}: ${n}`);throw n}function sh(){return new vt(n=>zh(n),Si)}async function Wy(n,e){let t=j(n),r=3,s=e.query,o=t.queries.get(s);o?!o.ba()&&e.Da()&&(r=2):(o=new bc,r=e.Da()?0:1);try{switch(r){case 0:o.wa=await t.onListen(s,!0);break;case 1:o.wa=await t.onListen(s,!1);break;case 2:await t.onFirstRemoteStoreListen(s)}}catch(a){let c=nl(a,`Initialization of query '${Dn(e.query)}' failed`);return void e.onError(c)}t.queries.set(s,o),o.Sa.push(e),e.va(t.onlineState),o.wa&&e.Fa(o.wa)&&rl(t)}async function Qy(n,e){let t=j(n),r=e.query,s=3,o=t.queries.get(r);if(o){let a=o.Sa.indexOf(e);a>=0&&(o.Sa.splice(a,1),o.Sa.length===0?s=e.Da()?0:1:!o.ba()&&e.Da()&&(s=2))}switch(s){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}}function Xy(n,e){let t=j(n),r=!1;for(let s of e){let o=s.query,a=t.queries.get(o);if(a){for(let c of a.Sa)c.Fa(s)&&(r=!0);a.wa=s}}r&&rl(t)}function Jy(n,e,t){let r=j(n),s=r.queries.get(e);if(s)for(let o of s.Sa)o.onError(t);r.queries.delete(e)}function rl(n){n.Ca.forEach(e=>{e.next()})}async function Yy(n,e,t=!0){let r=Ip(n),s,o=r.Tu.get(e);return o?(r.sharedClientState.addLocalQueryTarget(o.targetId),s=o.view.lu()):s=await wp(r,e,t,!0),s}async function Zy(n,e){let t=Ip(n);await wp(t,e,!0,!1)}async function wp(n,e,t,r){let s=await My(n.localStore,nt(e)),o=s.targetId,a=n.sharedClientState.addLocalQueryTarget(o,t),c;return r&&(c=await e0(n,e,o,a==="current",s.resumeToken)),n.isPrimaryClient&&t&&hp(n.remoteStore,s),c}async function e0(n,e,t,r,s){n.pu=(m,g,b)=>async function(v,C,D,k){let L=C.view.ru(D);L.Cs&&(L=await eh(v.localStore,C.query,!1).then(({documents:E})=>C.view.ru(E,L)));let H=k&&k.targetChanges.get(C.targetId),F=k&&k.targetMismatches.get(C.targetId)!=null,W=C.view.applyChanges(L,v.isPrimaryClient,H,F);return ah(v,C.targetId,W.au),W.snapshot}(n,m,g,b);let o=await eh(n.localStore,e,!0),a=new xc(e,o.Qs),c=a.ru(o.documents),u=qr.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",s),d=a.applyChanges(c,n.isPrimaryClient,u);ah(n,t,d.au);let p=new Tc(e,t,a);return n.Tu.set(e,p),n.Iu.has(t)?n.Iu.get(t).push(e):n.Iu.set(t,[e]),d.snapshot}async function t0(n,e,t){let r=j(n),s=r.Tu.get(e),o=r.Iu.get(s.targetId);if(o.length>1)return r.Iu.set(s.targetId,o.filter(a=>!Si(a,e))),void r.Tu.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await oc(r.localStore,s.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(s.targetId),t&&Yc(r.remoteStore,s.targetId),Cc(r,s.targetId)}).catch(Yn)):(Cc(r,s.targetId),await oc(r.localStore,s.targetId,!0))}async function n0(n,e){let t=j(n),r=t.Tu.get(e),s=t.Iu.get(r.targetId);t.isPrimaryClient&&s.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Yc(t.remoteStore,r.targetId))}async function r0(n,e,t){let r=u0(n);try{let s=await function(a,c){let u=j(a),d=ye.now(),p=c.reduce((b,S)=>b.add(S.key),J()),m,g;return u.persistence.runTransaction("Locally write mutations","readwrite",b=>{let S=Et(),v=J();return u.Ns.getEntries(b,p).next(C=>{S=C,S.forEach((D,k)=>{k.isValidDocument()||(v=v.add(D))})}).next(()=>u.localDocuments.getOverlayedDocuments(b,S)).next(C=>{m=C;let D=[];for(let k of c){let L=sy(k,m.get(k.key).overlayedDocument);L!=null&&D.push(new It(k.key,L,Oh(L.value.mapValue),cn.exists(!0)))}return u.mutationQueue.addMutationBatch(b,d,D,c)}).next(C=>{g=C;let D=C.applyToLocalDocumentSet(m,v);return u.documentOverlayCache.saveOverlays(b,C.batchId,D)})}).then(()=>({batchId:g.batchId,changes:Hh(m)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(s.batchId),function(a,c,u){let d=a.Vu[a.currentUser.toKey()];d||(d=new de(X)),d=d.insert(c,u),a.Vu[a.currentUser.toKey()]=d}(r,s.batchId,t),await Yr(r,s.changes),await Di(r.remoteStore)}catch(s){let o=nl(s,"Failed to persist write");t.reject(o)}}async function _p(n,e){let t=j(n);try{let r=await Ry(t.localStore,e);e.targetChanges.forEach((s,o)=>{let a=t.Au.get(o);a&&(ee(s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size<=1,22616),s.addedDocuments.size>0?a.hu=!0:s.modifiedDocuments.size>0?ee(a.hu,14607):s.removedDocuments.size>0&&(ee(a.hu,42227),a.hu=!1))}),await Yr(t,r,e)}catch(r){await Yn(r)}}function oh(n,e,t){let r=j(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let s=[];r.Tu.forEach((o,a)=>{let c=a.view.va(e);c.snapshot&&s.push(c.snapshot)}),function(a,c){let u=j(a);u.onlineState=c;let d=!1;u.queries.forEach((p,m)=>{for(let g of m.Sa)g.va(c)&&(d=!0)}),d&&rl(u)}(r.eventManager,e),s.length&&r.Pu.H_(s),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function s0(n,e,t){let r=j(n);r.sharedClientState.updateQueryState(e,"rejected",t);let s=r.Au.get(e),o=s&&s.key;if(o){let a=new de(U.comparator);a=a.insert(o,We.newNoDocument(o,G.min()));let c=J().add(o),u=new ni(G.min(),new Map,new de(X),a,c);await _p(r,u),r.du=r.du.remove(o),r.Au.delete(e),il(r)}else await oc(r.localStore,e,!1).then(()=>Cc(r,e,t)).catch(Yn)}async function i0(n,e){let t=j(n),r=e.batch.batchId;try{let s=await Dy(t.localStore,e);vp(t,r,null),bp(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),await Yr(t,s)}catch(s){await Yn(s)}}async function o0(n,e,t){let r=j(n);try{let s=await function(a,c){let u=j(a);return u.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let p;return u.mutationQueue.lookupMutationBatch(d,c).next(m=>(ee(m!==null,37113),p=m.keys(),u.mutationQueue.removeMutationBatch(d,m))).next(()=>u.mutationQueue.performConsistencyCheck(d)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(d,p,c)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,p)).next(()=>u.localDocuments.getDocuments(d,p))})}(r.localStore,e);vp(r,e,t),bp(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),await Yr(r,s)}catch(s){await Yn(s)}}function bp(n,e){(n.mu.get(e)||[]).forEach(t=>{t.resolve()}),n.mu.delete(e)}function vp(n,e,t){let r=j(n),s=r.Vu[r.currentUser.toKey()];if(s){let o=s.get(e);o&&(t?o.reject(t):o.resolve(),s=s.remove(e)),r.Vu[r.currentUser.toKey()]=s}}function Cc(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Iu.get(e))n.Tu.delete(r),t&&n.Pu.yu(r,t);n.Iu.delete(e),n.isPrimaryClient&&n.Ru.jr(e).forEach(r=>{n.Ru.containsKey(r)||Ep(n,r)})}function Ep(n,e){n.Eu.delete(e.path.canonicalString());let t=n.du.get(e);t!==null&&(Yc(n.remoteStore,t),n.du=n.du.remove(e),n.Au.delete(t),il(n))}function ah(n,e,t){for(let r of t)r instanceof yi?(n.Ru.addReference(r.key,e),a0(n,r)):r instanceof wi?(V(sl,"Document no longer in limbo: "+r.key),n.Ru.removeReference(r.key,e),n.Ru.containsKey(r.key)||Ep(n,r.key)):q(19791,{wu:r})}function a0(n,e){let t=e.key,r=t.path.canonicalString();n.du.get(t)||n.Eu.has(r)||(V(sl,"New document in limbo: "+t),n.Eu.add(r),il(n))}function il(n){for(;n.Eu.size>0&&n.du.size<n.maxConcurrentLimboResolutions;){let e=n.Eu.values().next().value;n.Eu.delete(e);let t=new U(pe.fromString(e)),r=n.fu.next();n.Au.set(r,new Sc(t)),n.du=n.du.insert(t,r),hp(n.remoteStore,new Ur(nt(Wc(t.path)),r,"TargetPurposeLimboResolution",Fn.ce))}}async function Yr(n,e,t){let r=j(n),s=[],o=[],a=[];r.Tu.isEmpty()||(r.Tu.forEach((c,u)=>{a.push(r.pu(u,e,t).then(d=>{if((d||t)&&r.isPrimaryClient){let p=d?!d.fromCache:t?.targetChanges.get(u.targetId)?.current;r.sharedClientState.updateQueryState(u.targetId,p?"current":"not-current")}if(d){s.push(d);let p=nc.As(u.targetId,d);o.push(p)}}))}),await Promise.all(a),r.Pu.H_(s),await async function(u,d){let p=j(u);try{await p.persistence.runTransaction("notifyLocalViewChanges","readwrite",m=>N.forEach(d,g=>N.forEach(g.Es,b=>p.persistence.referenceDelegate.addReference(m,g.targetId,b)).next(()=>N.forEach(g.ds,b=>p.persistence.referenceDelegate.removeReference(m,g.targetId,b)))))}catch(m){if(!Zn(m))throw m;V(Jc,"Failed to update sequence numbers: "+m)}for(let m of d){let g=m.targetId;if(!m.fromCache){let b=p.Ms.get(g),S=b.snapshotVersion,v=b.withLastLimboFreeSnapshotVersion(S);p.Ms=p.Ms.insert(g,v)}}}(r.localStore,o))}async function c0(n,e){let t=j(n);if(!t.currentUser.isEqual(e)){V(sl,"User change. New user:",e.toKey());let r=await up(t.localStore,e);t.currentUser=e,function(o,a){o.mu.forEach(c=>{c.forEach(u=>{u.reject(new $(R.CANCELLED,a))})}),o.mu.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),await Yr(t,r.Ls)}}function l0(n,e){let t=j(n),r=t.Au.get(e);if(r&&r.hu)return J().add(r.key);{let s=J(),o=t.Iu.get(e);if(!o)return s;for(let a of o){let c=t.Tu.get(a);s=s.unionWith(c.view.nu)}return s}}function Ip(n){let e=j(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=_p.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=l0.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=s0.bind(null,e),e.Pu.H_=Xy.bind(null,e.eventManager),e.Pu.yu=Jy.bind(null,e.eventManager),e}function u0(n){let e=j(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=i0.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=o0.bind(null,e),e}async function ta(n,e){n.asyncQueue.verifyOperationInProgress(),V(Ht,"Initializing OfflineComponentProvider");let t=n.configuration;await e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(async s=>{r.isEqual(s)||(await up(e.localStore,s),r=s)}),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e}async function ch(n,e){n.asyncQueue.verifyOperationInProgress();let t=await d0(n);V(Ht,"Initializing OnlineComponentProvider"),await e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>rh(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,s)=>rh(e.remoteStore,s)),n._onlineComponents=e}async function d0(n){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V(Ht,"Using user provided OfflineComponentProvider");try{await ta(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!function(s){return s.name==="FirebaseError"?s.code===R.FAILED_PRECONDITION||s.code===R.UNIMPLEMENTED:!(typeof DOMException<"u"&&s instanceof DOMException)||s.code===22||s.code===20||s.code===11}(t))throw t;Ln("Error using user provided cache. Falling back to memory cache: "+t),await ta(n,new Xn)}}else V(Ht,"Using default OfflineComponentProvider"),await ta(n,new Pc(void 0));return n._offlineComponents}async function xp(n){return n._onlineComponents||(n._uninitializedComponentsProvider?(V(Ht,"Using user provided OnlineComponentProvider"),await ch(n,n._uninitializedComponentsProvider._online)):(V(Ht,"Using default OnlineComponentProvider"),await ch(n,new Gr))),n._onlineComponents}function h0(n){return xp(n).then(e=>e.syncEngine)}async function p0(n){let e=await xp(n),t=e.eventManager;return t.onListen=Yy.bind(null,e.syncEngine),t.onUnlisten=t0.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=Zy.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=n0.bind(null,e.syncEngine),t}function m0(n,e,t={}){let r=new et;return n.asyncQueue.enqueueAndForget(async()=>function(o,a,c,u,d){let p=new Dc({next:g=>{p.Nu(),a.enqueueAndForget(()=>Qy(o,m));let b=g.docs.has(c);!b&&g.fromCache?d.reject(new $(R.UNAVAILABLE,"Failed to get document because the client is offline.")):b&&g.fromCache&&u&&u.source==="server"?d.reject(new $(R.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):d.resolve(g)},error:g=>d.reject(g)}),m=new Ic(Wc(c.path),p,{includeMetadataChanges:!0,qa:!0});return Wy(o,m)}(await p0(n),n.asyncQueue,e,t,r)),r.promise}function Tp(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}function f0(n,e,t,r={}){n=Lr(n,Hr);let s=Ms(e),o=n._getSettings(),a={...o,emulatorOptions:n._getEmulatorOptions()},c=`${e}:${t}`;s&&(Ju(`https://${c}`),Zu("Firestore",!0)),o.host!==Sp&&o.host!==c&&Ln("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let u={...o,host:c,ssl:s,emulatorOptions:r};if(!Sn(u,a)&&(n._setSettings(u),r.mockUserToken)){let d,p;if(typeof r.mockUserToken=="string")d=r.mockUserToken,p=ve.MOCK_USER;else{d=Yu(r.mockUserToken,n._app?.options.projectId);let m=r.mockUserToken.sub||r.mockUserToken.user_id;if(!m)throw new $(R.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");p=new ve(m)}n._authCredentials=new ra(new Ks(d,p))}}function ol(n,e,...t){if(n=xr(n),arguments.length===1&&(e=Vr.newId()),bg("doc","path",e),n instanceof Hr){let r=pe.fromString(e,...t);return Dd(r),new Ve(n,null,new U(r))}{if(!(n instanceof Ve||n instanceof Kr))throw new $(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(pe.fromString(e,...t));return Dd(r),new Ve(n.firestore,n instanceof Kr?n.converter:null,new U(r))}}function hh(n){let e=n.message||"";return n.stack&&(e=n.stack.includes(n.message)?n.stack:n.message+`
`+n.stack),e}function Ap(n,e){let t=typeof n=="object"?n:_d(),r=typeof n=="string"?n:e||Ys,s=gd(t,"firestore").getImmediate({identifier:r});if(!s._initialized){let o=Xu("firestore");o&&f0(s,...o)}return s}function Cp(n){if(n._terminated)throw new $(R.FAILED_PRECONDITION,"The client has already been terminated.");return n._firestoreClient||g0(n),n._firestoreClient}function g0(n){let e=n._freezeSettings(),t=function(s,o,a,c){return new da(s,o,a,c.host,c.ssl,c.experimentalForceLongPolling,c.experimentalAutoDetectLongPolling,Tp(c.experimentalLongPollingOptions),c.useFetchStreams,c.isUsingEmulator)}(n._databaseId,n._app?.options.appId||"",n._persistenceKey,e);n._componentsProvider||e.localCache?._offlineComponentProvider&&e.localCache?._onlineComponentProvider&&(n._componentsProvider={_offline:e.localCache._offlineComponentProvider,_online:e.localCache._onlineComponentProvider}),n._firestoreClient=new Rc(n._authCredentials,n._appCheckCredentials,n._queue,t,n._componentsProvider&&function(s){let o=s?._online.build();return{_offline:s?._offline.build(o),_online:o}}(n._componentsProvider))}function Pp(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw q(40011,{Ac:n})}}function w0(n){let e=n._freezeSettings(),t=Ci(n._databaseId);return new Vc(n._databaseId,!!e.ignoreUndefinedProperties,t)}function _0(n,e,t,r,s,o={}){let a=n.Cc(o.merge||o.mergeFields?2:0,e,t,s);kp("Data must be an object, but it was:",a,r);let c=Rp(r,a),u,d;if(o.merge)u=new Ze(a.fieldMask),d=a.fieldTransforms;else if(o.mergeFields){let p=[];for(let m of o.mergeFields){let g=b0(e,m,t);if(!a.contains(g))throw new $(R.INVALID_ARGUMENT,`Field '${g}' is specified in your field mask but missing from your input data.`);E0(p,g)||p.push(g)}u=new Ze(p),d=a.fieldTransforms.filter(m=>u.covers(m.field))}else u=null,d=a.fieldTransforms;return new kc(new Ke(c),u,d)}function Dp(n,e){if(Np(n=xr(n)))return kp("Unsupported field value:",e,n),Rp(n,e);if(n instanceof vi)return function(r,s){if(!Pp(s.Ac))throw s.Sc(`${r._methodName}() can only be used with update() and set()`);if(!s.path)throw s.Sc(`${r._methodName}() is not currently supported inside arrays`);let o=r._toFieldTransform(s);o&&s.fieldTransforms.push(o)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.fc&&e.Ac!==4)throw e.Sc("Nested arrays are not supported");return function(r,s){let o=[],a=0;for(let c of r){let u=Dp(c,s.wc(a));u==null&&(u={nullValue:"NULL_VALUE"}),o.push(u),a++}return{arrayValue:{values:o}}}(n,e)}return function(r,s){if((r=xr(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return Zg(s.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let o=ye.fromDate(r);return{timestampValue:oi(s.serializer,o)}}if(r instanceof ye){let o=new ye(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:oi(s.serializer,o)}}if(r instanceof Ut)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof qt)return{bytesValue:np(s.serializer,r._byteString)};if(r instanceof Ve){let o=s.databaseId,a=r.firestore._databaseId;if(!a.isEqual(o))throw s.Sc(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${o.projectId}/${o.database}`);return{referenceValue:Xc(r.firestore._databaseId||s.databaseId,r._key.path)}}if(r instanceof zt)return function(a,c){return{mapValue:{fields:{[zc]:{stringValue:jc},[Bn]:{arrayValue:{values:a.toArray().map(d=>{if(typeof d!="number")throw c.Sc("VectorValues must only contain numeric values.");return Qc(c.serializer,d)})}}}}}}(r,s);throw s.Sc(`Unsupported field value: ${$c(r)}`)}(n,e)}function Rp(n,e){let t={};return Ph(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):gn(n,(r,s)=>{let o=Dp(s,e.mc(r));o!=null&&(t[r]=o)}),{mapValue:{fields:t}}}function Np(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof ye||n instanceof Ut||n instanceof qt||n instanceof Ve||n instanceof vi||n instanceof zt)}function kp(n,e,t){if(!Np(t)||!mh(t)){let r=$c(t);throw r==="an object"?e.Sc(n+" a custom object"):e.Sc(n+" "+r)}}function b0(n,e,t){if((e=xr(e))instanceof Qr)return e._internalPath;if(typeof e=="string")return Mp(n,e);throw Ei("Field path arguments must be of type string or ",n,!1,void 0,t)}function Mp(n,e,t){if(e.search(v0)>=0)throw Ei(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Qr(...e.split("."))._internalPath}catch{throw Ei(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Ei(n,e,t,r,s){let o=r&&!r.isEmpty(),a=s!==void 0,c=`Function ${e}() called with invalid data`;t&&(c+=" (via `toFirestore()`)"),c+=". ";let u="";return(o||a)&&(u+=" (found",o&&(u+=` in field ${r}`),a&&(u+=` in document ${s}`),u+=")"),new $(R.INVALID_ARGUMENT,c+n+u)}function E0(n,e){return n.some(t=>t.isEqual(e))}function Vp(n,e){return typeof e=="string"?Mp(n,e):e instanceof Qr?e._internalPath:e._delegate._internalPath}function I0(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}function x0(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return q(61501,{type:n})}}function Lp(n){n=Lr(n,Ve);let e=Lr(n.firestore,Wr);return m0(Cp(e),n._key).then(t=>S0(e,n,t))}function Op(n,e,t){n=Lr(n,Ve);let r=Lr(n.firestore,Wr),s=I0(n.converter,e,t);return T0(r,[_0(w0(r),"setDoc",n._key,s,n.converter!==null,t).toMutation(n._key,cn.none())])}function T0(n,e){return function(r,s){let o=new et;return r.asyncQueue.enqueueAndForget(async()=>r0(await h0(r),s,o)),o.promise}(Cp(n),e)}function S0(n,e,t){let r=t.docs.get(e._key),s=new Fc(n);return new ln(n,s,e._key,r,new an(t.hasPendingWrites,t.fromCache),e.converter)}var Ad,Cd,ve,Jn,un,R,$,et,Ks,na,ra,sa,ia,oa,Ws,aa,Vr,yg,wg,Pd,Qs,pe,_g,$e,U,Rd,Nd,ye,G,Or,la,dn,Tg,ua,N,Fn,qc,fh,Dg,gh,yh,wh,_h,Rg,bh,vh,Eh,Ih,xh,Th,Sh,Ah,Ng,kg,Mg,Ch,Vg,Lg,n_,Og,Fg,Bg,r_,de,kn,tt,Ee,Xs,Ze,Js,Ce,$g,Dh,Rh,Nh,kh,da,Ys,Zs,zc,Mh,qs,jc,Bn,i_,Ke,We,Un,zn,ei,_e,it,fa,ga,ya,wa,_a,ba,va,Ea,jn,vt,Wg,Gh,Qg,Xg,Jg,Gn,Hn,hn,pn,Kn,Ta,cn,Wn,mn,It,ti,Sa,Aa,Ca,Pa,Da,me,Z,oy,cy,Ra,on,ni,qr,Mn,ri,si,ii,Na,ly,uy,dy,ka,Ur,Fa,ai,Ba,$a,o_,Jd,lp,ze,zr,Yd,Sy,qa,Ua,za,ja,Ga,Ha,Ka,Wa,Qa,jr,fe,Xa,Ja,Ya,Za,ci,ec,tc,li,nc,rc,sc,Jc,Cy,ic,ui,ac,cc,th,di,zs,Zo,Ly,uc,dc,Ae,hc,hi,nh,pi,pc,mc,fc,gc,yc,fn,wc,_c,fi,gi,Qn,bc,vc,Ec,ih,Ic,yi,wi,xc,sl,Tc,Sc,Ac,Xn,Pc,Gr,Dc,Ht,Rc,lh,Sp,uh,_i,Hr,Nc,Ve,Kr,dh,bi,Wr,qt,Qr,vi,Ut,zt,y0,kc,Mc,Vc,v0,Ii,Lc,Oc,an,ln,Vn,Mr,Fc,Fp=ne(()=>{Fs();Co();Po();Tr();Td();Sd();Ad="@firebase/firestore",Cd="4.9.2";ve=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};ve.UNAUTHENTICATED=new ve(null),ve.GOOGLE_CREDENTIALS=new ve("google-credentials-uid"),ve.FIRST_PARTY=new ve("first-party-uid"),ve.MOCK_USER=new ve("mock-user");Jn="12.3.0";un=new An("@firebase/firestore");R={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},$=class extends pt{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};et=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};Ks=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},na=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(ve.UNAUTHENTICATED))}shutdown(){}},ra=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},sa=class{constructor(e){this.t=e,this.currentUser=ve.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){ee(this.o===void 0,42304);let r=this.i,s=u=>this.i!==r?(r=this.i,t(u)):Promise.resolve(),o=new et;this.o=()=>{this.i++,this.currentUser=this.u(),o.resolve(),o=new et,e.enqueueRetryable(()=>s(this.currentUser))};let a=()=>{let u=o;e.enqueueRetryable(async()=>{await u.promise,await s(this.currentUser)})},c=u=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.o&&(this.auth.addAuthTokenListener(this.o),a())};this.t.onInit(u=>c(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?c(u):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),o.resolve(),o=new et)}},0),a()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(ee(typeof r.accessToken=="string",31837,{l:r}),new Ks(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return ee(e===null||typeof e=="string",2055,{h:e}),new ve(e)}},ia=class{constructor(e,t,r){this.P=e,this.T=t,this.I=r,this.type="FirstParty",this.user=ve.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);let e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}},oa=class{constructor(e,t,r){this.P=e,this.T=t,this.I=r}getToken(){return Promise.resolve(new ia(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(ve.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Ws=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},aa=class{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,yd(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){ee(this.o===void 0,3512);let r=o=>{o.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${o.error.message}`);let a=o.token!==this.m;return this.m=o.token,V("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?t(o.token):Promise.resolve()};this.o=o=>{e.enqueueRetryable(()=>r(o))};let s=o=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=o,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(o=>s(o)),setTimeout(()=>{if(!this.appCheck){let o=this.V.getImmediate({optional:!0});o?s(o):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new Ws(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(ee(typeof t.token=="string",44558,{tokenResult:t}),this.m=t.token,new Ws(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}};Vr=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(4.129032258064516),r="";for(;r.length<20;){let s=gg(40);for(let o=0;o<s.length;++o)r.length<20&&s[o]<t&&(r+=e.charAt(s[o]%62))}return r}};yg=55296,wg=57343;Pd="__name__",Qs=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&q(637,{offset:t,range:e.length}),r===void 0?r=e.length-t:r>e.length-t&&q(1746,{length:r,range:e.length-t}),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let s=0;s<r;s++){let o=n.compareSegments(e.get(s),t.get(s));if(o!==0)return o}return X(e.length,t.length)}static compareSegments(e,t){let r=n.isNumericId(e),s=n.isNumericId(t);return r&&!s?-1:!r&&s?1:r&&s?n.extractNumericId(e).compare(n.extractNumericId(t)):ca(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return gt.fromString(e.substring(4,e.length-2))}},pe=class n extends Qs{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new $(R.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(s=>s.length>0))}return new n(t)}static emptyPath(){return new n([])}},_g=/^[_a-zA-Z][_a-zA-Z0-9]*$/,$e=class n extends Qs{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return _g.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===Pd}static keyField(){return new n([Pd])}static fromServerFormat(e){let t=[],r="",s=0,o=()=>{if(r.length===0)throw new $(R.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},a=!1;for(;s<e.length;){let c=e[s];if(c==="\\"){if(s+1===e.length)throw new $(R.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let u=e[s+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new $(R.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,s+=2}else c==="`"?(a=!a,s++):c!=="."||a?(r+=c,s++):(o(),s++)}if(o(),a)throw new $(R.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};U=class n{constructor(e){this.path=e}static fromPath(e){return new n(pe.fromString(e))}static fromName(e){return new n(pe.fromString(e).popFirst(5))}static empty(){return new n(pe.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&pe.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return pe.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new pe(e.slice()))}};Rd=-62135596800,Nd=1e6,ye=class n{static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor((e-1e3*t)*Nd);return new n(t,r)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new $(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new $(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<Rd)throw new $(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new $(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Nd}_compareTo(e){return this.seconds===e.seconds?X(this.nanoseconds,e.nanoseconds):X(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:n._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(Xr(e,n._jsonSchema))return new n(e.seconds,e.nanoseconds)}valueOf(){let e=this.seconds-Rd;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};ye._jsonSchemaVersion="firestore/timestamp/1.0",ye._jsonSchema={type:ge("string",ye._jsonSchemaVersion),seconds:ge("number"),nanoseconds:ge("number")};G=class n{static fromTimestamp(e){return new n(e)}static min(){return new n(new ye(0,0))}static max(){return new n(new ye(253402300799,999999999))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};Or=-1,la=class{constructor(e,t,r,s){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=s}};la.UNKNOWN_ID=-1;dn=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(G.min(),U.empty(),Or)}static max(){return new n(G.max(),U.empty(),Or)}};Tg="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",ua=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};N=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&q(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,s)=>{this.nextCallback=o=>{this.wrapSuccess(e,o).next(r,s)},this.catchCallback=o=>{this.wrapFailure(t,o).next(r,s)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let s=0,o=0,a=!1;e.forEach(c=>{++s,c.next(()=>{++o,a&&o===s&&t()},u=>r(u))}),a=!0,o===s&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(s=>s?n.resolve(s):r());return t}static forEach(e,t){let r=[];return e.forEach((s,o)=>{r.push(t.call(this,s,o))}),this.waitFor(r)}static mapArray(e,t){return new n((r,s)=>{let o=e.length,a=new Array(o),c=0;for(let u=0;u<o;u++){let d=u;t(e[d]).next(p=>{a[d]=p,++c,c===o&&r(a)},p=>s(p))}})}static doWhile(e,t){return new n((r,s)=>{let o=()=>{e()===!0?t().next(()=>{o()},s):r()};o()})}};Fn=class{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=r=>this.ae(r),this.ue=r=>t.writeSequenceNumber(r))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}};Fn.ce=-1;qc=-1;fh="";Dg="remoteDocuments",gh="owner",yh="mutationQueues",wh="mutations";_h="documentMutations",Rg="remoteDocumentsV14",bh="remoteDocumentGlobal",vh="targets",Eh="targetDocuments",Ih="targetGlobal",xh="collectionParents",Th="clientMetadata",Sh="bundles",Ah="namedQueries",Ng="indexConfiguration",kg="indexState",Mg="indexEntries",Ch="documentOverlays",Vg="globals",Lg=[yh,wh,_h,Dg,vh,gh,Ih,Eh,Th,bh,xh,Sh,Ah],n_=[...Lg,Ch],Og=[yh,wh,_h,Rg,vh,gh,Ih,Eh,Th,bh,xh,Sh,Ah,Ch],Fg=Og,Bg=[...Fg,Ng,kg,Mg],r_=[...Bg,Vg];de=class n{constructor(e,t){this.comparator=e,this.root=t||tt.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tt.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let s=this.comparator(e,r.key);if(s===0)return t+r.left.size;s<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new kn(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new kn(this.root,e,this.comparator,!1)}getReverseIterator(){return new kn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new kn(this.root,e,this.comparator,!0)}},kn=class{constructor(e,t,r,s){this.isReverse=s,this.nodeStack=[];let o=1;for(;!e.isEmpty();)if(o=t?r(e.key,t):1,t&&s&&(o*=-1),o<0)e=this.isReverse?e.left:e.right;else{if(o===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},tt=class n{constructor(e,t,r,s,o){this.key=e,this.value=t,this.color=r??n.RED,this.left=s??n.EMPTY,this.right=o??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,s,o){return new n(e??this.key,t??this.value,r??this.color,s??this.left,o??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let s=this,o=r(e,s.key);return s=o<0?s.copy(null,null,null,s.left.insert(e,t,r),null):o===0?s.copy(null,t,null,null,null):s.copy(null,null,null,null,s.right.insert(e,t,r)),s.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,s=this;if(t(e,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),t(e,s.key)===0){if(s.right.isEmpty())return n.EMPTY;r=s.right.min(),s=s.copy(r.key,r.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw q(43730,{key:this.key,value:this.value});if(this.right.isRed())throw q(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw q(27949);return e+(this.isRed()?0:1)}};tt.EMPTY=null,tt.RED=!0,tt.BLACK=!1;tt.EMPTY=new class{constructor(){this.size=0}get key(){throw q(57766)}get value(){throw q(16141)}get color(){throw q(16727)}get left(){throw q(29726)}get right(){throw q(36894)}copy(e,t,r,s,o){return this}insert(e,t,r){return new tt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};Ee=class n{constructor(e){this.comparator=e,this.data=new de(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let s=r.getNext();if(this.comparator(s.key,e[1])>=0)return;t(s.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Xs(this.data.getIterator())}getIteratorFrom(e){return new Xs(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let s=t.getNext().key,o=r.getNext().key;if(this.comparator(s,o)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},Xs=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};Ze=class n{constructor(e){this.fields=e,e.sort($e.comparator)}static empty(){return new n([])}unionWith(e){let t=new Ee($e.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return On(this.fields,e.fields,(t,r)=>t.isEqual(r))}};Js=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};Ce=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(s){try{return atob(s)}catch(o){throw typeof DOMException<"u"&&o instanceof DOMException?new Js("Invalid base64 string: "+o):o}}(e);return new n(t)}static fromUint8Array(e){let t=function(s){let o="";for(let a=0;a<s.length;++a)o+=String.fromCharCode(s[a]);return o}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return X(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};Ce.EMPTY_BYTE_STRING=new Ce("");$g=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);Dh="server_timestamp",Rh="__type__",Nh="__previous_value__",kh="__local_write_time__";da=class{constructor(e,t,r,s,o,a,c,u,d,p){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=s,this.ssl=o,this.forceLongPolling=a,this.autoDetectLongPolling=c,this.longPollingOptions=u,this.useFetchStreams=d,this.isUsingEmulator=p}},Ys="(default)",Zs=class n{constructor(e,t){this.projectId=e,this.database=t||Ys}static empty(){return new n("","")}get isDefaultDatabase(){return this.database===Ys}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};zc="__type__",Mh="__max__",qs={mapValue:{fields:{__type__:{stringValue:Mh}}}},jc="__vector__",Bn="value";i_={mapValue:{fields:{[zc]:{stringValue:jc},[Bn]:{arrayValue:{}}}}};Ke=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!Gs(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Dr(t)}setAll(e){let t=$e.emptyPath(),r={},s=[];e.forEach((a,c)=>{if(!t.isImmediateParentOf(c)){let u=this.getFieldsMap(t);this.applyChanges(u,r,s),r={},s=[],t=c.popLast()}a?r[c.lastSegment()]=Dr(a):s.push(c.lastSegment())});let o=this.getFieldsMap(t);this.applyChanges(o,r,s)}delete(e){let t=this.field(e.popLast());Gs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return st(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let s=t.mapValue.fields[e.get(r)];Gs(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=s),t=s}return t.mapValue.fields}applyChanges(e,t,r){gn(t,(s,o)=>e[s]=o);for(let s of r)delete e[s]}clone(){return new n(Dr(this.value))}};We=class n{constructor(e,t,r,s,o,a,c){this.key=e,this.documentType=t,this.version=r,this.readTime=s,this.createTime=o,this.data=a,this.documentState=c}static newInvalidDocument(e){return new n(e,0,G.min(),G.min(),G.min(),Ke.empty(),0)}static newFoundDocument(e,t,r,s){return new n(e,1,t,G.min(),r,s,0)}static newNoDocument(e,t){return new n(e,2,t,G.min(),G.min(),Ke.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,G.min(),G.min(),Ke.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(G.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ke.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ke.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=G.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};Un=class{constructor(e,t){this.position=e,this.inclusive=t}};zn=class{constructor(e,t="asc"){this.field=e,this.dir=t}};ei=class{},_e=class n extends ei{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new fa(e,t,r):t==="array-contains"?new wa(e,r):t==="in"?new _a(e,r):t==="not-in"?new ba(e,r):t==="array-contains-any"?new va(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new ga(e,r):new ya(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&t.nullValue===void 0&&this.matchesComparison($n(t,this.value)):t!==null&&jt(this.value)===jt(t)&&this.matchesComparison($n(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return q(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},it=class n extends ei{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new n(e,t)}matches(e){return Fh(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.Pe!==null||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}};fa=class extends _e{constructor(e,t,r){super(e,t,r),this.key=U.fromName(r.referenceValue)}matches(e){let t=U.comparator(e.key,this.key);return this.matchesComparison(t)}},ga=class extends _e{constructor(e,t){super(e,"in",t),this.keys=Uh("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},ya=class extends _e{constructor(e,t){super(e,"not-in",t),this.keys=Uh("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};wa=class extends _e{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return Gc(t)&&$r(t.arrayValue,this.value)}},_a=class extends _e{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&$r(this.value.arrayValue,t)}},ba=class extends _e{constructor(e,t){super(e,"not-in",t)}matches(e){if($r(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&t.nullValue===void 0&&!$r(this.value.arrayValue,t)}},va=class extends _e{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!Gc(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>$r(this.value.arrayValue,r))}};Ea=class{constructor(e,t=null,r=[],s=[],o=null,a=null,c=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=s,this.limit=o,this.startAt=a,this.endAt=c,this.Te=null}};jn=class{constructor(e,t=null,r=[],s=[],o=null,a="F",c=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=s,this.limit=o,this.limitType=a,this.startAt=c,this.endAt=u,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}};vt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[s,o]of r)if(this.equalsFn(s,e))return o}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),s=this.inner[r];if(s===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let o=0;o<s.length;o++)if(this.equalsFn(s[o][0],e))return void(s[o]=[e,t]);s.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return r.length===1?delete this.inner[t]:r.splice(s,1),this.innerSize--,!0;return!1}forEach(e){gn(this.inner,(t,r)=>{for(let[s,o]of r)e(s,o)})}isEmpty(){return Ph(this.inner)}size(){return this.innerSize}};Wg=new de(U.comparator);Gh=new de(U.comparator);Qg=new de(U.comparator),Xg=new Ee(U.comparator);Jg=new Ee(X);Gn=class{constructor(){this._=void 0}};Hn=class extends Gn{},hn=class extends Gn{constructor(e){super(),this.elements=e}};pn=class extends Gn{constructor(e){super(),this.elements=e}};Kn=class extends Gn{constructor(e,t){super(),this.serializer=e,this.Ae=t}};Ta=class{constructor(e,t){this.version=e,this.transformResults=t}},cn=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};Wn=class{};mn=class extends Wn{constructor(e,t,r,s=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}},It=class extends Wn{constructor(e,t,r,s,o=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=s,this.fieldTransforms=o,this.type=1}getFieldMask(){return this.fieldMask}};ti=class extends Wn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Sa=class extends Wn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};Aa=class{constructor(e,t,r,s){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=s}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let s=0;s<this.mutations.length;s++){let o=this.mutations[s];o.key.isEqual(e.key)&&ry(o,e,r[s])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=kr(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=kr(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=Kh();return this.mutations.forEach(s=>{let o=e.get(s.key),a=o.overlayedDocument,c=this.applyToLocalView(a,o.mutatedFields);c=t.has(s.key)?null:c;let u=Zh(a,c);u!==null&&r.set(s.key,u),a.isValidDocument()||a.convertToNoDocument(G.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),J())}isEqual(e){return this.batchId===e.batchId&&On(this.mutations,e.mutations,(t,r)=>jd(t,r))&&On(this.baseMutations,e.baseMutations,(t,r)=>jd(t,r))}},Ca=class n{constructor(e,t,r,s){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=s}static from(e,t,r){ee(e.mutations.length===r.length,58842,{me:e.mutations.length,fe:r.length});let s=function(){return Qg}(),o=e.mutations;for(let a=0;a<o.length;a++)s=s.insert(o[a].key,r[a].version);return new n(e,t,r,s)}};Pa=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};Da=class{constructor(e,t){this.count=e,this.unchangedNames=t}};(Z=me||(me={}))[Z.OK=0]="OK",Z[Z.CANCELLED=1]="CANCELLED",Z[Z.UNKNOWN=2]="UNKNOWN",Z[Z.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Z[Z.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Z[Z.NOT_FOUND=5]="NOT_FOUND",Z[Z.ALREADY_EXISTS=6]="ALREADY_EXISTS",Z[Z.PERMISSION_DENIED=7]="PERMISSION_DENIED",Z[Z.UNAUTHENTICATED=16]="UNAUTHENTICATED",Z[Z.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Z[Z.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Z[Z.ABORTED=10]="ABORTED",Z[Z.OUT_OF_RANGE=11]="OUT_OF_RANGE",Z[Z.UNIMPLEMENTED=12]="UNIMPLEMENTED",Z[Z.INTERNAL=13]="INTERNAL",Z[Z.UNAVAILABLE=14]="UNAVAILABLE",Z[Z.DATA_LOSS=15]="DATA_LOSS";oy=null;cy=new gt([4294967295,4294967295],0);Ra=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new on(`Invalid padding: ${t}`);if(r<0)throw new on(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new on(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new on(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=gt.fromNumber(this.ge)}ye(e,t,r){let s=e.add(t.multiply(gt.fromNumber(r)));return s.compare(cy)===1&&(s=new gt([s.getBits(0),s.getBits(1)],0)),s.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(this.ge===0)return!1;let t=Kd(e),[r,s]=Wd(t);for(let o=0;o<this.hashCount;o++){let a=this.ye(r,s,o);if(!this.we(a))return!1}return!0}static create(e,t,r){let s=e%8==0?0:8-e%8,o=new Uint8Array(Math.ceil(e/8)),a=new n(o,s,t);return r.forEach(c=>a.insert(c)),a}insert(e){if(this.ge===0)return;let t=Kd(e),[r,s]=Wd(t);for(let o=0;o<this.hashCount;o++){let a=this.ye(r,s,o);this.Se(a)}}Se(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},on=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};ni=class n{constructor(e,t,r,s,o){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=s,this.resolvedLimboDocuments=o}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let s=new Map;return s.set(e,qr.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(G.min(),s,new de(X),Et(),J())}},qr=class n{constructor(e,t,r,s,o){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=s,this.removedDocuments=o}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,J(),J(),J())}};Mn=class{constructor(e,t,r,s){this.be=e,this.removedTargetIds=t,this.key=r,this.De=s}},ri=class{constructor(e,t){this.targetId=e,this.Ce=t}},si=class{constructor(e,t,r=Ce.EMPTY_BYTE_STRING,s=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=s}},ii=class{constructor(){this.ve=0,this.Fe=Qd(),this.Me=Ce.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return this.ve!==0}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=J(),t=J(),r=J();return this.Fe.forEach((s,o)=>{switch(o){case 0:e=e.add(s);break;case 2:t=t.add(s);break;case 1:r=r.add(s);break;default:q(38017,{changeType:o})}}),new qr(this.Me,this.xe,e,t,r)}qe(){this.Oe=!1,this.Fe=Qd()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,ee(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}},Na=class{constructor(e){this.Ge=e,this.ze=new Map,this.je=Et(),this.Je=Us(),this.He=Us(),this.Ye=new de(X)}Ze(e){for(let t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let r=this.nt(t);switch(e.state){case 0:this.rt(t)&&r.Le(e.resumeToken);break;case 1:r.Ke(),r.Ne||r.qe(),r.Le(e.resumeToken);break;case 2:r.Ke(),r.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(r.We(),r.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),r.Le(e.resumeToken));break;default:q(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((r,s)=>{this.rt(s)&&t(s)})}st(e){let t=e.targetId,r=e.Ce.count,s=this.ot(t);if(s){let o=s.target;if(Ia(o))if(r===0){let a=new U(o.path);this.et(t,a,We.newNoDocument(a,G.min()))}else ee(r===1,20013,{expectedCount:r});else{let a=this._t(t);if(a!==r){let c=this.ut(e),u=c?this.ct(c,e,a):1;if(u!==0){this.it(t);let d=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ye=this.Ye.insert(t,d)}oy?.lt(function(p,m,g,b,S){let v={localCacheCount:p,existenceFilterCount:m.count,databaseId:g.database,projectId:g.projectId},C=m.unchangedNames;return C&&(v.bloomFilter={applied:S===0,hashCount:C?.hashCount??0,bitmapLength:C?.bits?.bitmap?.length??0,padding:C?.bits?.padding??0,mightContain:D=>b?.mightContain(D)??!1}),v}(a,e.Ce,this.Ge.ht(),c,u))}}}}ut(e){let t=e.Ce.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:s=0},hashCount:o=0}=t,a,c;try{a=bt(r).toUint8Array()}catch(u){if(u instanceof Js)return Ln("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{c=new Ra(a,s,o)}catch(u){return Ln(u instanceof on?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return c.ge===0?null:c}ct(e,t,r){return t.Ce.count===r-this.Pt(e,t.targetId)?0:2}Pt(e,t){let r=this.Ge.getRemoteKeysForTarget(t),s=0;return r.forEach(o=>{let a=this.Ge.ht(),c=`projects/${a.projectId}/databases/${a.database}/documents/${o.path.canonicalString()}`;e.mightContain(c)||(this.et(t,o,null),s++)}),s}Tt(e){let t=new Map;this.ze.forEach((o,a)=>{let c=this.ot(a);if(c){if(o.current&&Ia(c.target)){let u=new U(c.target.path);this.It(u).has(a)||this.Et(a,u)||this.et(a,u,We.newNoDocument(u,e))}o.Be&&(t.set(a,o.ke()),o.qe())}});let r=J();this.He.forEach((o,a)=>{let c=!0;a.forEachWhile(u=>{let d=this.ot(u);return!d||d.purpose==="TargetPurposeLimboResolution"||(c=!1,!1)}),c&&(r=r.add(o))}),this.je.forEach((o,a)=>a.setReadTime(e));let s=new ni(e,t,this.Ye,this.je,r);return this.je=Et(),this.Je=Us(),this.He=Us(),this.Ye=new de(X),s}Xe(e,t){if(!this.rt(e))return;let r=this.Et(e,t.key)?2:0;this.nt(e).Qe(t.key,r),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,r){if(!this.rt(e))return;let s=this.nt(e);this.Et(e,t)?s.Qe(t,1):s.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),r&&(this.je=this.je.insert(t,r))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new ii,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new Ee(X),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new Ee(X),this.Je=this.Je.insert(e,t)),t}rt(e){let t=this.ot(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new ii),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}};ly={asc:"ASCENDING",desc:"DESCENDING"},uy={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},dy={and:"AND",or:"OR"},ka=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};Ur=class n{constructor(e,t,r,s,o=G.min(),a=G.min(),c=Ce.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=s,this.snapshotVersion=o,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=c,this.expectedCount=u}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};Fa=class{constructor(e){this.yt=e}};ai=class{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(e.booleanValue?1:0);else if("integerValue"in e)this.Ft(t,15),t.Mt(ie(e.integerValue));else if("doubleValue"in e){let r=ie(e.doubleValue);isNaN(r)?this.Ft(t,13):(this.Ft(t,15),Fr(r)?t.Mt(0):t.Mt(r))}else if("timestampValue"in e){let r=e.timestampValue;this.Ft(t,20),typeof r=="string"&&(r=_t(r)),t.xt(`${r.seconds||""}`),t.Mt(r.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(bt(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.Ft(t,45),t.Mt(r.latitude||0),t.Mt(r.longitude||0)}else"mapValue"in e?Lh(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):Vh(e)?this.kt(e.mapValue,t):(this.qt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.Qt(e.arrayValue,t),this.Nt(t)):q(19022,{$t:e})}Ot(e,t){this.Ft(t,25),this.Ut(e,t)}Ut(e,t){t.xt(e)}qt(e,t){let r=e.fields||{};this.Ft(t,55);for(let s of Object.keys(r))this.Ot(s,t),this.Ct(r[s],t)}kt(e,t){let r=e.fields||{};this.Ft(t,53);let s=Bn,o=r[s].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(ie(o)),this.Ot(s,t),this.Ct(r[s],t)}Qt(e,t){let r=e.values||[];this.Ft(t,50);for(let s of r)this.Ct(s,t)}Lt(e,t){this.Ft(t,37),U.fromName(e).path.forEach(r=>{this.Ft(t,60),this.Ut(r,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}};ai.Kt=new ai;Ba=class{constructor(){this.Cn=new $a}addToCollectionParentIndex(e,t){return this.Cn.add(t),N.resolve()}getCollectionParents(e,t){return N.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return N.resolve()}deleteFieldIndex(e,t){return N.resolve()}deleteAllFieldIndexes(e){return N.resolve()}createTargetIndexes(e,t){return N.resolve()}getDocumentsMatchingTarget(e,t){return N.resolve(null)}getIndexType(e,t){return N.resolve(0)}getFieldIndexes(e,t){return N.resolve([])}getNextCollectionGroupToUpdate(e){return N.resolve(null)}getMinOffset(e,t){return N.resolve(dn.min())}getMinOffsetFromCollectionGroup(e,t){return N.resolve(dn.min())}updateCollectionGroup(e,t,r){return N.resolve()}updateIndexEntries(e,t){return N.resolve()}},$a=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),s=this.index[t]||new Ee(pe.comparator),o=!s.has(r);return this.index[t]=s.add(r),o}has(e){let t=e.lastSegment(),r=e.popLast(),s=this.index[t];return s&&s.has(r)}getEntries(e){return(this.index[e]||new Ee(pe.comparator)).toArray()}};o_=new Uint8Array(0);Jd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},lp=41943040,ze=class n{static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}};ze.DEFAULT_COLLECTION_PERCENTILE=10,ze.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ze.DEFAULT=new ze(lp,ze.DEFAULT_COLLECTION_PERCENTILE,ze.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ze.DISABLED=new ze(-1,0,0);zr=class n{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new n(0)}static cr(){return new n(-1)}};Yd="LruGarbageCollector",Sy=1048576;qa=class{constructor(e){this.Ir=e,this.buffer=new Ee(Zd),this.Er=0}dr(){return++this.Er}Ar(e){let t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();Zd(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},Ua=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Rr=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return this.Rr!==null}Vr(e){V(Yd,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Zn(t)?V(Yd,"Ignoring IndexedDB error during garbage collection: ",t):await Yn(t)}await this.Vr(3e5)})}},za=class{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return N.resolve(Fn.ce);let r=new qa(t);return this.mr.forEachTarget(e,s=>r.Ar(s.sequenceNumber)).next(()=>this.mr.pr(e,s=>r.Ar(s))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.mr.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),N.resolve(Jd)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Jd):this.yr(e,t))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let r,s,o,a,c,u,d,p=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(m=>(m>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${m}`),s=this.params.maximumSequenceNumbersToCollect):s=m,a=Date.now(),this.nthSequenceNumber(e,s))).next(m=>(r=m,c=Date.now(),this.removeTargets(e,r,t))).next(m=>(o=m,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(m=>(d=Date.now(),Pn()<=Y.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-p}ms
	Determined least recently used ${s} in `+(c-a)+`ms
	Removed ${o} targets in `+(u-c)+`ms
	Removed ${m} documents in `+(d-u)+`ms
Total Duration: ${d-p}ms`),N.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:o,documentsRemoved:m})))}};ja=class{constructor(){this.changes=new vt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,We.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?N.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};Ga=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};Ha=class{constructor(e,t,r,s){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=s}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(s=>(r=s,this.remoteDocumentCache.getEntry(e,t))).next(s=>(r!==null&&kr(r.mutation,s,Ze.empty(),ye.now()),s))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,J()).next(()=>r))}getLocalViewOfDocuments(e,t,r=J()){let s=sn();return this.populateOverlays(e,s,t).next(()=>this.computeViews(e,t,s,r).next(o=>{let a=Pr();return o.forEach((c,u)=>{a=a.insert(c,u.overlayedDocument)}),a}))}getOverlayedDocuments(e,t){let r=sn();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,J()))}populateOverlays(e,t,r){let s=[];return r.forEach(o=>{t.has(o)||s.push(o)}),this.documentOverlayCache.getOverlays(e,s).next(o=>{o.forEach((a,c)=>{t.set(a,c)})})}computeViews(e,t,r,s){let o=Et(),a=Nr(),c=function(){return Nr()}();return t.forEach((u,d)=>{let p=r.get(d.key);s.has(d.key)&&(p===void 0||p.mutation instanceof It)?o=o.insert(d.key,d):p!==void 0?(a.set(d.key,p.mutation.getFieldMask()),kr(p.mutation,d,p.mutation.getFieldMask(),ye.now())):a.set(d.key,Ze.empty())}),this.recalculateAndSaveOverlays(e,o).next(u=>(u.forEach((d,p)=>a.set(d,p)),t.forEach((d,p)=>c.set(d,new Ga(p,a.get(d)??null))),c))}recalculateAndSaveOverlays(e,t){let r=Nr(),s=new de((a,c)=>a-c),o=J();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(a=>{for(let c of a)c.keys().forEach(u=>{let d=t.get(u);if(d===null)return;let p=r.get(u)||Ze.empty();p=c.applyToLocalView(d,p),r.set(u,p);let m=(s.get(c.batchId)||J()).add(u);s=s.insert(c.batchId,m)})}).next(()=>{let a=[],c=s.getReverseIterator();for(;c.hasNext();){let u=c.getNext(),d=u.key,p=u.value,m=Kh();p.forEach(g=>{if(!o.has(g)){let b=Zh(t.get(g),r.get(g));b!==null&&m.set(g,b),o=o.add(g)}}),a.push(this.documentOverlayCache.saveOverlays(e,d,m))}return N.waitFor(a)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,s){return function(a){return U.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):jg(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,s):this.getDocumentsMatchingCollectionQuery(e,t,r,s)}getNextDocuments(e,t,r,s){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,s).next(o=>{let a=s-o.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,s-o.size):N.resolve(sn()),c=Or,u=o;return a.next(d=>N.forEach(d,(p,m)=>(c<m.largestBatchId&&(c=m.largestBatchId),o.get(p)?N.resolve():this.remoteDocumentCache.getEntry(e,p).next(g=>{u=u.insert(p,g)}))).next(()=>this.populateOverlays(e,d,o)).next(()=>this.computeViews(e,u,d,J())).next(p=>({batchId:c,changes:Hh(p)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new U(t)).next(r=>{let s=Pr();return r.isFoundDocument()&&(s=s.insert(r.key,r)),s})}getDocumentsMatchingCollectionGroupQuery(e,t,r,s){let o=t.collectionGroup,a=Pr();return this.indexManager.getCollectionParents(e,o).next(c=>N.forEach(c,u=>{let d=function(m,g){return new jn(g,null,m.explicitOrderBy.slice(),m.filters.slice(),m.limit,m.limitType,m.startAt,m.endAt)}(t,u.child(o));return this.getDocumentsMatchingCollectionQuery(e,d,r,s).next(p=>{p.forEach((m,g)=>{a=a.insert(m,g)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(e,t,r,s){let o;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(a=>(o=a,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,o,s))).next(a=>{o.forEach((u,d)=>{let p=d.getKey();a.get(p)===null&&(a=a.insert(p,We.newInvalidDocument(p)))});let c=Pr();return a.forEach((u,d)=>{let p=o.get(u);p!==void 0&&kr(p.mutation,d,Ze.empty(),ye.now()),Ai(t,d)&&(c=c.insert(u,d))}),c})}};Ka=class{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return N.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,function(s){return{id:s.id,version:s.version,createTime:rt(s.createTime)}}(t)),N.resolve()}getNamedQuery(e,t){return N.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,function(s){return{name:s.name,query:Ty(s.bundledQuery),readTime:rt(s.readTime)}}(t)),N.resolve()}};Wa=class{constructor(){this.overlays=new de(U.comparator),this.qr=new Map}getOverlay(e,t){return N.resolve(this.overlays.get(t))}getOverlays(e,t){let r=sn();return N.forEach(t,s=>this.getOverlay(e,s).next(o=>{o!==null&&r.set(s,o)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((s,o)=>{this.St(e,t,o)}),N.resolve()}removeOverlaysForBatchId(e,t,r){let s=this.qr.get(r);return s!==void 0&&(s.forEach(o=>this.overlays=this.overlays.remove(o)),this.qr.delete(r)),N.resolve()}getOverlaysForCollection(e,t,r){let s=sn(),o=t.length+1,a=new U(t.child("")),c=this.overlays.getIteratorFrom(a);for(;c.hasNext();){let u=c.getNext().value,d=u.getKey();if(!t.isPrefixOf(d.path))break;d.path.length===o&&u.largestBatchId>r&&s.set(u.getKey(),u)}return N.resolve(s)}getOverlaysForCollectionGroup(e,t,r,s){let o=new de((d,p)=>d-p),a=this.overlays.getIterator();for(;a.hasNext();){let d=a.getNext().value;if(d.getKey().getCollectionGroup()===t&&d.largestBatchId>r){let p=o.get(d.largestBatchId);p===null&&(p=sn(),o=o.insert(d.largestBatchId,p)),p.set(d.getKey(),d)}}let c=sn(),u=o.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((d,p)=>c.set(d,p)),!(c.size()>=s)););return N.resolve(c)}St(e,t,r){let s=this.overlays.get(r.key);if(s!==null){let a=this.qr.get(s.largestBatchId).delete(r.key);this.qr.set(s.largestBatchId,a)}this.overlays=this.overlays.insert(r.key,new Pa(t,r));let o=this.qr.get(t);o===void 0&&(o=J(),this.qr.set(t,o)),this.qr.set(t,o.add(r.key))}};Qa=class{constructor(){this.sessionToken=Ce.EMPTY_BYTE_STRING}getSessionToken(e){return N.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,N.resolve()}};jr=class{constructor(){this.Qr=new Ee(fe.$r),this.Ur=new Ee(fe.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){let r=new fe(e,t);this.Qr=this.Qr.add(r),this.Ur=this.Ur.add(r)}Wr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Gr(new fe(e,t))}zr(e,t){e.forEach(r=>this.removeReference(r,t))}jr(e){let t=new U(new pe([])),r=new fe(t,e),s=new fe(t,e+1),o=[];return this.Ur.forEachInRange([r,s],a=>{this.Gr(a),o.push(a.key)}),o}Jr(){this.Qr.forEach(e=>this.Gr(e))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){let t=new U(new pe([])),r=new fe(t,e),s=new fe(t,e+1),o=J();return this.Ur.forEachInRange([r,s],a=>{o=o.add(a.key)}),o}containsKey(e){let t=new fe(e,0),r=this.Qr.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},fe=class{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return U.comparator(e.key,t.key)||X(e.Yr,t.Yr)}static Kr(e,t){return X(e.Yr,t.Yr)||U.comparator(e.key,t.key)}};Xa=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new Ee(fe.$r)}checkEmpty(e){return N.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,s){let o=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let a=new Aa(o,t,r,s);this.mutationQueue.push(a);for(let c of s)this.Zr=this.Zr.add(new fe(c.key,o)),this.indexManager.addToCollectionParentIndex(e,c.key.path.popLast());return N.resolve(a)}lookupMutationBatch(e,t){return N.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,s=this.ei(r),o=s<0?0:s;return N.resolve(this.mutationQueue.length>o?this.mutationQueue[o]:null)}getHighestUnacknowledgedBatchId(){return N.resolve(this.mutationQueue.length===0?qc:this.tr-1)}getAllMutationBatches(e){return N.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new fe(t,0),s=new fe(t,Number.POSITIVE_INFINITY),o=[];return this.Zr.forEachInRange([r,s],a=>{let c=this.Xr(a.Yr);o.push(c)}),N.resolve(o)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Ee(X);return t.forEach(s=>{let o=new fe(s,0),a=new fe(s,Number.POSITIVE_INFINITY);this.Zr.forEachInRange([o,a],c=>{r=r.add(c.Yr)})}),N.resolve(this.ti(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,s=r.length+1,o=r;U.isDocumentKey(o)||(o=o.child(""));let a=new fe(new U(o),0),c=new Ee(X);return this.Zr.forEachWhile(u=>{let d=u.key.path;return!!r.isPrefixOf(d)&&(d.length===s&&(c=c.add(u.Yr)),!0)},a),N.resolve(this.ti(c))}ti(e){let t=[];return e.forEach(r=>{let s=this.Xr(r);s!==null&&t.push(s)}),t}removeMutationBatch(e,t){ee(this.ni(t.batchId,"removed")===0,55003),this.mutationQueue.shift();let r=this.Zr;return N.forEach(t.mutations,s=>{let o=new fe(s.key,t.batchId);return r=r.delete(o),this.referenceDelegate.markPotentiallyOrphaned(e,s.key)}).next(()=>{this.Zr=r})}ir(e){}containsKey(e,t){let r=new fe(t,0),s=this.Zr.firstAfterOrEqual(r);return N.resolve(t.isEqual(s&&s.key))}performConsistencyCheck(e){return this.mutationQueue.length,N.resolve()}ni(e,t){return this.ei(e)}ei(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Xr(e){let t=this.ei(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};Ja=class{constructor(e){this.ri=e,this.docs=function(){return new de(U.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,s=this.docs.get(r),o=s?s.size:0,a=this.ri(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:a}),this.size+=a-o,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return N.resolve(r?r.document.mutableCopy():We.newInvalidDocument(t))}getEntries(e,t){let r=Et();return t.forEach(s=>{let o=this.docs.get(s);r=r.insert(s,o?o.document.mutableCopy():We.newInvalidDocument(s))}),N.resolve(r)}getDocumentsMatchingQuery(e,t,r,s){let o=Et(),a=t.path,c=new U(a.child("__id-9223372036854775808__")),u=this.docs.getIteratorFrom(c);for(;u.hasNext();){let{key:d,value:{document:p}}=u.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||xg(Ig(p),r)<=0||(s.has(p.key)||Ai(t,p))&&(o=o.insert(p.key,p.mutableCopy()))}return N.resolve(o)}getAllFromCollectionGroup(e,t,r,s){q(9500)}ii(e,t){return N.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new Ya(this)}getSize(e){return N.resolve(this.size)}},Ya=class extends ja{constructor(e){super(),this.Nr=e}applyChanges(e){let t=[];return this.changes.forEach((r,s)=>{s.isValidDocument()?t.push(this.Nr.addEntry(e,s)):this.Nr.removeEntry(r)}),N.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}};Za=class{constructor(e){this.persistence=e,this.si=new vt(t=>Hc(t),Kc),this.lastRemoteSnapshotVersion=G.min(),this.highestTargetId=0,this.oi=0,this._i=new jr,this.targetCount=0,this.ai=zr.ur()}forEachTarget(e,t){return this.si.forEach((r,s)=>t(s)),N.resolve()}getLastRemoteSnapshotVersion(e){return N.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return N.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),N.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.oi&&(this.oi=t),N.resolve()}Pr(e){this.si.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.ai=new zr(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,N.resolve()}updateTargetData(e,t){return this.Pr(t),N.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,N.resolve()}removeTargets(e,t,r){let s=0,o=[];return this.si.forEach((a,c)=>{c.sequenceNumber<=t&&r.get(c.targetId)===null&&(this.si.delete(a),o.push(this.removeMatchingKeysForTargetId(e,c.targetId)),s++)}),N.waitFor(o).next(()=>s)}getTargetCount(e){return N.resolve(this.targetCount)}getTargetData(e,t){let r=this.si.get(t)||null;return N.resolve(r)}addMatchingKeys(e,t,r){return this._i.Wr(t,r),N.resolve()}removeMatchingKeys(e,t,r){this._i.zr(t,r);let s=this.persistence.referenceDelegate,o=[];return s&&t.forEach(a=>{o.push(s.markPotentiallyOrphaned(e,a))}),N.waitFor(o)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),N.resolve()}getMatchingKeysForTargetId(e,t){let r=this._i.Hr(t);return N.resolve(r)}containsKey(e,t){return N.resolve(this._i.containsKey(t))}};ci=class{constructor(e,t){this.ui={},this.overlays={},this.ci=new Fn(0),this.li=!1,this.li=!0,this.hi=new Qa,this.referenceDelegate=e(this),this.Pi=new Za(this),this.indexManager=new Ba,this.remoteDocumentCache=function(s){return new Ja(s)}(r=>this.referenceDelegate.Ti(r)),this.serializer=new Fa(t),this.Ii=new Ka(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Wa,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.ui[e.toKey()];return r||(r=new Xa(t,this.referenceDelegate),this.ui[e.toKey()]=r),r}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let s=new ec(this.ci.next());return this.referenceDelegate.Ei(),r(s).next(o=>this.referenceDelegate.di(s).next(()=>o)).toPromise().then(o=>(s.raiseOnCommittedEvent(),o))}Ai(e,t){return N.or(Object.values(this.ui).map(r=>()=>r.containsKey(e,t)))}},ec=class extends ua{constructor(e){super(),this.currentSequenceNumber=e}},tc=class n{constructor(e){this.persistence=e,this.Ri=new jr,this.Vi=null}static mi(e){return new n(e)}get fi(){if(this.Vi)return this.Vi;throw q(60996)}addReference(e,t,r){return this.Ri.addReference(r,t),this.fi.delete(r.toString()),N.resolve()}removeReference(e,t,r){return this.Ri.removeReference(r,t),this.fi.add(r.toString()),N.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),N.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach(s=>this.fi.add(s.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(s=>{s.forEach(o=>this.fi.add(o.toString()))}).next(()=>r.removeTargetData(e,t))}Ei(){this.Vi=new Set}di(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return N.forEach(this.fi,r=>{let s=U.fromPath(r);return this.gi(e,s).next(o=>{o||t.removeEntry(s,G.min())})}).next(()=>(this.Vi=null,t.apply(e)))}updateLimboDocument(e,t){return this.gi(e,t).next(r=>{r?this.fi.delete(t.toString()):this.fi.add(t.toString())})}Ti(e){return 0}gi(e,t){return N.or([()=>N.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}},li=class n{constructor(e,t){this.persistence=e,this.pi=new vt(r=>Cg(r.path),(r,s)=>r.isEqual(s)),this.garbageCollector=Ay(this,t)}static mi(e,t){return new n(e,t)}Ei(){}di(e){return N.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){let t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next(r=>t.next(s=>r+s))}wr(e){let t=0;return this.pr(e,r=>{t++}).next(()=>t)}pr(e,t){return N.forEach(this.pi,(r,s)=>this.br(e,r,s).next(o=>o?N.resolve():t(s)))}removeTargets(e,t,r){return this.persistence.getTargetCache().removeTargets(e,t,r)}removeOrphanedDocuments(e,t){let r=0,s=this.persistence.getRemoteDocumentCache(),o=s.newChangeBuffer();return s.ii(e,a=>this.br(e,a,t).next(c=>{c||(r++,o.removeEntry(a,G.min()))})).next(()=>o.apply(e)).next(()=>r)}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),N.resolve()}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,r)}addReference(e,t,r){return this.pi.set(r,e.currentSequenceNumber),N.resolve()}removeReference(e,t,r){return this.pi.set(r,e.currentSequenceNumber),N.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),N.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=js(e.data.value)),t}br(e,t,r){return N.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let s=this.pi.get(t);return N.resolve(s!==void 0&&s>r)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}};nc=class n{constructor(e,t,r,s){this.targetId=e,this.fromCache=t,this.Es=r,this.ds=s}static As(e,t){let r=J(),s=J();for(let o of t.docChanges)switch(o.type){case 0:r=r.add(o.doc.key);break;case 1:s=s.add(o.doc.key)}return new n(e,t.fromCache,r,s)}};rc=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};sc=class{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=function(){return td()?8:Sg(ed())>0?6:4}()}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,r,s){let o={result:null};return this.ys(e,t).next(a=>{o.result=a}).next(()=>{if(!o.result)return this.ws(e,t,s,r).next(a=>{o.result=a})}).next(()=>{if(o.result)return;let a=new rc;return this.Ss(e,t,a).next(c=>{if(o.result=c,this.Vs)return this.bs(e,t,a,c.size)})}).next(()=>o.result)}bs(e,t,r,s){return r.documentReadCount<this.fs?(Pn()<=Y.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",Dn(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),N.resolve()):(Pn()<=Y.DEBUG&&V("QueryEngine","Query:",Dn(t),"scans",r.documentReadCount,"local documents and returns",s,"documents as results."),r.documentReadCount>this.gs*s?(Pn()<=Y.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",Dn(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nt(t))):N.resolve())}ys(e,t){if(Ud(t))return N.resolve(null);let r=nt(t);return this.indexManager.getIndexType(e,r).next(s=>s===0?null:(t.limit!==null&&s===1&&(t=xa(t,null,"F"),r=nt(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(o=>{let a=J(...o);return this.ps.getDocuments(e,a).next(c=>this.indexManager.getMinOffset(e,r).next(u=>{let d=this.Ds(t,c);return this.Cs(t,d,a,u.readTime)?this.ys(e,xa(t,null,"F")):this.vs(e,d,t,u)}))})))}ws(e,t,r,s){return Ud(t)||s.isEqual(G.min())?N.resolve(null):this.ps.getDocuments(e,r).next(o=>{let a=this.Ds(t,o);return this.Cs(t,a,r,s)?N.resolve(null):(Pn()<=Y.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Dn(t)),this.vs(e,a,t,Eg(s,Or)).next(c=>c))})}Ds(e,t){let r=new Ee(jh(e));return t.forEach((s,o)=>{Ai(e,o)&&(r=r.add(o))}),r}Cs(e,t,r,s){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let o=e.limitType==="F"?t.last():t.first();return!!o&&(o.hasPendingWrites||o.version.compareTo(s)>0)}Ss(e,t,r){return Pn()<=Y.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",Dn(t)),this.ps.getDocumentsMatchingQuery(e,t,dn.min(),r)}vs(e,t,r,s){return this.ps.getDocumentsMatchingQuery(e,r,s).next(o=>(t.forEach(a=>{o=o.insert(a.key,a)}),o))}};Jc="LocalStore",Cy=3e8,ic=class{constructor(e,t,r,s){this.persistence=e,this.Fs=t,this.serializer=s,this.Ms=new de(X),this.xs=new vt(o=>Hc(o),Kc),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(r)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Ha(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}};ui=class{constructor(){this.activeTargetIds=Yg()}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},ac=class{constructor(){this.Mo=new ui,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,r){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new ui,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};cc=class{Oo(e){}shutdown(){}};th="ConnectivityMonitor",di=class{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){V(th,"Network connectivity changed: AVAILABLE");for(let e of this.qo)e(0)}ko(){V(th,"Network connectivity changed: UNAVAILABLE");for(let e of this.qo)e(1)}static v(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};zs=null;Zo="RestConnection",Ly={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"},uc=class{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",r=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${r}/databases/${s}`,this.Wo=this.databaseId.database===Ys?`project_id=${r}`:`project_id=${r}&database_id=${s}`}Go(e,t,r,s,o){let a=lc(),c=this.zo(e,t.toUriEncodedString());V(Zo,`Sending RPC '${e}' ${a}:`,c,r);let u={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(u,s,o);let{host:d}=new URL(c),p=Ms(d);return this.Jo(e,c,u,r,p).then(m=>(V(Zo,`Received RPC '${e}' ${a}: `,m),m),m=>{throw Ln(Zo,`RPC '${e}' ${a} failed with error: `,m,"url: ",c,"request:",r),m})}Ho(e,t,r,s,o,a){return this.Go(e,t,r,s,o)}jo(e,t,r){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Jn}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((s,o)=>e[o]=s),r&&r.headers.forEach((s,o)=>e[o]=s)}zo(e,t){let r=Ly[e];return`${this.Uo}/v1/${t}:${r}`}terminate(){}};dc=class{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}};Ae="WebChannelConnection",hc=class extends uc{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,r,s,o){let a=lc();return new Promise((c,u)=>{let d=new Ho;d.setWithCredentials(!0),d.listenOnce(Ko.COMPLETE,()=>{try{switch(d.getLastErrorCode()){case Cr.NO_ERROR:let m=d.getResponseJson();V(Ae,`XHR for RPC '${e}' ${a} received:`,JSON.stringify(m)),c(m);break;case Cr.TIMEOUT:V(Ae,`RPC '${e}' ${a} timed out`),u(new $(R.DEADLINE_EXCEEDED,"Request time out"));break;case Cr.HTTP_ERROR:let g=d.getStatus();if(V(Ae,`RPC '${e}' ${a} failed with status:`,g,"response text:",d.getResponseText()),g>0){let b=d.getResponseJson();Array.isArray(b)&&(b=b[0]);let S=b?.error;if(S&&S.status&&S.message){let v=function(D){let k=D.toLowerCase().replace(/_/g,"-");return Object.values(R).indexOf(k)>=0?k:R.UNKNOWN}(S.status);u(new $(v,S.message))}else u(new $(R.UNKNOWN,"Server responded with status "+d.getStatus()))}else u(new $(R.UNAVAILABLE,"Connection failed."));break;default:q(9055,{l_:e,streamId:a,h_:d.getLastErrorCode(),P_:d.getLastError()})}}finally{V(Ae,`RPC '${e}' ${a} completed.`)}});let p=JSON.stringify(s);V(Ae,`RPC '${e}' ${a} sending request:`,s),d.send(t,"POST",p,r,15)})}T_(e,t,r){let s=lc(),o=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=Xo(),c=Qo(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;d!==void 0&&(u.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(u.useFetchStreams=!0),this.jo(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;let p=o.join("");V(Ae,`Creating RPC '${e}' stream ${s}: ${p}`,u);let m=a.createWebChannel(p,u);this.I_(m);let g=!1,b=!1,S=new dc({Yo:C=>{b?V(Ae,`Not sending because RPC '${e}' stream ${s} is closed:`,C):(g||(V(Ae,`Opening RPC '${e}' stream ${s} transport.`),m.open(),g=!0),V(Ae,`RPC '${e}' stream ${s} sending:`,C),m.send(C))},Zo:()=>m.close()}),v=(C,D,k)=>{C.listen(D,L=>{try{k(L)}catch(H){setTimeout(()=>{throw H},0)}})};return v(m,Cn.EventType.OPEN,()=>{b||(V(Ae,`RPC '${e}' stream ${s} transport opened.`),S.o_())}),v(m,Cn.EventType.CLOSE,()=>{b||(b=!0,V(Ae,`RPC '${e}' stream ${s} transport closed`),S.a_(),this.E_(m))}),v(m,Cn.EventType.ERROR,C=>{b||(b=!0,Ln(Ae,`RPC '${e}' stream ${s} transport errored. Name:`,C.name,"Message:",C.message),S.a_(new $(R.UNAVAILABLE,"The operation could not be completed")))}),v(m,Cn.EventType.MESSAGE,C=>{if(!b){let D=C.data[0];ee(!!D,16349);let k=D,L=k?.error||k[0]?.error;if(L){V(Ae,`RPC '${e}' stream ${s} received error:`,L);let H=L.status,F=function(y){let _=me[y];if(_!==void 0)return tp(_)}(H),W=L.message;F===void 0&&(F=R.INTERNAL,W="Unknown error status: "+H+" with message "+L.message),b=!0,S.a_(new $(F,W)),m.close()}else V(Ae,`RPC '${e}' stream ${s} received:`,D),S.u_(D)}}),v(c,Wo.STAT_EVENT,C=>{C.stat===$s.PROXY?V(Ae,`RPC '${e}' stream ${s} detected buffering proxy`):C.stat===$s.NOPROXY&&V(Ae,`RPC '${e}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{S.__()},0),S}terminate(){this.c_.forEach(e=>e.close()),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter(t=>t===e)}};hi=class{constructor(e,t,r=1e3,s=1.5,o=6e4){this.Mi=e,this.timerId=t,this.d_=r,this.A_=s,this.R_=o,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();let t=Math.floor(this.V_+this.y_()),r=Math.max(0,Date.now()-this.f_),s=Math.max(0,t-r);s>0&&V("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,s,()=>(this.f_=Date.now(),e())),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){this.m_!==null&&(this.m_.skipDelay(),this.m_=null)}cancel(){this.m_!==null&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}};nh="PersistentStream",pi=class{constructor(e,t,r,s,o,a,c,u){this.Mi=e,this.S_=r,this.b_=s,this.connection=o,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=c,this.listener=u,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new hi(e,t)}x_(){return this.state===1||this.state===5||this.O_()}O_(){return this.state===2||this.state===3}start(){this.F_=0,this.state!==4?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&this.C_===null&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,()=>this.k_()))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,e!==4?this.M_.reset():t&&t.code===R.RESOURCE_EXHAUSTED?(wt(t.toString()),wt("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===R.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;let e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,s])=>{this.D_===t&&this.G_(r,s)},r=>{e(()=>{let s=new $(R.UNKNOWN,"Fetching auth token failed: "+r.message);return this.z_(s)})})}G_(e,t){let r=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo(()=>{r(()=>this.listener.Xo())}),this.stream.t_(()=>{r(()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.t_()))}),this.stream.r_(s=>{r(()=>this.z_(s))}),this.stream.onMessage(s=>{r(()=>++this.F_==1?this.J_(s):this.onNext(s))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return V(nh,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget(()=>this.D_===e?t():(V(nh,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},pc=class extends pi{constructor(e,t,r,s,o,a){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,s,a),this.serializer=o}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=my(this.serializer,e),r=function(o){if(!("targetChange"in o))return G.min();let a=o.targetChange;return a.targetIds&&a.targetIds.length?G.min():a.readTime?rt(a.readTime):G.min()}(e);return this.listener.H_(t,r)}Y_(e){let t={};t.database=Oa(this.serializer),t.addTarget=function(o,a){let c,u=a.target;if(c=Ia(u)?{documents:yy(o,u)}:{query:wy(o,u).ft},c.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){c.resumeToken=np(o,a.resumeToken);let d=Ma(o,a.expectedCount);d!==null&&(c.expectedCount=d)}else if(a.snapshotVersion.compareTo(G.min())>0){c.readTime=oi(o,a.snapshotVersion.toTimestamp());let d=Ma(o,a.expectedCount);d!==null&&(c.expectedCount=d)}return c}(this.serializer,e);let r=by(this.serializer,e);r&&(t.labels=r),this.q_(t)}Z_(e){let t={};t.database=Oa(this.serializer),t.removeTarget=e,this.q_(t)}},mc=class extends pi{constructor(e,t,r,s,o,a){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,s,a),this.serializer=o}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return ee(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,ee(!e.writeResults||e.writeResults.length===0,55816),this.listener.ta()}onNext(e){ee(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let t=gy(e.writeResults,e.commitTime),r=rt(e.commitTime);return this.listener.na(r,t)}ra(){let e={};e.database=Oa(this.serializer),this.q_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>fy(this.serializer,r))};this.q_(t)}};fc=class{},gc=class extends fc{constructor(e,t,r,s){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=s,this.ia=!1}sa(){if(this.ia)throw new $(R.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,r,s){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Go(e,Va(t,r),s,o,a)).catch(o=>{throw o.name==="FirebaseError"?(o.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new $(R.UNKNOWN,o.toString())})}Ho(e,t,r,s,o){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,c])=>this.connection.Ho(e,Va(t,r),s,a,c,o)).catch(a=>{throw a.name==="FirebaseError"?(a.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new $(R.UNKNOWN,a.toString())})}terminate(){this.ia=!0,this.connection.terminate()}},yc=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){this.oa===0&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){this.state==="Online"?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,e==="Online"&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(wt(t),this.aa=!1):V("OnlineStateTracker",t)}Pa(){this._a!==null&&(this._a.cancel(),this._a=null)}};fn="RemoteStore",wc=class{constructor(e,t,r,s,o){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=o,this.Aa.Oo(a=>{r.enqueueAndForget(async()=>{yn(this)&&(V(fn,"Restarting streams for network reachability change."),await async function(u){let d=j(u);d.Ea.add(4),await Jr(d),d.Ra.set("Unknown"),d.Ea.delete(4),await Pi(d)}(this))})}),this.Ra=new yc(r,s)}};_c=class n{constructor(e,t,r,s,o){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=s,this.removalCallback=o,this.deferred=new et,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,s,o){let a=Date.now()+r,c=new n(e,t,a,s,o);return c.start(r),c}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new $(R.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};fi=class n{static emptySet(e){return new n(e.comparator)}constructor(e){this.comparator=e?(t,r)=>e(t,r)||U.comparator(t.key,r.key):(t,r)=>U.comparator(t.key,r.key),this.keyedMap=Pr(),this.sortedSet=new de(this.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let s=t.getNext().key,o=r.getNext().key;if(!s.isEqual(o))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};gi=class{constructor(){this.ga=new de(U.comparator)}track(e){let t=e.doc.key,r=this.ga.get(t);r?e.type!==0&&r.type===3?this.ga=this.ga.insert(t,e):e.type===3&&r.type!==1?this.ga=this.ga.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.ga=this.ga.remove(t):e.type===1&&r.type===2?this.ga=this.ga.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):q(63341,{Rt:e,pa:r}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,r)=>{e.push(r)}),e}},Qn=class n{constructor(e,t,r,s,o,a,c,u,d){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=s,this.mutatedKeys=o,this.fromCache=a,this.syncStateChanged=c,this.excludesMetadataChanges=u,this.hasCachedResults=d}static fromInitialDocuments(e,t,r,s,o){let a=[];return t.forEach(c=>{a.push({type:0,doc:c})}),new n(e,t,fi.emptySet(t),a,r,s,!0,!1,o)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Si(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let s=0;s<t.length;s++)if(t[s].type!==r[s].type||!t[s].doc.isEqual(r[s].doc))return!1;return!0}};bc=class{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some(e=>e.Da())}},vc=class{constructor(){this.queries=sh(),this.onlineState="Unknown",this.Ca=new Set}terminate(){(function(t,r){let s=j(t),o=s.queries;s.queries=sh(),o.forEach((a,c)=>{for(let u of c.Sa)u.onError(r)})})(this,new $(R.ABORTED,"Firestore shutting down"))}};(ih=Ec||(Ec={})).Ma="default",ih.Cache="cache";Ic=class{constructor(e,t,r){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=r||{}}Fa(e){if(!this.options.includeMetadataChanges){let r=[];for(let s of e.docChanges)s.type!==3&&r.push(s);e=new Qn(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){if(!e.fromCache||!this.Da())return!0;let r=t!=="Offline";return(!this.options.qa||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}ka(e){e=Qn.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==Ec.Cache}};yi=class{constructor(e){this.key=e}},wi=class{constructor(e){this.key=e}},xc=class{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=J(),this.mutatedKeys=J(),this.eu=jh(e),this.tu=new fi(this.eu)}get nu(){return this.Ya}ru(e,t){let r=t?t.iu:new gi,s=t?t.tu:this.tu,o=t?t.mutatedKeys:this.mutatedKeys,a=s,c=!1,u=this.query.limitType==="F"&&s.size===this.query.limit?s.last():null,d=this.query.limitType==="L"&&s.size===this.query.limit?s.first():null;if(e.inorderTraversal((p,m)=>{let g=s.get(p),b=Ai(this.query,m)?m:null,S=!!g&&this.mutatedKeys.has(g.key),v=!!b&&(b.hasLocalMutations||this.mutatedKeys.has(b.key)&&b.hasCommittedMutations),C=!1;g&&b?g.data.isEqual(b.data)?S!==v&&(r.track({type:3,doc:b}),C=!0):this.su(g,b)||(r.track({type:2,doc:b}),C=!0,(u&&this.eu(b,u)>0||d&&this.eu(b,d)<0)&&(c=!0)):!g&&b?(r.track({type:0,doc:b}),C=!0):g&&!b&&(r.track({type:1,doc:g}),C=!0,(u||d)&&(c=!0)),C&&(b?(a=a.add(b),o=v?o.add(p):o.delete(p)):(a=a.delete(p),o=o.delete(p)))}),this.query.limit!==null)for(;a.size>this.query.limit;){let p=this.query.limitType==="F"?a.last():a.first();a=a.delete(p.key),o=o.delete(p.key),r.track({type:1,doc:p})}return{tu:a,iu:r,Cs:c,mutatedKeys:o}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,s){let o=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let a=e.iu.ya();a.sort((p,m)=>function(b,S){let v=C=>{switch(C){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return q(20277,{Rt:C})}};return v(b)-v(S)}(p.type,m.type)||this.eu(p.doc,m.doc)),this.ou(r),s=s??!1;let c=t&&!s?this._u():[],u=this.Xa.size===0&&this.current&&!s?1:0,d=u!==this.Za;return this.Za=u,a.length!==0||d?{snapshot:new Qn(this.query,e.tu,o,a,e.mutatedKeys,u===0,d,!1,!!r&&r.resumeToken.approximateByteSize()>0),au:c}:{au:c}}va(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({tu:this.tu,iu:new gi,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(t=>this.Ya=this.Ya.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ya=this.Ya.delete(t)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Xa;this.Xa=J(),this.tu.forEach(r=>{this.uu(r.key)&&(this.Xa=this.Xa.add(r.key))});let t=[];return e.forEach(r=>{this.Xa.has(r)||t.push(new wi(r))}),this.Xa.forEach(r=>{e.has(r)||t.push(new yi(r))}),t}cu(e){this.Ya=e.Qs,this.Xa=J();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return Qn.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,this.Za===0,this.hasCachedResults)}},sl="SyncEngine",Tc=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},Sc=class{constructor(e){this.key=e,this.hu=!1}},Ac=class{constructor(e,t,r,s,o,a){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=s,this.currentUser=o,this.maxConcurrentLimboResolutions=a,this.Pu={},this.Tu=new vt(c=>zh(c),Si),this.Iu=new Map,this.Eu=new Set,this.du=new de(U.comparator),this.Au=new Map,this.Ru=new jr,this.Vu={},this.mu=new Map,this.fu=zr.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return this.gu===!0}};Xn=class{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=Ci(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){return Py(this.persistence,new sc,e.initialUser,this.serializer)}Cu(e){return new ci(tc.mi,this.serializer)}Du(e){return new ac}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}};Xn.provider={build:()=>new Xn};Pc=class extends Xn{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){ee(this.persistence.referenceDelegate instanceof li,46915);let r=this.persistence.referenceDelegate.garbageCollector;return new Ua(r,e.asyncQueue,t)}Cu(e){let t=this.cacheSizeBytes!==void 0?ze.withCacheSize(this.cacheSizeBytes):ze.DEFAULT;return new ci(r=>li.mi(r,t),this.serializer)}},Gr=class{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>oh(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=c0.bind(null,this.syncEngine),await Ky(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return function(){return new vc}()}createDatastore(e){let t=Ci(e.databaseInfo.databaseId),r=function(o){return new hc(o)}(e.databaseInfo);return function(o,a,c,u){return new gc(o,a,c,u)}(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){return function(r,s,o,a,c){return new wc(r,s,o,a,c)}(this.localStore,this.datastore,e.asyncQueue,t=>oh(this.syncEngine,t,0),function(){return di.v()?new di:new cc}())}createSyncEngine(e,t){return function(s,o,a,c,u,d,p){let m=new Ac(s,o,a,c,u,d);return p&&(m.gu=!0),m}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function(t){let r=j(t);V(fn,"RemoteStore shutting down."),r.Ea.add(5),await Jr(r),r.Aa.shutdown(),r.Ra.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}};Gr.provider={build:()=>new Gr};Dc=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):wt("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}};Ht="FirestoreClient",Rc=class{constructor(e,t,r,s,o){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=s,this.user=ve.UNAUTHENTICATED,this.clientId=Vr.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=o,this.authCredentials.start(r,async a=>{V(Ht,"Received user=",a.uid),await this.authCredentialListener(a),this.user=a}),this.appCheckCredentials.start(r,a=>(V(Ht,"Received new app check token=",a),this.appCheckCredentialListener(a,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new et;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=nl(t,"Failed to shutdown persistence");e.reject(r)}}),e.promise}};lh=new Map;Sp="firestore.googleapis.com",uh=!0,_i=class{constructor(e){if(e.host===void 0){if(e.ssl!==void 0)throw new $(R.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Sp,this.ssl=uh}else this.host=e.host,this.ssl=e.ssl??uh;if(this.isUsingEmulator=e.emulatorOptions!==void 0,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=lp;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<Sy)throw new $(R.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}vg("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Tp(e.experimentalLongPollingOptions??{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new $(R.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new $(R.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new $(R.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,s){return r.timeoutSeconds===s.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Hr=class{constructor(e,t,r,s){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new _i({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new $(R.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new $(R.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new _i(e),this._emulatorOptions=e.emulatorOptions||{},e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new na;switch(r.type){case"firstParty":return new oa(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new $(R.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=lh.get(t);r&&(V("ComponentProvider","Removing Datastore"),lh.delete(t),r.terminate())}(this),Promise.resolve()}};Nc=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},Ve=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Kr(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}toJSON(){return{type:n._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,r){if(Xr(t,n._jsonSchema))return new n(e,r||null,new U(pe.fromString(t.referencePath)))}};Ve._jsonSchemaVersion="firestore/documentReference/1.0",Ve._jsonSchema={type:ge("string",Ve._jsonSchemaVersion),referencePath:ge("string")};Kr=class n extends Nc{constructor(e,t,r){super(e,t,Wc(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new Ve(this.firestore,null,new U(e))}withConverter(e){return new n(this.firestore,e,this._path)}};dh="AsyncQueue",bi=class{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new hi(this,"async_queue_retry"),this._c=()=>{let r=ea();r&&V(dh,"Visibility state changed to "+r.visibilityState),this.M_.w_()},this.ac=e;let t=ea();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=ea();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new et;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xu.push(e),this.lc()))}async lc(){if(this.Xu.length!==0){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!Zn(e))throw e;V(dh,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(r=>{throw this.nc=r,this.rc=!1,wt("INTERNAL UNHANDLED ERROR: ",hh(r)),r}).then(r=>(this.rc=!1,r))));return this.ac=t,t}enqueueAfterDelay(e,t,r){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let s=_c.createAndSchedule(this,e,t,r,o=>this.hc(o));return this.tc.push(s),s}uc(){this.nc&&q(47125,{Pc:hh(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{this.tc.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this.tc)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.Tc()})}dc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}};Wr=class extends Hr{constructor(e,t,r,s){super(e,t,r,s),this.type="firestore",this._queue=new bi,this._persistenceKey=s?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new bi(e),this._firestoreClient=void 0,await e}}};qt=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(Ce.fromBase64String(e))}catch(t){throw new $(R.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(Ce.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:n._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(Xr(e,n._jsonSchema))return n.fromBase64String(e.bytes)}};qt._jsonSchemaVersion="firestore/bytes/1.0",qt._jsonSchema={type:ge("string",qt._jsonSchemaVersion),bytes:ge("string")};Qr=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new $(R.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new $e(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};vi=class{constructor(e){this._methodName=e}};Ut=class n{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new $(R.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new $(R.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return X(this._lat,e._lat)||X(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:n._jsonSchemaVersion}}static fromJSON(e){if(Xr(e,n._jsonSchema))return new n(e.latitude,e.longitude)}};Ut._jsonSchemaVersion="firestore/geoPoint/1.0",Ut._jsonSchema={type:ge("string",Ut._jsonSchemaVersion),latitude:ge("number"),longitude:ge("number")};zt=class n{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(r,s){if(r.length!==s.length)return!1;for(let o=0;o<r.length;++o)if(r[o]!==s[o])return!1;return!0}(this._values,e._values)}toJSON(){return{type:n._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(Xr(e,n._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(t=>typeof t=="number"))return new n(e.vectorValues);throw new $(R.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}};zt._jsonSchemaVersion="firestore/vectorValue/1.0",zt._jsonSchema={type:ge("string",zt._jsonSchemaVersion),vectorValues:ge("object")};y0=/^__.*__$/,kc=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new It(e,this.data,this.fieldMask,t,this.fieldTransforms):new mn(e,this.data,t,this.fieldTransforms)}};Mc=class n{constructor(e,t,r,s,o,a){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=s,o===void 0&&this.Rc(),this.fieldTransforms=o||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new n({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){let t=this.path?.child(e),r=this.Vc({path:t,fc:!1});return r.gc(e),r}yc(e){let t=this.path?.child(e),r=this.Vc({path:t,fc:!1});return r.Rc(),r}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return Ei(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(e.length===0)throw this.Sc("Document fields must not be empty");if(Pp(this.Ac)&&y0.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}},Vc=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||Ci(e)}Cc(e,t,r,s=!1){return new Mc({Ac:e,methodName:t,Dc:r,path:$e.emptyPath(),fc:!1,bc:s},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};v0=new RegExp("[~\\*/\\[\\]]");Ii=class{constructor(e,t,r,s,o){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=s,this._converter=o}get id(){return this._key.path.lastSegment()}get ref(){return new Ve(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new Lc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(Vp("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},Lc=class extends Ii{data(){return super.data()}};Oc=class{convertValue(e,t="none"){switch(jt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ie(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(bt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw q(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return gn(e,(s,o)=>{r[s]=this.convertValue(o,t)}),r}convertVectorValue(e){let t=e.fields?.[Bn].arrayValue?.values?.map(r=>ie(r.doubleValue));return new zt(t)}convertGeoPoint(e){return new Ut(ie(e.latitude),ie(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=Ti(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(Br(e));default:return null}}convertTimestamp(e){let t=_t(e);return new ye(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=pe.fromString(e);ee(cp(r),9688,{name:e});let s=new Zs(r.get(1),r.get(3)),o=new U(r.popFirst(5));return s.isEqual(t)||wt(`Document ${o} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),o}};an=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},ln=class n extends Ii{constructor(e,t,r,s,o,a){super(e,t,r,s,a),this._firestore=e,this._firestoreImpl=e,this.metadata=o}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Vn(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(Vp("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new $(R.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e=this._document,t={};return t.type=n._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),!e||!e.isValidDocument()||!e.isFoundDocument()?t:(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),t.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),t)}};ln._jsonSchemaVersion="firestore/documentSnapshot/1.0",ln._jsonSchema={type:ge("string",ln._jsonSchemaVersion),bundleSource:ge("string","DocumentSnapshot"),bundleName:ge("string"),bundle:ge("string")};Vn=class extends ln{data(e={}){return super.data(e)}},Mr=class n{constructor(e,t,r,s){this._firestore=e,this._userDataWriter=t,this._snapshot=s,this.metadata=new an(s.hasPendingWrites,s.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Vn(this._firestore,this._userDataWriter,r.key,r,new an(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new $(R.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,o){if(s._snapshot.oldDocs.isEmpty()){let a=0;return s._snapshot.docChanges.map(c=>{let u=new Vn(s._firestore,s._userDataWriter,c.doc.key,c.doc,new an(s._snapshot.mutatedKeys.has(c.doc.key),s._snapshot.fromCache),s.query.converter);return c.doc,{type:"added",doc:u,oldIndex:-1,newIndex:a++}})}{let a=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(c=>o||c.type!==3).map(c=>{let u=new Vn(s._firestore,s._userDataWriter,c.doc.key,c.doc,new an(s._snapshot.mutatedKeys.has(c.doc.key),s._snapshot.fromCache),s.query.converter),d=-1,p=-1;return c.type!==0&&(d=a.indexOf(c.doc.key),a=a.delete(c.doc.key)),c.type!==1&&(a=a.add(c.doc),p=a.indexOf(c.doc.key)),{type:x0(c.type),doc:u,oldIndex:d,newIndex:p}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new $(R.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e={};e.type=n._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=Vr.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;let t=[],r=[],s=[];return this.docs.forEach(o=>{o._document!==null&&(t.push(o._document),r.push(this._userDataWriter.convertObjectMap(o._document.data.value.mapValue.fields,"previous")),s.push(o.ref.path))}),e.bundle=(this._firestore,this.query._query,e.bundleName,"NOT SUPPORTED"),e}};Mr._jsonSchemaVersion="firestore/querySnapshot/1.0",Mr._jsonSchema={type:ge("string",Mr._jsonSchemaVersion),bundleSource:ge("string","QuerySnapshot"),bundleName:ge("string"),bundle:ge("string")};Fc=class extends Oc{constructor(e){super(),this.firestore=e}convertBytes(e){return new qt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ve(this.firestore,null,t)}};(function(e,t=!0){(function(s){Jn=s})(wd),Sr(new mt("firestore",(r,{instanceIdentifier:s,options:o})=>{let a=r.getProvider("app").getImmediate(),c=new Wr(new sa(r.getProvider("auth-internal")),new aa(a,r.getProvider("app-check-internal")),function(d,p){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new $(R.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Zs(d.options.projectId,p)}(a,s),a);return o={useFetchStreams:t,...o},c._setSettings(o),c},"PUBLIC").setMultipleInstances(!0)),$t(Ad,Cd,e),$t(Ad,Cd,"esm2020")})()});var al=ne(()=>{Fp()});var A0,C0,cl,Bp=ne(()=>{Ed();al();A0={apiKey:"AIzaSyBXq1WuHg8SNfLs0ft7to35-Wp8KhcKgVw",authDomain:"maco-a16fb.firebaseapp.com",projectId:"maco-a16fb",storageBucket:"maco-a16fb.firebasestorage.app",messagingSenderId:"14843865865",appId:"1:14843865865:web:a42f60266e5f471dce81d8",measurementId:"G-H1FZSW8L3K"},C0=jo(A0),cl=Ap(C0)});var je={};Ge(je,{calculateScores:()=>Pe,consolidateMachinesByGroup:()=>tr,debugRpnRating:()=>P0,formatTrainGroupDisplay:()=>R0,generateTrainMap:()=>Zr,getGroupedTrainSurfaceArea:()=>$p,getMacoPerSwabForTrain:()=>dl,getProductTrainId:()=>qe,getRpnRatingClass:()=>Tt,getRpnRatingText:()=>ul,getToxicityPreference:()=>xt,getTrainData:()=>xe,getTrainGroupingDetails:()=>D0,getWorstCaseProductType:()=>St,populateSelectWithOptions:()=>es});function xt(){let n=localStorage.getItem("productRegister-pdeHidden")==="true",e=localStorage.getItem("productRegister-ld50Hidden")==="true";return n&&!e?"ld50":!n&&e||n&&e?"pde":"auto"}function Zr(){let n=new Map(nn),e={};B.forEach(a=>{if(a.machineIds&&a.machineIds.length>0){let c=ll(a.machineIds),u=JSON.stringify(c);e[u]||(e[u]={products:[]}),e[u].products.push(a.id)}}),nn.clear();let t=0;n.forEach(a=>{a>t&&(t=a)});let r=Object.keys(e).sort(),s=[];r.forEach(a=>{n.has(a)?nn.set(a,n.get(a)):s.push(a)});let o=t+1;s.forEach(a=>{nn.set(a,o++)})}function ll(n){let e=[],t=new Set;return[...n].sort((s,o)=>s-o).forEach(s=>{let o=Q.find(a=>a.id===s);o&&(o.group&&o.group!==""?t.has(o.group)||(e.push(`group:${o.group}`),t.add(o.group)):e.push(`machine:${s}`))}),e.sort()}function qe(n){if(!n.machineIds||n.machineIds.length===0)return"N/A";let e=ll(n.machineIds),t=JSON.stringify(e);return nn.get(t)||"N/A"}function Pe(n,e="auto"){let t=(g,b)=>{let S=String(b||"").toLowerCase(),v=g.criteria.find(C=>String(C.text||"").toLowerCase()===S);return v?v.score:g.defaultScore},r=(g,b)=>{let S=parseFloat(b);if(isNaN(S))return g.defaultScore;for(let v of g.criteria)if(v.comparison==="greater_exclusive"&&S>v.lowerBound||v.comparison==="less_exclusive"&&S<v.upperBound||v.comparison==="between_inclusive_both"&&S>=v.lowerBound&&S<=v.upperBound||v.comparison==="less_inclusive"&&S<=v.upperBound||v.comparison==="between_exclusive_lower_inclusive_upper"&&S>v.lowerBound&&S<=v.upperBound)return v.score;return g.defaultScore},s=t(re.solubility,n.solubility),o=r(re.therapeuticDose,n.therapeuticDose),a=t(re.cleanability,n.cleanability),c,u,d;n.pde!==null&&!isNaN(n.pde)&&(u=r(re.toxicityPde,n.pde)),n.ld50!==null&&!isNaN(n.ld50)&&(d=r(re.toxicityLd50,n.ld50)),e==="ld50"?d!==void 0?c=d:u!==void 0?c=u:c=1:u!==void 0?c=u:d!==void 0?c=d:c=1;let p=s*o*a*c,m=ul(p);return{rpn:p,pdeScore:u,ld50Score:d,solubilityScore:s,therapeuticDoseScore:o,cleanabilityScore:a,rpnRatingText:m}}function xe(){let n={};B.forEach(t=>{if(t.machineIds&&t.machineIds.length>0){let r=ll(t.machineIds),s=JSON.stringify(r);if(!n[s])n[s]={key:s,consolidatedPath:r,machineIds:t.machineIds,products:[]};else{let o=new Set(n[s].machineIds);t.machineIds.forEach(a=>o.add(a)),n[s].machineIds=Array.from(o).sort((a,c)=>a-c)}n[s].products.push(t)}});let e=Object.values(n).map(t=>({...t,id:nn.get(t.key)})).filter(t=>t.id!==void 0);return e.sort((t,r)=>t.id-r.id),e.length===0?[]:(e.forEach(t=>{t.essa=$p(t.machineIds);let r=null,s=-1;t.products.forEach(g=>{g.activeIngredients.forEach(b=>{let{rpn:S}=Pe(b);S>s&&(s=S,r={productName:g.name,ingredientName:b.name,rpn:s,rating:ul(s)})})}),t.worstProductRpn=r;let o=1/0,a=-1;t.products.forEach(g=>{g.activeIngredients.forEach(b=>{b.therapeuticDose<o&&(o=b.therapeuticDose,a=g.id)})}),t.lowestLtd=o,t.lowestLtdProductId=a;let c=t.products.map(g=>{let b=Math.min(...g.activeIngredients.map(S=>g.batchSizeKg*1e3/(S.mdd/1e3)));return{productId:g.id,ratio:b}}).sort((g,b)=>g.ratio-b.ratio),u,d=-1;if(c.length>0){let g=c[0];if(g.productId===a&&c.length>1){let b=c[1];u=b.ratio,d=b.productId}else u=g.ratio,d=g.productId}else u=1/0;t.minBsMddRatio=u,t.minRatioProductId=d;let p=t.products.reduce((g,b)=>b.batchSizeKg<g.batchSizeKg?b:g,t.products[0]);t.minMbsKg=p.batchSizeKg,t.minMbsProductId=p.id;let m=t.products.flatMap(g=>g.activeIngredients).map(g=>g.pde).filter(g=>g!=null);t.lowestPde=m.length>0?Math.min(...m):null,t.assumedSsa=25}),e)}function St(n){for(let r of wo)if(n.includes(r))return r;let t=[...new Set(n)].find(r=>!wo.includes(r));return t||"Other"}function dl(n,e){let r=(le[St(n.products.map(p=>p.productType))]||le.Other).max,s=n.lowestLtd*n.minBsMddRatio/r,o=10*n.minMbsKg,a=1/0;n.lowestPde!==null&&(a=n.lowestPde*n.minBsMddRatio);let c=.004*e,u=Math.min(s,o,a,c);return(e>0?u/e:0)*n.assumedSsa}function es(n,e,t=!1,r=null){if(!n)return;n.innerHTML="",t?n.innerHTML='<option value="all">All</option>':n.innerHTML='<option value="" disabled selected>Select...</option>';let s;if(r)s=[...new Set(r)];else{let o=re[e];if(!o)return;s=[...new Set(o.criteria.map(a=>a.text))]}s.forEach(o=>{n.innerHTML+=`<option value="${o}">${o}</option>`})}function tr(n){let e=[],t=new Map;return n.forEach(r=>{let s=Q.find(c=>c.id===r);if(!s)return;let o=s.group||`individual_${s.id}`;t.has(o)||t.set(o,{group:s.group||null,machines:[],maxArea:0,representativeMachine:s});let a=t.get(o);a.machines.push(s),s.area>a.maxArea&&(a.maxArea=s.area,a.representativeMachine=s)}),t.forEach((r,s)=>{r.group?e.push({id:`group_${r.group}`,name:`${r.group} (Group)`,group:r.group,area:r.maxArea,stage:r.representativeMachine.stage,isGroup:!0,machineCount:r.machines.length,machines:r.machines}):e.push({...r.representativeMachine,isGroup:!1,machineCount:1,machines:[r.representativeMachine]})}),e}function $p(n){return tr(n).reduce((t,r)=>t+r.area,0)}function D0(n){let e=tr(n),t={totalMachines:n.length,consolidatedUnits:e.length,groups:[],individuals:[],totalSurfaceArea:0,worstCaseOptimization:0},r=0;return n.forEach(s=>{let o=Q.find(a=>a.id===s);o&&(r+=o.area)}),e.forEach(s=>{t.totalSurfaceArea+=s.area,s.isGroup?t.groups.push({name:s.group,machineCount:s.machineCount,worstCaseArea:s.area,machines:s.machines.map(o=>({id:o.id,name:o.name,area:o.area}))}):t.individuals.push({id:s.id,name:s.name,area:s.area})}),t.worstCaseOptimization=r-t.totalSurfaceArea,t}function R0(n){return tr(n).map(t=>t.isGroup?`<span class="group-indicator" title="Group: ${t.group} (${t.machineCount} machines, worst-case area: ${t.area.toLocaleString()} cm\xB2)">
                <strong>${t.group}</strong> <em>(${t.machineCount}x)</em>
            </span>`:`<span class="individual-machine" title="Individual machine: ${t.name}">${t.name}</span>`).join(" \u2192 ")}var ul,Tt,P0,he=ne(()=>{Fe();ul=n=>{let e=re.rpnRating;if(!e||!e.criteria)return"N/A";for(let t of e.criteria){let r=parseFloat(t.min),s=t.max===null||t.max===void 0?1/0:parseFloat(t.max);if(n>=r&&n<=s)return t.rating}return"N/A"},Tt=n=>{switch(String(n).toLowerCase()){case"low":return"rpn-low";case"medium":return"rpn-medium";case"high":return"rpn-high";default:return"rpn-default"}},P0=n=>{console.log("=== DEBUG RPN RATING ==="),console.log("RPN Value:",n),console.log("RPN Config:",re.rpnRating);let e=re.rpnRating;if(!e){console.log("ERROR: rpnConfig is undefined or null");return}if(!e.criteria){console.log("ERROR: rpnConfig.criteria is undefined or null");return}console.log("Available criteria:",e.criteria),e.criteria.forEach((t,r)=>{console.log(`Criteria ${r}:`,{min:t.min,max:t.max,rating:t.rating,minParsed:parseFloat(t.min),maxParsed:parseFloat(t.max),rangeCheck:`${n} >= ${parseFloat(t.min)} && ${n} <= ${parseFloat(t.max)}`,result:n>=parseFloat(t.min)&&n<=parseFloat(t.max)})}),console.log("=== END DEBUG ===")}});var hl={};Ge(hl,{addCriterionToScoringTab:()=>N0,renderScoringSystem:()=>Ri,saveScoringCriteria:()=>Up,toggleScoringEditMode:()=>ot});function ot(n){Bu(n);let e=document.getElementById("editScoringBtn"),t="btn-gradient",r="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200";n?(e.textContent="View",e.className=`px-4 py-2 text-sm rounded-lg ${r}`):(e.textContent="Edit",e.className=`px-4 py-2 text-sm rounded-lg ${t}`),Ri()}function Ri(){let n=document.getElementById("scoringSystemContainer");if(n.innerHTML="",ct){let e=document.createElement("form");e.id="scoringForm",e.className="space-y-6";for(let r in re){let s=re[r],o=document.createElement("div");o.innerHTML=`<h4 class="text-lg font-semibold mb-3">${s.title}</h4>`;let a=document.createElement("div");a.id=`fields-container-${r}`,a.className="space-y-2",s.criteria.forEach(u=>a.appendChild(qp(r,u))),o.appendChild(a);let c=document.createElement("div");c.className="pt-2 no-print",c.innerHTML=`<button type="button" onclick="addCriterionToScoringTab('${r}')" class="text-sm px-3 py-1 rounded-md text-white btn-gradient">+ Add Criterion</button>`,o.appendChild(c),e.appendChild(o)}n.appendChild(e);let t=document.createElement("button");t.onclick=r=>Up(r),t.className="w-full mt-6 py-2.5 text-white rounded-lg no-print btn-gradient",t.textContent="Save All Changes",n.appendChild(t)}else{let e=document.createElement("div");e.className="grid grid-cols-1 md:grid-cols-2 gap-6";for(let t in re){let r=re[t],s=document.createElement("div");s.className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700";let o=`<h4 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">${r.title}</h4>
                                     <div class="overflow-hidden rounded-md border border-gray-300 dark:border-gray-600">
                                         <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">`,a=r.type==="rpn_threshold";o+=`<thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${a?"Range Description":"Criteria"}</th>
                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${a?"Rating":"Score"}</th>
                                    </tr>
                                  </thead>
                                  <tbody class="divide-y divide-gray-200 dark:divide-gray-600" style="background-color: var(--bg-secondary);">`,r.criteria.forEach(d=>{let p,m;a?(p=d.rangeDescription,m=`<span class="rpn-rating-badge ${Tt(d.rating)}">${d.rating}</span>`):(p=d.text,m=`<span class="score-badge ${`score-${d.score}`}">${d.score}</span>`),o+=`<tr>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${p}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${m}</td>
                                      </tr>`}),o+="</tbody></table></div>",s.innerHTML=o,e.appendChild(s)}n.appendChild(e)}}function qp(n,e){let t=document.createElement("div");t.className="grid gap-2 items-center p-2 border rounded-md",t.style.borderColor="var(--border-color)";let r=re[n].type;if(r==="exactMatch")t.style.gridTemplateColumns="3fr 1fr 0.5fr",t.innerHTML=`<input type="text" value="${e.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" value="${e.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if(r==="range")t.style.gridTemplateColumns="2fr 1fr 1fr 1fr 0.5fr",t.innerHTML=`<input type="text" value="${e.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" step="any" value="${e.lowerBound??""}" placeholder="Min" class="w-full px-2 py-1 border rounded-md text-sm" data-field="lowerBound" min="0"><input type="number" step="any" value="${e.upperBound??""}" placeholder="Max" class="w-full px-2 py-1 border rounded-md text-sm" data-field="upperBound" min="0"><input type="number" value="${e.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if(r==="rpn_threshold"){t.style.gridTemplateColumns="1fr 1fr 1fr 1fr 0.5fr";let s=e.max===1/0?"":e.max;t.innerHTML=`<input type="number" value="${e.min}" placeholder="Min RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="minRpn" min="0"><input type="number" value="${s}" placeholder="Max RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="maxRpn" min="0"><input type="text" value="${e.rating}" placeholder="Rating" class="w-full px-2 py-1 border rounded-md text-sm" data-field="ratingText"><span class="text-xs self-center" style="color:var(--text-secondary);">${e.rangeDescription}</span>`}return t.innerHTML+='<button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>',t}function N0(n){let e=document.getElementById(`fields-container-${n}`),t=re[n],r;t.type==="rpn_threshold"?r={min:0,max:10,rating:"NEW",rangeDescription:"0-10"}:(r={...t.criteria[0]||{text:"",score:0},text:"New Criterion",score:t.defaultScore||1},t.type==="range"&&(delete r.lowerBound,delete r.upperBound,r.comparison=t.criteria[0]?.comparison||"between_inclusive_both")),e.appendChild(qp(n,r))}function Up(n){let e=n.target;Te(),e.disabled=!0;try{let t=JSON.parse(JSON.stringify(re)),r=!0;for(let s in t){if(!r)break;let o=t[s],a=re[s].type;o.criteria=[];let c=document.getElementById(`fields-container-${s}`);c&&Array.from(c.children).forEach(u=>{if(!r)return;let d={};if(a==="exactMatch"||a==="range"){if(d.text=u.querySelector('[data-field="text"]').value,d.score=parseInt(u.querySelector('[data-field="score"]').value),!d.text||isNaN(d.score)){r=!1;return}if(a==="range"){let p=u.querySelector('[data-field="lowerBound"]').value,m=u.querySelector('[data-field="upperBound"]').value;if(d.lowerBound=p?parseFloat(p):void 0,d.upperBound=m?parseFloat(m):void 0,p&&isNaN(d.lowerBound)||m&&isNaN(d.upperBound)||d.lowerBound!==void 0&&d.upperBound!==void 0&&d.lowerBound>=d.upperBound){r=!1;return}d.lowerBound===void 0&&d.upperBound!==void 0?d.comparison="less_inclusive":d.lowerBound!==void 0&&d.upperBound===void 0?d.comparison="greater_exclusive":d.comparison=re[s].criteria.find(g=>g.text===d.text)?.comparison||"between_exclusive_lower_inclusive_upper"}}else if(a==="rpn_threshold"){d.min=parseFloat(u.querySelector('[data-field="minRpn"]').value);let p=u.querySelector('[data-field="maxRpn"]').value;if(d.max=p===""||p===null?1/0:parseFloat(p),d.rating=u.querySelector('[data-field="ratingText"]').value.trim(),isNaN(d.min)||p!==""&&isNaN(d.max)||!d.rating||d.min>=d.max){r=!1;return}d.rangeDescription=`${d.min} - ${p||"Infinity"}`}o.criteria.push(d)})}r?(Ft(t),Le(),ot(!1),De(),O("Success","Changes saved successfully.")):O("Validation Error","Please check your input. Some fields may be invalid.")}catch(t){console.error("Error saving scoring criteria:",t),O("Error","Failed to save changes. Please try again.")}finally{z(),e.disabled=!1}}var pl=ne(()=>{Fe();ts();Oe();he()});var nr={};Ge(nr,{executeExportSelection:()=>Kp,executePrintSelection:()=>Wp,handleSearchAndFilter:()=>ns,handleWorstCaseProductFilter:()=>ml,renderRpnChart:()=>rs,renderWorstCaseByTrain:()=>Kt,sortData:()=>ki,toggleAllTrainsSelection:()=>Hp,toggleWorstCaseExportDropdown:()=>jp,toggleWorstCasePrintDropdown:()=>Gp,updateAllTrainsCheckbox:()=>Ni,updateSortIndicators:()=>zp});function ns(n){if(n!=="worstCaseProducts")return;let e=document.getElementById("worstCaseProductNameFilter"),t=e?e.value.toLowerCase():"";Me[n]=B.filter(r=>r.name.toLowerCase().includes(t)),Kt()}function ml(){ns("worstCaseProducts")}function ki(n,e){e==="worstCaseProducts"&&(ue.key===n?ue.direction=ue.direction==="asc"?"desc":"asc":(ue.key=n,ue.direction=n==="rpn"?"desc":"asc"),Kt(!1))}function zp(n){let e=document.getElementById(n);e&&e.querySelectorAll(".mainTable th.sortable").forEach(t=>{let r=t.querySelector(".sort-indicator"),s=t.dataset.key;r.textContent="",s===ue.key&&(r.textContent=ue.direction==="asc"?"\u25B2":"\u25BC")})}function Kt(n=!0){let e=document.getElementById("worstCaseTrainsContainer"),t=document.getElementById("noWorstCaseMessage");e.innerHTML="",Me.worstCaseProducts||(Me.worstCaseProducts=[...B]);let r=[...Me.worstCaseProducts];if(r.length===0){t.style.display="block",e.style.display="none";return}let s={};if(r.forEach(a=>{let c=qe(a);c!=="N/A"&&(s[c]||(s[c]=[]),s[c].push(a))}),Object.keys(s).length===0){t.style.display="block",e.style.display="none";return}t.style.display="none",e.style.display="block",Object.keys(s).sort((a,c)=>a-c).forEach((a,c)=>{if(window.printSelectedTrain&&window.printSelectedTrain!=="all"){if(Array.isArray(window.printSelectedTrain)){if(!window.printSelectedTrain.includes(String(a)))return}else if(String(a)!==String(window.printSelectedTrain))return}let u=s[a],p=!(document.body.classList.contains("printing-worstCaseProducts")||!n),m=document.createElement("div");m.className="train-card";let g=`
                <div class="train-header" onclick="toggleTrain('wc-${a}')">
                <span>Train ${a} - Worst Case Analysis</span>
                <button class="train-toggle" id="toggle-wc-${a}">${p?"\u25B6":"\u25BC"}</button>
                </div>
                <div class="train-content ${p?"collapsed":""}" id="content-wc-${a}">
                <div class="train-content-inner">
                    <table class="w-full text-sm mainTable">
                    <thead style="background: var(--bg-accent);">
                        <tr>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="productCode"
                        onclick="(event)=>event.stopPropagation()">
                            Product Code <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="name">
                            Product Name <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable cursor-pointer" data-key="rpn">
                            Highest RPN <span class="sort-indicator"></span>
                        </th>
                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Special Case Product</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y" style="border-color: var(--border-color);">`;u.forEach(S=>{let v=xt(),C=S.activeIngredients.map(D=>Pe(D,v).rpn);S.sortValue=C.length>0?Math.max(...C):0}),u.sort((S,v)=>{let C=ue.key,D=ue.direction==="asc"?1:-1,k,L;switch(C){case"productCode":k=S.productCode,L=v.productCode;break;case"name":k=S.name,L=v.name;break;case"rpn":default:k=S.sortValue,L=v.sortValue}return k<L?-1*D:k>L?1*D:0}),u.forEach(S=>{let v=S.isCritical?"Yes":"No",C=S.isCritical?"text-red-600 font-bold":"";g+=`
                        <tr class="product-main-row">
                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${S.productCode}</td>
                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">
                                <span class="product-name">${S.name}</span>
                                <p class="text-xs italic" style="color: var(--text-secondary);">${S.productType||"N/A"}</p>    
                            </td>
                            <td class="px-3 py-3 text-sm font-bold whitespace-nowrap align-top" style="color: var(--gradient-mid);">${S.sortValue}</td>
                            <td class="px-3 py-3 text-sm align-top">
                                <span class="${C}">${v}</span>
                                ${S.isCritical&&S.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 150px; white-space: normal;">${S.criticalReason}</p>`:""}
                            </td>
                        </tr>`;let D=xt(),k=S.activeIngredients.sort((L,H)=>Pe(H,D).rpn-Pe(L,D).rpn);if(k.length>0){let L='<tr class="ingredients-sub-row"><td colspan="4"><div class="p-4 ingredients-sub-table rounded-b-lg"><table class="w-full text-sm"><thead class="bg-transparent"><tr class="border-b" style="border-color: var(--border-color);"><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Ingredient</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">TD Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Solubility Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Cleanability Score</th><th class="pde-col px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">PDE Score</th><th class="ld50-col px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">LD50 Score</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">RPN</th><th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Rating</th></tr></thead><tbody class="bg-transparent">';k.forEach(H=>{let F=Pe(H,D);L+=`<tr><td class="px-3 py-2 font-semibold">${H.name}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${F.therapeuticDoseScore}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${F.solubilityScore}</td><td class="px-3 py-2" style="color: var(--text-secondary);">${F.cleanabilityScore}</td><td class="pde-col px-3 py-2" style="color: var(--text-secondary);">${F.pdeScore??"N/A"}</td><td class="ld50-col px-3 py-2" style="color: var(--text-secondary);">${F.ld50Score??"N/A"}</td><td class="px-3 py-2 font-bold" style="color: var(--gradient-mid);">${F.rpn}</td><td class="px-3 py-2"><span class="rpn-rating-badge ${Tt(F.rpnRatingText)}">${F.rpnRatingText}</span></td></tr>`}),L+="</tbody></table></div></td></tr>",g+=L}}),g+="</tbody></table></div></div></div>",m.innerHTML=g,e.appendChild(m),m.querySelectorAll("th.sortable[data-key]").forEach(S=>{S.addEventListener("click",function(v){v.stopPropagation();let C=this.getAttribute("data-key");ki(C,"worstCaseProducts")})})}),at("worstCaseProducts"),zp("worstCaseProducts"),z(),fl()}function rs(){let n=document.getElementById("rpnChartCanvas"),e=document.getElementById("rpnChartPlaceholder"),t={low:{bg:"rgba(74, 222, 128, 0.6)",border:"rgba(34, 197, 94, 1)"},medium:{bg:"rgba(250, 204, 21, 0.6)",border:"rgba(234, 179, 8, 1)"},high:{bg:"rgba(239, 68, 68, 0.6)",border:"rgba(220, 38, 38, 1)"},default:{bg:"rgba(156, 163, 175, 0.6)",border:"rgba(107, 114, 128, 1)"}};Me.worstCaseProducts||(Me.worstCaseProducts=[...B]);let r=Me.worstCaseProducts||[],s=xt(),o=r.flatMap(g=>g.activeIngredients.map(b=>{let S=Pe(b,s),v=qe(g);return{productName:g.name,ingredientName:b.name,rpn:S.rpn,ratingKey:S.rpnRatingText.toLowerCase(),trainId:v!=="N/A"?`T${v}`:""}}));if(o.length===0){n.style.display="none",e.style.display="flex",Vt&&Vt.destroy();return}else n.style.display="block",e.style.display="none";o.sort((g,b)=>b.rpn-g.rpn);let a=o.map(g=>`${g.productName} (${g.ingredientName}) ${g.trainId}`),c=o.map(g=>g.rpn),u=o.map(g=>(t[g.ratingKey]||t.default).bg),d=o.map(g=>(t[g.ratingKey]||t.default).border);Vt&&Vt.destroy();let p=n.getContext("2d"),m=new Chart(p,{type:"bar",data:{labels:a,datasets:[{label:"RPN",data:c,backgroundColor:u,borderColor:d,borderWidth:1}]},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"var(--text-secondary)"},grid:{display:!1}},y:{beginAtZero:!0,ticks:{color:"var(--text-secondary)"},grid:{color:"var(--border-color)"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(g){let b=g.dataset.label||"";return b&&(b+=": "),g.parsed.y!==null&&(b+=g.parsed.y),b}}}}}});Ou(m)}function jp(){let n=document.getElementById("worstCaseExportDropdown");n.classList.toggle("hidden"),fl(),document.addEventListener("click",function e(t){!t.target.closest("#worstCaseExportDropdown")&&!t.target.closest('button[onclick="toggleWorstCaseExportDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function Gp(){let n=document.getElementById("worstCasePrintDropdown");n.classList.toggle("hidden"),fl(),document.addEventListener("click",function e(t){!t.target.closest("#worstCasePrintDropdown")&&!t.target.closest('button[onclick="toggleWorstCasePrintDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function fl(){let n=Me.worstCaseProducts||B,e=new Set;n.forEach(o=>{let a=qe(o);a!=="N/A"&&e.add(a)});let t=Array.from(e).sort((o,a)=>o-a),r=document.getElementById("worstCaseExportTrainOptions");r&&(r.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 export-train-checkbox",c.value=o,c.onchange=()=>Ni("export");let u=document.createElement("span");u.textContent=`Train ${o}`,a.appendChild(c),a.appendChild(u),r.appendChild(a)}));let s=document.getElementById("worstCasePrintTrainOptions");s&&(s.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 print-train-checkbox",c.value=o,c.onchange=()=>Ni("print");let u=document.createElement("span");u.textContent=`Train ${o}`,a.appendChild(c),a.appendChild(u),s.appendChild(a)}))}function Hp(n){let e=document.getElementById(`${n}AllTrainsCheckbox`);document.querySelectorAll(`.${n}-train-checkbox`).forEach(r=>{r.checked=e.checked})}function Ni(n){let e=document.getElementById(`${n}AllTrainsCheckbox`),t=document.querySelectorAll(`.${n}-train-checkbox`),r=document.querySelectorAll(`.${n}-train-checkbox:checked`);r.length===0?(e.checked=!1,e.indeterminate=!1):r.length===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}function Kp(){let n=document.getElementById("exportAllTrainsCheckbox"),e=[];if(n.checked)exportWorstCaseToExcel("all");else{if(document.querySelectorAll(".export-train-checkbox:checked").forEach(r=>{e.push(r.value)}),e.length===0){O("No Selection","Please select at least one train to export.");return}exportWorstCaseToExcel(e)}document.getElementById("worstCaseExportDropdown").classList.add("hidden")}function Wp(){let n=document.getElementById("printAllTrainsCheckbox"),e=[];if(n.checked)printCurrentView("worstCaseProducts","all");else{if(document.querySelectorAll(".print-train-checkbox:checked").forEach(r=>{e.push(r.value)}),e.length===0){O("No Selection","Please select at least one train to print.");return}printCurrentView("worstCaseProducts",e)}document.getElementById("worstCasePrintDropdown").classList.add("hidden")}var Wt=ne(()=>{Fe();Oe();he();window.toggleAllTrainsSelection=Hp;window.updateAllTrainsCheckbox=Ni;window.executeExportSelection=Kp;window.executePrintSelection=Wp;window.toggleWorstCaseExportDropdown=jp;window.toggleWorstCasePrintDropdown=Gp});var gl={};Ge(gl,{renderMacoChart:()=>Vi,renderMainDashboard:()=>Mi});function Mi(){let n=document.getElementById("dashboardStats");n.innerHTML="";let e=xe(),t={id:"N/A",finalMaco:1/0},r={id:"N/A",essa:0};if(e.length>0){let o=e.reduce((c,u)=>Math.max(c,u.essa),0),a=e.map(c=>{let d=(le[St(c.products.map(S=>S.productType))]||le.Other).max,p=c.lowestLtd*c.minBsMddRatio/d,m=10*c.minMbsKg,g=1/0;c.lowestPde!==null&&(g=c.lowestPde*c.minBsMddRatio);let b=.004*o;return{...c,finalMaco:Math.min(p,m,g,b)}});t=a.reduce((c,u)=>u.finalMaco<c.finalMaco?u:c),r=a.reduce((c,u)=>u.essa>c.essa?u:c)}[{label:"Total Products",value:B.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16"><path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.405 1.372L8 2.267l3.75 2.605 2.405-1.372L8.186 1.113zM3.75 4.81L8 7.76l4.25-2.95L8 1.815 3.75 4.81z"/><path d="M1 4.53v7.94l6.5 3.53 6.5-3.53V4.53L8 8.06 1 4.53zm7.5 3.56l-3.5-2-3.5 2v7.19l3.5 2 3.5-2v-7.19zm3.5 2l-3.5 2v7.19l3.5-2 3.5 2v-7.19l-3.5-2z"/></svg>'},{label:"Total Machines",value:Q.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-gear-wide-connected" viewBox="0 0 16 16"><path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.62 1.105l-.09.282c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.09-.282c-.268-1.135.925-1.824 1.62-1.105l.205.211a.96.96 0 0 0 1.622-.434L7.068.727zM12.973 8.5H8.25l-1.03-1.03a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l2.5-2.5a1 1 0 0 0-1.414-1.414L12.973 8.5z"/><path d="M.242 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353-.14l.17-.186c.695-.761 1.888.06 1.62 1.204l-.066.261c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066-.261c-.268-1.144.925-1.965 1.62-1.204l.17.186a.96.96 0 0 0 1.353.14l.058-.058a.626.626 0 0 1 0-.884zM15.758 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353.14l.17-.186c.695.761-.925 1.965-1.62 1.204l-.066-.261c-.273-.85-.92-1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066.261c-.268 1.144 1.888.443 1.62-1.204l.17-.186a.96.96 0 0 0 1.353-.14l.058-.058a.626.626 0 0 1 0 .884z"/></svg>'},{label:"Number of Trains",value:e.length,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-diagram-3" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H14a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 2 7h5.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 10.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/></svg>'},{label:"Lowest MACO Train",value:`Train ${t.id}`,subValue:`${t.finalMaco?t.finalMaco.toFixed(2):"N/A"} mg`,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 0 1 14 0H1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/><path d="M7.25 4.5a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5h-1.5z"/></svg>'},{label:"Largest Area Train",value:`Train ${r.id}`,subValue:`${r.essa.toLocaleString()} cm\xB2`,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 1.5a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-1 0v-12a.5.5 0 0 1 .5-.5z"/><path d="M1.5 6.002a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5z"/><path d="M14.25 2.164a.5.5 0 0 1 .146.353v10.966a.5.5 0 0 1-.146.353l-10.966 2.193a.5.5 0 0 1-.611-.493v-1.077A5.002 5.002 0 0 1 5.5 7.425V4.28a.5.5 0 0 1 .2-.4l8-3a.5.5 0 0 1 .55.284zM3.5 13.923v-1.077A5.002 5.002 0 0 1 5.5 7.425V4.893L3.5 5.672v8.251zm2-6.538A4.002 4.002 0 0 0 4.5 12.8v-1.077a4 4 0 0 0-1-2.316V8.19a4 4 0 0 0 2 1.2V7.385zM13.5 3.33v-.171l-8 3v3.115A4.002 4.002 0 0 0 9.5 8.19v2.292a4 4 0 0 0 1-2.316V9.423a4 4 0 0 0 2-1.2v-4.9z"/></svg>'}].forEach(o=>{let a=document.createElement("div");a.className="card p-6 flex items-center",a.innerHTML=`
                    <div class="p-3 rounded-full mr-4 text-white" style="background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));">
                        ${o.icon}
                    </div>
                    <div>
                        <p class="text-2xl font-bold">${o.value}</p>
                        <p class="text-sm -mt-1" style="color: var(--text-secondary);">${o.label}</p>
                        ${o.subValue?`<p class="text-xs font-semibold mt-1" style="color: var(--text-primary);">${o.subValue}</p>`:""}
                    </div>
                `,n.appendChild(a)}),rs(),Vi()}function k0(n,e){let r=(le[St(n.products.map(p=>p.productType))]||le.Other).max,s=n.lowestLtd*n.minBsMddRatio/r,o=10*n.minMbsKg,a=1/0;n.lowestPde!==null&&(a=n.lowestPde*n.minBsMddRatio);let c=.004*e,u=Math.min(s,o,a,c);return(e>0?u/e:0)*n.assumedSsa}function Vi(){let n=document.getElementById("macoChartCanvas"),e=document.getElementById("macoChartPlaceholder"),t=xe();if(t.length===0){n.style.display="none",e.style.display="flex",Lt&&Lt.destroy();return}n.style.display="block",e.style.display="none";let r=t.reduce((d,p)=>Math.max(d,p.essa),0),s=t.map(d=>`Train ${d.id}`),o=t.map(d=>k0(d,r));Lt&&Lt.destroy();let a=n.getContext("2d"),c=a.createLinearGradient(0,0,0,400);c.addColorStop(0,"rgba(59, 130, 246, 0.8)"),c.addColorStop(1,"rgba(139, 92, 246, 0.6)");let u=new Chart(a,{type:"bar",data:{labels:s,datasets:[{label:"MACO per Swab",data:o,backgroundColor:c,borderColor:"rgba(99, 102, 241, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"var(--text-secondary)"},grid:{display:!1}},y:{type:"logarithmic",ticks:{color:"var(--text-secondary)"},grid:{display:!1},title:{display:!0,text:"MACO (mg/Swab)",color:"var(--text-secondary)"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(d){let p=d.dataset.label||"";return p&&(p+=": "),d.parsed.y!==null&&(p+=d.parsed.y.toLocaleString(void 0,{maximumFractionDigits:5})),p}}}}}});Fu(u)}var yl=ne(()=>{Fe();he();Wt();Fe()});var Oi={};Ge(Oi,{executeMacoExportSelection:()=>Zp,executeMacoPrintSelection:()=>em,recalculateProductMacoForTrain:()=>Qp,renderMacoForTrains:()=>ss,toggleAllMacoTrainsSelection:()=>Yp,toggleMacoExportDropdown:()=>Xp,toggleMacoPrintDropdown:()=>Jp,updateAllMacoTrainsCheckbox:()=>Li});function ss(){let n=document.getElementById("trainsContainer"),e=document.getElementById("noTrainsMessage");n.innerHTML="";let t=xe();if(t.length===0){e.style.display="block",n.style.display="none";return}let r=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(Array.isArray(window.printSelectedTrain)?r=t.filter(c=>window.printSelectedTrain.includes(String(c.id))):r=t.filter(c=>String(c.id)===String(window.printSelectedTrain))),r.length===0){e.style.display="block",n.style.display="none";return}if(r.length===0){e.style.display="block",n.style.display="none";return}e.style.display="none",n.style.display="block";let s=t.reduce((c,u)=>u.essa>c.essa?u:c),o=s.essa;r.forEach((c,u)=>{let p=c.products.map(F=>F.productType),m=St(p),g=le[m]||safetyFactorConfig.Other,b=document.createElement("div");b.className="train-card",b.id=`product-maco-train-${c.id}`;let S=v(c.machineIds);function v(F){return tr(F).map(E=>{if(E.isGroup){let y=E.machines.map(_=>_.name).join(", ");return`<span class="group-indicator" title="Group: ${E.group} - ${y} - Max area: ${E.area.toLocaleString()} cm\xB2">
                <strong>${E.group}</strong>
            </span>`}else return`<span class="individual-machine" title="Individual machine: ${E.name}">${E.name}</span>`}).join(" \u2192 ")}let C=c.products.map(F=>{let W=F.activeIngredients.length>0?Math.min(...F.activeIngredients.map(_=>F.batchSizeKg*1e3/(_.mdd/1e3))):1/0,E=F.id===c.minMbsProductId,y=F.id===c.minRatioProductId;return`
                    <tr class="product-main-row">
                        <td class="px-4 py-3 whitespace-nowrap">${F.productCode}</td>
                        <td class="px-4 py-3 font-medium">${F.name}<p class="text-xs italic" style="color:var(--text-secondary);">${F.productType}</p></td>
                        <td class="px-4 py-3 whitespace-nowrap ${E?"font-bold":""}" style="${E?"color: var(--gradient-start);":""}">${F.batchSizeKg} ${E?'<span class="text-xs ml-1" title="Minimum Batch Size in Train">\u2605</span>':""}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${y?"font-bold":""}" style="${y?"color: var(--gradient-end);":""}">${isFinite(W)?W.toLocaleString(void 0,{maximumFractionDigits:2}):"N/A"} ${y?'<span class="text-xs ml-1" title="Minimum BS/MDD Ratio in Train">\u2605</span>':""}</td>
                    </tr>
                    <tr class="ingredients-sub-row">
                        <td colspan="4" class="!pb-0">
                            <div class="p-3 ingredients-sub-table">
                                 <ul class="text-xs list-disc list-inside">
                                 ${F.activeIngredients.map(_=>`<li><b>${_.name}</b> (TD: ${_.therapeuticDose}mg, MDD: ${_.mdd/1e3}g)</li>`).join("")}
                                 </ul>
                            </div>
                        </td>
                    </tr>`}).join(""),D=c.worstProductRpn?`<p><b class="text-sm" >${c.worstProductRpn.productName}</b> (Ingredient: ${c.worstProductRpn.ingredientName})</p>
                 <p class="mt-0.4">RPN: <span class="font-bold text-sm" style="color:var(--gradient-mid);">${c.worstProductRpn.rpn}</span> <span class="rpn-rating-badge ${Tt(c.worstProductRpn.rating)}">${c.worstProductRpn.rating}</span></p>`:'<p style="color:var(--text-secondary);">N/A</p>',k=B.find(F=>F.id===c.lowestLtdProductId),L=B.find(F=>F.id===c.minRatioProductId),H=B.find(F=>F.id===c.minMbsProductId);b.innerHTML=`
                    <div class="train-header" onclick="toggleTrain('pm-${c.id}')">
                        <span>Train ${c.id} - Product MACO Calculation</span>
                        <button class="train-toggle" id="toggle-pm-${c.id}">\u25B6</button>
                    </div>
                    <div class="train-content collapsed" id="content-pm-${c.id}">
                        <div class="train-content-inner space-y-6">
                            <!-- Train Details -->
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        <h3 class="text-lg font-bold">Train ${c.id} Details</h3>
                                        <div class="flex items-center gap-x-2 mt-1" id="train-badges-${c.id}"></div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <p class="text-sm uppercase font-semibold" style="color: var(--text-secondary);">Train Area (ESSA)</p>
                                        <p class="text-lg font-bold" style="color: var(--gradient-mid);">${c.essa.toLocaleString()} cm\xB2</p>
                                    </div>
                                </div>
                                <div class="mt-4 p-3 rounded-md" style="background-color:var(--bg-accent);">
                                    <p class="text-xs uppercase font-semibold mb-1" style="color: var(--text-secondary);">Machines in Train</p>
                                    <p class="text-sm">${S}</p>
                                </div>
                            </div>

                            <!-- Products Table -->
                            <div class="space-y-2">
                                <h4 class="text-lg font-semibold">Products in Train</h4>
                                <div class="overflow-hidden rounded-md border" style="border-color: var(--border-color);">
                                    <table class="w-full text-sm">
                                        <thead class="border-b" style="border-color: var(--border-color);">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Code</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Product Name</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Batch Size (Kg)</th>
                                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">BS/MDD Ratio</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y" style="border-color: var(--border-color);">${C}</tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Analysis & Calculations Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4 border-t" style="border-color: var(--border-color);">
                                <!-- Left Column: RPN & MACO Limits -->
                                <div class="space-y-6">
                                    <div class="p-4 rounded-lg" style="background-color:var(--bg-accent);">
                                        <div class="flex items-center gap-2 mb-2">
                                                   <div class="relative group">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16" style="color: var(--text-secondary);" title="Information">
                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                                </svg>
            
                                            </div>
                                            <h5 class="text-sm font-semibold">Worst-Case Product for Cleaning Study (by RPN)</h5>

                                        </div>
                                        ${D}
                                    </div>
      
                                </div>

                                <!-- Right Column: MACO Calculation Details -->
                                <div class="space-y-4">

                                     <h4 class="text-md font-semibold">MACO Calculation Breakdown</h4>
                                     <button id="breakdown-toggle-btn-${c.id}" onclick="toggleMacoBreakdown(${c.id})" class="w-full text-sm py-2 px-4 rounded-md border" style="color: var(--gradient-mid); border-color: var(--gradient-mid);">Show MACO Calculation Breakdown</button>
                                     <div id="maco-breakdown-details-${c.id}" class="hidden space-y-4">
                                         <div class="p-4 rounded-lg" style="background-color: var(--bg-accent);">
                                            <p class="text-sm"><b>Worst-Case Dosage Form:</b> ${m}</p>
                                            <p class="text-xs mt-1" style="color:var(--text-secondary);">Range for ${g.route} route: ${g.min.toLocaleString()} - ${g.max.toLocaleString()}</p>
                                            <label for="product-sf-input-train-${c.id}" class="block text-sm font-small mt-2 mb-1">Safety Factor (SF)</label>
                                            <input type="number" id="product-sf-input-train-${c.id}" class="w-full px-2 py-2 border rounded-lg" value="${g.max}" min="${g.min}" max="${g.max}" oninput="recalculateProductMacoForTrain(${c.id})" onchange="clampSafetyFactor(this, ${c.id})">
                                         </div>
                                         <ul class="text-sm space-y-1 p-3 border-l-4 rounded-r-md" style="border-color:var(--gradient-mid); background-color:var(--bg-accent);">
                                            <li><b>Minimum Batch Size (MBS):</b> ${c.minMbsKg} kg <span class="text-xs" style="color:var(--text-secondary);">(from ${H.name})</span></li>
                                            <li><b>Lowest LTD:</b> ${c.lowestLtd} mg <span class="text-xs" style="color:var(--text-secondary);">(from ${k.name})</span></li>
                                            <li><b>Minimum BS(g)/MDD(g) Ratio:</b> ${c.minBsMddRatio.toLocaleString(void 0,{maximumFractionDigits:2})} <span class="text-xs" style="color:var(--text-secondary);">(from ${L.name})</span></li>
                                            <li><b>Lowest PDE (ADE):</b> ${c.lowestPde!==null?c.lowestPde+" mg":"N/A"}</li>
                                            <li><b>Global Largest ESSA:</b> ${o.toLocaleString()} cm\xB2 (from Train ${s.id})</li>
                                         </ul>
                                         <div id="maco-breakdown-container-${c.id}" class="divide-y rounded-md border" style="border-color:var(--border-color);"></div>
                                    </div>
                                    <div id="final-maco-container-${c.id}" class="p-3 rounded-md text-center" style="background-color:var(--bg-secondary); border: 2px solid var(--gradient-mid);"></div>
                                                                    <div class="p-4 rounded-lg border" style="border-color:var(--gradient-mid);">
                                        <h5 class="text-sm font-semibold mb-2">Final MACO Limits for Train ${c.id}</h5>
                                        <div class="space-y-3">
                                            <div><p class="text-sm" style="color:var(--text-secondary);">MACO / Area</p><p class="text-md font-bold" id="maco-per-area-val-${c.id}">...</p></div>
                                            <div><p class="text-sm" style="color:var(--text-secondary);">MACO / Swab (assuming ${c.assumedSsa} cm\xB2 area)</p><p class="text-md font-bold" id="maco-per-swab-val-${c.id}">...</p></div>
                                        </div>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                `,n.appendChild(b),Qp(c.id,o)});let a=r.map(c=>{let u=document.getElementById(`final-maco-val-${c.id}`);return u&&u.dataset.value?{...c,finalMaco:parseFloat(u.dataset.value)}:{...c,finalMaco:0}});if(a.length>0){let c=a.reduce((p,m)=>m.finalMaco<p.finalMaco?m:p),u=document.getElementById(`train-badges-${s.id}`),d=document.getElementById(`train-badges-${c.id}`);u&&(u.innerHTML+='<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300">Largest ESSA</span>'),d&&(d.innerHTML+='<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 ml-2">Lowest MACO</span>')}wl(),z()}function Qp(n,e){let t=xe().find(C=>C.id===n);if(!t)return;if(e===void 0){let C=xe();e=C.length>0?Math.max(...C.map(D=>D.essa)):0}let r=document.getElementById(`product-sf-input-train-${t.id}`),s=parseFloat(r.value);if(isNaN(s))return;let o=t.lowestLtd*t.minBsMddRatio/s,a=10*t.minMbsKg,c=1/0;t.lowestPde!==null&&(c=t.lowestPde*t.minBsMddRatio);let u=.004*e,d=[{name:"0.1% Therapeutic Dose",value:o},{name:"10 ppm Criterion",value:a},{name:"Health-Based Limit (ADE)",value:c},{name:"Visual Clean Limit",value:u}],p=d.reduce((C,D)=>D.value<C.value?D:C),m=p.value,g=e>0?m/e:0,b=g*t.assumedSsa;document.getElementById(`maco-per-area-val-${t.id}`).textContent=`${g.toExponential(3)} mg/cm\xB2`,document.getElementById(`maco-per-swab-val-${t.id}`).textContent=`${b.toLocaleString(void 0,{minimumFractionDigits:4,maximumFractionDigits:4})} mg/Swab`;let S=document.getElementById(`maco-breakdown-container-${t.id}`);S&&(S.innerHTML=d.map(({value:C,name:D})=>{let k="";return D==="0.1% Therapeutic Dose"?k='MACO = (<span title="Lowest Therapeutic Dose (mg)">LTD</span> \xD7 <span title="Batch Size / Maximum Daily Dose Ratio">BS/MDD Ratio</span>) / <span title="Safety Factor">SF</span>':D==="10 ppm Criterion"?k='MACO = 10 \xD7 <span title="Minimum Batch Size (kg)">MBS(kg)</span>':D==="Health-Based Limit (ADE)"?k='MACO = <span title="Acceptable Daily Exposure (mg)">ADE</span> \xD7 <span title="Batch Size / Maximum Daily Dose Ratio">BS/MDD Ratio</span>':D==="Visual Clean Limit"&&(k='MACO = 0.004 \xD7 <span title="Equipment Surface Shared Area (cm\xB2)">Largest ESSA</span>'),`
                    <div class="p-3 ${p.value===C?"font-bold":""}" style="${p.value===C?"background-color: #dcfce7; color: #166534;":""}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-medium">${D}</span>
                            <span class="text-sm text-right">${isFinite(C)?C.toLocaleString(void 0,{maximumFractionDigits:2})+" mg":"N/A"} ${p.value===C?'<span class="text-xs ml-2">\u2713</span>':""}</span>
                        </div>
                        <div class="text-xs font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded mt-1" style="color: var(--text-secondary);">
                            ${k}
                        </div>
                    </div>
                `}).join(""));let v=document.getElementById(`final-maco-container-${t.id}`);v.innerHTML=`
                <p class="text-sm" style="color:var(--text-secondary);">Selected Limit: ${p.name}</p>
                <p class="text-lg font-extrabold" style="color:var(--gradient-mid);" id="final-maco-val-${t.id}" data-value="${m}">${m.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})} mg</p>
            `}function Xp(){let n=document.getElementById("macoExportDropdown");n.classList.toggle("hidden"),wl(),document.addEventListener("click",function e(t){!t.target.closest("#macoExportDropdown")&&!t.target.closest('button[onclick="toggleMacoExportDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function Jp(){let n=document.getElementById("macoPrintDropdown");n.classList.toggle("hidden"),wl(),document.addEventListener("click",function e(t){!t.target.closest("#macoPrintDropdown")&&!t.target.closest('button[onclick="toggleMacoPrintDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function wl(){Promise.resolve().then(()=>(he(),je)).then(n=>{let{getTrainData:e}=n,t=e(),r=document.getElementById("macoExportTrainOptions");r&&(r.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 export-maco-train-checkbox",c.value=o.id,c.onchange=()=>Li("export");let u=document.createElement("span");u.textContent=`Train ${o.id}`,a.appendChild(c),a.appendChild(u),r.appendChild(a)}));let s=document.getElementById("macoPrintTrainOptions");s&&(s.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 print-maco-train-checkbox",c.value=o.id,c.onchange=()=>Li("print");let u=document.createElement("span");u.textContent=`Train ${o.id}`,a.appendChild(c),a.appendChild(u),s.appendChild(a)}))})}function Yp(n){let e=document.getElementById(`${n}MacoAllTrainsCheckbox`);document.querySelectorAll(`.${n}-maco-train-checkbox`).forEach(r=>{r.checked=e.checked})}function Li(n){let e=document.getElementById(`${n}MacoAllTrainsCheckbox`),t=document.querySelectorAll(`.${n}-maco-train-checkbox`),r=document.querySelectorAll(`.${n}-maco-train-checkbox:checked`);r.length===0?(e.checked=!1,e.indeterminate=!1):r.length===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}function Zp(){Promise.resolve().then(()=>(Oe(),At)).then(n=>{let e=document.getElementById("exportMacoAllTrainsCheckbox"),t=[];if(e.checked)n.exportProductMacoToExcel("all");else{if(document.querySelectorAll(".export-maco-train-checkbox:checked").forEach(s=>{t.push(s.value)}),t.length===0){n.showCustomAlert("No Selection","Please select at least one train to export.");return}n.exportProductMacoToExcel(t)}document.getElementById("macoExportDropdown").classList.add("hidden")}).catch(n=>{console.error("Error loading export function:",n),alert("Error loading export function")})}function em(){Promise.resolve().then(()=>(Oe(),At)).then(n=>{let e=document.getElementById("printMacoAllTrainsCheckbox"),t=[];if(e.checked)n.printCurrentView("macoForTrains","all");else{if(document.querySelectorAll(".print-maco-train-checkbox:checked").forEach(s=>{t.push(s.value)}),t.length===0){n.showCustomAlert("No Selection","Please select at least one train to print.");return}n.printCurrentView("macoForTrains",t)}document.getElementById("macoPrintDropdown").classList.add("hidden")}).catch(n=>{console.error("Error loading print function:",n),alert("Error loading print function")})}var _l=ne(()=>{Fe();Oe();he();window.toggleMacoExportDropdown=Xp;window.toggleMacoPrintDropdown=Jp;window.toggleAllMacoTrainsSelection=Yp;window.updateAllMacoTrainsCheckbox=Li;window.executeMacoExportSelection=Zp;window.executeMacoPrintSelection=em});var os={};Ge(os,{addDetergentIngredient:()=>M0,executeDetergentExportSelection:()=>rm,executeDetergentPrintSelection:()=>sm,populateDetergentTrainOptions:()=>bl,recalculateDetergentMacoForTrain:()=>tm,removeDetergentIngredient:()=>V0,renderDetergentIngredientsList:()=>is,renderDetergentMaco:()=>wn,toggleAllDetergentTrainsSelection:()=>nm,toggleDetergentExportDropdown:()=>im,toggleDetergentPrintDropdown:()=>om,updateAllDetergentTrainsCheckbox:()=>Fi,updateDetergentIngredient:()=>L0});function wn(){let n=document.getElementById("detergentMacoResults"),e=document.getElementById("noTrainsForDetergentMessage");n.innerHTML="";let t=xe(),r=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(Array.isArray(window.printSelectedTrain)?r=t.filter(a=>window.printSelectedTrain.includes(String(a.id))):r=t.filter(a=>String(a.id)===String(window.printSelectedTrain))),r.length===0){e.style.display="block";return}e.style.display="none";let s=xe(),o=s.length>0?Math.max(...s.map(a=>a.essa)):0;r.forEach((a,c)=>{let d=a.products.map(b=>b.productType),p=St(d),m=le[p]||le.Other,g=document.createElement("div");g.className="train-card",g.innerHTML=`
                    <div class="train-header" onclick="toggleTrain('dm-${a.id}')">
                        <span>Train ${a.id} - Detergent MACO Calculation</span>
                        <button class="train-toggle" id="toggle-dm-${a.id}">\u25B6</button>
                    </div>
                    <div class="train-content collapsed" id="content-dm-${a.id}">
                        <div class="train-content-inner space-y-3">
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                               
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">
                                    Based on products in the train, the minimum (Batch Size / MDD) ratio is: <b>${a.minBsMddRatio.toLocaleString(void 0,{maximumFractionDigits:2})}</b>.
                                </p>
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">
                                    Min LD50 = <b><span id="min-ld50-train-${a.id}">...</span> mg/kg</b>
                                </p>
                            </div>

                            <div class="p-3 rounded-md border" style="border-color:var(--border-color)">
                                <label for="sf-input-train-${a.id}" class="block text-sm font-small mb-1">Safety Factor (SF)</label>
                                <input type="number" 
                                    id="sf-input-train-${a.id}" 
                                    class="w-full px-2 py-2 border rounded-md text-sm"
                                    value="${m.max}" 
                                    min="${m.min}" 
                                    max="${m.max}" 
                                    oninput="recalculateDetergentMacoForTrain(${a.id})"
                                    onchange="clampSafetyFactor(this, ${a.id})">
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">Range for ${m.route} route: ${m.min.toLocaleString()} - ${m.max.toLocaleString()}</p>
                            </div>
                            
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">ADI = (5e-4 * LD50 * BW) / SF</p>
                                <p><b  class="text-sm">Acceptable Daily Intake (ADI):</b> <span  class="text-sm" id="adi-value-train-${a.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO = (ADI * Min BS/MDD Ratio)</p>
                                <p><b  class="text-sm">MACO:</b> <span  class="text-sm" id="maco-value-train-${a.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO/Area = MACO / Global Largest ESSA</p>
                                <p><b  class="text-sm">MACO per Area:</b> <span class="text-sm"id="macoarea-value-train-${a.id}">...</span></p>
                            </div>
                            <div class="p-3 rounded-md" style="background-color: var(--bg-accent);">
                                <p class="font-mono text-xs" style="color:var(--text-secondary);">MACO/Swab = (MACO/Area) * SSA</p>
                                <p><b class="text-sm">MACO per Swab:</b> <span  class="text-sm" id="macoswab-value-train-${a.id}">...</span></p>
                            </div>
                        </div>
                    </div>
                `,n.appendChild(g),tm(a.id,o)})}function tm(n,e){let t=xe().find(m=>m.id===n);if(!t)return;if(e===void 0){let m=xe();e=m.length>0?Math.max(...m.map(g=>g.essa)):0}let r=ce.map(m=>parseFloat(m.ld50)).filter(m=>!isNaN(m)),s=r.length>0?Math.min(...r):0,o=parseFloat(document.getElementById("bodyWeight").value)||0,a=parseFloat(document.getElementById(`sf-input-train-${n}`).value)||1,c=5e-4*s*o/a,u=c*t.minBsMddRatio,d=e>0?u/e:0,p=d*t.assumedSsa;document.getElementById(`min-ld50-train-${n}`).textContent=s.toLocaleString(),document.getElementById(`adi-value-train-${n}`).textContent=`${c.toFixed(4)} mg`,document.getElementById(`maco-value-train-${n}`).textContent=`${u.toFixed(2)} mg`,document.getElementById(`macoarea-value-train-${n}`).textContent=`${d.toExponential(3)} mg/cm\xB2`,document.getElementById(`macoswab-value-train-${n}`).textContent=`${p.toFixed(4)} mg/swab`}function is(){let n=document.getElementById("detergentIngredientsContainer");n.innerHTML="",ce.length===0&&(n.innerHTML='<p class="text-sm text-center p-2" style="color:var(--text-secondary);">Please add at least one detergent ingredient.</p>'),ce.forEach(e=>{let t=document.createElement("div");t.className="flex items-center gap-x-2 mb-2",t.innerHTML=`
                    <input type="text" oninput="updateDetergentIngredient(${e.id}, 'name', this.value)" value="${e.name}" placeholder="Ingredient Name" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <input type="number" oninput="updateDetergentIngredient(${e.id}, 'ld50', this.value)" value="${e.ld50}" placeholder="LD50 (mg/kg)" class="w-32 px-3 py-2 border rounded-lg text-sm" min="0">
                    <div class="w-8 px-3 py-2 flex items-center justify-center">
                        <button onclick="removeDetergentIngredient(${e.id})" class="text-red-500 hover:bg-red-50 rounded p-1" title="Remove Ingredient">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
                        </button>
                    </div>
                `,n.appendChild(t)})}function M0(){let n=[...ce,{id:Ss,name:"",ld50:""}];Tn(Ss+1),ht(n),is(),wn()}function V0(n){let e=ce.filter(t=>t.id!==n);ht(e),is(),wn()}function L0(n,e,t){let r=ce.find(s=>s.id===n);r&&(r[e]=t,wn())}function bl(){Promise.resolve().then(()=>(he(),je)).then(n=>{let{getTrainData:e}=n,t=e(),r=document.getElementById("detergentExportTrainOptions");r&&(r.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 export-detergent-train-checkbox",c.value=o.id,c.onchange=()=>Fi("export");let u=document.createElement("span");u.textContent=`Train ${o.id}`,a.appendChild(c),a.appendChild(u),r.appendChild(a)}));let s=document.getElementById("detergentPrintTrainOptions");s&&(s.innerHTML="",t.forEach(o=>{let a=document.createElement("label");a.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",a.style.color="var(--text-primary)";let c=document.createElement("input");c.type="checkbox",c.className="mr-2 print-detergent-train-checkbox",c.value=o.id,c.onchange=()=>Fi("print");let u=document.createElement("span");u.textContent=`Train ${o.id}`,a.appendChild(c),a.appendChild(u),s.appendChild(a)}))}).catch(n=>console.error("Error populating detergent train options:",n))}function nm(n){let e=document.getElementById(`${n}DetergentAllTrainsCheckbox`);document.querySelectorAll(`.${n}-detergent-train-checkbox`).forEach(r=>{r.checked=e.checked})}function Fi(n){let e=document.getElementById(`${n}DetergentAllTrainsCheckbox`),t=document.querySelectorAll(`.${n}-detergent-train-checkbox`),r=document.querySelectorAll(`.${n}-detergent-train-checkbox:checked`);e&&(r.length===0?(e.checked=!1,e.indeterminate=!1):r.length===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0))}function rm(){Promise.resolve().then(()=>(Oe(),At)).then(n=>{let e=document.getElementById("exportDetergentAllTrainsCheckbox"),t=[];if(e&&e.checked)n.exportDetergentMacoToExcel();else{if(document.querySelectorAll(".export-detergent-train-checkbox:checked").forEach(o=>t.push(o.value)),t.length===0){n.showCustomAlert("No Selection","Please select at least one train to export.");return}window.exportSelectedDetergentTrains=t,n.exportDetergentMacoToExcel(t)}let r=document.getElementById("detergentExportDropdown");r&&r.classList.add("hidden")}).catch(n=>console.error("Error executing detergent export selection:",n))}function sm(){Promise.resolve().then(()=>(Oe(),At)).then(n=>{let e=document.getElementById("printDetergentAllTrainsCheckbox"),t=[];if(e&&e.checked)n.printCurrentView("detergentMaco","all");else{if(document.querySelectorAll(".print-detergent-train-checkbox:checked").forEach(o=>t.push(o.value)),t.length===0){n.showCustomAlert("No Selection","Please select at least one train to print.");return}window.printSelectedTrain=t,n.printCurrentView("detergentMaco",t)}let r=document.getElementById("detergentPrintDropdown");r&&r.classList.add("hidden")}).catch(n=>console.error("Error executing detergent print selection:",n))}function im(){let n=document.getElementById("detergentExportDropdown");n&&(n.classList.toggle("hidden"),n.classList.contains("hidden")||(bl(),setTimeout(()=>{function e(t){!t.target.closest("#detergentExportDropdown")&&!t.target.closest('[onclick="toggleDetergentExportDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))}document.addEventListener("click",e)},10)))}function om(){let n=document.getElementById("detergentPrintDropdown");n&&(n.classList.toggle("hidden"),n.classList.contains("hidden")||(bl(),setTimeout(()=>{function e(t){!t.target.closest("#detergentPrintDropdown")&&!t.target.closest('[onclick="toggleDetergentPrintDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))}document.addEventListener("click",e)},10)))}var Bi=ne(()=>{Fe();he();window.toggleDetergentExportDropdown=im;window.toggleDetergentPrintDropdown=om;window.toggleAllDetergentTrainsSelection=nm;window.updateAllDetergentTrainsCheckbox=Fi;window.executeDetergentExportSelection=rm;window.executeDetergentPrintSelection=sm});var Ui={};Ge(Ui,{executeTrainSummaryExportSelection:()=>um,executeTrainSummaryPrintSelection:()=>dm,renderTrainSummary:()=>qi,toggleAllTrainSummaryTrainsSelection:()=>lm,toggleTrainSummaryExportDropdown:()=>am,toggleTrainSummaryPrintDropdown:()=>cm,updateAllTrainSummaryTrainsCheckbox:()=>$i});function O0(n){let e=null,t=0;try{if(!n||!n.products||!Array.isArray(n.products))return null;for(let r of n.products)if(!(!r||!r.activeIngredients||!Array.isArray(r.activeIngredients))){for(let s of r.activeIngredients)if(s)try{let o=Pe(s);o&&o.rpn>t&&(t=o.rpn,e={productCode:r.productCode||"Unknown",productName:r.name||"Unknown Product",ingredientName:s.name||"Unknown Ingredient",rpn:o.rpn})}catch(o){console.warn("Error calculating scores for ingredient:",s,o);continue}}}catch(r){return console.error("Error in getWorstCaseProductForTrain:",r),null}return e}function F0(n){try{if(!n)return 0;let e=xe();if(!e||!Array.isArray(e))return 0;let t=Math.max(...e.map(s=>s.essa||0));return t<=0?0:dl(n,t)||0}catch(e){return console.error("Error calculating MACO for train:",n?.id||"unknown",e),0}}function qi(){let n=document.getElementById("trainSummaryContainer"),e=document.getElementById("noTrainSummaryMessage");n.innerHTML="";let t=xe();if(t.length===0){e.style.display="block",n.style.display="none";return}let r=t;if(window.printSelectedTrain&&window.printSelectedTrain!=="all"&&(console.log("Filtering trains for print:",window.printSelectedTrain),console.log("Available trains:",t.map(o=>o.id)),Array.isArray(window.printSelectedTrain)?r=t.filter(o=>window.printSelectedTrain.includes(String(o.id))):r=t.filter(o=>String(o.id)===String(window.printSelectedTrain)),console.log("Filtered trains:",r.map(o=>o.id))),r.length===0){console.log("No trains to render after filtering"),e.style.display="block",n.style.display="none";return}e.style.display="none",n.style.display="block";let s=r.map(o=>{let c=o.machineIds.map(S=>{let v=Q.find(C=>C.id===S);return v||{id:S,name:`Unknown (ID: ${S})`,machineNumber:"N/A"}}).map(S=>{let v=S.group?` [${S.group}]`:"";return`${S.name}${v}`}).join(", "),u=o.products.map(S=>S.name).join(", "),d=`
            <div class="mb-2">
                <span class="font-semibold text-blue-600">Machines:</span><br>
                <span class="text-sm">${c}</span>
            </div>
            <div>
                <span class="font-semibold text-purple-600">Products:</span><br>
                <span class="text-sm">${u}</span>
            </div>
        `,p=O0(o),m=p?`
                <div class="text-sm">
                    <div class="font-semibold text-orange-600">${p.productName}</div>
                    <div class="text-xs text-gray-600">Ingredient: ${p.ingredientName}</div>
                    <div class="text-xs font-bold text-red-600">RPN: ${p.rpn.toFixed(2)}</div>
                </div>
            `:'<span class="text-gray-500 text-sm">No data available</span>',g=F0(o),b=g>0?`<span class="font-semibold text-green-600">${g.toFixed(4)} mg/swab</span>`:'<span class="text-gray-500">Not calculated</span>';return`
            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800/50" style="border-color: var(--border-color);">
                <td class="px-4 py-4 text-center font-bold text-lg" style="color: var(--text-primary);">T${o.id}</td>
                <td class="px-4 py-4" style="color: var(--text-primary);">
                    ${d}
                </td>
                <td class="px-4 py-4" style="color: var(--text-primary);">
                    ${m}
                </td>
                <td class="px-4 py-4 text-center" style="color: var(--text-primary);">
                    ${b}
                </td>
            </tr>
        `}).join("");n.innerHTML=`
        <div class="overflow-hidden rounded-lg border" style="border-color: var(--border-color);">
            <table class="w-full text-sm">
                <thead class="bg-gray-200 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider w-20" style="color: var(--text-secondary);">Train</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Machines & Products</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider w-64" style="color: var(--text-secondary);">Worst Case Product</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider w-32" style="color: var(--text-secondary);">MACO</th>
                    </tr>
                </thead>
                <tbody style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    ${s}
                </tbody>
            </table>
        </div>
    `,vl(),z()}function am(){let n=document.getElementById("trainSummaryExportDropdown");n.classList.toggle("hidden"),vl(),document.addEventListener("click",function e(t){!t.target.closest("#trainSummaryExportDropdown")&&!t.target.closest('button[onclick="toggleTrainSummaryExportDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function cm(){let n=document.getElementById("trainSummaryPrintDropdown");n.classList.toggle("hidden"),vl(),document.addEventListener("click",function e(t){!t.target.closest("#trainSummaryPrintDropdown")&&!t.target.closest('button[onclick="toggleTrainSummaryPrintDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function vl(){let n=xe(),e=document.getElementById("trainSummaryExportTrainOptions");e&&(e.innerHTML="",n.forEach(r=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let o=document.createElement("input");o.type="checkbox",o.className="mr-2 export-trainsummary-train-checkbox",o.value=r.id,o.onchange=()=>$i("export");let a=document.createElement("span");a.textContent=`Train ${r.id}`,s.appendChild(o),s.appendChild(a),e.appendChild(s)}));let t=document.getElementById("trainSummaryPrintTrainOptions");t&&(t.innerHTML="",n.forEach(r=>{let s=document.createElement("label");s.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",s.style.color="var(--text-primary)";let o=document.createElement("input");o.type="checkbox",o.className="mr-2 print-trainsummary-train-checkbox",o.value=r.id,o.onchange=()=>$i("print");let a=document.createElement("span");a.textContent=`Train ${r.id}`,s.appendChild(o),s.appendChild(a),t.appendChild(s)}))}function lm(n){let e=document.getElementById(`${n}TrainSummaryAllTrainsCheckbox`);document.querySelectorAll(`.${n}-trainsummary-train-checkbox`).forEach(r=>{r.checked=e.checked})}function $i(n){let e=document.getElementById(`${n}TrainSummaryAllTrainsCheckbox`),t=document.querySelectorAll(`.${n}-trainsummary-train-checkbox`),r=document.querySelectorAll(`.${n}-trainsummary-train-checkbox:checked`);r.length===0?(e.checked=!1,e.indeterminate=!1):r.length===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}function um(){Promise.resolve().then(()=>(Oe(),At)).then(n=>{let{showCustomAlert:e,exportTrainSummaryToExcel:t}=n,r=document.getElementById("exportTrainSummaryAllTrainsCheckbox"),s=[];if(r.checked)t("all");else{if(document.querySelectorAll(".export-trainsummary-train-checkbox:checked").forEach(a=>{s.push(a.value)}),s.length===0){e("No Selection","Please select at least one train to export.");return}t(s)}document.getElementById("trainSummaryExportDropdown").classList.add("hidden")}).catch(n=>{console.error("Error loading export function:",n),alert("Error loading export function")})}function dm(){try{let n=document.getElementById("printTrainSummaryAllTrainsCheckbox"),e=document.querySelectorAll(".print-trainsummary-train-checkbox:checked");if(console.log("All checkbox checked:",n?n.checked:"not found"),console.log("Individual checkboxes found:",e.length),!n){alert("Print dropdown elements not found. Please try refreshing the page.");return}Promise.resolve().then(()=>(Oe(),At)).then(t=>{let{showCustomAlert:r,printCurrentView:s}=t,o=[];if(n.checked)console.log("Printing all trains"),s("trainSummary","all");else{if(e.forEach(c=>{o.push(c.value)}),console.log("Selected trains for printing:",o),o.length===0){r("No Selection","Please select at least one train to print.");return}s("trainSummary",o)}let a=document.getElementById("trainSummaryPrintDropdown");a&&a.classList.add("hidden")}).catch(t=>{console.error("Error loading print function:",t),alert("Error loading print function: "+t.message)})}catch(n){console.error("Error in executeTrainSummaryPrintSelection:",n),alert("Print function error: "+n.message)}}var El=ne(()=>{Fe();Oe();he();he();window.toggleTrainSummaryExportDropdown=am;window.toggleTrainSummaryPrintDropdown=cm;window.toggleAllTrainSummaryTrainsSelection=lm;window.updateAllTrainSummaryTrainsCheckbox=$i;window.executeTrainSummaryExportSelection=um;window.executeTrainSummaryPrintSelection=dm});var At={};Ge(At,{clampSafetyFactor:()=>Q0,exportAllTabsToExcel:()=>sw,exportAllToJson:()=>j0,exportDetergentMacoToExcel:()=>tw,exportMachinesToExcel:()=>Z0,exportProductMacoToExcel:()=>ew,exportSummaryToExcel:()=>rw,exportToExcel:()=>z0,exportTrainSummaryToExcel:()=>nw,exportWorstCaseToExcel:()=>Y0,hideLoader:()=>z,hideModal:()=>Ct,importFromJson:()=>G0,loadAllDataFromFirestore:()=>as,loadAllDataFromLocalStorage:()=>B0,printCurrentView:()=>$0,redoChange:()=>Tl,saveAllDataToFirestore:()=>Il,saveAllDataToLocalStorage:()=>zi,saveStateForUndo:()=>Le,showCustomAlert:()=>O,showLoader:()=>Te,toggleColumn:()=>q0,toggleColumnVisibilityDropdown:()=>U0,toggleDarkMode:()=>cs,toggleMacoBreakdown:()=>J0,toggleOtherMachineGroup:()=>W0,toggleOtherMachineStage:()=>K0,toggleOtherProductType:()=>H0,toggleStageSection:()=>iw,toggleTrain:()=>X0,undoChange:()=>xl,updateToggleIcons:()=>at,updateUndoRedoButtons:()=>ji});async function Il(n="defaultUser"){try{await Op(ol(cl,"appData",n),{products:B,machines:Q,scoringCriteria:re,detergentIngredients:ce,machineStageDisplayOrder:ke}),console.log("Data saved to Firestore")}catch(e){console.error("Failed to save data to Firestore",e),O("Save Error","Could not save data to Firestore.")}}async function as(n="defaultUser"){try{let e=await Lp(ol(cl,"appData",n));if(e.exists()){let t=e.data();t.products&&dt(t.products),t.machines&&Ot(t.machines),t.scoringCriteria&&Ft(t.scoringCriteria),t.detergentIngredients&&ht(t.detergentIngredients),t.machineStageDisplayOrder&&vo(t.machineStageDisplayOrder),console.log("Data loaded from Firestore")}else console.log("No Firestore data found for user")}catch(e){console.error("Failed to load data from Firestore",e),O("Load Error","Could not load data from Firestore.")}}function O(n,e){document.getElementById("customAlertTitle").textContent=n,document.getElementById("customAlertMessage").textContent=e,document.getElementById("customAlertModal").style.display="flex"}function zi(){try{localStorage.setItem("macoProducts",JSON.stringify(B)),localStorage.setItem("macoMachines",JSON.stringify(Q)),localStorage.setItem("macoScoringCriteria",JSON.stringify(re)),localStorage.setItem("macoDetergentIngredients",JSON.stringify(ce)),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(ke))}catch(n){console.error("Failed to save data to localStorage",n),O("Save Error","Could not save data. Storage might be full.")}}function B0(){let n=localStorage.getItem("macoProducts"),e=localStorage.getItem("macoMachines"),t=localStorage.getItem("macoScoringCriteria"),r=localStorage.getItem("macoDetergentIngredients"),s=localStorage.getItem("machineStageDisplayOrder");if(n)try{dt(JSON.parse(n))}catch(o){console.error("Error loading products",o)}if(e)try{Ot(JSON.parse(e))}catch(o){console.error("Error loading machines",o)}if(t)try{Ft(JSON.parse(t))}catch(o){console.error("Error loading scoring criteria",o)}if(r)try{ht(JSON.parse(r))}catch(o){console.error("Error loading detergent ingredients",o)}if(s)try{vo(JSON.parse(s))}catch(o){console.error("Error loading machine stage order",o)}}function Le(){Zr();let n=lt.slice(0,ut+1),e={products:JSON.parse(JSON.stringify(B)),machines:JSON.parse(JSON.stringify(Q)),scoringCriteria:JSON.parse(JSON.stringify(re)),detergentIngredients:JSON.parse(JSON.stringify(ce))};n.push(e),Rs(n,n.length-1),ji(),zi()}function ji(){let n=document.getElementById("undo-btn"),e=document.getElementById("redo-btn");n&&(n.disabled=ut<=0),e&&(e.disabled=ut>=lt.length-1)}function xl(){if(ut>0){let n=ut-1,e=lt[n];dt(JSON.parse(JSON.stringify(e.products))),Ot(JSON.parse(JSON.stringify(e.machines))),Ft(JSON.parse(JSON.stringify(e.scoringCriteria))),ht(JSON.parse(JSON.stringify(e.detergentIngredients))),Rs(lt,n),ct&&ot(!1),De(),ji(),zi()}}function Tl(){if(ut<lt.length-1){let n=ut+1,e=lt[n];dt(JSON.parse(JSON.stringify(e.products))),Ot(JSON.parse(JSON.stringify(e.machines))),Ft(JSON.parse(JSON.stringify(e.scoringCriteria))),ht(JSON.parse(JSON.stringify(e.detergentIngredients))),Rs(lt,n),ct&&ot(!1),De(),ji(),zi()}}function cs(n){let e=document.getElementById("theme-toggle-light-icon"),t=document.getElementById("theme-toggle-dark-icon");n?(document.documentElement.classList.add("dark"),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")):(document.documentElement.classList.remove("dark"),e&&e.classList.remove("hidden"),t&&t.classList.add("hidden")),Vt&&rs(),Lt&&Vi()}function $0(n,e="all"){n==="scoring-system"&&ct&&(Ns(!0),ot(!1)),console.log("Printing view:",n,"Train:",e),document.body.classList.add(`printing-${n}`),n==="worstCaseProducts"?Promise.resolve().then(()=>(Wt(),nr)).then(t=>{window.printSelectedTrain=e,t.renderWorstCaseByTrain(),setTimeout(()=>{window.print()},200)}):n==="macoForTrains"?(window.printSelectedTrain=e,Promise.resolve().then(()=>(_l(),Oi)).then(t=>{t.renderMacoForTrains();let r=document.querySelectorAll("#macoForTrains .train-content.collapsed"),s=[];r.forEach(c=>{let u=c.id.match(/content-pm-(\d+)/);if(u){s.push(u[1]),c.classList.remove("collapsed");let d=document.getElementById(`toggle-pm-${u[1]}`);d&&(d.textContent="\u25BC")}});let o=document.querySelectorAll('#macoForTrains [id^="maco-breakdown-details-"].hidden'),a=[];o.forEach(c=>{let u=c.id.match(/maco-breakdown-details-(\d+)/);if(u){a.push(u[1]),c.classList.remove("hidden");let d=document.getElementById(`breakdown-toggle-btn-${u[1]}`);d&&(d.textContent="Hide MACO Calculation Breakdown")}}),setTimeout(()=>{window.print(),setTimeout(()=>{s.forEach(c=>{let u=document.getElementById(`content-pm-${c}`),d=document.getElementById(`toggle-pm-${c}`);u&&u.classList.add("collapsed"),d&&(d.textContent="\u25B6")}),a.forEach(c=>{let u=document.getElementById(`maco-breakdown-details-${c}`),d=document.getElementById(`breakdown-toggle-btn-${c}`);u&&u.classList.add("hidden"),d&&(d.textContent="Show MACO Calculation Breakdown")})},1e3)},200)})):n==="detergentMaco"?(window.printSelectedTrain=e,Promise.resolve().then(()=>(Bi(),os)).then(t=>{t.renderDetergentMaco();let r=document.querySelectorAll("#detergentMaco .train-content.collapsed"),s=[];r.forEach(o=>{let a=o.id.match(/content-dm-(\d+)/);if(a){s.push(a[1]),o.classList.remove("collapsed");let c=document.getElementById(`toggle-dm-${a[1]}`);c&&(c.textContent="\u25BC")}}),setTimeout(()=>{window.print(),setTimeout(()=>{s.forEach(o=>{let a=document.getElementById(`content-dm-${o}`),c=document.getElementById(`toggle-dm-${o}`);a&&a.classList.add("collapsed"),c&&(c.textContent="\u25B6")})},1e3)},200)}).catch(t=>{console.error("Error loading detergent view for print:",t),window.print()}).finally(()=>{setTimeout(()=>{window.printSelectedTrain=null,Promise.resolve().then(()=>(Bi(),os)).then(t=>t.renderDetergentMaco()).catch(()=>{})},1200)})):n==="trainSummary"?(window.printSelectedTrain=e,console.log("Setting printSelectedTrain to:",e),Promise.resolve().then(()=>(El(),Ui)).then(t=>{t.renderTrainSummary(),setTimeout(()=>{let r=document.getElementById("trainSummaryContainer"),s=document.getElementById("noTrainSummaryMessage");if(console.log("Container display:",r?r.style.display:"not found"),console.log("No trains message display:",s?s.style.display:"not found"),console.log("Container has content:",r?r.innerHTML.length>0:!1),!r||r.style.display==="none"){console.warn("Train summary container is hidden or missing"),alert("No train data to print. Please ensure you have created trains first.");return}window.print(),setTimeout(()=>{window.printSelectedTrain=null,t.renderTrainSummary()},1e3)},500)}).catch(t=>{console.error("Error loading train summary view:",t),alert("Error loading train summary: "+t.message)})):setTimeout(()=>{window.print()},100)}function q0(n,e){if(n==="pde"||n==="ld50"){["productRegister","worstCaseProducts"].forEach(r=>{document.querySelectorAll(`#${r} .mainTable, #${r} .ingredients-sub-table`).forEach(s=>{s.classList.toggle(`hide-${n}`)}),document.querySelectorAll(`#${r}, #${r} .train-content-inner`).forEach(s=>{s&&s.classList.toggle(`hide-${n}`)})});let t=document.querySelector(`#productRegister .mainTable.hide-${n}`)!==null;localStorage.setItem(`productRegister-${n}Hidden`,t),at("productRegister"),at("worstCaseProducts"),Promise.resolve().then(()=>(Wt(),nr)).then(r=>{r.renderWorstCaseByTrain()}),Promise.resolve().then(()=>(Wt(),nr)).then(r=>{r.renderRpnChart&&r.renderRpnChart()})}else{document.querySelectorAll(`#${e} .mainTable, #${e} .ingredients-sub-table`).forEach(r=>{r.classList.toggle(`hide-${n}`)});let t=document.querySelector(`#${e} .mainTable.hide-${n}`)!==null;localStorage.setItem(`${e}-${n}Hidden`,t),at(e)}}function U0(){let n=document.getElementById("columnVisibilityDropdown");n.classList.toggle("hidden"),n.classList.contains("hidden")||document.addEventListener("click",function e(t){!t.target.closest("#columnVisibilityDropdown")&&!t.target.closest('button[onclick="toggleColumnVisibilityDropdown()"]')&&(n.classList.add("hidden"),document.removeEventListener("click",e))})}function at(n){let e=document.getElementById(n);if(!e)return;let t,r;if(n==="worstCaseProducts"){let u=localStorage.getItem("productRegister-pdeHidden"),d=localStorage.getItem("productRegister-ld50Hidden");if(u===null&&d===null)t=!1,r=!1;else{let p=u==="true",m=d==="true";p&&m?(t=!1,r=!0):(t=p,r=m)}}else{let u=localStorage.getItem(`${n}-pdeHidden`),d=localStorage.getItem(`${n}-ld50Hidden`);t=u==="true",r=d==="true"}let s=e.querySelector(".toggle-pde"),o=e.querySelector(".toggle-ld50");s&&(s.innerHTML=t?"Show PDE":"Hide PDE"),o&&(o.innerHTML=r?"Show LD50":"Hide LD50"),document.querySelectorAll(`#${n} .mainTable, #${n} .ingredients-sub-table`).forEach(u=>{u&&(u.classList.toggle("hide-pde",t),u.classList.toggle("hide-ld50",r))}),document.querySelectorAll(`#${n}, #${n} .train-content-inner`).forEach(u=>{u&&(u.classList.toggle("hide-pde",t),u.classList.toggle("hide-ld50",r))})}function z0(){Te(),Promise.resolve().then(()=>(he(),je)).then(n=>{let{getProductTrainId:e,calculateScores:t}=n,r=[];if(B.forEach(d=>{let p="No";d.isCritical&&(p=`Yes${d.criticalReason?`: ${d.criticalReason}`:""}`);let m=e(d),g=d.date?new Date(d.date).toLocaleDateString():"";r.push({Date:g,"Product Code":d.productCode,"Product Name":d.name,"Train No.":m,"Dosage Form":d.productType||"","Batch Size (Kg)":d.batchSizeKg,"Special Case Product":p,"Active Ingredient":"",Solubility:"","Therapeutic Dose (mg/day)":"",Cleanability:"","PDE (\xB5g/day)":"","LD50 (mg/kg)":"","Solubility Score":"","Therapeutic Dose Score":"","Cleanability Score":"","Toxicity Score":"",RPN:"","RPN Rating":""}),d.activeIngredients.forEach(b=>{let S=t(b);r.push({Date:"","Product Code":"","Product Name":`  \u2514\u2500 ${b.name}`,"Train No.":"","Dosage Form":"","Batch Size (Kg)":"","Special Case Product":"","Active Ingredient":b.name,Solubility:b.solubility||"","Therapeutic Dose (mg/day)":b.therapeuticDose||"",Cleanability:b.cleanability||"","PDE (\xB5g/day)":b.pde||"","LD50 (mg/kg)":b.ld50||"","Solubility Score":S.solubilityScore||"","Therapeutic Dose Score":S.therapeuticDoseScore||"","Cleanability Score":S.cleanabilityScore||"","Toxicity Score":S.pdeScore||S.ld50Score||"",RPN:S.rpn,"RPN Rating":S.rpnRatingText})})}),r.length===0){z(),O("No Data","There is no data in the current view to export.");return}let o=XLSX.utils.json_to_sheet(r),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"MACO Report");let u=Object.keys(r[0]).map(d=>({wch:Math.max(d.length,...r.map(p=>String(p[d]||"").length))+2}));o["!cols"]=u,XLSX.writeFile(a,"MACO_All_Products_Report.xlsx"),z()}).catch(n=>{console.error("Error exporting to Excel:",n),z(),O("Error","Failed to export data to Excel.")})}function j0(){Te();try{let n={exportDate:new Date().toISOString(),scoringCriteria:re,products:B,machines:Q,detergentIngredients:ce},e=JSON.stringify(n,null,2),t=new Blob([e],{type:"application/json"}),r=URL.createObjectURL(t),s=document.createElement("a");s.href=r,s.download="maco_data_export.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}catch(n){O("Error","Failed to export data to JSON."+n.message)}finally{z()}}function G0(n){let e=n.target.files[0];if(!e)return;let t=new FileReader;t.onload=function(r){try{let s=JSON.parse(r.target.result);s&&s.products&&s.scoringCriteria&&s.machines?(dt(s.products),Ot(s.machines),Ft(s.scoringCriteria),s.detergentIngredients&&ht(s.detergentIngredients),Le(),De(),O("Success","Data imported successfully.")):O("Error","Invalid JSON file structure.")}catch{O("Error","Failed to parse JSON file.")}finally{n.target.value=""}},t.readAsText(e)}function H0(n,e){let t=document.getElementById(e),r=t.querySelector("input");n.value==="Other"?(t.style.display="block",r.required=!0):(t.style.display="none",r.required=!1,r.value="")}function K0(n,e){let t=document.getElementById(e),r=t.querySelector("input");n.value==="Other"?(t.style.display="block",r.required=!0):(t.style.display="none",r.required=!1,r.value="")}function W0(n,e){let t=document.getElementById(e),r=t.querySelector("input");n.value==="Other"?(t.style.display="block",r.required=!0):(t.style.display="none",r.required=!1,r.value="")}function Q0(n,e){let t=parseFloat(n.min),r=parseFloat(n.max),s=parseFloat(n.value);isNaN(s)&&(s=t),s<t?s=t:s>r&&(s=r),parseFloat(n.value)!==s&&(n.value=s),n.id.startsWith("product-sf-input")?recalculateProductMacoForTrain(e):n.id.startsWith("sf-input-train")&&recalculateDetergentMacoForTrain(e)}function X0(n){let e=document.getElementById(`content-${n}`),t=document.getElementById(`toggle-${n}`);e&&t&&(e.classList.contains("collapsed")?(e.classList.remove("collapsed"),t.textContent="\u25BC"):(e.classList.add("collapsed"),t.textContent="\u25B6"))}function J0(n){let e=document.getElementById(`maco-breakdown-details-${n}`),t=document.getElementById(`breakdown-toggle-btn-${n}`);e.classList.contains("hidden")?(e.classList.remove("hidden"),t.textContent="Hide MACO Calculation Breakdown"):(e.classList.add("hidden"),t.textContent="Show MACO Calculation Breakdown")}function Y0(n="all"){Te(),Promise.resolve().then(()=>(he(),je)).then(e=>{let{getProductTrainId:t,calculateScores:r,getToxicityPreference:s}=e,o=[],a=Me.worstCaseProducts||B;if(a.length===0){z(),O("No Data","There are no products in the worst case view to export.");return}let c={};a.forEach(D=>{let k=t(D);k!=="N/A"&&(c[k]||(c[k]=[]),c[k].push(D))});let u=c;if(n!=="all"&&(u={},Array.isArray(n)?n.forEach(D=>{c[D]&&(u[D]=c[D])}):c[n]&&(u={[n]:c[n]}),Object.keys(u).length===0)){z();let D=Array.isArray(n)?`Trains ${n.join(", ")}`:`Train ${n}`;O("No Data",`${D} not found or has no products.`);return}let d=s();if(Object.keys(u).sort((D,k)=>D-k).forEach(D=>{let k=u[D];o.push({Train:`Train ${D} - Worst Case Analysis`,"Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""}),k.forEach(L=>{let H=L.activeIngredients.map(F=>r(F,d).rpn);L.sortValue=H.length>0?Math.max(...H):0}),k.sort((L,H)=>H.sortValue-L.sortValue),k.forEach(L=>{let H=L.isCritical?"Yes":"No";o.push({Train:"","Product Code":L.productCode,"Product Name":L.name,"Highest RPN":L.sortValue,"Special Case Product":H,Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""}),L.activeIngredients.sort((W,E)=>r(E,d).rpn-r(W,d).rpn).forEach(W=>{let E=r(W,d);o.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:W.name,"TD Score":E.therapeuticDoseScore,"Solubility Score":E.solubilityScore,"Cleanability Score":E.cleanabilityScore,"PDE Score":E.pdeScore??"N/A","LD50 Score":E.ld50Score??"N/A",RPN:E.rpn,Rating:E.rpnRatingText})}),o.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""})})}),o.length===0){z(),O("No Data","There is no data in the worst case view to export.");return}let m=XLSX.utils.json_to_sheet(o),g=XLSX.utils.book_new();XLSX.utils.book_append_sheet(g,m,"Worst Case Products");let S=Object.keys(o[0]).map(D=>({wch:Math.max(D.length,...o.map(k=>String(k[D]||"").length))+2}));m["!cols"]=S;let v=new Date().toISOString().split("T")[0],C="";n!=="all"&&(Array.isArray(n)?C=`_Trains_${n.join("_")}`:C=`_Train_${n}`),XLSX.writeFile(g,`MACO_Worst_Case_Products${C}_${v}.xlsx`),z()}).catch(e=>{console.error("Error exporting worst case to Excel:",e),z(),O("Error","Failed to export worst case data to Excel.")})}function Z0(){Te();try{if(Q.length===0){z(),O("No Data","There are no machines to export.");return}let n=[],e={};Q.forEach(c=>{e[c.stage]||(e[c.stage]=[]),e[c.stage].push(c)}),ke.forEach(c=>{e[c]&&e[c].forEach(u=>{let d=B.filter(g=>g.machineIds&&g.machineIds.includes(u.id)),p=d.map(g=>g.name).join(", ")||"None",m=d.length;n.push({"Machine Number":u.machineNumber,"Machine Name":u.name,Stage:u.stage,"Area (sq cm)":u.area,"Assigned Products Count":m,"Assigned Products":p})})});let t=XLSX.utils.json_to_sheet(n),r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,t,"Machines");let s=[{wch:15},{wch:20},{wch:15},{wch:15},{wch:20},{wch:50}];t["!cols"]=s;let a=new Date().toISOString().split("T")[0];XLSX.writeFile(r,`MACO_Machines_${a}.xlsx`),z(),O("Success","Machines data exported to Excel successfully!")}catch(n){console.error("Error exporting machines to Excel:",n),z(),O("Error","Failed to export machines data to Excel.")}}function ew(n="all"){Te(),Promise.resolve().then(()=>(he(),je)).then(e=>{let{getTrainData:t,getWorstCaseProductType:r,getMacoPerSwabForTrain:s}=e,o=t();if(o.length===0){z(),O("No Data","There are no trains to export. Assign machines to products first.");return}let a=o;if(n!=="all"&&(Array.isArray(n)?a=o.filter(v=>n.includes(String(v.id))):a=o.filter(v=>String(v.id)===String(n))),a.length===0){z(),O("No Data","No trains match the selected criteria.");return}let c=[],d=o.reduce((v,C)=>C.essa>v.essa?C:v).essa;a.forEach(v=>{let C=r(v.products.map(Ie=>Ie.productType)),k=(le[C]||le.Other).max,L=v.lowestLtd*v.minBsMddRatio/k,H=10*v.minMbsKg,F="N/A";v.lowestPde!==null&&(F=v.lowestPde*v.minBsMddRatio);let W=.004*d,y=[{name:"0.1% Therapeutic Dose",value:L},{name:"10 ppm Criterion",value:H},{name:"Health-Based Limit (ADE)",value:typeof F=="number"?F:1/0},{name:"Visual Clean Limit",value:W}].reduce((Ie,Qt)=>Qt.value<Ie.value?Qt:Ie),_=y.value,T=d>0?_/d:0,x=T*v.assumedSsa,I=v.machineIds.map(Ie=>{let Qt=Q.find(bn=>bn.id===Ie);return Qt||{name:`Unknown (ID: ${Ie})`,machineNumber:"N/A"}}),w=e.consolidateMachinesByGroup(v.machineIds).map(Ie=>Ie.isGroup?`${Ie.group} (${Ie.machineCount}x)`:Ie.name).join(" \u2192 "),oe=v.products.map(Ie=>`${Ie.productCode} - ${Ie.name}`).join("; "),Qe=v.worstProductRpn?`${v.worstProductRpn.productName} (${v.worstProductRpn.ingredientName}) - RPN: ${v.worstProductRpn.rpn}`:"N/A";c.push({Train:`T${v.id}`,"Total Products":v.products.length,"Total Machines":I.length,"Total Area (ESSA) cm\xB2":v.essa.toLocaleString(),Products:oe,Machines:w,"Worst-Case Dosage Form":C,"Safety Factor":k,"Lowest LTD (mg)":v.lowestLtd,"Min Batch Size (kg)":v.minMbsKg,"Min BS/MDD Ratio":v.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":v.lowestPde!==null?v.lowestPde:"N/A","Worst-Case Product (by RPN)":Qe,"MACO - Therapeutic Dose (mg)":L.toFixed(2),"MACO - 10 ppm (mg)":H.toFixed(2),"MACO - Health-Based (mg)":typeof F=="number"?F.toFixed(2):"N/A","MACO - Visual Clean (mg)":W.toFixed(2),"Selected MACO Method":y.name,"Final MACO (mg)":_.toFixed(2),"MACO per Area (mg/cm\xB2)":T.toExponential(3),"MACO per Swab (mg/Swab)":x.toFixed(4)})});let p=XLSX.utils.json_to_sheet(c),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,p,"Product MACO Report");let g=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:40},{wch:18},{wch:15},{wch:18},{wch:15},{wch:20},{wch:15},{wch:18},{wch:18}];p["!cols"]=g;let b=new Date().toISOString().split("T")[0],S="Product_MACO_Report";if(n!=="all")if(Array.isArray(n)){let v=n.sort((C,D)=>C-D);S+=`_Trains_${v.join("_")}`}else S+=`_Train_${n}`;S+=`_${b}.xlsx`,XLSX.writeFile(m,S),z(),O("Success","Product MACO data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Product MACO to Excel:",e),z(),O("Error","Failed to export Product MACO data to Excel.")})}function tw(n="all"){Te(),Promise.resolve().then(()=>(he(),je)).then(e=>{let{getTrainData:t,getWorstCaseProductType:r}=e,s=t();if(n!=="all"&&(Array.isArray(n)?s=s.filter(v=>n.includes(String(v.id))):s=s.filter(v=>String(v.id)===String(n))),s.length===0){z(),O("No Data","There are no trains to export. Assign machines to products first.");return}if(ce.length===0){z(),O("No Data","There are no detergent ingredients configured. Add detergent ingredients first.");return}let o=[],a=s.length>0?Math.max(...s.map(v=>v.essa)):0,c=parseFloat(document.getElementById("bodyWeight")?.value)||70,u=ce.map(v=>parseFloat(v.ld50)).filter(v=>!isNaN(v)),d=u.length>0?Math.min(...u):0,p=ce.map(v=>v.name).filter(v=>v.trim()!=="").join(", ");s.forEach(v=>{let C=r(v.products.map(I=>I.productType)),D=le[C]||le.Other,k=document.getElementById(`sf-input-train-${v.id}`),L=k&&parseFloat(k.value)||D.max,H=5e-4*d*c/L,F=H*v.minBsMddRatio,W=a>0?F/a:0,E=W*v.assumedSsa,y=v.machineIds.map(I=>{let w=Q.find(oe=>oe.id===I);return w||{name:`Unknown (ID: ${I})`,machineNumber:"N/A"}}),_=e.consolidateMachinesByGroup(v.machineIds).map(I=>I.isGroup?`${I.group} (${I.machineCount}x)`:I.name).join(" \u2192 "),T=v.products.map(I=>`${I.productCode} - ${I.name}`).join("; "),x=v.worstProductRpn?`${v.worstProductRpn.productName} (${v.worstProductRpn.ingredientName}) - RPN: ${v.worstProductRpn.rpn}`:"N/A";o.push({Train:`T${v.id}`,"Total Products":v.products.length,"Total Machines":y.length,"Total Area (ESSA) cm\xB2":v.essa.toLocaleString(),Products:T,Machines:_,"Worst-Case Dosage Form":C,"Safety Factor Range":`${D.min} - ${D.max}`,"Applied Safety Factor":L,"Detergent Ingredients":p,"Body Weight (kg)":c,"Minimum LD50 (mg/kg)":d,"Min Batch Size (kg)":v.minMbsKg,"Min BS/MDD Ratio":v.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":x,"ADI (mg)":H.toFixed(4),"MACO (mg)":F.toFixed(2),"MACO per Area (mg/cm\xB2)":W.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let m=XLSX.utils.json_to_sheet(o),g=XLSX.utils.book_new();XLSX.utils.book_append_sheet(g,m,"Detergent MACO Report");let b=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:15},{wch:15},{wch:30},{wch:12},{wch:15},{wch:12},{wch:12},{wch:40},{wch:12},{wch:12},{wch:18},{wch:18}];m["!cols"]=b;let S=new Date().toISOString().split("T")[0];XLSX.writeFile(g,`Detergent_MACO_Report_${S}.xlsx`),z(),O("Success","Detergent MACO data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Detergent MACO to Excel:",e),z(),O("Error","Failed to export Detergent MACO data to Excel.")})}function nw(n="all"){Te(),Promise.resolve().then(()=>(he(),je)).then(e=>{let{getTrainData:t}=e,r=t();if(r.length===0){z(),O("No Data","There are no trains to export. Assign machines to products first.");return}let s=r;if(n!=="all"&&(Array.isArray(n)?s=r.filter(m=>n.includes(String(m.id))):s=r.filter(m=>String(m.id)===String(n))),s.length===0){z(),O("No Data","No trains match the selected criteria.");return}let o=[];s.forEach(m=>{let g=m.machineIds.map(D=>{let k=Q.find(L=>L.id===D);return k||{id:D,name:`Unknown (ID: ${D})`,machineNumber:"N/A"}}),b=e.consolidateMachinesByGroup(m.machineIds).map(D=>D.isGroup?`${D.group} (${D.machineCount}x)`:D.name).join(" \u2192 "),S=m.products.map(D=>`${D.productCode} - ${D.name}`).join("; "),v=m.products.map(D=>`${D.productCode}: ${D.name}`).join(`
`),C=g.map(D=>`${D.machineNumber}: ${D.name}`).join(`
`);o.push({"Train ID":`T${m.id}`,"Products Count":m.products.length,"Machines Count":g.length,"Total Area (ESSA) cm\xB2":m.essa.toLocaleString(),"Products (Code - Name)":S,"Machines (Number - Name)":b,"Products Detailed":v,"Machines Detailed":C,"Min Batch Size (kg)":m.minMbsKg,"Min BS/MDD Ratio":m.minBsMddRatio.toFixed(2),"Assumed SSA (cm\xB2)":m.assumedSsa,"Lowest LTD (mg)":m.lowestLtd,"Lowest PDE (mg)":m.lowestPde!==null?m.lowestPde:"N/A","Worst RPN Product":m.worstProductRpn?`${m.worstProductRpn.productName} (${m.worstProductRpn.ingredientName}) - RPN: ${m.worstProductRpn.rpn}`:"N/A"})});let a=XLSX.utils.json_to_sheet(o),c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,a,"Train Summary Report");let u=[{wch:10},{wch:12},{wch:12},{wch:15},{wch:60},{wch:60},{wch:40},{wch:40},{wch:15},{wch:15},{wch:15},{wch:12},{wch:12},{wch:50}];a["!cols"]=u;let d=new Date().toISOString().split("T")[0],p="Train_Summary_Report";if(n!=="all")if(Array.isArray(n)){let m=n.sort((g,b)=>g-b);p+=`_Trains_${m.join("_")}`}else p+=`_Train_${n}`;p+=`_${d}.xlsx`,XLSX.writeFile(c,p),z(),O("Success","Train Summary data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Train Summary to Excel:",e),z(),O("Error","Failed to export Train Summary data to Excel.")})}function rw(){Te(),Promise.resolve().then(()=>(he(),je)).then(n=>{let{getProductTrainId:e,calculateScores:t}=n,r=B.flatMap(p=>{let m=e(p);return p.activeIngredients.map(g=>({productName:p.name,productCode:p.productCode,ingredientName:g.name,rpn:t(g).rpn,trainId:m!=="N/A"?`T${m}`:"N/A",scores:t(g)}))}).sort((p,m)=>m.rpn-p.rpn).slice(0,10),s=B.filter(p=>p.isCritical);if(r.length===0&&s.length===0){z(),O("No Data","There are no summary data to export. Add products and ingredients first.");return}let o=XLSX.utils.book_new();if(r.length>0){let p=r.map((b,S)=>({Rank:S+1,"Product Code":b.productCode,"Product Name":b.productName,Train:b.trainId,Ingredient:b.ingredientName,RPN:b.rpn})),m=XLSX.utils.json_to_sheet(p),g=[{wch:8},{wch:15},{wch:30},{wch:10},{wch:25},{wch:8}];m["!cols"]=g,XLSX.utils.book_append_sheet(o,m,"Top 10 RPN")}if(s.length>0){let p=s.map(b=>({"Product Code":b.productCode,"Product Name":b.name,"Product Type":b.productType,"Batch Size (kg)":b.batchSizeKg,"MDD (mg)":b.mddMg,"Critical Reason":b.criticalReason||"No reason provided",Train:e(b)!=="N/A"?`T${e(b)}`:"N/A"})),m=XLSX.utils.json_to_sheet(p),g=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:50},{wch:10}];m["!cols"]=g,XLSX.utils.book_append_sheet(o,m,"Critical Products")}let a=B.map(p=>{let m=e(p),g=p.activeIngredients.reduce((b,S)=>{let v=t(S).rpn;return v>b.rpn?{...S,rpn:v}:b},{rpn:0,name:"N/A"});return{"Product Code":p.productCode,"Product Name":p.name,"Product Type":p.productType,"Batch Size (kg)":p.batchSizeKg,"MDD (mg)":p.mddMg,Train:m!=="N/A"?`T${m}`:"N/A","Is Critical":p.isCritical?"Yes":"No","Critical Reason":p.criticalReason||"N/A","Ingredients Count":p.activeIngredients.length,"Highest RPN Ingredient":g.name,"Highest RPN Value":g.rpn||0}}),c=XLSX.utils.json_to_sheet(a),u=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:10},{wch:10},{wch:40},{wch:12},{wch:25},{wch:12}];c["!cols"]=u,XLSX.utils.book_append_sheet(o,c,"All Products");let d=new Date().toISOString().split("T")[0];XLSX.writeFile(o,`MACO_Summary_Report_${d}.xlsx`),z(),O("Success","Summary report data exported to Excel successfully!")}).catch(n=>{console.error("Error exporting Summary to Excel:",n),z(),O("Error","Failed to export Summary report data to Excel.")})}function sw(){Te(),Promise.resolve().then(()=>(he(),je)).then(n=>{let{getTrainData:e,getWorstCaseProductType:t,getProductTrainId:r,calculateScores:s}=n,o=e();if(o.length===0){z(),O("No Data","There are no trains to export. Assign machines to products first.");return}let a=XLSX.utils.book_new();try{let u=o.reduce((m,g)=>g.essa>m.essa?g:m).essa,d=[];o.forEach(m=>{let g=t(m.products.map(I=>I.productType)),S=(le[g]||le.Other).max,v=m.lowestLtd*m.minBsMddRatio/S,C=10*m.minMbsKg,D="N/A";m.lowestPde!==null&&(D=m.lowestPde*m.minBsMddRatio);let k=.004*u,H=[{name:"0.1% Therapeutic Dose",value:v},{name:"10 ppm Criterion",value:C},{name:"Health-Based Limit (ADE)",value:typeof D=="number"?D:1/0},{name:"Visual Clean Limit",value:k}].reduce((I,w)=>w.value<I.value?w:I),F=H.value,W=u>0?F/u:0,E=W*m.assumedSsa,y=m.machineIds.map(I=>{let w=Q.find(oe=>oe.id===I);return w||{name:`Unknown (ID: ${I})`,machineNumber:"N/A"}}),_=n.consolidateMachinesByGroup(m.machineIds).map(I=>I.isGroup?`${I.group} (${I.machineCount}x)`:I.name).join(" \u2192 "),T=m.products.map(I=>`${I.productCode} - ${I.name}`).join("; "),x=m.worstProductRpn?`${m.worstProductRpn.productName} (${m.worstProductRpn.ingredientName}) - RPN: ${m.worstProductRpn.rpn}`:"N/A";d.push({Train:`T${m.id}`,"Total Products":m.products.length,"Total Machines":y.length,"Total Area (ESSA) cm\xB2":m.essa.toLocaleString(),Products:T,Machines:_,"Worst-Case Dosage Form":g,"Safety Factor":S,"Lowest LTD (mg)":m.lowestLtd,"Min Batch Size (kg)":m.minMbsKg,"Min BS/MDD Ratio":m.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":m.lowestPde!==null?m.lowestPde:"N/A","Worst-Case Product (by RPN)":x,"MACO - Therapeutic Dose (mg)":v.toFixed(2),"MACO - 10 ppm (mg)":C.toFixed(2),"MACO - Health-Based (mg)":typeof D=="number"?D.toFixed(2):"N/A","MACO - Visual Clean (mg)":k.toFixed(2),"Selected MACO Method":H.name,"Final MACO (mg)":F.toFixed(2),"MACO per Area (mg/cm\xB2)":W.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let p=XLSX.utils.json_to_sheet(d);XLSX.utils.book_append_sheet(a,p,"Product MACO")}catch(u){console.error("Error creating Product MACO sheet:",u)}try{if(ce.length>0){let u=o.length>0?Math.max(...o.map(v=>v.essa)):0,d=parseFloat(document.getElementById("bodyWeight")?.value)||70,p=ce.map(v=>parseFloat(v.ld50)).filter(v=>!isNaN(v)),m=p.length>0?Math.min(...p):0,g=ce.map(v=>v.name).filter(v=>v.trim()!=="").join(", "),b=[];o.forEach(v=>{let C=t(v.products.map(I=>I.productType)),D=le[C]||le.Other,k=document.getElementById(`sf-input-train-${v.id}`),L=k&&parseFloat(k.value)||D.max,H=5e-4*m*d/L,F=H*v.minBsMddRatio,W=u>0?F/u:0,E=W*v.assumedSsa,y=v.machineIds.map(I=>{let w=Q.find(oe=>oe.id===I);return w||{name:`Unknown (ID: ${I})`,machineNumber:"N/A"}}),_=n.consolidateMachinesByGroup(v.machineIds).map(I=>I.isGroup?`${I.group} (${I.machineCount}x)`:I.name).join(" \u2192 "),T=v.products.map(I=>`${I.productCode} - ${I.name}`).join("; "),x=v.worstProductRpn?`${v.worstProductRpn.productName} (${v.worstProductRpn.ingredientName}) - RPN: ${v.worstProductRpn.rpn}`:"N/A";b.push({Train:`T${v.id}`,"Total Products":v.products.length,"Total Machines":y.length,"Total Area (ESSA) cm\xB2":v.essa.toLocaleString(),Products:T,Machines:_,"Worst-Case Dosage Form":C,"Safety Factor Range":`${D.min} - ${D.max}`,"Applied Safety Factor":L,"Detergent Ingredients":g,"Body Weight (kg)":d,"Minimum LD50 (mg/kg)":m,"Min Batch Size (kg)":v.minMbsKg,"Min BS/MDD Ratio":v.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":x,"ADI (mg)":H.toFixed(4),"MACO (mg)":F.toFixed(2),"MACO per Area (mg/cm\xB2)":W.toExponential(3),"MACO per Swab (mg/Swab)":E.toFixed(4)})});let S=XLSX.utils.json_to_sheet(b);XLSX.utils.book_append_sheet(a,S,"Detergent MACO")}}catch(u){console.error("Error creating Detergent MACO sheet:",u)}try{let u=[];o.forEach(p=>{let m=p.machineIds.map(C=>{let D=Q.find(k=>k.id===C);return D||{id:C,name:`Unknown (ID: ${C})`,machineNumber:"N/A"}}),g=n.consolidateMachinesByGroup(p.machineIds).map(C=>C.isGroup?`${C.group} (${C.machineCount}x)`:C.name).join(" \u2192 "),b=p.products.map(C=>`${C.productCode} - ${C.name}`).join("; "),S=p.products.map(C=>`${C.productCode}: ${C.name}`).join(`
`),v=m.map(C=>`${C.machineNumber}: ${C.name}`).join(`
`);u.push({"Train ID":`T${p.id}`,"Products Count":p.products.length,"Machines Count":m.length,"Total Area (ESSA) cm\xB2":p.essa.toLocaleString(),"Products (Code - Name)":b,"Machines (Number - Name)":g,"Products Detailed":S,"Machines Detailed":v,"Min Batch Size (kg)":p.minMbsKg,"Min BS/MDD Ratio":p.minBsMddRatio.toFixed(2),"Assumed SSA (cm\xB2)":p.assumedSsa,"Lowest LTD (mg)":p.lowestLtd,"Lowest PDE (mg)":p.lowestPde!==null?p.lowestPde:"N/A","Worst RPN Product":p.worstProductRpn?`${p.worstProductRpn.productName} (${p.worstProductRpn.ingredientName}) - RPN: ${p.worstProductRpn.rpn}`:"N/A"})});let d=XLSX.utils.json_to_sheet(u);XLSX.utils.book_append_sheet(a,d,"Train Summary")}catch(u){console.error("Error creating Train Summary sheet:",u)}try{let u=B.flatMap(d=>{let p=r(d);return d.activeIngredients.map(m=>({productName:d.name,productCode:d.productCode,ingredientName:m.name,rpn:s(m).rpn,trainId:p!=="N/A"?`T${p}`:"N/A"}))}).sort((d,p)=>p.rpn-d.rpn).slice(0,10);if(u.length>0){let d=u.map((m,g)=>({Rank:g+1,"Product Code":m.productCode,"Product Name":m.productName,Train:m.trainId,Ingredient:m.ingredientName,RPN:m.rpn})),p=XLSX.utils.json_to_sheet(d);XLSX.utils.book_append_sheet(a,p,"Top 10 RPN")}}catch(u){console.error("Error creating Top 10 RPN sheet:",u)}try{let u=B.filter(d=>d.isCritical);if(u.length>0){let d=u.map(m=>({"Product Code":m.productCode,"Product Name":m.name,"Product Type":m.productType,"Batch Size (kg)":m.batchSizeKg,"MDD (mg)":m.mddMg,"Critical Reason":m.criticalReason||"No reason provided",Train:r(m)!=="N/A"?`T${r(m)}`:"N/A"})),p=XLSX.utils.json_to_sheet(d);XLSX.utils.book_append_sheet(a,p,"Critical Products")}}catch(u){console.error("Error creating Critical Products sheet:",u)}try{let u=B.map(p=>{let m=r(p),g=p.activeIngredients.reduce((b,S)=>{let v=s(S).rpn;return v>b.rpn?{...S,rpn:v}:b},{rpn:0,name:"N/A"});return{"Product Code":p.productCode,"Product Name":p.name,"Product Type":p.productType,"Batch Size (kg)":p.batchSizeKg,"MDD (mg)":p.mddMg,Train:m!=="N/A"?`T${m}`:"N/A","Is Critical":p.isCritical?"Yes":"No","Critical Reason":p.criticalReason||"N/A","Ingredients Count":p.activeIngredients.length,"Highest RPN Ingredient":g.name,"Highest RPN Value":g.rpn||0}}),d=XLSX.utils.json_to_sheet(u);XLSX.utils.book_append_sheet(a,d,"All Products")}catch(u){console.error("Error creating All Products sheet:",u)}try{let u=[];B.forEach(p=>{let m=r(p),g={"Product Code":p.productCode,"Product Name":p.name,"Product Type":p.productType,"Batch Size (kg)":p.batchSizeKg,"MDD (mg)":p.mddMg,Train:m!=="N/A"?`T${m}`:"N/A","Is Critical":p.isCritical?"Yes":"No","Critical Reason":p.criticalReason||"N/A","Ingredient Type":"PRODUCT","Ingredient Name":"","LTD (mg)":"","PDE (mg)":"","LD50 (mg/kg)":"",Severity:"",Occurrence:"",Detection:"",RPN:""};u.push(g),p.activeIngredients.forEach(b=>{let S=s(b);u.push({"Product Code":"","Product Name":"","Product Type":"","Batch Size (kg)":"","MDD (mg)":"",Train:"","Is Critical":"","Critical Reason":"","Ingredient Type":"INGREDIENT","Ingredient Name":b.name,"LTD (mg)":b.ltdMg||"N/A","PDE (mg)":b.pdeMg||"N/A","LD50 (mg/kg)":b.ld50||"N/A",Severity:S.severity,Occurrence:S.occurrence,Detection:S.detection,RPN:S.rpn})})});let d=XLSX.utils.json_to_sheet(u);XLSX.utils.book_append_sheet(a,d,"Product Register")}catch(u){console.error("Error creating Product Register sheet:",u)}let c=new Date().toISOString().split("T")[0];XLSX.writeFile(a,`Complete_MACO_Report_${c}.xlsx`),z(),O("Success","Complete report with all tabs exported to Excel successfully!")}).catch(n=>{console.error("Error exporting all tabs to Excel:",n),z(),O("Error","Failed to export complete report to Excel.")})}function iw(n){let e=document.getElementById(`stage-${n}`),t=e.style.display==="none";e.style.display=t?"":"none",localStorage.setItem(`machineStage-${n}-hidden`,!t);let r=e.parentElement.querySelector("button");r&&(r.textContent=t?"Hide":"Show")}var hm,Te,z,Ct,Oe=ne(()=>{Bp();al();Fe();ts();he();pl();Wt();yl();hm=document.getElementById("loader"),Te=()=>hm.style.display="flex",z=()=>hm.style.display="none";Ct=n=>document.getElementById(n).style.display="none"});var Nl={};Ge(Nl,{addIngredientFormFields:()=>mm,addNewProduct:()=>Rl,deleteIngredient:()=>uw,deleteProduct:()=>lw,handleSearchAndFilter:()=>rr,populateDynamicSelectsForElement:()=>Al,populateFilterSelects:()=>Dl,renderProducts:()=>Gi,resetFilters:()=>dw,saveIngredientChanges:()=>Pl,saveProductChanges:()=>Cl,showAddForm:()=>ow,showEditIngredientModal:()=>cw,showEditProductModal:()=>aw,sortData:()=>Sl,updateSortIndicators:()=>pm});function Gi(n){if(n==="worstCaseProducts"){Kt();return}let e=document.getElementById(n);if(!e)return;let t=e.querySelector(".productsTable"),r=e.querySelector(".noResultsMessage"),s=[...Me[n]];s.sort((o,a)=>{let c,u;switch(ue.key){case"productCode":c=o.productCode,u=a.productCode;break;case"name":c=o.name,u=a.name;break;case"batchSizeKg":c=o.batchSizeKg,u=a.batchSizeKg;break;case"date":c=new Date(o.date),u=new Date(a.date);break;default:return 0}let p=ue.direction==="asc"?1:-1;return c<u?-1*p:c>u?1*p:0}),t.innerHTML="",r.style.display=s.length>0?"none":"block",t.style.display=s.length>0?"":"none",s.forEach((o,a)=>{let c=document.createElement("tr");c.className="product-main-row";let u=o.isCritical?"Yes":"No",d=o.isCritical?"text-red-600 font-bold":"",p=qe(o),m=p!=="N/A"?"T"+p:"N/A";c.innerHTML=`
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${a+1}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${new Date(o.date).toLocaleDateString()}</td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${o.productCode}</td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">
                        <span class="product-name">${o.name}</span>
                    </td>
                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top text-center" style="color: var(--text-secondary);">${m}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${o.productType||"N/A"}</td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${o.batchSizeKg}</td>
                    <td class="px-3 py-3 text-sm align-top">
                         <span class="${d}">${u}</span>
                         ${o.isCritical&&o.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 200px; white-space: normal;">${o.criticalReason}</p>`:""}
                    </td>
                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top">
                        <div class="flex items-center gap-x-2 no-print">
                           <button onclick="showAssignMachinesModal(${o.id})" class="p-1" style="color: var(--text-secondary);" title="Assign Machines">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-wide-connected" viewBox="0 0 16 16"><path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.62 1.105l-.09.282c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.09-.282c-.268-1.135.925-1.824 1.62-1.105l.205.211a.96.96 0 0 0 1.622-.434L7.068.727zM12.973 8.5H8.25l-1.03-1.03a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l2.5-2.5a1 1 0 0 0-1.414-1.414L12.973 8.5z"/><path d="M.242 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353-.14l.17-.186c.695-.761 1.888.06 1.62 1.204l-.066.261c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066-.261c-.268-1.144.925-1.965 1.62-1.204l.17.186a.96.96 0 0 0 1.353.14l.058-.058a.626.626 0 0 1 0-.884zM15.758 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353.14l.17-.186c.695.761-.925 1.965-1.62 1.204l-.066-.261c-.273-.85-.92-1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066.261c-.268 1.144 1.888.443 1.62-1.204l.17-.186a.96.96 0 0 0 1.353-.14l.058-.058a.626.626 0 0 1 0 .884z"/></svg>
                            </button>
                             <button onclick="showEditProductModal(${o.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Product"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                            <button onclick="deleteProduct(${o.id})" class="p-1 text-red-500" title="Delete Product">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>
                            </button>
                        </div>
                    </td>
                `;let g=document.createElement("tr");g.className="ingredients-sub-row";let b=document.createElement("td");b.colSpan=9;let S=`
                    <div class="p-4 ingredients-sub-table rounded-b-lg">
                        <table class="w-full text-xs">
                            <thead class="bg-transparent">
                                <tr class="border-b" style="border-color: var(--border-color);">
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Ingredient</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">TD (mg)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">MDD (g/day)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Solubility</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Cleanability</th>
                                    <th class="pde-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">PDE (mg/day)</th>
                                    <th class="ld50-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">LD50 (mg/kg)</th>
                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-transparent">`;o.activeIngredients.forEach(v=>{S+=`
                        <tr>
                            <td class="px-3 py-2 font-semibold">${v.name}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${v.therapeuticDose}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${v.mdd/1e3}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${v.solubility}</td>
                            <td class="px-3 py-2" style="color: var(--text-secondary);">${v.cleanability}</td>
                            <td class="pde-col px-3 py-2" style="color: var(--text-secondary);">${v.pde??"N/A"}</td>
                            <td class="ld50-col px-3 py-2" style="color: var(--text-secondary);">${v.ld50??"N/A"}</td>
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-x-2 no-print">
                                    <button onclick="showEditIngredientModal(${o.id}, ${v.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                                    <button onclick="deleteIngredient(${o.id}, ${v.id})" class="p-1 text-red-500" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                                </div>
                            </td>
                        </tr>`}),S+="</tbody></table></div>",b.innerHTML=S,g.appendChild(b),t.appendChild(c),t.appendChild(g)}),pm(n),at(n),z()}function rr(n){Te();let e=document.getElementById(n);if(n==="worstCaseProducts"){let c=document.getElementById("worstCaseProductNameFilter"),u=c?c.value.toLowerCase():"";Me[n]=B.filter(d=>d.name.toLowerCase().includes(u)),Gi(n);return}let t=e.querySelector(".filterColProductCode").value.toLowerCase(),r=e.querySelector(".filterColProductName").value.toLowerCase(),s=e.querySelector(".filterColTrainNo").value,o=e.querySelector(".filterColProductType").value,a=e.querySelector(".filterColIsCritical").value;Me[n]=B.filter(c=>{let u=c.productCode.toLowerCase().includes(t),d=c.name.toLowerCase().includes(r),p=qe(c),m=p!=="N/A"?"T"+p:"N/A",g=s==="all"||m===s,b=o==="all"||c.productType===o,S=a==="all"||String(c.isCritical)===a;return u&&d&&g&&b&&S}),Gi(n)}function Sl(n,e){ue.key===n?ue.direction=ue.direction==="asc"?"desc":"asc":(ue.key=n,ue.direction=n==="rpn"?"desc":"asc"),e==="worstCaseProducts"?Kt():Gi(e)}function pm(n){let e=document.getElementById(n);!e||n==="worstCaseProducts"||e.querySelectorAll(".mainTable th.sortable").forEach(t=>{let r=t.querySelector(".sort-indicator");t.getAttribute("onclick").match(/'(.*?)'/)[1]===ue.key?r.textContent=ue.direction==="asc"?"\u25B2":"\u25BC":r.textContent=""})}function ow(){let n=document.getElementById("addProductForm");n.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="addProductCode" class="w-full px-3 py-2 border rounded-lg" required placeholder="e.g. 1ABC12345DE" pattern="[0-9]{1}[A-Z]{3}[0-9]{5}[A-Z]{2}"></div>
                                  <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" required></div>
                                  <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="addProductDate" class="w-full px-3 py-2 border rounded-lg" required></div>
                              </div>
                              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                                  <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="addBatchSize" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>
                                  <div class="md:col-span-2">
                                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Dosage Form</label>
                                            <select id="addProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="toggleOtherProductType(this, 'addOtherTypeContainer')">
                                                <option value="" disabled selected>Select a form...</option>
                                                <option value="Tablets">Tablets</option>
                                                <option value="Capsules">Capsules</option>
                                                <option value="Liquids">Liquids</option>
                                                <option value="Semisolids">Semisolids</option>
                                                <option value="Sterile Products">Sterile Products</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div id="addOtherTypeContainer" style="display: none;">
                                            <label class="block text-sm font-medium mb-1">Specify Other Form</label>
                                            <input type="text" id="addOtherProductType" class="w-full px-3 py-2 border rounded-lg">
                                        </div>
                                      </div>
                                  </div>
                              </div>
                              <div><div class="flex justify-between items-center mb-4"><h4 class="text-lg font-medium">Active Ingredients</h4><button type="button" onclick="addIngredientFormFields('ingredientsContainer')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button></div><div id="ingredientsContainer"></div></div>`,document.getElementById("ingredientsContainer").innerHTML="",Eo(0),mm("ingredientsContainer"),document.getElementById("addProductDate").value=new Date().toISOString().split("T")[0],document.getElementById("addProductModal").style.display="flex"}function mm(n,e=null){let t=!!e;Eo(_o+1);let r=document.getElementById(n),s=document.createElement("div");s.className="border rounded-lg p-4 mb-4 relative ingredient-edit-row",s.style.borderColor="var(--border-color)";let o=t||r.id==="editIngredientsContainer"||r.children.length>0?`<button type="button" onclick="this.closest('.ingredient-edit-row').remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>`:"";s.innerHTML=`
        ${o}
        <input type="hidden" name="ingredientId" value="${e?.id||""}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="md:col-span-2"><label class="block text-xs font-medium mb-1">Ingredient Name</label><input type="text" name="ingredientName" value="${e?.name||""}" class="w-full px-3 py-2 border rounded-lg text-sm" required></div>
            <div><label class="block text-xs font-medium mb-1">TD (mg)</label><input type="number" step="any" name="therapeuticDose" value="${e?.therapeuticDose||""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>
            <div><label class="block text-xs font-medium mb-1">MDD (g/day)</label><input type="number" step="any" name="mdd" value="${e?e.mdd/1e3:""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>
            <div><label class="block text-xs font-medium mb-1">Solubility</label><select name="solubility" class="w-full px-3 py-2 border rounded-lg text-sm"></select></div>
            <div><label class="block text-xs font-medium mb-1">Cleanability</label><select name="cleanability" class="w-full px-3 py-2 border rounded-lg text-sm" required></select></div>
            <div><label class="block text-xs font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" name="pde" value="${e?.pde??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>
            <div><label class="block text-xs font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" name="ld50" value="${e?.ld50??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>
        </div>`,r.appendChild(s),Al(s),e&&(s.querySelector('select[name="solubility"]').value=e.solubility,s.querySelector('select[name="cleanability"]').value=e.cleanability)}function Al(n){es(n.querySelector('select[name="solubility"], #editSolubility'),"solubility"),es(n.querySelector('select[name="cleanability"], #editCleanability'),"cleanability")}function aw(n){let e=B.find(d=>d.id===n);if(!e)return;let t=document.getElementById("editProductForm"),r=e.date?new Date(e.date).toISOString().split("T")[0]:"";t.innerHTML=`
                <input type="hidden" id="editProductId" value="${e.id}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="editProductCode" value="${e.productCode}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="editProductName" value="${e.name}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="editProductDate" value="${r}" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="editBatchSize" value="${e.batchSizeKg}" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                    <div>
                        <label class="block text-sm font-medium mb-1">Dosage Form</label>
                        <select id="editProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="toggleOtherProductType(this, 'editOtherTypeContainer')">
                            <option value="Tablets">Tablets</option>
                            <option value="Capsules">Capsules</option>
                            <option value="Liquids">Liquids</option>
                            <option value="Semisolids">Semisolids</option>
                            <option value="Sterile Products">Sterile Products</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div id="editOtherTypeContainer" style="display: none;">
                        <label class="block text-sm font-medium mb-1">Specify Other Form</label>
                        <input type="text" id="editOtherProductType" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Special Case Product</label>
                    <select id="editIsCritical" onchange="document.getElementById('editCriticalReasonContainer').style.display = this.value === 'true' ? 'block' : 'none';" class="w-full px-3 py-2 border rounded-lg">
                        <option value="false" ${e.isCritical?"":"selected"}>No</option>
                        <option value="true" ${e.isCritical?"selected":""}>Yes</option>
                    </select>
                </div>
                <div id="editCriticalReasonContainer" style="display: ${e.isCritical?"block":"none"};">
                    <label class="block text-sm font-medium mb-1">Reason for Special Case Status</label>
                    <textarea id="editCriticalReason" class="w-full px-3 py-2 border rounded-lg" placeholder="Enter reason...">${e.criticalReason||""}</textarea>
                </div>
                <div class="border-t pt-4 mt-4" style="border-color:var(--border-color);">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium">Add New Ingredients</h4>
                        <button type="button" onclick="addIngredientFormFields('editIngredientsContainer')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button>
                    </div>
                    <div id="editIngredientsContainer" class="space-y-4"></div>
                </div>
            `;let s=t.querySelector("#editIngredientsContainer");s.innerHTML="";let o=t.querySelector("#editProductType"),a=t.querySelector("#editOtherProductType"),c=t.querySelector("#editOtherTypeContainer");Array.from(o.options).map(d=>d.value).includes(e.productType)?(o.value=e.productType,c.style.display="none",a.required=!1):(o.value="Other",a.value=e.productType||"",c.style.display="block",a.required=!0),document.getElementById("editProductModalTitle").textContent=`Edit Product: ${e.name}`,document.getElementById("editProductModal").style.display="flex"}function Cl(n){n.preventDefault();let e=parseInt(document.getElementById("editProductId").value),t=B.find(u=>u.id===e);if(!t){O("Error","Could not find product to update.");return}let r=document.getElementById("editProductType").value;if(r==="Other"){let u=document.getElementById("editOtherProductType").value.trim();if(!u){O("Validation Error","Please specify the 'Other' dosage form.");return}r=u}if(t.productCode=document.getElementById("editProductCode").value,t.name=document.getElementById("editProductName").value,t.date=new Date(document.getElementById("editProductDate").value).toISOString(),t.batchSizeKg=parseFloat(document.getElementById("editBatchSize").value),t.productType=r,t.isCritical=document.getElementById("editIsCritical").value==="true",t.criticalReason=t.isCritical?document.getElementById("editCriticalReason").value:"",B.find(u=>u.id!==e&&u.productCode.toLowerCase()===t.productCode.toLowerCase())){O("Validation Error",`Product code "${t.productCode}" already exists. Please use a unique product code.`);return}let o=[],a=document.querySelectorAll("#editIngredientsContainer .ingredient-edit-row"),c=!0;if(a.forEach(u=>{if(!c)return;let d={id:tn};d.name=u.querySelector('[name="ingredientName"]').value.trim(),d.therapeuticDose=parseFloat(u.querySelector('[name="therapeuticDose"]').value),d.mdd=parseFloat(u.querySelector('[name="mdd"]').value)*1e3,d.solubility=u.querySelector('[name="solubility"]').value,d.cleanability=u.querySelector('[name="cleanability"]').value;let p=u.querySelector('[name="pde"]').value,m=u.querySelector('[name="ld50"]').value;d.pde=p?parseFloat(p):null,d.ld50=m?parseFloat(m):null,!d.name||isNaN(d.therapeuticDose)||isNaN(d.mdd)||!d.solubility||!d.cleanability||d.pde===null&&d.ld50===null?c=!1:(o.push(d),Tn(tn+1))}),!c){O("Validation Error","Please fill all required fields for each newly added ingredient."),nextIngredientId-=o.length;return}t.activeIngredients.push(...o),Le(),De(),Ct("editProductModal"),O("Success","Product updated successfully.")}function cw(n,e){let r=B.find(o=>o.id===n)?.activeIngredients.find(o=>o.id===e);if(!r){O("Error","Could not find ingredient to edit.");return}let s=document.getElementById("editIngredientForm");s.innerHTML=`<input type="hidden" id="editIngredientProductId" value="${n}"><input type="hidden" id="editIngredientId" value="${e}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Ingredient Name</label><input type="text" id="editIngredientName" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">TD (mg)</label><input type="number" step="any" id="editTherapeuticDose" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">MDD (g/day)</label><input type="number" step="any" id="editMdd" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">Solubility</label><select id="editSolubility" class="w-full px-3 py-2 border rounded-lg"></select></div><div><label class="block text-sm font-medium mb-1">Cleanability</label><select id="editCleanability" class="w-full px-3 py-2 border rounded-lg" required></select></div><div><label class="block text-sm font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" id="editPde" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div><div><label class="block text-sm font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" id="editLd50" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div></div>`,document.getElementById("editIngredientModalTitle").textContent=`Edit: ${r.name}`,document.getElementById("editIngredientName").value=r.name,document.getElementById("editTherapeuticDose").value=r.therapeuticDose,document.getElementById("editMdd").value=r.mdd/1e3,document.getElementById("editPde").value=r.pde??"",document.getElementById("editLd50").value=r.ld50??"",Al(s),document.getElementById("editSolubility").value=r.solubility,document.getElementById("editCleanability").value=r.cleanability,document.getElementById("editIngredientModal").style.display="flex"}function Pl(n){n.preventDefault();let e=parseInt(document.getElementById("editIngredientProductId").value),t=parseInt(document.getElementById("editIngredientId").value),s=B.find(c=>c.id===e)?.activeIngredients.find(c=>c.id===t);if(!s){O("Error","Save failed. Could not find original ingredient.");return}let o=document.getElementById("editPde").value,a=document.getElementById("editLd50").value;if(s.name=document.getElementById("editIngredientName").value.trim(),s.therapeuticDose=parseFloat(document.getElementById("editTherapeuticDose").value),s.mdd=parseFloat(document.getElementById("editMdd").value)*1e3,s.solubility=document.getElementById("editSolubility").value,s.cleanability=document.getElementById("editCleanability").value,s.pde=o?parseFloat(o):null,s.ld50=a?parseFloat(a):null,!s.name||isNaN(s.therapeuticDose)||isNaN(s.mdd)||!s.solubility||!s.cleanability||s.pde===null&&s.ld50===null){O("Validation Error","Please fill all required fields.");return}Le(),Ct("editIngredientModal"),De(),O("Success",`${s.name} was updated successfully.`)}function lw(n){if(confirm("Are you sure you want to delete this entire product?")){let e=B.filter(t=>t.id!==n);dt(e),Le(),De()}}function uw(n,e){let t=B.find(r=>r.id===n);if(t){if(t.activeIngredients.length===1){O("Cannot Remove","A product must have at least one ingredient. To remove this, please delete the entire product.");return}confirm("Are you sure you want to remove this ingredient?")&&(t.activeIngredients=t.activeIngredients.filter(r=>r.id!==e),Le(),De())}}function Dl(){let n=[...new Set(B.map(t=>t.productType))].sort();es(document.querySelector(".filterColProductType"),null,!0,n);let e=document.querySelector(".filterColTrainNo");if(e){let t=[...new Set(B.map(r=>qe(r)).filter(r=>r!=="N/A"))].sort((r,s)=>r-s);e.innerHTML='<option value="all">All</option>',t.forEach(r=>{e.innerHTML+=`<option value="T${r}">T${r}</option>`})}}function dw(n){let e=document.getElementById(n);e.querySelectorAll('.filter-row input[type="text"], .filter-row input[type="number"]').forEach(t=>t.value=""),e.querySelectorAll(".filter-row select").forEach(t=>t.value="all"),ue.key="rpn",ue.direction="desc",rr(n)}function Rl(n){n.preventDefault();let e=document.getElementById("addProductCode").value.trim(),t=document.getElementById("addProductName").value.trim(),r=parseFloat(document.getElementById("addBatchSize").value),s=new Date(document.getElementById("addProductDate").value).toISOString(),o=document.getElementById("addProductType").value;if(o==="Other"){let g=document.getElementById("addOtherProductType").value.trim();if(!g){O("Validation Error","Please specify the 'Other' dosage form or choose a different option.");return}o=g}if(!e||!t||!s||isNaN(r)||r<=0||!o){O("Validation Error","Please fill all required product fields, including Dosage Form.");return}if(B.find(g=>g.productCode.toLowerCase()===e.toLowerCase())){O("Validation Error",`Product code "${e}" already exists. Please use a unique product code.`);return}let c=document.querySelectorAll("#ingredientsContainer > div"),u=[],d=!0;if(c.forEach(g=>{if(!d)return;let b={id:tn};br(tn+1),b.name=g.querySelector('[name="ingredientName"]').value.trim(),b.therapeuticDose=parseFloat(g.querySelector('[name="therapeuticDose"]').value),b.mdd=parseFloat(g.querySelector('[name="mdd"]').value)*1e3,b.solubility=g.querySelector('[name="solubility"]').value,b.cleanability=g.querySelector('[name="cleanability"]').value;let S=g.querySelector('[name="pde"]').value,v=g.querySelector('[name="ld50"]').value;b.pde=S?parseFloat(S):null,b.ld50=v?parseFloat(v):null,!b.name||isNaN(b.therapeuticDose)||isNaN(b.mdd)||!b.solubility||!b.cleanability||b.pde===null&&b.ld50===null?d=!1:u.push(b)}),!d){O("Validation Error","Please fill all required fields for each ingredient."),br(tn-u.length);return}let p={id:As,productCode:e,name:t,batchSizeKg:r,date:s,productType:o,machineIds:[],activeIngredients:u,isCritical:!1,criticalReason:""};Ps(As+1);let m=[...B,p];dt(m),Le(),De(),Ct("addProductModal")}var fm=ne(()=>{Fe();ts();Oe();he();Wt()});var _n={};Ge(_n,{deleteMachine:()=>fw,exportMachineProductsToExcel:()=>gm,printMachineProducts:()=>ym,renderMachinesTable:()=>us,saveMachine:()=>kl,showMachineModal:()=>mw,showMachineProductsModal:()=>gw,sortMachines:()=>hw});function hw(n){Ue.key===n?Ue.direction=Ue.direction==="asc"?"desc":"asc":(Ue.key=n,Ue.direction="asc"),$u(Ue),us()}function pw(){let n=document.getElementById("machineManagement");n&&n.querySelectorAll(".card th.sortable").forEach(e=>{let t=e.querySelector(".sort-indicator");e.getAttribute("onclick").match(/'(.*?)'/)[1]===Ue.key?t.textContent=Ue.direction==="asc"?"\u25B2":"\u25BC":t.textContent=""})}function us(){let n=document.getElementById("machinesContainer"),e=document.getElementById("noMachinesMessage");if(n.innerHTML="",Q.length===0){e.style.display="block";return}e.style.display="none";let t={};ke.forEach(s=>{s!=="Other"&&(t[s]=[])});let r=[];Q.forEach(s=>{ke.includes(s.stage)?s.stage!=="Other"&&t[s.stage].push(s):(t[s.stage]||(t[s.stage]=[],r.push(s.stage)),t[s.stage].push(s))}),Object.keys(t).forEach(s=>{let o=s.toLowerCase().replace(/\s+/g,""),a=localStorage.getItem(`machineStage-${o}-hidden`)==="true",c=t[s];if(c.length===0)return;let u=[...c].sort((m,g)=>{let b=Ue.key,S=Ue.direction==="asc"?1:-1,v,C;return b==="area"?(v=m.area,C=g.area):(v=String(m[b]||"").toLowerCase(),C=String(g[b]||"").toLowerCase()),v<C?-1*S:v>C?1*S:0}),d=document.createElement("div");d.className="card p-6";let p=`
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">${s} Machines (${c.length})</h3>
                <button onclick="toggleStageSection('${o}')" class="text-sm px-3 py-1 rounded border" style="border-color: var(--border-color); color: var(--text-secondary);">
                    ${a?"Show":"Hide"}
                </button>
            </div>
            <div id="stage-${o}" ${a?'style="display: none;"':""}>
                <div class="overflow-x-auto overflow-hidden rounded-md border" style="border-color: var(--border-color);">
                    <table class="w-full text-sm">
                        <thead class="border-b" style="border-color: var(--border-color);">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('machineNumber')">Number <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('name')">Name <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('group')">Group <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('area')">Area (cm\xB2) <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('cleaningSOP')">Cleaning SOP <span class="sort-indicator"></span></th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Products</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y" style="border-color: var(--border-color);">`;u.forEach(m=>{let g=B.filter(D=>D.machineIds&&D.machineIds.includes(m.id)),b=g.length,S='<div class="flex items-center gap-x-2">';b>0?S+=`
                    <span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color: var(--bg-accent); color: var(--text-primary);">${b}</span>
                    <button onclick="showMachineProductsModal(${m.id})" class="p-1" style="color: var(--text-secondary);" title="View ${b} Product(s)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                    </button>`:S+='<span class="text-xs" style="color: var(--text-secondary);">None</span>',S+=`</div>
                <div class="only-print text-xs" style="display: none; white-space: normal; word-break: break-word;">
                    ${g.map(D=>D.name).join(", ")||"None"}
                </div>`;let v=m.group?"machine-group-cell grouped":"machine-group-cell individual",C=m.group||'<span style="color: var(--text-secondary); font-style: italic;">Individual</span>';p+=`
                <tr>
                    <td class="px-4 py-3 whitespace-nowrap">${m.machineNumber}</td>
                    <td class="px-4 py-3 font-medium">${m.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${v}">${C}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${m.area.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${m.cleaningSOP||""}</td>
                    <td class="px-4 py-3">${S}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center gap-x-2 no-print">
                            <button onclick="showAddProductsToMachineModal(${m.id})" class="p-1 text-blue-500" title="Assign Products to this Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                            <button onclick="showMachineModal(${m.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                            <button onclick="deleteMachine(${m.id})" class="p-1 text-red-500" title="Delete Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg></button>
                        </div>
                    </td>
                </tr>`}),p+="</tbody></table></div></div>",d.innerHTML=p,n.appendChild(d)}),pw()}function mw(n=null){document.getElementById("machineForm").reset();let t=document.getElementById("machineModalTitle"),r=document.getElementById("machineId"),s=document.getElementById("machineNumber"),o=document.getElementById("machineName"),a=document.getElementById("machineArea"),c=document.getElementById("cleaningSOP"),u=document.getElementById("machineStage"),d=document.getElementById("machineGroup");if(u.innerHTML='<option value="" disabled selected>Select a Stage</option>',ke.forEach(p=>{let m=p==="Other"?"Other (Add New Stage)":p;u.innerHTML+=`<option value="${p}">${m}</option>`}),d.innerHTML='<option value="">No Group (Individual Machine)</option>',xn.forEach(p=>{d.innerHTML+=`<option value="${p}">${p}</option>`}),d.innerHTML+='<option value="Other">Other (Create New Group)</option>',n){let p=Q.find(m=>m.id===n);if(p){t.textContent="Edit Machine",r.value=p.id,s.value=p.machineNumber,o.value=p.name,a.value=p.area,c.value=p.cleaningSOP||"";let m=document.getElementById("otherStageContainer"),g=document.getElementById("otherMachineStage");ke.filter(v=>v!=="Other").includes(p.stage)?(u.value=p.stage,m.style.display="none",g.required=!1):(u.value="Other",g.value=p.stage,m.style.display="block",g.required=!0);let b=document.getElementById("otherGroupContainer"),S=document.getElementById("otherMachineGroup");!p.group||p.group===""?(d.value="",b.style.display="none",S.required=!1):xn.includes(p.group)?(d.value=p.group,b.style.display="none",S.required=!1):(d.value="Other",S.value=p.group,b.style.display="block",S.required=!0)}}else t.textContent="Add Machine",r.value="",document.getElementById("otherStageContainer").style.display="none",document.getElementById("otherMachineStage").required=!1,document.getElementById("otherGroupContainer").style.display="none",document.getElementById("otherMachineGroup").required=!1;document.getElementById("machineModal").style.display="flex"}function kl(n){n.preventDefault();let e=document.getElementById("machineId").value,t=document.getElementById("machineNumber").value.trim(),r=document.getElementById("machineName").value.trim(),s=document.getElementById("machineStage").value,o=parseInt(document.getElementById("machineArea").value,10),a=document.getElementById("cleaningSOP").value.trim(),c=document.getElementById("machineGroup").value;if(s==="Other"){let d=document.getElementById("otherMachineStage").value.trim();if(!d){O("Validation Error","Please specify the new stage name.");return}if(s=d,!ke.includes(s)){let p=ke.indexOf("Other");p>-1?ke.splice(p,0,s):ke.push(s),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(ke))}}if(c==="Other"){let d=document.getElementById("otherMachineGroup").value.trim();if(!d){O("Validation Error","Please specify the new group name.");return}c=d,xn.includes(c)||(xn.push(c),localStorage.setItem("machineGroups",JSON.stringify(xn)))}if(c&&c!==""){let d=Q.filter(p=>p.group===c&&(!e||p.id!==parseInt(e)));if(d.length>0){let p=[...new Set(d.map(m=>m.stage))];if(p.length>0&&!p.includes(s)){let m=p.join(", ");O("Group Stage Mismatch",`Cannot assign this machine to group "${c}". All machines in a group must belong to the same stage.

Current group stage(s): ${m}
New machine stage: ${s}

Please either:
\u2022 Change the machine's stage to match the group
\u2022 Choose a different group
\u2022 Create a new group for this stage`);return}}}if(!t||!r||!s||isNaN(o)||!a){O("Error","All fields are required.");return}if(Q.some(d=>{let p=e?parseInt(e,10):null;return d.id!==p&&d.machineNumber.toLowerCase()===t.toLowerCase()})){O("Validation Error","A machine with this number already exists.");return}if(e){let d=Q.find(p=>p.id===parseInt(e));d&&(d.machineNumber=t,d.name=r,d.stage=s,d.area=o,d.cleaningSOP=a,d.group=c||"")}else Ds(Cs+1),Q.push({id:Cs,machineNumber:t,name:r,stage:s,area:o,cleaningSOP:a,group:c||""});Le(),De(),Ct("machineModal")}function fw(n){if(confirm("Are you sure you want to delete this machine? It will be removed from all products that use it.")){let e=Q.filter(t=>t.id!==n);Ot(e),B.forEach(t=>{t.machineIds&&(t.machineIds=t.machineIds.filter(r=>r!==n))}),Le(),De()}}function gw(n){let e=Q.find(o=>o.id===n);if(!e)return;ls=e;let t=document.getElementById("machineProductsModalTitle"),r=document.getElementById("machineProductsList");t.textContent=`Products on: ${e.name} (${e.machineNumber})`;let s=B.filter(o=>o.machineIds&&o.machineIds.includes(n));if(s.length>0){let o='<div class="divide-y" style="border-color: var(--border-color);">';s.forEach((a,c)=>{let u=qe(a),d=u!=="N/A"?"T"+u:"N/A",p=a.isCritical?"Yes":"No",m=a.isCritical?"text-red-600 font-bold":"",g=new Date(a.date).toLocaleDateString(),b=xt(),S=0,v="N/A";a.activeIngredients.forEach(D=>{let k=Pe(D,b);k.rpn>S&&(S=k.rpn,v=k.rpnRatingText)});let C=Tt(v);o+=`
                        <div class="py-3 px-2">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-lg">${a.name}</h4>
                                <span class="text-xs px-2 py-1 rounded" style="background-color: var(--bg-accent); color: var(--text-secondary);">${a.productCode}</span>
                            </div>
                            <div class="text-xs flex flex-wrap gap-4">
                                <span ><strong>Highest RPN:</strong> <span class="${C}" style="font-weight: bold;">${S.toFixed(1)}</span></span>
                                <span><strong>Special Case Product:</strong> <span class="${m}">${p}</span></span>
                                ${a.isCritical&&a.criticalReason?`<span class="text-xs italic" style="color: var(--text-secondary);">Reason: ${a.criticalReason}</span>`:""}
                            </div>
                        </div>
                    `}),o+="</div>",r.innerHTML=o}else r.innerHTML='<p style="color:var(--text-secondary);">No products are currently assigned to this machine.</p>';document.getElementById("machineProductsModal").style.display="flex"}function gm(){if(!ls){console.error("No machine data available for export");return}let n=ls,e=B.filter(p=>p.machineIds&&p.machineIds.includes(n.id));if(e.length===0){alert("No products to export for this machine.");return}let t=xt(),r=e.map(p=>{let m=p.isCritical?"Yes":"No",g=0;return p.activeIngredients.forEach(b=>{let S=Pe(b,t);S.rpn>g&&(g=S.rpn)}),{"Product Name":p.name,"Highest RPN":g.toFixed(1),"Special Case Product":m}}),s=XLSX.utils.json_to_sheet(r),o=XLSX.utils.book_new(),a=`${n.name} Products`;XLSX.utils.book_append_sheet(o,s,a);let c=Object.keys(r[0]||{}).map(p=>({wch:Math.max(p.length,...r.map(m=>String(m[p]||"").length))+2}));s["!cols"]=c;let u=new Date().toISOString().slice(0,19).replace(/[:\-T]/g,""),d=`Machine_${n.machineNumber}_Products_${u}.xlsx`;XLSX.writeFile(o,d)}function ym(){if(!ls){alert("No machine selected for printing");return}try{let n=ls,e=B.filter(o=>o.machineIds&&o.machineIds.includes(n.id));if(!e||e.length===0){alert("No products found for this machine");return}let t=`
            <html>
            <head>
                <title>Machine Products Report</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px;
                        font-size: 12px;
                    }
                    h1 { 
                        color: #333; 
                        border-bottom: 2px solid #ddd; 
                        padding-bottom: 10px;
                    }
                    .info-table {
                        border-collapse: collapse;
                        width: 100%;
                        margin-bottom: 20px;
                    }
                    .info-table th, .info-table td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: left;
                    }
                    .info-table th {
                        background-color: #f5f5f5;
                        font-weight: bold;
                    }
                    @media print {
                        body { margin: 0; }
                        h1 { page-break-after: avoid; }
                    }
                </style>
            </head>
            <body>
                <h1>Machine Products Report</h1>
                
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Highest RPN</th>
                            <th>Special Case</th>
                        </tr>
                    </thead>
                    <tbody>
        `;e.forEach(o=>{let a=o.isCritical?"Yes":"No",c=xt(),u=0;o.activeIngredients.forEach(d=>{let p=Pe(d,c);p.rpn>u&&(u=p.rpn)}),t+=`
                <tr>
                    <td>${o.name}</td>
                    <td>${u.toFixed(1)}</td>
                    <td>${a}</td>
                </tr>
            `}),t+=`
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; font-size: 10px; color: #666;">
                    Generated on: ${new Date().toLocaleString()}
                </div>
            </body>
            </html>
        `;let r=document.createElement("iframe");r.style.position="absolute",r.style.left="-9999px",r.style.width="0px",r.style.height="0px",document.body.appendChild(r);let s=r.contentWindow.document;s.write(t),s.close(),r.contentWindow.focus(),r.contentWindow.print(),setTimeout(()=>{document.body.removeChild(r)},1e3)}catch(n){console.error("Error printing machine products:",n),alert("Failed to generate print report. Please try again.")}}var ls,wm=ne(()=>{Fe();ts();Oe();he();ls=null;window.exportMachineProductsToExcel=gm;window.printMachineProducts=ym});var Ml={};Ge(Ml,{renderSummaryReport:()=>Hi});function Hi(){let n=document.getElementById("topRpnTableBody"),e=document.getElementById("criticalProductsTableBody"),t=document.getElementById("topRpnTableContainer"),r=document.getElementById("criticalProductsTableContainer"),s=document.getElementById("noTopRpnMessage"),o=document.getElementById("noCriticalMessage");n.innerHTML="",e.innerHTML="";let a=B.flatMap(u=>{let d=qe(u);return u.activeIngredients.map(p=>({productName:u.name,ingredientName:p.name,rpn:Pe(p).rpn,trainId:d!=="N/A"?`T${d}`:""}))}).sort((u,d)=>d.rpn-u.rpn).slice(0,10);a.length>0?(s.style.display="none",t.style.display="block",a.forEach((u,d)=>{let p=n.insertRow();p.innerHTML=`<td class="px-4 py-3">${d+1}</td><td class="px-4 py-3">${u.productName}</td><td class="px-4 py-3">${u.trainId||"N/A"}</td><td class="px-4 py-3">${u.ingredientName}</td><td class="px-4 py-3 font-bold" style="color: var(--gradient-mid);">${u.rpn}</td>`})):(s.style.display="block",t.style.display="none");let c=B.filter(u=>u.isCritical);c.length>0?(o.style.display="none",r.style.display="block",c.forEach(u=>{let d=e.insertRow();d.innerHTML=`<td class="px-4 py-3">${u.name}</td><td class="px-4 py-3" style="white-space: pre-wrap; word-break: break-word;">${u.criticalReason||"No reason provided"}</td>`})):(o.style.display="block",r.style.display="none")}var _m=ne(()=>{Fe();he()});function bm(){document.querySelectorAll("#maco-product-trains-container .train-container").forEach(e=>{if(e.querySelector(".print-train-btn"))return;let t=e.id,r=document.createElement("button");r.textContent="Print Train",r.className="btn print-train-btn",r.style.margin="10px",r.onclick=()=>vm(t);let s=e.querySelector(".train-details");s&&s.appendChild(r)})}function vm(n){if(!document.getElementById(n)){console.error("Could not find train content to print:",n);return}document.body.classList.add("printing-maco-train"),setTimeout(()=>{window.print()},100)}function De(){try{Zr(),rr("productRegister"),ns("worstCaseProducts"),us(),Mi(),ss(),bm(),wn(),is(),Hi(),Ri(),Dl()}catch(n){console.error("Error during full application render:",n),z()}}function yw(n,e){qu(n),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active-tab-content")),document.getElementById(n).classList.add("active-tab-content"),document.querySelectorAll(".tab-button").forEach(t=>t.classList.remove("active-tab")),e.classList.add("active-tab"),n==="dashboard"&&Mi(),n==="summaryReport"&&Hi(),n==="trainSummary"&&qi(),n==="machineManagement"&&us(),n==="macoForTrains"&&(ss(),bm()),n==="detergentMaco"&&wn(),(n==="productRegister"||n==="worstCaseProducts")&&rr(n)}function ww(){Te();try{let n=localStorage.getItem("orgId")||prompt("Enter your organization ID:"),e=localStorage.getItem("userId")||prompt("Enter your user ID:");n||(n="defaultOrg"),e||(e="defaultUser"),localStorage.setItem("orgId",n),localStorage.setItem("userId",e),window.orgId=n,window.userId=e,localStorage.getItem("theme")==="dark"?cs(!0):cs(!1),as(n).then(()=>{if(B.length>0){Ps(Math.max(0,...B.map(r=>r.id))+1);let t=B.flatMap(r=>r.activeIngredients.map(s=>s.id));br(t.length>0?Math.max(0,...t)+1:1)}Q.length>0&&Ds(Math.max(0,...Q.map(t=>t.id))+1),ce.length>0&&Tn(Math.max(0,...ce.map(t=>t.id))+1),B.forEach(t=>{t.isCritical===void 0&&(t.isCritical=!1)}),Le(),De(),at("productRegister"),ot(!1)}).finally(()=>{z()})}catch(n){console.error("Error during application initialization:",n),z()}}var ts=ne(()=>{Fe();Oe();he();fm();wm();Wt();_l();Bi();yl();_m();El();pl();Oe();document.addEventListener("DOMContentLoaded",function(){window.changeTab=yw,window.printTrain=vm,window.saveAllDataToFirestore=Il,window.loadAllDataFromFirestore=as,window.handleSearchAndFilter=function(a){a==="worstCaseProducts"?ns(a):rr(a)},window.sortData=function(a,c){c==="worstCaseProducts"?ki(a,c):Sl(a,c)};let{printReport:n,...e}=Oi,{handleSearchAndFilter:t,...r}=Nl,{handleSearchAndFilter:s,...o}=nr;Object.assign(window,At,je,r,_n,o,e,os,gl,Ml,Ui,hl),document.getElementById("theme-toggle").addEventListener("click",()=>{let a=document.documentElement.classList.contains("dark");cs(!a),localStorage.setItem("theme",a?"light":"dark")}),window.addEventListener("beforeprint",()=>{window.printingView=null,document.body.classList.contains("printing-worstCaseProducts")?window.printingView="worstCaseProducts":document.body.classList.contains("printing-macoForTrains")?window.printingView="macoForTrains":document.body.classList.contains("printing-trainSummary")&&(window.printingView="trainSummary")}),window.addEventListener("afterprint",()=>{let a=document.body.classList.contains("printing-worstCaseProducts"),c=document.body.classList.contains("printing-macoForTrains"),u=document.body.classList.contains("printing-trainSummary");document.body.className=document.body.className.replace(/printing-[\w-]+/g,""),bo&&(ot(!0),Ns(!1)),(a||c||u)&&(Te(),window.printSelectedTrain=null,a?Kt():c?ss():u&&qi()),window.printingView=null}),window.addEventListener("focus",()=>{window.printingView&&!document.body.className.includes("printing-")&&setTimeout(()=>{window.printingView&&!document.body.className.includes("printing-")&&(z(),window.printSelectedTrain=null,window.printingView=null)},500)}),document.addEventListener("keydown",function(a){a.ctrlKey&&a.key==="z"&&(a.preventDefault(),xl()),a.ctrlKey&&a.key==="y"&&(a.preventDefault(),Tl())}),document.addEventListener("input",function(a){a.target.matches(".filterColProductCode, .filterColProductName")&&handleSearchAndFilter("productRegister"),a.target.matches("#worstCaseProductNameFilter")&&ml()}),document.addEventListener("change",function(a){a.target.matches(".filterColTrainNo, .filterColProductType, .filterColIsCritical")&&handleSearchAndFilter("productRegister")}),document.getElementById("addProductForm").addEventListener("submit",Rl),document.getElementById("editProductForm").addEventListener("submit",Cl),document.getElementById("editIngredientForm").addEventListener("submit",Pl),document.getElementById("machineForm").addEventListener("submit",kl),document.getElementById("assignMachinesForm").addEventListener("submit",void 0),document.getElementById("addProductsToMachineForm").addEventListener("submit",void 0),document.getElementById("customAlertButton").onclick=()=>Ct("customAlertModal"),document.getElementById("editScoringBtn").addEventListener("click",()=>ot(!ct)),ww()})});ts();})();
/*! Bundled license information:

@firebase/util/dist/index.esm.js:
  (**
   * @license
   * Copyright 2017 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2022 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2025 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2021 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2019 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2020 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@firebase/component/dist/esm/index.esm.js:
  (**
   * @license
   * Copyright 2019 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@firebase/logger/dist/esm/index.esm.js:
  (**
   * @license
   * Copyright 2017 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@firebase/app/dist/esm/index.esm.js:
  (**
   * @license
   * Copyright 2019 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2021 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

firebase/app/dist/esm/index.esm.js:
  (**
   * @license
   * Copyright 2020 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@firebase/webchannel-wrapper/dist/bloom-blob/esm/bloom_blob_es2018.js:
  (** @license
  Copyright The Closure Library Authors.
  SPDX-License-Identifier: Apache-2.0
  *)
  (** @license
  
   Copyright The Closure Library Authors.
   SPDX-License-Identifier: Apache-2.0
  *)

@firebase/webchannel-wrapper/dist/webchannel-blob/esm/webchannel_blob_es2018.js:
  (** @license
  Copyright The Closure Library Authors.
  SPDX-License-Identifier: Apache-2.0
  *)
  (** @license
  
   Copyright The Closure Library Authors.
   SPDX-License-Identifier: Apache-2.0
  *)

@firebase/firestore/dist/index.esm.js:
  (**
  * @license
  * Copyright 2020 Google LLC
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *   http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *)
  (**
   * @license
   * Copyright 2017 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2020 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2025 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2021 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2018 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2022 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2019 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
  (**
   * @license
   * Copyright 2021 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law | agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES | CONDITIONS OF ANY KIND, either express | implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
*/
