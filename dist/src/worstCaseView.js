import*as e from"./state.js";import{hideLoader as t,updateToggleIcons as n,showCustomAlert as r}from"./ui.js";import{getProductTrainId as o,calculateScores as a,getRpnRatingClass as s,getToxicityPreference as c,getTrainsGroupedByLine as i}from"./utils.js";export function handleSearchAndFilter(t,n=null){if("worstCaseProducts"!==t)return;const r=document.getElementById("worstCaseProductNameFilter"),o=r?r.value.toLowerCase():"";e.viewProducts[t]=e.products.filter(e=>{const t=e.name.toLowerCase().includes(o),r=!n||e.line===n;return t&&r}),renderWorstCaseByTrain(!0,n)}export function handleWorstCaseProductFilter(){handleSearchAndFilter("worstCaseProducts")}export function sortData(t,n){"worstCaseProducts"===n&&(e.sortState.key===t?e.sortState.direction="asc"===e.sortState.direction?"desc":"asc":(e.sortState.key=t,e.sortState.direction="rpn"===t?"desc":"asc"),renderWorstCaseByTrain(!1))}export function updateSortIndicators(t){const n=document.getElementById(t);n&&n.querySelectorAll(".mainTable th.sortable").forEach(t=>{const n=t.querySelector(".sort-indicator"),r=t.dataset.key;n.textContent="",r===e.sortState.key&&(n.textContent="asc"===e.sortState.direction?"▲":"▼")})}export function renderWorstCaseByTrain(r=!0,o=null){const s=document.getElementById("worstCaseTrainsContainer"),l=document.getElementById("noWorstCaseMessage");s.innerHTML="",e.viewProducts.worstCaseProducts||(e.viewProducts.worstCaseProducts=[...e.products]);if(0===[...e.viewProducts.worstCaseProducts].length)return l.style.display="block",void(s.style.display="none");let p=i();if(o&&(p=p.filter(e=>e.line===o)),!p||0===p.length)return l.style.display="block",void(s.style.display="none");l.style.display="none",s.style.display="block",p.forEach(t=>{const n=document.createElement("div");n.className="card p-4 mb-4",n.innerHTML=`<h3 class="text-lg font-bold">${t.line}</h3>`,s.appendChild(n);const o={};t.trains.forEach(e=>{o[e.dosageForm]||(o[e.dosageForm]=[]),o[e.dosageForm].push(e)}),Object.keys(o).forEach(n=>{const i=document.createElement("div");i.className="pl-4 mb-3",i.innerHTML=`<h4 class="text-md font-semibold">${n}</h4>`,s.appendChild(i),o[n].forEach(n=>{if(window.printSelectedTrain&&"all"!==window.printSelectedTrain)if(Array.isArray(window.printSelectedTrain)){if(!window.printSelectedTrain.includes(String(n.number)))return}else if(String(n.number)!==String(window.printSelectedTrain))return;const o=!(document.body.classList.contains("printing-worstCaseProducts")||!r);n.products.forEach(e=>{const t=c(),n=e.activeIngredients.map(e=>a(e,t).rpn);e.sortValue=n.length>0?Math.max(...n):0}),n.products.sort((t,n)=>{const r=e.sortState.key,o="asc"===e.sortState.direction?1:-1;let a,s;switch(r){case"productCode":a=t.productCode,s=n.productCode;break;case"name":a=t.name,s=n.name;break;default:a=t.sortValue,s=n.sortValue}return a<s?-1*o:a>s?1*o:0});const i=document.createElement("div");i.className="train-card mb-3";let d=`\n                    <div class="train-header" onclick="toggleTrain('wc-${t.line}-${n.number}')">\n                        <span>Train ${n.number} - ${n.dosageForm}</span>\n                        <button class="train-toggle" id="toggle-wc-${t.line}-${n.number}">${o?"▶":"▼"}</button>\n                    </div>\n                    <div class="train-content ${o?"collapsed":""}" id="content-wc-${t.line}-${n.number}">\n                        <div class="train-content-inner">\n                            <table class="w-full text-sm mainTable">\n                                <thead style="background: var(--bg-accent);">\n                                    <tr>\n                                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable" data-key="productCode">Code <span class="sort-indicator"></span></th>\n                                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider sortable" data-key="name">Product Name <span class="sort-indicator"></span></th>\n                                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Highest RPN</th>\n                                        <th class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider">Special Case</th>\n                                    </tr>\n                                </thead>\n                                <tbody class="divide-y" style="border-color: var(--border-color);">\n                `;n.products.forEach(e=>{const t=e.isCritical?"Yes":"No",n=e.isCritical?"text-red-600 font-bold":"";d+=`\n                        <tr class="product-main-row">\n                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${e.productCode}</td>\n                            <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">\n                                <span class="product-name">${e.name}</span>\n                                <p class="text-xs italic" style="color: var(--text-secondary);">${e.productType||"N/A"}</p>\n                            </td>\n                            <td class="px-3 py-3 text-sm font-bold whitespace-nowrap align-top" style="color: var(--gradient-mid);">${e.sortValue}</td>\n                            <td class="px-3 py-3 text-sm align-top">\n                                <span class="${n}">${t}</span>\n                                ${e.isCritical&&e.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 150px; white-space: normal;">${e.criticalReason}</p>`:""}\n                            </td>\n                        </tr>`}),d+="</tbody></table></div></div>",i.innerHTML=d,s.appendChild(i);i.querySelectorAll("th.sortable[data-key]").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation();sortData(this.getAttribute("data-key"),"worstCaseProducts")})})})})}),n("worstCaseProducts"),updateSortIndicators("worstCaseProducts"),t(),d()}export function renderRpnChart(){const t=document.getElementById("rpnChartCanvas"),n=document.getElementById("rpnChartPlaceholder"),r={low:{bg:"rgba(74, 222, 128, 0.6)",border:"rgba(34, 197, 94, 1)"},medium:{bg:"rgba(250, 204, 21, 0.6)",border:"rgba(234, 179, 8, 1)"},high:{bg:"rgba(239, 68, 68, 0.6)",border:"rgba(220, 38, 38, 1)"},default:{bg:"rgba(156, 163, 175, 0.6)",border:"rgba(107, 114, 128, 1)"}};e.viewProducts.worstCaseProducts||(e.viewProducts.worstCaseProducts=[...e.products]);const s=e.viewProducts.worstCaseProducts||[],i=c(),d=s.flatMap(e=>e.activeIngredients.map(t=>{const n=a(t,i),r=o(e);return{productName:e.name,ingredientName:t.name,rpn:n.rpn,ratingKey:n.rpnRatingText.toLowerCase(),trainId:"N/A"!==r?`T${r}`:""}}));if(0===d.length)return t.style.display="none",n.style.display="flex",void(e.rpnChartInstance&&e.rpnChartInstance.destroy());t.style.display="block",n.style.display="none",d.sort((e,t)=>t.rpn-e.rpn);const l=d.map(e=>`${e.productName} (${e.ingredientName}) ${e.trainId}`),p=d.map(e=>e.rpn),u=d.map(e=>(r[e.ratingKey]||r.default).bg),m=d.map(e=>(r[e.ratingKey]||r.default).border);e.rpnChartInstance&&e.rpnChartInstance.destroy();const g=t.getContext("2d"),h=new Chart(g,{type:"bar",data:{labels:l,datasets:[{label:"RPN",data:p,backgroundColor:u,borderColor:m,borderWidth:1}]},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"var(--text-secondary)"},grid:{display:!1}},y:{beginAtZero:!0,ticks:{color:"var(--text-secondary)"},grid:{color:"var(--border-color)"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){let t=e.dataset.label||"";return t&&(t+=": "),null!==e.parsed.y&&(t+=e.parsed.y),t}}}}}});e.setRpnChartInstance(h)}export function toggleWorstCaseExportDropdown(){const e=document.getElementById("worstCaseExportDropdown");e.classList.toggle("hidden"),d(),document.addEventListener("click",function t(n){n.target.closest("#worstCaseExportDropdown")||n.target.closest('button[onclick="toggleWorstCaseExportDropdown()"]')||(e.classList.add("hidden"),document.removeEventListener("click",t))})}export function toggleWorstCasePrintDropdown(){const e=document.getElementById("worstCasePrintDropdown");e.classList.toggle("hidden"),d(),document.addEventListener("click",function t(n){n.target.closest("#worstCasePrintDropdown")||n.target.closest('button[onclick="toggleWorstCasePrintDropdown()"]')||(e.classList.add("hidden"),document.removeEventListener("click",t))})}function d(){const t=e.viewProducts.worstCaseProducts||e.products,n=new Set;t.forEach(e=>{const t=o(e);"N/A"!==t&&n.add(String(t))});const r=Array.from(n).sort((e,t)=>parseInt(e)-parseInt(t)),a=getTrainIdToLineNumberMap(),s=document.getElementById("worstCaseExportTrainOptions");s&&(s.innerHTML="",r.forEach(e=>{const t=document.createElement("label");t.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",t.style.color="var(--text-primary)";const n=document.createElement("input");n.type="checkbox",n.className="mr-2 export-train-checkbox",n.value=e,n.onchange=()=>updateAllTrainsCheckbox("export");const r=document.createElement("span"),o=a.get(String(e));r.textContent=o?`${o.line} — Train ${o.number}`:`Train ${e}`,t.appendChild(n),t.appendChild(r),s.appendChild(t)}));const c=document.getElementById("worstCasePrintTrainOptions");c&&(c.innerHTML="",r.forEach(e=>{const t=document.createElement("label");t.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",t.style.color="var(--text-primary)";const n=document.createElement("input");n.type="checkbox",n.className="mr-2 print-train-checkbox",n.value=e,n.onchange=()=>updateAllTrainsCheckbox("print");const r=document.createElement("span"),o=a.get(String(e));r.textContent=o?`${o.line} — Train ${o.number}`:`Train ${e}`,t.appendChild(n),t.appendChild(r),c.appendChild(t)}))}export function toggleAllTrainsSelection(e){const t=document.getElementById(`${e}AllTrainsCheckbox`);document.querySelectorAll(`.${e}-train-checkbox`).forEach(e=>{e.checked=t.checked})}export function updateAllTrainsCheckbox(e){const t=document.getElementById(`${e}AllTrainsCheckbox`),n=document.querySelectorAll(`.${e}-train-checkbox`),r=document.querySelectorAll(`.${e}-train-checkbox:checked`);0===r.length?(t.checked=!1,t.indeterminate=!1):r.length===n.length?(t.checked=!0,t.indeterminate=!1):(t.checked=!1,t.indeterminate=!0)}export function executeExportSelection(){const e=document.getElementById("exportAllTrainsCheckbox"),t=[];if(e.checked)exportWorstCaseToExcel("all");else{if(document.querySelectorAll(".export-train-checkbox:checked").forEach(e=>{t.push(e.value)}),0===t.length)return void r("No Selection","Please select at least one train to export.");exportWorstCaseToExcel(t)}document.getElementById("worstCaseExportDropdown").classList.add("hidden")}export function executePrintSelection(){const e=document.getElementById("printAllTrainsCheckbox"),t=[];if(e.checked)printCurrentView("worstCaseProducts","all");else{if(document.querySelectorAll(".print-train-checkbox:checked").forEach(e=>{t.push(e.value)}),0===t.length)return void r("No Selection","Please select at least one train to print.");printCurrentView("worstCaseProducts",t)}document.getElementById("worstCasePrintDropdown").classList.add("hidden")}window.toggleAllTrainsSelection=toggleAllTrainsSelection,window.updateAllTrainsCheckbox=updateAllTrainsCheckbox,window.executeExportSelection=executeExportSelection,window.executePrintSelection=executePrintSelection,window.toggleWorstCaseExportDropdown=toggleWorstCaseExportDropdown,window.toggleWorstCasePrintDropdown=toggleWorstCasePrintDropdown;