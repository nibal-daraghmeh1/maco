import*as e from"./state.js";import*as t from"./ui.js";import*as n from"./utils.js";import*as r from"./productView.js";import*as o from"./machineView.js";import*as a from"./worstCaseView.js";import*as i from"./macoProductView.js";import*as d from"./macoDetergentView.js";import*as s from"./dashboardView.js";import*as c from"./summaryView.js";import*as l from"./trainSummaryView.js";import*as m from"./scoringView.js";function u(){document.querySelectorAll("#maco-product-trains-container .train-container").forEach(e=>{if(e.querySelector(".print-train-btn"))return;const t=e.id,n=document.createElement("button");n.textContent="Print Train",n.className="btn print-train-btn",n.style.margin="10px",n.onclick=()=>g(t);const r=e.querySelector(".train-details");r&&r.appendChild(n)})}function g(e){document.getElementById(e)?(document.body.classList.add("printing-maco-train"),setTimeout(()=>{window.print()},100)):console.error("Could not find train content to print:",e)}window.changeTab=w,window.printTrain=g;export function fullAppRender(){try{n.generateTrainMap(),r.handleSearchAndFilter("productRegister"),a.handleSearchAndFilter("worstCaseProducts"),o.renderMachinesTable(),o.updateMachineLineOptionsIfModalOpen(),s.renderMainDashboard(),i.renderMacoForTrains(),u(),d.renderDetergentMaco(),d.renderDetergentIngredientsList(),c.renderSummaryReport(),m.renderScoringSystem(),r.populateFilterSelects(),renderLineNavigation()}catch(e){console.error("Error during full application render:",e),t.hideLoader()}}export function renderLineNavigation(){const t=document.getElementById("lineNavigation");if(!t)return void console.error("Line navigation element not found");const r=n.getUniqueProductLines(e.products);t.innerHTML="",r.forEach(e=>{if("Shared"===e)return;const n=document.createElement("div");n.className="line-nav-item",n.innerHTML=`\n            <button onclick="toggleLineMenu('${e}')" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between" style="color: var(--text-primary);">\n                <span>${e}</span>\n                <svg class="w-4 h-4 transform transition-transform" id="arrow-${e}" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>\n                </svg>\n            </button>\n            <div id="submenu-${e}" class="hidden ml-4 mt-2 space-y-1">\n                <button onclick="showLineSpecificView('${e}', 'worstCase')" class="w-full text-left px-3 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm" style="color: var(--text-secondary);">Worst Case Products</button>\n                <button onclick="showLineSpecificView('${e}', 'maco')" class="w-full text-left px-3 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm" style="color: var(--text-secondary);">Product MACO Calculation</button>\n                <button onclick="showLineSpecificView('${e}', 'detergent')" class="w-full text-left px-3 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm" style="color: var(--text-secondary);">Detergent MACO Calculation</button>\n                <button onclick="showLineSpecificView('${e}', 'trainSummary')" class="w-full text-left px-3 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm" style="color: var(--text-secondary);">Train Summary</button>\n            </div>\n        `,t.appendChild(n)})}function w(t,n){e.setActiveTabId(t),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active-tab-content")),document.getElementById(t).classList.add("active-tab-content"),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active-tab")),n.classList.add("active-tab"),"dashboard"===t&&s.renderMainDashboard(),"summaryReport"===t&&c.renderSummaryReport(),"trainSummary"===t&&l.renderTrainSummary(),"machineManagement"===t&&o.renderMachinesTable(),"macoForTrains"===t&&(i.renderMacoForTrains(),u()),"detergentMaco"===t&&d.renderDetergentMaco(),"productRegister"!==t&&"worstCaseProducts"!==t||r.handleSearchAndFilter(t)}window.toggleLineMenu=function(e){const t=document.getElementById(`submenu-${e}`),n=document.getElementById(`arrow-${e}`);t.classList.contains("hidden")?(t.classList.remove("hidden"),n.style.transform="rotate(180deg)"):(t.classList.add("hidden"),n.style.transform="rotate(0deg)")},window.toggleSidebar=function(){const e=document.getElementById("sidebar"),t=document.getElementById("mainContent"),n=document.getElementById("sidebarToggleIcon"),r=document.getElementById("floatingToggle"),o=document.getElementById("sidebarBackdrop");e.classList.contains("collapsed")?(e.classList.remove("collapsed"),e.classList.add("w-64"),e.classList.remove("w-0"),e.classList.remove("mr-0"),e.classList.add("mr-8"),t.classList.remove("ml-0"),n.style.transform="rotate(0deg)",r.classList.add("hidden"),window.innerWidth<=1024&&o.classList.remove("hidden")):(e.classList.add("collapsed"),e.classList.remove("w-64"),e.classList.add("w-0"),e.classList.remove("mr-8"),e.classList.add("mr-0"),t.classList.add("ml-0"),n.style.transform="rotate(180deg)",r.classList.remove("hidden"),o.classList.add("hidden"))},window.showLineSpecificView=function(e,t){let n;switch(console.log("showLineSpecificView called with:",e,t),window.currentLineFilter=e,t){case"worstCase":n="worstCaseProducts";break;case"maco":n="macoForTrains";break;case"detergent":n="detergentMaco";break;case"trainSummary":n="trainSummary"}console.log("Switching to tab:",n),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active-tab-content"));const r=document.getElementById(n);r?(r.classList.add("active-tab-content"),console.log("Tab content shown:",n)):console.error("Tab content not found:",n),function(e,t){switch(console.log("applyLineFilter called with:",e,t),t){case"worstCase":console.log("Filtering worst case products for line:",e),a.handleSearchAndFilter("worstCaseProducts",e);break;case"maco":console.log("Filtering MACO calculations for line:",e),i.renderMacoForTrains(e);break;case"detergent":console.log("Filtering detergent MACO for line:",e),d.renderDetergentMaco(e);break;case"trainSummary":console.log("Filtering train summary for line:",e),l.renderTrainSummary(e)}}(e,t)},document.addEventListener("DOMContentLoaded",function(){window.changeTab=w,window.printTrain=g,window.toggleSidebar=window.toggleSidebar,window.toggleLineMenu=window.toggleLineMenu,window.showLineSpecificView=window.showLineSpecificView,window.saveAllDataToLocalStorage=t.saveAllDataToLocalStorage,window.loadAllDataFromLocalStorage=t.loadAllDataFromLocalStorage,window.handleSearchAndFilter=function(e){"worstCaseProducts"===e?a.handleSearchAndFilter(e):r.handleSearchAndFilter(e)},window.sortData=function(e,t){"worstCaseProducts"===t?a.sortData(e,t):r.sortData(e,t)};const{printReport:u,...p}=i,{handleSearchAndFilter:h,...y}=r,{handleSearchAndFilter:f,...L}=a;Object.assign(window,t,n,y,o,L,p,d,s,c,l,m),document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.documentElement.classList.contains("dark");t.toggleDarkMode(!e),localStorage.setItem("theme",e?"light":"dark")}),window.addEventListener("beforeprint",()=>{window.printingView=null,document.body.classList.contains("printing-worstCaseProducts")?window.printingView="worstCaseProducts":document.body.classList.contains("printing-macoForTrains")?window.printingView="macoForTrains":document.body.classList.contains("printing-trainSummary")&&(window.printingView="trainSummary")}),window.addEventListener("afterprint",()=>{const n=document.body.classList.contains("printing-worstCaseProducts"),r=document.body.classList.contains("printing-macoForTrains"),o=document.body.classList.contains("printing-trainSummary");document.body.className=document.body.className.replace(/printing-[\w-]+/g,""),e.scoringWasInEditModeForPrint&&(m.toggleScoringEditMode(!0),e.setScoringWasInEditModeForPrint(!1)),(n||r||o)&&(t.showLoader(),window.printSelectedTrain=null,n?a.renderWorstCaseByTrain():r?i.renderMacoForTrains():o&&l.renderTrainSummary()),window.printingView=null}),window.addEventListener("focus",()=>{window.printingView&&!document.body.className.includes("printing-")&&setTimeout(()=>{window.printingView&&!document.body.className.includes("printing-")&&(t.hideLoader(),window.printSelectedTrain=null,window.printingView=null)},500)}),document.addEventListener("keydown",function(e){e.ctrlKey&&"z"===e.key&&(e.preventDefault(),t.undoChange()),e.ctrlKey&&"y"===e.key&&(e.preventDefault(),t.redoChange())}),document.addEventListener("input",function(e){e.target.matches(".filterColProductCode, .filterColProductName")&&handleSearchAndFilter("productRegister"),e.target.matches("#worstCaseProductNameFilter")&&a.handleWorstCaseProductFilter()}),document.addEventListener("change",function(e){e.target.matches(".filterColTrainNo, .filterColProductType, .filterColIsCritical")&&handleSearchAndFilter("productRegister")}),document.getElementById("addProductForm").addEventListener("submit",r.addNewProduct),document.getElementById("editProductForm").addEventListener("submit",r.saveProductChanges),document.getElementById("editIngredientForm").addEventListener("submit",r.saveIngredientChanges),document.getElementById("machineForm").addEventListener("submit",o.saveMachine),document.getElementById("assignMachinesForm").addEventListener("submit",o.saveProductMachines),document.getElementById("addProductsToMachineForm").addEventListener("submit",o.saveProductsToMachine),document.getElementById("customAlertButton").onclick=()=>t.hideModal("customAlertModal"),document.getElementById("editScoringBtn").addEventListener("click",()=>m.toggleScoringEditMode(!e.scoringInEditMode)),window.addEventListener("resize",function(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarBackdrop");window.innerWidth>1024?t.classList.add("hidden"):e.classList.contains("collapsed")||t.classList.remove("hidden")}),function(){t.showLoader();try{let n,r;if(n||(n="defaultOrg"),r||(r="defaultUser"),localStorage.setItem("orgId",n),localStorage.setItem("userId",r),window.orgId=n,window.userId=r,"dark"===localStorage.getItem("theme")?t.toggleDarkMode(!0):t.toggleDarkMode(!1),t.loadAllDataFromLocalStorage(),e.products.length>0){e.setNextProductId(Math.max(0,...e.products.map(e=>e.id))+1);const t=e.products.flatMap(e=>e.activeIngredients.map(e=>e.id));e.setNextIngredientId(t.length>0?Math.max(0,...t)+1:1)}e.machines.length>0&&e.setNextMachineId(Math.max(0,...e.machines.map(e=>e.id))+1),e.detergentIngredients.length>0&&e.setNextDetergentIngredientId(Math.max(0,...e.detergentIngredients.map(e=>e.id))+1),e.products.forEach(e=>{void 0===e.isCritical&&(e.isCritical=!1)}),t.saveStateForUndo();try{"function"==typeof e.ensureProductsHaveLine&&e.ensureProductsHaveLine()}catch(e){console.warn("[migration] ensureProductsHaveLine failed",e)}fullAppRender(),t.updateToggleIcons("productRegister"),m.toggleScoringEditMode(!1),t.hideLoader()}catch(e){console.error("Error during application initialization:",e),t.hideLoader()}}()});