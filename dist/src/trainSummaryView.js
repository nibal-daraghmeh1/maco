import*as e from"./state.js";import{hideLoader as t}from"./ui.js";import{getTrainData as n,calculateScores as r,getMacoPerSwabForTrain as o,getTrainsGroupedByLine as a,getLargestEssaForLineAndDosageForm as i}from"./utils.js";import*as s from"./utils.js";export function renderTrainSummary(o=null){console.log("renderTrainSummary called with lineFilter:",o);const l=document.getElementById("trainSummaryContainer"),d=document.getElementById("noTrainSummaryMessage");if(!l)return void console.error("trainSummaryContainer not found");l.innerHTML="";let m=a();console.log("All lines with trains:",m),o&&(m=m.filter(e=>e.line===o),console.log("Filtered lines with trains for",o,":",m));const u=[];if(m.forEach(e=>{e.trains.forEach(t=>{u.push({...t,line:e.line})})}),0===u.length)return d.style.display="block",void(l.style.display="none");let p=u;if(window.printSelectedTrain&&"all"!==window.printSelectedTrain&&(console.log("Filtering trains for print:",window.printSelectedTrain),console.log("Available trains:",u.map(e=>e.id)),p=Array.isArray(window.printSelectedTrain)?u.filter(e=>window.printSelectedTrain.includes(String(e.id))):u.filter(e=>String(e.id)===String(window.printSelectedTrain)),console.log("Filtered trains:",p.map(e=>e.id))),0===p.length)return console.log("No trains to render after filtering"),d.style.display="block",void(l.style.display="none");d.style.display="none",l.style.display="block";const g=s.getTrainIdToLineNumberMap(),y=p.sort((e,t)=>e.line!==t.line?e.line.localeCompare(t.line):e.id-t.id),h={};y.forEach(e=>{const t=e.line||"Unassigned",n=[...new Set(e.products.map(e=>e.productType||"Unknown"))].join(", "),r=`${t}|${n}`;h[r]||(h[r]={line:t,dosageForm:n,trains:[],totalStudies:0}),h[r].trains.push(e)}),Object.keys(h).forEach(t=>{const n=h[t],o=n.trains,a=(o.map(e=>{let t=0,n=null,o=null;return e.products&&e.products.length>0&&e.products.forEach(e=>{e.activeIngredients&&Array.isArray(e.activeIngredients)&&e.activeIngredients.forEach(a=>{try{const i=r(a);i&&i.rpn>t&&(t=i.rpn,n=e,o=a)}catch(e){console.warn("Error calculating RPN for ingredient:",a,e)}})}),{train:e,rpn:t,worstProduct:n,worstIngredient:o}}).sort((e,t)=>t.rpn-e.rpn),new Set);o.forEach(e=>{e.machineIds.forEach(e=>a.add(e))});const i=o.map(e=>{let t=0,n=null,o=null;return e.products&&e.products.length>0&&e.products.forEach(e=>{e.activeIngredients&&Array.isArray(e.activeIngredients)&&e.activeIngredients.forEach(a=>{try{const i=r(a);i&&i.rpn>t&&(t=i.rpn,n=e,o=a)}catch(e){console.warn("Error calculating RPN for ingredient:",a,e)}})}),{train:e,rpn:t,worstProduct:n,worstIngredient:o}}).sort((e,t)=>t.rpn-e.rpn),s=new Set;n.studyBreakdown=i.map(({train:t,rpn:n,worstProduct:r,worstIngredient:o},i)=>{const c=i+1,l=g.get(String(t.id)),d=l?`Train ${l.number}`:`T${t.id}`,m=t.machineIds.filter(e=>a.has(e)&&!s.has(e));m.forEach(e=>s.add(e));const u=m.map(t=>{const n=e.machines.find(e=>e.id===t);return n?n.name:`Unknown (ID: ${t})`}).join(", ");return{studyNumber:c,trainLabel:d,productName:r?r.name:"Unknown",ingredientName:o?o.name:"Unknown",rpn:n.toFixed(2),machines:u}}),n.totalStudies=o.length});const x=Object.keys(h).map(t=>{const o=h[t];return o.trains.map(e=>{let t=0;return e.products&&e.products.length>0&&e.products.forEach(e=>{e.activeIngredients&&Array.isArray(e.activeIngredients)&&e.activeIngredients.forEach(e=>{try{const n=r(e);n&&n.rpn>t&&(t=n.rpn)}catch(t){console.warn("Error calculating RPN for ingredient:",e,t)}})}),{train:e,rpn:t}}).sort((e,t)=>e.train.id-t.train.id).map(({train:a},s)=>{const c=`\n            <div class="mb-2">\n                <span class="font-semibold text-blue-600">Machines:</span><br>\n                <span class="text-sm">${a.machineIds.map(t=>{const n=e.machines.find(e=>e.id===t);return n||{id:t,name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}).map(e=>e.name).join(", ")}</span>\n            </div>\n            <div>\n                <span class="font-semibold text-purple-600">Products:</span><br>\n                <span class="text-sm">${a.products.map(e=>e.name).join(", ")}</span>\n            </div>\n        `,l=function(e){let t=null,n=0;try{if(!e||!e.products||!Array.isArray(e.products))return null;for(const o of e.products)if(o&&o.activeIngredients&&Array.isArray(o.activeIngredients))for(const e of o.activeIngredients)if(e)try{const a=r(e);a&&a.rpn>n&&(n=a.rpn,t={productCode:o.productCode||"Unknown",productName:o.name||"Unknown Product",ingredientName:e.name||"Unknown Ingredient",rpn:a.rpn})}catch(t){console.warn("Error calculating scores for ingredient:",e,t);continue}}catch(e){return console.error("Error in getWorstCaseProductForTrain:",e),null}return t}(a),d=l?`\n                <div class="text-sm">\n                    <div class="font-semibold text-orange-600">${l.productName}</div>\n                    <div class="text-xs text-gray-600">Ingredient: ${l.ingredientName}</div>\n                    <div class="text-xs font-bold text-red-600">RPN: ${l.rpn.toFixed(2)}</div>\n                </div>\n            `:'<span class="text-gray-500 text-sm">No data available</span>',m=function(t){try{const r=n(),o=r.find(e=>e.id===t.id);if(!o)return{value:0,display:"Not calculated"};const a=i(t,r);if(a<=0)return{value:0,display:"Not calculated"};const s=(e.safetyFactorConfig[getWorstCaseProductType(o.products.map(e=>e.productType))]||e.safetyFactorConfig.Other).max,c=o.lowestLtd*o.minBsMddRatio/s,l=10*o.minMbsKg;let d=1/0,m=1/0;const u="true"===localStorage.getItem("productRegister-pdeHidden"),p="true"===localStorage.getItem("productRegister-ld50Hidden");if(null===o.lowestPde||u||(d=o.lowestPde*o.minBsMddRatio),null!==o.lowestLd50&&!p){const e=70*o.lowestLd50/2e3,t=o.products.flatMap(e=>e.activeIngredients.map(e=>e.mdd/1e3)),n=Math.min(...t);m=e*o.minMbsKg*1e3/(s*n)}const g=.004*a,y=[{name:"0.1% Therapeutic Dose",value:c},{name:"10 ppm Criterion",value:l}];null===o.lowestPde||u||y.push({name:"Health-Based Limit (PDE)",value:d}),null===o.lowestLd50||p||y.push({name:"Health-Based Limit (NOEL)",value:m}),y.push({name:"Visual Clean Limit",value:g});const h=y.reduce((e,t)=>t.value<e.value?t:e).value,x=(a>0?h/a:0)*o.assumedSsa,v=x>0?`${x.toLocaleString(void 0,{minimumFractionDigits:4,maximumFractionDigits:4})} mg/Swab`:"Not calculated";return{value:x,display:v}}catch(e){return console.error("Error calculating MACO for train:",t?.id||"unknown",e),{value:0,display:"Not calculated"}}}(a),u=m.value>0?`<span class="font-semibold text-green-600">${m.display}</span>`:`<span class="text-gray-500">${m.display}</span>`,p=g.get(String(a.id)),y=p?`Train ${p.number}`:`T${a.id}`,h=0===s?`<td class="px-4 py-4 text-center align-middle" style="color: var(--text-primary); border-left: 2px solid var(--border-color);" rowspan="${o.trains.length}">\n                    <div class="text-center">\n                        <div class="font-bold text-orange-600 text-lg mb-2">${o.totalStudies} Studies</div>\n                        <button \n                            onclick="toggleStudyBreakdown('${t}')" \n                            class="p-1 mb-2" \n                            style="color: var(--text-secondary);" \n                            title="View Study Details"\n                        >\n                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>\n                        </button>\n                        <div id="breakdown-${t}" class="text-xs space-y-1 hidden">\n                            ${o.studyBreakdown.map(e=>`\n                                <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded border" style="border-color: var(--border-color);">\n                                    <div class="font-semibold text-blue-600">Study ${e.studyNumber}: ${e.trainLabel}</div>\n                                    <div class="text-gray-600 dark:text-gray-400">\n                                        <div><strong>Product:</strong> ${e.productName}</div>\n                                        <div><strong>Machines:</strong> ${e.machines}</div>\n                                    </div>\n                                </div>\n                            `).join("")}\n                        </div>\n                    </div>\n                   </td>`:"";return`\n            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800/50" style="border-color: var(--border-color);">\n                    <td class="px-4 py-4 text-center" style="color: var(--text-primary);">\n                        <span class="font-semibold text-indigo-600">${o.line} - ${o.dosageForm}</span>\n                    </td>\n                <td class="px-4 py-4 text-center font-bold text-lg" style="color: var(--text-primary);">${y}</td>\n                <td class="px-4 py-4" style="color: var(--text-primary);">\n                    ${c}\n                </td>\n                <td class="px-4 py-4" style="color: var(--text-primary);">\n                    ${d}\n                </td>\n                <td class="px-4 py-4 text-center" style="color: var(--text-primary);">\n                    ${u}\n                </td>\n                    ${h}\n            </tr>\n        `}).join("")}).join("");l.innerHTML=`\n        <div class="overflow-hidden rounded-lg border" style="border-color: var(--border-color);">\n            <table class="w-full text-sm">\n                <thead class="bg-gray-200 dark:bg-gray-700">\n                    <tr>\n                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); width: 15%;">Line - Dosage Form</th>\n                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); width: 10%;">Train</th>\n                               <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); width: 35%;">Machines & Products</th>\n                        <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); width: 20%;">Worst Case Product</th>\n                        <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); width: 12%;">MACO</th>\n                               <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary); border-left: 2px solid var(--border-color); width: 8%;">Studies Needed</th>\n                    </tr>\n                </thead>\n                <tbody style="border-color: var(--border-color); background-color: var(--bg-secondary);">\n                    ${x}\n                </tbody>\n            </table>\n        </div>\n    `,c(),t()}window.toggleStudyBreakdown=function(e){const t=document.getElementById(`breakdown-${e}`);t.classList.contains("hidden")?t.classList.remove("hidden"):t.classList.add("hidden")};export function toggleTrainSummaryExportDropdown(){const e=document.getElementById("trainSummaryExportDropdown");e.classList.toggle("hidden"),c(),document.addEventListener("click",function t(n){n.target.closest("#trainSummaryExportDropdown")||n.target.closest('button[onclick="toggleTrainSummaryExportDropdown()"]')||(e.classList.add("hidden"),document.removeEventListener("click",t))})}export function toggleTrainSummaryPrintDropdown(){const e=document.getElementById("trainSummaryPrintDropdown");e.classList.toggle("hidden"),c(),document.addEventListener("click",function t(n){n.target.closest("#trainSummaryPrintDropdown")||n.target.closest('button[onclick="toggleTrainSummaryPrintDropdown()"]')||(e.classList.add("hidden"),document.removeEventListener("click",t))})}function c(){const e=n(),t=document.getElementById("trainSummaryExportTrainOptions");t&&(t.innerHTML="",e.forEach(e=>{const n=document.createElement("label");n.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",n.style.color="var(--text-primary)";const r=document.createElement("input");r.type="checkbox",r.className="mr-2 export-trainsummary-train-checkbox",r.value=e.id,r.onchange=()=>updateAllTrainSummaryTrainsCheckbox("export");const o=document.createElement("span");o.textContent=`Train ${e.id}`,n.appendChild(r),n.appendChild(o),t.appendChild(n)}));const r=document.getElementById("trainSummaryPrintTrainOptions");r&&(r.innerHTML="",e.forEach(e=>{const t=document.createElement("label");t.className="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",t.style.color="var(--text-primary)";const n=document.createElement("input");n.type="checkbox",n.className="mr-2 print-trainsummary-train-checkbox",n.value=e.id,n.onchange=()=>updateAllTrainSummaryTrainsCheckbox("print");const o=document.createElement("span");o.textContent=`Train ${e.id}`,t.appendChild(n),t.appendChild(o),r.appendChild(t)}))}export function toggleAllTrainSummaryTrainsSelection(e){const t=document.getElementById(`${e}TrainSummaryAllTrainsCheckbox`);document.querySelectorAll(`.${e}-trainsummary-train-checkbox`).forEach(e=>{e.checked=t.checked})}export function updateAllTrainSummaryTrainsCheckbox(e){const t=document.getElementById(`${e}TrainSummaryAllTrainsCheckbox`),n=document.querySelectorAll(`.${e}-trainsummary-train-checkbox`),r=document.querySelectorAll(`.${e}-trainsummary-train-checkbox:checked`);0===r.length?(t.checked=!1,t.indeterminate=!1):r.length===n.length?(t.checked=!0,t.indeterminate=!1):(t.checked=!1,t.indeterminate=!0)}export function executeTrainSummaryExportSelection(){import("./ui.js").then(e=>{const{showCustomAlert:t,exportTrainSummaryToExcel:n}=e,r=document.getElementById("exportTrainSummaryAllTrainsCheckbox"),o=[];if(r.checked)n("all");else{if(document.querySelectorAll(".export-trainsummary-train-checkbox:checked").forEach(e=>{o.push(e.value)}),0===o.length)return void t("No Selection","Please select at least one train to export.");n(o)}document.getElementById("trainSummaryExportDropdown").classList.add("hidden")}).catch(e=>{console.error("Error loading export function:",e),alert("Error loading export function")})}export function executeTrainSummaryPrintSelection(){try{const e=document.getElementById("printTrainSummaryAllTrainsCheckbox"),t=document.querySelectorAll(".print-trainsummary-train-checkbox:checked");if(console.log("All checkbox checked:",e?e.checked:"not found"),console.log("Individual checkboxes found:",t.length),!e)return void alert("Print dropdown elements not found. Please try refreshing the page.");import("./ui.js").then(n=>{const{showCustomAlert:r,printCurrentView:o}=n,a=[];if(e.checked)console.log("Printing all trains"),o("trainSummary","all");else{if(t.forEach(e=>{a.push(e.value)}),console.log("Selected trains for printing:",a),0===a.length)return void r("No Selection","Please select at least one train to print.");o("trainSummary",a)}const i=document.getElementById("trainSummaryPrintDropdown");i&&i.classList.add("hidden")}).catch(e=>{console.error("Error loading print function:",e),alert("Error loading print function: "+e.message)})}catch(e){console.error("Error in executeTrainSummaryPrintSelection:",e),alert("Print function error: "+e.message)}}window.toggleTrainSummaryExportDropdown=toggleTrainSummaryExportDropdown,window.toggleTrainSummaryPrintDropdown=toggleTrainSummaryPrintDropdown,window.toggleAllTrainSummaryTrainsSelection=toggleAllTrainSummaryTrainsSelection,window.updateAllTrainSummaryTrainsCheckbox=updateAllTrainSummaryTrainsCheckbox,window.executeTrainSummaryExportSelection=executeTrainSummaryExportSelection,window.executeTrainSummaryPrintSelection=executeTrainSummaryPrintSelection;