import*as e from"./state.js";import{fullAppRender as t}from"./app.js";import{showCustomAlert as n,hideModal as a,saveStateForUndo as o}from"./ui.js";import{getProductTrainId as i,getToxicityPreference as s,calculateScores as r,getRpnRatingClass as c,getUniqueProductLines as l}from"./utils.js";export function populateMachineLineOptions(){const e=document.getElementById("machineLine");if(!e)return;const t=l(),n=e.value;e.innerHTML='<option value="" disabled selected>Select a Line</option>',e.innerHTML+='<option value="Shared">Shared (Available to all lines)</option>',t.forEach(t=>{"Shared"!==t&&(e.innerHTML+=`<option value="${t}">${t}</option>`)}),e.innerHTML+='<option value="Other">Other</option>',n&&Array.from(e.options).some(e=>e.value===n)&&(e.value=n)}export function updateMachineLineOptionsIfModalOpen(){const e=document.getElementById("machineModal");e&&"none"!==e.style.display&&!e.classList.contains("hidden")&&populateMachineLineOptions()}export function sortMachines(t){e.machineSortState.key===t?e.machineSortState.direction="asc"===e.machineSortState.direction?"desc":"asc":(e.machineSortState.key=t,e.machineSortState.direction="asc"),e.setMachineSortState(e.machineSortState),renderMachinesTable()}export function renderMachinesTable(){const t=document.getElementById("machinesContainer"),n=document.getElementById("noMachinesMessage");if(t.innerHTML="",0===e.machines.length)return void(n.style.display="block");n.style.display="none";const a={};e.machineStageDisplayOrder.forEach(e=>{"Other"!==e&&(a[e]=[])});const o=[];e.machines.forEach(t=>{e.machineStageDisplayOrder.includes(t.stage)?"Other"!==t.stage&&a[t.stage].push(t):(a[t.stage]||(a[t.stage]=[],o.push(t.stage)),a[t.stage].push(t))}),Object.keys(a).forEach(n=>{const o=n.toLowerCase().replace(/\s+/g,""),i="true"===localStorage.getItem(`machineStage-${o}-hidden`),s=a[n];if(0===s.length)return;const r=[...s].sort((t,n)=>{const a=e.machineSortState.key,o="asc"===e.machineSortState.direction?1:-1;let i,s;return"area"===a?(i=t.area,s=n.area):(i=String(t[a]||"").toLowerCase(),s=String(n[a]||"").toLowerCase()),i<s?-1*o:i>s?1*o:0}),c=document.createElement("div");c.className="card p-6";let l=`\n            <div class="flex items-center justify-between mb-4">\n                <h3 class="text-xl font-bold">${n} Machines (${s.length})</h3>\n                <button onclick="toggleStageSection('${o}')" class="text-sm px-3 py-1 rounded border" style="border-color: var(--border-color); color: var(--text-secondary);">\n                    ${i?"Show":"Hide"}\n                </button>\n            </div>\n            <div id="stage-${o}" ${i?'style="display: none;"':""}>\n                <div class="overflow-x-auto overflow-hidden rounded-md border" style="border-color: var(--border-color);">\n                    <table class="w-full text-sm">\n                        <thead class="border-b" style="border-color: var(--border-color);">\n                            <tr>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('machineNumber')">Number <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('name')">Name <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('line')">Line <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('group')">Group <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('area')">Area (cm²) <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider sortable" onclick="sortMachines('cleaningSOP')">Cleaning SOP <span class="sort-indicator"></span></th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Products</th>\n                                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Actions</th>\n                            </tr>\n                        </thead>\n                        <tbody class="divide-y" style="border-color: var(--border-color);">`;r.forEach(t=>{const n=e.products.filter(e=>e.machineIds&&e.machineIds.includes(t.id)),a=n.length;let o='<div class="flex items-center gap-x-2">';o+=a>0?`\n                    <span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color: var(--bg-accent); color: var(--text-primary);">${a}</span>\n                    <button onclick="showMachineProductsModal(${t.id})" class="p-1" style="color: var(--text-secondary);" title="View ${a} Product(s)">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>\n                    </button>`:'<span class="text-xs" style="color: var(--text-secondary);">None</span>',o+=`</div>\n                <div class="only-print text-xs" style="display: none; white-space: normal; word-break: break-word;">\n                    ${n.map(e=>e.name).join(", ")||"None"}\n                </div>`;const i=t.group?"machine-group-cell grouped":"machine-group-cell individual",s=t.group||'<span style="color: var(--text-secondary); font-style: italic;">Individual</span>',r=t.line||'<span style="color: var(--text-secondary); font-style: italic;">Not Assigned</span>';l+=`\n                <tr>\n                    <td class="px-4 py-3 whitespace-nowrap">${t.machineNumber}</td>\n                    <td class="px-4 py-3 font-medium">${t.name}</td>\n                    <td class="px-4 py-3 whitespace-nowrap">${r}</td>\n                    <td class="px-4 py-3 whitespace-nowrap ${i}">${s}</td>\n                    <td class="px-4 py-3 whitespace-nowrap">${t.area.toLocaleString()}</td>\n                    <td class="px-4 py-3 whitespace-nowrap">${t.cleaningSOP||""}</td>\n                    <td class="px-4 py-3">${o}</td>\n                    <td class="px-4 py-3 whitespace-nowrap">\n                        <div class="flex items-center gap-x-2 no-print">\n                            <button onclick="showAddProductsToMachineModal(${t.id})" class="p-1 text-blue-500" title="Assign Products to this Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>\n                            <button onclick="showMachineModal(${t.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>\n                            <button onclick="deleteMachine(${t.id})" class="p-1 text-red-500" title="Delete Machine"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg></button>\n                        </div>\n                    </td>\n                </tr>`}),l+="</tbody></table></div></div>",c.innerHTML=l,t.appendChild(c)}),function(){const t=document.getElementById("machineManagement");t&&t.querySelectorAll(".card th.sortable").forEach(t=>{const n=t.querySelector(".sort-indicator");t.getAttribute("onclick").match(/'(.*?)'/)[1]===e.machineSortState.key?n.textContent="asc"===e.machineSortState.direction?"▲":"▼":n.textContent=""})}()}export function showMachineModal(t=null){document.getElementById("machineForm").reset();const a=document.getElementById("machineModalTitle"),o=document.getElementById("machineId"),i=document.getElementById("machineNumber"),s=document.getElementById("machineName"),r=document.getElementById("machineLine");if(!r)return console.error("Machine line select element not found. Please refresh the page."),void n("Error","Machine line field not found. Please refresh the page to load the updated interface.");populateMachineLineOptions();const c=document.getElementById("machineArea"),l=document.getElementById("cleaningSOP"),d=document.getElementById("machineStage"),h=document.getElementById("machineGroup");if(d.innerHTML='<option value="" disabled selected>Select a Stage</option>',e.machineStageDisplayOrder.forEach(e=>{const t="Other"===e?"Other (Add New Stage)":e;d.innerHTML+=`<option value="${e}">${t}</option>`}),h.innerHTML='<option value="">No Group (Individual Machine)</option>',e.machineGroups.forEach(e=>{h.innerHTML+=`<option value="${e}">${e}</option>`}),h.innerHTML+='<option value="Other">Other (Create New Group)</option>',t){const n=e.machines.find(e=>e.id===t);if(n){a.textContent="Edit Machine",o.value=n.id,i.value=n.machineNumber,s.value=n.name;const t=n.line||"";if(["Shared","Solids","Semisolid","Liquids"].includes(t))r.value=t;else if(t){r.value="Other";const e=document.getElementById("machineOtherLineContainer"),n=document.getElementById("machineOtherLine");e&&n&&(e.style.display="block",n.value=t,n.required=!0)}c.value=n.area,l.value=n.cleaningSOP||"";const m=document.getElementById("otherStageContainer"),u=document.getElementById("otherMachineStage");e.machineStageDisplayOrder.filter(e=>"Other"!==e).includes(n.stage)?(d.value=n.stage,m.style.display="none",u.required=!1):(d.value="Other",u.value=n.stage,m.style.display="block",u.required=!0);const p=document.getElementById("otherGroupContainer"),g=document.getElementById("otherMachineGroup");n.group&&""!==n.group?e.machineGroups.includes(n.group)?(h.value=n.group,p.style.display="none",g.required=!1):(h.value="Other",g.value=n.group,p.style.display="block",g.required=!0):(h.value="",p.style.display="none",g.required=!1)}}else{a.textContent="Add Machine",o.value="",document.getElementById("otherStageContainer").style.display="none",document.getElementById("otherMachineStage").required=!1,document.getElementById("otherGroupContainer").style.display="none",document.getElementById("otherMachineGroup").required=!1;const e=document.getElementById("machineOtherLineContainer"),t=document.getElementById("machineOtherLine");e&&t&&(e.style.display="none",t.value="",t.required=!1)}document.getElementById("machineModal").style.display="flex"}export function saveMachine(i){i.preventDefault();const s=document.getElementById("machineId").value,r=document.getElementById("machineNumber").value.trim(),c=document.getElementById("machineName").value.trim(),l=document.getElementById("machineLine");if(!l)return void n("Error","Machine line field not found. Please refresh the page to load the updated interface.");let d=l.value;if("Other"===d){const e=document.getElementById("machineOtherLine").value.trim();if(!e)return void n("Validation Error","Please specify the custom line name.");d=e}let h=document.getElementById("machineStage").value;const m=parseInt(document.getElementById("machineArea").value,10),u=document.getElementById("cleaningSOP").value.trim();let p=document.getElementById("machineGroup").value;if("Other"===h){const t=document.getElementById("otherMachineStage").value.trim();if(!t)return void n("Validation Error","Please specify the new stage name.");if(h=t,!e.machineStageDisplayOrder.includes(h)){const t=e.machineStageDisplayOrder.indexOf("Other");t>-1?e.machineStageDisplayOrder.splice(t,0,h):e.machineStageDisplayOrder.push(h),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(e.machineStageDisplayOrder))}}if("Other"===p){const t=document.getElementById("otherMachineGroup").value.trim();if(!t)return void n("Validation Error","Please specify the new group name.");p=t,e.machineGroups.includes(p)||(e.machineGroups.push(p),localStorage.setItem("machineGroups",JSON.stringify(e.machineGroups)))}if(p&&""!==p){const t=e.machines.filter(e=>e.group===p&&(!s||e.id!==parseInt(s)));if(t.length>0){const e=[...new Set(t.map(e=>e.stage))];if(e.length>0&&!e.includes(h)){const t=e.join(", ");return void n("Group Stage Mismatch",`Cannot assign this machine to group "${p}". All machines in a group must belong to the same stage.\n\nCurrent group stage(s): ${t}\nNew machine stage: ${h}\n\nPlease either:\n• Change the machine's stage to match the group\n• Choose a different group\n• Create a new group for this stage`)}}}if(!r||!c||!d||!h||isNaN(m)||!u)return void n("Error","All fields are required.");if(e.machines.some(e=>{const t=s?parseInt(s,10):null;return e.id!==t&&e.machineNumber.toLowerCase()===r.toLowerCase()}))n("Validation Error","A machine with this number already exists.");else{if(s){const t=e.machines.find(e=>e.id===parseInt(s));t&&(t.machineNumber=r,t.name=c,t.line=d,t.stage=h,t.area=m,t.cleaningSOP=u,t.group=p||"")}else e.setNextMachineId(e.nextMachineId+1),e.machines.push({id:e.nextMachineId,machineNumber:r,name:c,line:d,stage:h,area:m,cleaningSOP:u,group:p||""});o(),t(),a("machineModal"),console.log("Saving machines to Firestore")}}export function deleteMachine(n){if(confirm("Are you sure you want to delete this machine? It will be removed from all products that use it.")){const a=e.machines.filter(e=>e.id!==n);e.setMachines(a),e.products.forEach(e=>{e.machineIds&&(e.machineIds=e.machineIds.filter(e=>e!==n))}),o(),t()}}let d=null;export function showMachineProductsModal(t){const n=e.machines.find(e=>e.id===t);if(!n)return;d=n;const a=document.getElementById("machineProductsModalTitle"),o=document.getElementById("machineProductsList");a.textContent=`Products on: ${n.name} (${n.machineNumber})`;const l=e.products.filter(e=>e.machineIds&&e.machineIds.includes(t));if(l.length>0){let e='<div class="divide-y" style="border-color: var(--border-color);">';l.forEach((t,n)=>{i(t);const a=t.isCritical?"Yes":"No",o=t.isCritical?"text-red-600 font-bold":"",l=(new Date(t.date).toLocaleDateString(),s());let d=0,h="N/A";t.activeIngredients.forEach(e=>{const t=r(e,l);t.rpn>d&&(d=t.rpn,h=t.rpnRatingText)});const m=c(h);e+=`\n                        <div class="py-3 px-2">\n                            <div class="flex justify-between items-center mb-2">\n                                <h4 class="font-semibold text-lg">${t.name}</h4>\n                                <span class="text-xs px-2 py-1 rounded" style="background-color: var(--bg-accent); color: var(--text-secondary);">${t.productCode}</span>\n                            </div>\n                            <div class="text-xs flex flex-wrap gap-4">\n                                <span ><strong>Highest RPN:</strong> <span class="${m}" style="font-weight: bold;">${d.toFixed(1)}</span></span>\n                                <span><strong>Special Case Product:</strong> <span class="${o}">${a}</span></span>\n                                ${t.isCritical&&t.criticalReason?`<span class="text-xs italic" style="color: var(--text-secondary);">Reason: ${t.criticalReason}</span>`:""}\n                            </div>\n                        </div>\n                    `}),e+="</div>",o.innerHTML=e}else o.innerHTML='<p style="color:var(--text-secondary);">No products are currently assigned to this machine.</p>';document.getElementById("machineProductsModal").style.display="flex"}export function exportMachineProductsToExcel(){if(!d)return void console.error("No machine data available for export");const t=d,n=e.products.filter(e=>e.machineIds&&e.machineIds.includes(t.id));if(0===n.length)return void alert("No products to export for this machine.");const a=s(),o=n.map(e=>{const t=e.isCritical?"Yes":"No";let n=0;return e.activeIngredients.forEach(e=>{const t=r(e,a);t.rpn>n&&(n=t.rpn)}),{"Product Name":e.name,"Highest RPN":n.toFixed(1),"Special Case Product":t}}),i=XLSX.utils.json_to_sheet(o),c=XLSX.utils.book_new(),l=`${t.name} Products`;XLSX.utils.book_append_sheet(c,i,l);const h=Object.keys(o[0]||{}).map(e=>({wch:Math.max(e.length,...o.map(t=>String(t[e]||"").length))+2}));i["!cols"]=h;const m=(new Date).toISOString().slice(0,19).replace(/[:\-T]/g,""),u=`Machine_${t.machineNumber}_Products_${m}.xlsx`;XLSX.writeFile(c,u)}export function printMachineProducts(){if(d)try{const t=d,n=e.products.filter(e=>e.machineIds&&e.machineIds.includes(t.id));if(!n||0===n.length)return void alert("No products found for this machine");let a='\n            <html>\n            <head>\n                <title>Machine Products Report</title>\n                <style>\n                    body { \n                        font-family: Arial, sans-serif; \n                        margin: 20px;\n                        font-size: 12px;\n                    }\n                    h1 { \n                        color: #333; \n                        border-bottom: 2px solid #ddd; \n                        padding-bottom: 10px;\n                    }\n                    .info-table {\n                        border-collapse: collapse;\n                        width: 100%;\n                        margin-bottom: 20px;\n                    }\n                    .info-table th, .info-table td {\n                        border: 1px solid #ddd;\n                        padding: 8px;\n                        text-align: left;\n                    }\n                    .info-table th {\n                        background-color: #f5f5f5;\n                        font-weight: bold;\n                    }\n                    @media print {\n                        body { margin: 0; }\n                        h1 { page-break-after: avoid; }\n                    }\n                </style>\n            </head>\n            <body>\n                <h1>Machine Products Report</h1>\n                \n                <table class="info-table">\n                    <thead>\n                        <tr>\n                            <th>Product Name</th>\n                            <th>Highest RPN</th>\n                            <th>Special Case</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n        ';n.forEach(e=>{const t=e.isCritical?"Yes":"No",n=s();let o=0;e.activeIngredients.forEach(e=>{const t=r(e,n);t.rpn>o&&(o=t.rpn)}),a+=`\n                <tr>\n                    <td>${e.name}</td>\n                    <td>${o.toFixed(1)}</td>\n                    <td>${t}</td>\n                </tr>\n            `}),a+=`\n                    </tbody>\n                </table>\n                \n                <div style="margin-top: 30px; font-size: 10px; color: #666;">\n                    Generated on: ${(new Date).toLocaleString()}\n                </div>\n            </body>\n            </html>\n        `;const o=document.createElement("iframe");o.style.position="absolute",o.style.left="-9999px",o.style.width="0px",o.style.height="0px",document.body.appendChild(o);const i=o.contentWindow.document;i.write(a),i.close(),o.contentWindow.focus(),o.contentWindow.print(),setTimeout(()=>{document.body.removeChild(o)},1e3)}catch(e){console.error("Error printing machine products:",e),alert("Failed to generate print report. Please try again.")}else alert("No machine selected for printing")}export function showAssignMachinesModal(t){const n=e.products.find(e=>e.id===t);if(!n)return;document.getElementById("assignMachineProductId").value=t,document.getElementById("assignMachinesModalTitle").textContent=`Assign Machines to: ${n.name}`;const a=document.getElementById("assignMachinesList");a.innerHTML="";const o=e.machines.some(e=>void 0!==e.line&&null!==e.line),i=n.line?String(n.line).trim():null;e.machineStageDisplayOrder.forEach(t=>{let s=e.machines.filter(e=>e.stage===t);if(o&&i&&(s=s.filter(e=>{const t=String(e.line||"").trim();return t===i||"Shared"===t})),"Mixing"===t?s.sort((e,t)=>{const n=e.name.toLowerCase().includes("bin"),a=t.name.toLowerCase().includes("bin");if(n&&!a)return-1;if(!n&&a)return 1;if(n&&a){return parseInt((e.name.match(/\d+/)||[0])[0],10)-parseInt((t.name.match(/\d+/)||[0])[0],10)}return e.name.localeCompare(t.name)}):s.sort((e,t)=>e.name.localeCompare(t.name)),s.length>0){const e=document.createElement("div"),o=document.createElement("h4");o.className="text-sm font-bold uppercase tracking-wider pb-1 mb-2 border-b",o.style.borderColor="var(--border-color)",o.style.color="var(--text-secondary)",o.textContent="Other"===t?"Other / Custom Stages":t,e.appendChild(o);const i=document.createElement("div");i.className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 pl-2",s.forEach(e=>{const t=n.machineIds&&n.machineIds.includes(e.id),a=document.createElement("div");a.className="flex items-center",a.innerHTML=`\n                            <input type="checkbox" id="machine-check-${e.id}" value="${e.id}" ${t?"checked":""} class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n                            <label for="machine-check-${e.id}" class="ml-2 text-sm font-medium" style="color: var(--text-primary);">${e.name} <span class="text-xs" style="color:var(--text-secondary)">(${e.machineNumber})</span></label>\n                        `,i.appendChild(a)}),e.appendChild(i),a.appendChild(e)}}),document.getElementById("assignMachinesModal").style.display="flex"}export function saveProductMachines(i){i.preventDefault();const s=parseInt(document.getElementById("assignMachineProductId").value),r=e.products.find(e=>e.id===s);if(!r)return;const c=[];document.querySelectorAll('#assignMachinesList input[type="checkbox"]:checked').forEach(e=>{c.push(parseInt(e.value))}),r.machineIds=c,o(),a("assignMachinesModal"),t(),n("Success","Product machines updated successfully.")}export function showAddProductsToMachineModal(t){const n=e.machines.find(e=>e.id===t);if(!n)return;document.getElementById("addProductsMachineId").value=t,document.getElementById("addProductsToMachineModalTitle").textContent=`Assign Products to: ${n.name}`;const a=document.getElementById("addProductsToMachineList"),o=document.getElementById("noAvailableProductsMessage"),i=document.getElementById("addProductsToMachineSaveBtn");a.innerHTML="";const s=e.machines.some(e=>void 0!==e.line&&null!==e.line),r=n.line?String(n.line).trim():null;let c=e.products;if(s&&r&&(c=e.products.filter(e=>{const t=e.line?String(e.line).trim():null;return!t||t===r||"Shared"===r})),c.length>0)o.style.display="none",a.style.display="block",i.style.display="block",c.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const n=e.machineIds&&e.machineIds.includes(t);let o="";e.machineIds&&e.machineIds.some(e=>e!==t)&&(o='<span class="ml-auto text-xs font-semibold px-1.5 py-0.5 rounded" style="background-color: var(--bg-accent); color: var(--text-secondary);" title="This product is also assigned to other machines.">Linked</span>');const i=document.createElement("div");i.className="flex items-center",i.innerHTML=`\n                        <input type="checkbox" id="product-assign-check-${e.id}" value="${e.id}" ${n?"checked":""} class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n                        <label for="product-assign-check-${e.id}" class="ml-3 flex-1 flex items-center text-sm font-medium" style="color: var(--text-primary);">\n                            <span>${e.name} <span class="text-xs" style="color:var(--text-secondary)">(${e.productCode})</span></span>\n                            ${o}\n                        </label>\n                    `,a.appendChild(i)});else{const t=0===e.products.length?"There are no products registered in the system.":`No products available for line "${r}". Products must be from the same line as the machine.`;o.textContent=t,o.style.display="block",a.style.display="none",i.style.display="none"}document.getElementById("addProductsToMachineModal").style.display="flex"}export function saveProductsToMachine(i){i.preventDefault();const s=parseInt(document.getElementById("addProductsMachineId").value);if(isNaN(s))return;const r=[];document.querySelectorAll('#addProductsToMachineList input[type="checkbox"]:checked').forEach(e=>{r.push(parseInt(e.value))}),e.products.forEach(e=>{e.machineIds||(e.machineIds=[]);const t=e.machineIds.includes(s),n=r.includes(e.id);n&&!t?e.machineIds.push(s):!n&&t&&(e.machineIds=e.machineIds.filter(e=>e!==s))}),o(),t(),a("addProductsToMachineModal"),n("Success","Machine assignments updated.")}window.exportMachineProductsToExcel=exportMachineProductsToExcel,window.printMachineProducts=printMachineProducts;