import*as e from"./state.js";import{fullAppRender as t}from"./app.js";import{showLoader as l,hideLoader as d,showCustomAlert as n,hideModal as i,saveStateForUndo as o,updateToggleIcons as r}from"./ui.js";import{getProductTrainId as a,calculateScores as s,populateSelectWithOptions as c}from"./utils.js";import{renderWorstCaseByTrain as u}from"./worstCaseView.js";export function renderProducts(t){if("worstCaseProducts"===t)return void u();const l=document.getElementById(t);if(!l)return;const n=l.querySelector(".productsTable"),i=l.querySelector(".noResultsMessage");let o=[...e.viewProducts[t]];o.sort((t,l)=>{const d=t.line||"Unassigned",n=l.line||"Unassigned",i=t.productType||"Other",o=l.productType||"Other";if(d!==n)return d.localeCompare(n);if(i!==o)return i.localeCompare(o);let r,a;switch(e.sortState.key){case"productCode":r=t.productCode,a=l.productCode;break;case"name":r=t.name,a=l.name;break;case"batchSizeKg":r=t.batchSizeKg,a=l.batchSizeKg;break;case"date":r=new Date(t.date),a=new Date(l.date);break;default:return 0}const s="asc"===e.sortState.direction?1:-1;return r<a?-1*s:r>a?1*s:0}),n.innerHTML="",i.style.display=o.length>0?"none":"block",n.style.display=o.length>0?"":"none",o.forEach((e,t)=>{const l=document.createElement("tr");l.className="product-main-row";const d=e.isCritical?"Yes":"No",i=e.isCritical?"text-red-600 font-bold":"",o=a(e),r="N/A"!==o?"T"+o:"N/A";l.innerHTML=`\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${t+1}</td>\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${new Date(e.date).toLocaleDateString()}</td>\n                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">${e.productCode}</td>\n                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top">\n                        <span class="product-name">${e.name}</span>\n                    </td>\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${e.line||"Not Assigned"}</td>\n                    <td class="px-3 py-3 text-sm font-medium whitespace-nowrap align-top text-center" style="color: var(--text-secondary);">${r}</td>\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${e.productType||"N/A"}</td>\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top" style="color: var(--text-secondary);">${e.batchSizeKg}</td>\n                    <td class="px-3 py-3 text-sm align-top">\n                         <span class="${i}">${d}</span>\n                         ${e.isCritical&&e.criticalReason?`<p class="text-xs italic" style="color: var(--text-secondary); max-width: 200px; white-space: normal;">${e.criticalReason}</p>`:""}\n                    </td>\n                    <td class="px-3 py-3 text-sm whitespace-nowrap align-top">\n                        <div class="flex items-center gap-x-2 no-print">\n                           <button onclick="showAssignMachinesModal(${e.id})" class="p-1" style="color: var(--text-secondary);" title="Assign Machines">\n                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-wide-connected" viewBox="0 0 16 16"><path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.62 1.105l-.09.282c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.09-.282c-.268-1.135.925-1.824 1.62-1.105l.205.211a.96.96 0 0 0 1.622-.434L7.068.727zM12.973 8.5H8.25l-1.03-1.03a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l2.5-2.5a1 1 0 0 0-1.414-1.414L12.973 8.5z"/><path d="M.242 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353-.14l.17-.186c.695-.761 1.888.06 1.62 1.204l-.066.261c-.273.85-.92 1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066-.261c-.268-1.144.925-1.965 1.62-1.204l.17.186a.96.96 0 0 0 1.353.14l.058-.058a.626.626 0 0 1 0-.884zM15.758 4.753a.626.626 0 0 1 .884 0l.058.058a.96.96 0 0 0 1.353.14l.17-.186c.695.761-.925 1.965-1.62 1.204l-.066-.261c-.273-.85-.92-1.368-1.843 1.368h-1.11c-.923 0-1.57-.517-1.843 1.368l-.066.261c-.268 1.144 1.888.443 1.62-1.204l.17-.186a.96.96 0 0 0 1.353-.14l.058-.058a.626.626 0 0 1 0 .884z"/></svg>\n                            </button>\n                             <button onclick="showEditProductModal(${e.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Product"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>\n                            <button onclick="deleteProduct(${e.id})" class="p-1 text-red-500" title="Delete Product">\n                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>\n                            </button>\n                        </div>\n                    </td>\n                `;const s=document.createElement("tr");s.className="ingredients-sub-row";const c=document.createElement("td");c.colSpan=10;let u='\n                    <div class="p-4 ingredients-sub-table rounded-b-lg">\n                        <table class="w-full text-xs">\n                            <thead class="bg-transparent">\n                                <tr class="border-b" style="border-color: var(--border-color);">\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Ingredient</th>\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">TD (mg)</th>\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">MDD (g/day)</th>\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Solubility</th>\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Cleanability</th>\n                                    <th class="pde-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">PDE (mg/day)</th>\n                                    <th class="ld50-col px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">LD50 (mg/kg)</th>\n                                    <th class="px-3 py-2 text-left font-semibold uppercase tracking-wider" style="font-size: 12px !important;">Actions</th>\n                                </tr>\n                            </thead>\n                            <tbody class="bg-transparent">';e.activeIngredients.forEach(t=>{u+=`\n                        <tr>\n                            <td class="px-3 py-2 font-semibold">${t.name}</td>\n                            <td class="px-3 py-2" style="color: var(--text-secondary);">${t.therapeuticDose}</td>\n                            <td class="px-3 py-2" style="color: var(--text-secondary);">${t.mdd/1e3}</td>\n                            <td class="px-3 py-2" style="color: var(--text-secondary);">${t.solubility}</td>\n                            <td class="px-3 py-2" style="color: var(--text-secondary);">${t.cleanability}</td>\n                            <td class="pde-col px-3 py-2" style="color: var(--text-secondary);">${t.pde??"N/A"}</td>\n                            <td class="ld50-col px-3 py-2" style="color: var(--text-secondary);">${t.ld50??"N/A"}</td>\n                            <td class="px-3 py-2">\n                                <div class="flex items-center gap-x-2 no-print">\n                                    <button onclick="showEditIngredientModal(${e.id}, ${t.id})" class="p-1" style="color: var(--text-secondary);" title="Edit Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM12.879 4.379L11 2.5 4.939 8.561a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121L12.879 4.379z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>\n                                    <button onclick="deleteIngredient(${e.id}, ${t.id})" class="p-1 text-red-500" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>\n                                </div>\n                            </td>\n                        </tr>`}),u+="</tbody></table></div>",c.innerHTML=u,s.appendChild(c),n.appendChild(l),n.appendChild(s)}),updateSortIndicators(t),r(t),d()}export function handleSearchAndFilter(t){l();const d=document.getElementById(t);if("worstCaseProducts"===t){const l=document.getElementById("worstCaseProductNameFilter"),d=l?l.value.toLowerCase():"";return e.viewProducts[t]=e.products.filter(e=>e.name.toLowerCase().includes(d)),void renderProducts(t)}const n=d.querySelector(".filterColProductCode").value.toLowerCase(),i=d.querySelector(".filterColProductName").value.toLowerCase(),o=d.querySelector(".filterColLine").value,r=d.querySelector(".filterColTrainNo").value,s=d.querySelector(".filterColProductType").value,c=d.querySelector(".filterColIsCritical").value;e.viewProducts[t]=e.products.filter(e=>{const t=e.productCode.toLowerCase().includes(n),l=e.name.toLowerCase().includes(i),d=a(e),u="all"===r||("N/A"!==d?"T"+d:"N/A")===r,p="all"===o||e.line===o,m="all"===s||e.productType===s,y="all"===c||String(e.isCritical)===c;return t&&l&&u&&p&&m&&y}),renderProducts(t)}export function sortData(t,l){e.sortState.key===t?e.sortState.direction="asc"===e.sortState.direction?"desc":"asc":(e.sortState.key=t,e.sortState.direction="rpn"===t?"desc":"asc"),"worstCaseProducts"===l?u():renderProducts(l)}export function updateSortIndicators(t){const l=document.getElementById(t);l&&"worstCaseProducts"!==t&&l.querySelectorAll(".mainTable th.sortable").forEach(t=>{const l=t.querySelector(".sort-indicator");t.getAttribute("onclick").match(/'(.*?)'/)[1]===e.sortState.key?l.textContent="asc"===e.sortState.direction?"▲":"▼":l.textContent=""})}export function showAddForm(){document.getElementById("addProductForm").innerHTML='<div class="grid grid-cols-1 md:grid-cols-3 gap-4">\n                                  <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="addProductCode" class="w-full px-3 py-2 border rounded-lg" required placeholder="e.g. 1ABC12345DE"></div>\n                                  <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" required></div>\n                                  <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="addProductDate" class="w-full px-3 py-2 border rounded-lg" required></div>\n                              </div>\n                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n                                  <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="addBatchSize" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>\n                                \n                                  <div>\n                                    <label class="block text-sm font-medium mb-1">Line</label>\n                                                                        <select id="addProductLine" class="w-full px-3 py-2 border rounded-lg" required onchange="document.getElementById(\'addOtherLineContainer\').style.display = this.value === \'Other\' ? \'block\' : \'none\'; document.getElementById(\'addOtherLine\').required = this.value === \'Other\'; updateDosageFormOptions(\'add\')">\n                                        <option value="" disabled selected>Select a line...</option>\n                                        <option value="Solids">Solids</option>\n                                        <option value="Semisolid">Semisolid</option>\n                                        <option value="Liquids">Liquids</option>\n                                        <option value="Other">Other</option>\n                                    </select>\n                                                                        <div id="addOtherLineContainer" style="display:none;margin-top:6px;">\n                                                                                <label class="block text-sm font-medium mb-1">Specify Other Line</label>\n                                                                                <input type="text" id="addOtherLine" class="w-full px-3 py-2 border rounded-lg" />\n                                                                        </div>\n                                                                        </div>\n                                  <div>\n                                      <div class="">\n                                        <div>\n                                            <label class="block text-sm font-medium mb-1">Dosage Form</label>\n                                            <select id="addProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="document.getElementById(\'addOtherTypeContainer\').style.display = this.value === \'Other\' ? \'block\' : \'none\'; document.getElementById(\'addOtherProductType\').required = this.value === \'Other\';">\n                                            <option value="" disabled selected>Select a form...</option>\n                                            </select>\n                                        </div>\n                                        <div id="addOtherTypeContainer" style="display: none;">\n                                            <label class="block text-sm font-medium mb-1">Specify Other Form</label>\n                                            <input type="text" id="addOtherProductType" class="w-full px-3 py-2 border rounded-lg">\n                                        </div>\n                                      </div>\n                                  </div>\n                                  <div>\n                    <label class="block text-sm font-medium mb-1">Special Case Product</label>\n                    <select id="editIsCritical" onchange="document.getElementById(\'editCriticalReasonContainer2\').style.display = this.value === \'true\' ? \'block\' : \'none\';" class="w-full px-3 py-2 border rounded-lg">\n                        <option value="false" \'selected\' >No</option>\n                        <option value="true">Yes</option>\n                    </select>\n                </div>\n                <div id="editCriticalReasonContainer2" style="display: none">\n                    <label class="block text-sm font-medium mb-1">Reason for Special Case Status</label>\n                    <textarea id="editCriticalReason" class="w-full px-3 py-2 border rounded-lg" placeholder="Enter reason..."></textarea>\n                </div>\n                              </div>\n                              <div><div class="flex justify-between items-center mb-4"><h4 class="text-lg font-medium">Active Ingredients</h4><button type="button" onclick="addIngredientFormFields(\'ingredientsContainer\')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button></div><div id="ingredientsContainer"></div></div>',document.getElementById("ingredientsContainer").innerHTML="",e.setIngredientFormCounter(0),addIngredientFormFields("ingredientsContainer"),document.getElementById("addProductDate").value=(new Date).toISOString().split("T")[0],document.getElementById("addProductModal").style.display="flex"}export function addIngredientFormFields(t,l=null){const d=!!l;e.setIngredientFormCounter(e.ingredientFormCounter+1);const n=document.getElementById(t),i=document.createElement("div");i.className="border rounded-lg p-4 mb-4 relative ingredient-edit-row",i.style.borderColor="var(--border-color)";const o=d||"editIngredientsContainer"===n.id||n.children.length>0?'<button type="button" onclick="this.closest(\'.ingredient-edit-row\').remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1" title="Remove Ingredient"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>':"";i.innerHTML=`\n        ${o}\n        <input type="hidden" name="ingredientId" value="${l?.id||""}">\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">\n            <div class="md:col-span-2"><label class="block text-xs font-medium mb-1">Ingredient Name</label><input type="text" name="ingredientName" value="${l?.name||""}" class="w-full px-3 py-2 border rounded-lg text-sm" required></div>\n            <div><label class="block text-xs font-medium mb-1">TD (mg)</label><input type="number" step="any" name="therapeuticDose" value="${l?.therapeuticDose||""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>\n            <div><label class="block text-xs font-medium mb-1">MDD (g/day)</label><input type="number" step="any" name="mdd" value="${l?l.mdd/1e3:""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" required></div>\n            <div><label class="block text-xs font-medium mb-1">Solubility</label><select name="solubility" class="w-full px-3 py-2 border rounded-lg text-sm"></select></div>\n            <div><label class="block text-xs font-medium mb-1">Cleanability</label><select name="cleanability" class="w-full px-3 py-2 border rounded-lg text-sm" required></select></div>\n            <div><label class="block text-xs font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" name="pde" value="${l?.pde??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>\n            <div><label class="block text-xs font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" name="ld50" value="${l?.ld50??""}" class="w-full px-3 py-2 border rounded-lg text-sm" min="0" placeholder="Optional"></div>\n        </div>`,n.appendChild(i),populateDynamicSelectsForElement(i),l&&(i.querySelector('select[name="solubility"]').value=l.solubility,i.querySelector('select[name="cleanability"]').value=l.cleanability)}export function populateDynamicSelectsForElement(e){c(e.querySelector('select[name="solubility"], #editSolubility'),"solubility"),c(e.querySelector('select[name="cleanability"], #editCleanability'),"cleanability")}export function showEditProductModal(t){const l=e.products.find(e=>e.id===t);if(!l)return;const d=document.getElementById("editProductForm"),n=l.date?new Date(l.date).toISOString().split("T")[0]:"";d.innerHTML=`\n                <input type="hidden" id="editProductId" value="${l.id}">\n                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n                    <div><label class="block text-sm font-medium mb-1">Product Code</label><input type="text" id="editProductCode" value="${l.productCode}" class="w-full px-3 py-2 border rounded-lg" required></div>\n                    <div><label class="block text-sm font-medium mb-1">Product Name</label><input type="text" id="editProductName" value="${l.name}" class="w-full px-3 py-2 border rounded-lg" required></div>\n                    <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="editProductDate" value="${n}" class="w-full px-3 py-2 border rounded-lg" required></div>\n                    <div><label class="block text-sm font-medium mb-1">Batch Size (Kg)</label><input type="number" step="0.01" id="editBatchSize" value="${l.batchSizeKg}" class="w-full px-3 py-2 border rounded-lg" min="0" required></div>\n  \n                    </div>\n    \n                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n                    <div>\n                    <label class="block text-sm font-medium mb-1">Line</label>\n                    <select id="editProductLine" class="w-full px-3 py-2 border rounded-lg" required onchange="document.getElementById('editOtherLineContainer').style.display = this.value === 'Other' ? 'block' : 'none'; document.getElementById('editOtherLine').required = this.value === 'Other'; updateDosageFormOptions('edit')">\n                        <option value="" disabled selected>Select a line...</option>\n                        <option value="Solids">Solids</option>\n                        <option value="Semisolid">Semisolid</option>\n                        <option value="Liquids">Liquids</option>\n                        <option value="Other">Other</option>\n                    </select>\n                    <div id="editOtherLineContainer" style="display:none;margin-top:6px;">\n                        <label class="block text-sm font-medium mb-1">Specify Other Line</label>\n                        <input type="text" id="editOtherLine" class="w-full px-3 py-2 border rounded-lg">\n                    </div>\n                    </div>\n                    <div>\n                        <label>Dosage Form</label>\n                        <select id="editProductType" class="w-full px-3 py-2 border rounded-lg" required onchange="document.getElementById('editOtherTypeContainer').style.display = this.value === 'Other' ? 'block' : 'none'; document.getElementById('editOtherProductType').required = this.value === 'Other';">\n                        <option value="" disabled selected>Select a form...</option>\n                        </select>\n                    </div>\n                    <div id="editOtherTypeContainer" style="display: none;">\n                        <label class="block text-sm font-medium mb-1">Specify Other Form</label>\n                        <input type="text" id="editOtherProductType" class="w-full px-3 py-2 border rounded-lg">\n                    </div>\n                </div>\n                <div>\n                    <label class="block text-sm font-medium mb-1">Special Case Product</label>\n                    <select id="editIsCritical" onchange="document.getElementById('editCriticalReasonContainer').style.display = this.value === 'true' ? 'block' : 'none';" class="w-full px-3 py-2 border rounded-lg">\n                        <option value="false" ${l.isCritical?"":"selected"}>No</option>\n                        <option value="true" ${l.isCritical?"selected":""}>Yes</option>\n                    </select>\n                </div>\n                <div id="editCriticalReasonContainer" style="display: ${l.isCritical?"block":"none"};">\n                    <label class="block text-sm font-medium mb-1">Reason for Special Case Status</label>\n                    <textarea id="editCriticalReason" class="w-full px-3 py-2 border rounded-lg" placeholder="Enter reason...">${l.criticalReason||""}</textarea>\n                </div>\n                <div class="border-t pt-4 mt-4" style="border-color:var(--border-color);">\n                    <div class="flex justify-between items-center mb-4">\n                        <h4 class="text-lg font-medium">Add New Ingredients</h4>\n                        <button type="button" onclick="addIngredientFormFields('editIngredientsContainer')" class="text-white px-3 py-1 rounded-lg text-sm btn-gradient">+ Add Ingredient</button>\n                    </div>\n                    <div id="editIngredientsContainer" class="space-y-4"></div>\n                </div>\n            `;d.querySelector("#editIngredientsContainer").innerHTML="";const i=d.querySelector("#editProductLine"),o=d.querySelector("#editProductType"),r=d.querySelector("#editOtherProductType"),a=d.querySelector("#editOtherTypeContainer");if(!l.line&&l.productType){const e=["Ointment","Cream","Gel"],t=["Syrup","Solution","Suspension"];["Tablets","Capsules","Powder"].includes(l.productType)?l.line="Solids":e.includes(l.productType)?l.line="Semisolid":t.includes(l.productType)?l.line="Liquids":l.line=""}if(l.line){if(Array.from(i.options).map(e=>e.value).filter(Boolean).includes(l.line))i.value=l.line;else{i.value="Other";const e=d.querySelector("#editOtherLine");e&&(e.value=l.line,d.querySelector("#editOtherLineContainer").style.display="block",e.required=!0)}}try{updateDosageFormOptions("edit")}catch(e){}const s=Array.from(o.options).map(e=>e.value).filter(Boolean);l.productType&&s.includes(l.productType)?(o.value=l.productType,a.style.display="none",r.required=!1):l.productType?(s.includes("Other")||(o.innerHTML+='<option value="Other">Other</option>'),o.value="Other",r.value=l.productType||"",a.style.display="block",r.required=!0):(a.style.display="none",r.required=!1),document.getElementById("editProductModalTitle").textContent=`Edit Product: ${l.name}`,document.getElementById("editProductModal").style.display="flex"}export function saveProductChanges(l){l.preventDefault();const d=parseInt(document.getElementById("editProductId").value),r=e.products.find(e=>e.id===d);if(!r)return void n("Error","Could not find product to update.");let a=document.getElementById("editProductType").value;if("Other"===a){const e=document.getElementById("editOtherProductType").value.trim();if(!e)return void n("Validation Error","Please specify the 'Other' dosage form.");a=e}let s=document.getElementById("editProductLine").value;if("Other"===s&&(s=document.getElementById("editOtherLine").value.trim(),!s))return void n("Validation Error","Please specify the Other Line.");r.line=s,r.productCode=document.getElementById("editProductCode").value,r.name=document.getElementById("editProductName").value,r.date=new Date(document.getElementById("editProductDate").value).toISOString(),r.batchSizeKg=parseFloat(document.getElementById("editBatchSize").value),r.productType=a,r.isCritical="true"===document.getElementById("editIsCritical").value,r.criticalReason=r.isCritical?document.getElementById("editCriticalReason").value:"";if(e.products.find(e=>e.id!==d&&e.productCode.toLowerCase()===r.productCode.toLowerCase()))return void n("Validation Error",`Product code "${r.productCode}" already exists. Please use a unique product code.`);const c=[],u=document.querySelectorAll("#editIngredientsContainer .ingredient-edit-row");let p=!0;if(u.forEach(t=>{if(!p)return;const l={id:e.nextIngredientId};l.name=t.querySelector('[name="ingredientName"]').value.trim(),l.therapeuticDose=parseFloat(t.querySelector('[name="therapeuticDose"]').value),l.mdd=1e3*parseFloat(t.querySelector('[name="mdd"]').value),l.solubility=t.querySelector('[name="solubility"]').value,l.cleanability=t.querySelector('[name="cleanability"]').value;const d=t.querySelector('[name="pde"]').value,n=t.querySelector('[name="ld50"]').value;l.pde=d?parseFloat(d):null,l.ld50=n?parseFloat(n):null,!l.name||isNaN(l.therapeuticDose)||isNaN(l.mdd)||!l.solubility||!l.cleanability||null===l.pde&&null===l.ld50?p=!1:(c.push(l),e.setNextDetergentIngredientId(e.nextIngredientId+1))}),!p)return n("Validation Error","Please fill all required fields for each newly added ingredient."),void(nextIngredientId-=c.length);r.activeIngredients.push(...c),o(),t(),i("editProductModal"),n("Success","Product updated successfully.")}export function showEditIngredientModal(t,l){const d=e.products.find(e=>e.id===t),i=d?.activeIngredients.find(e=>e.id===l);if(!i)return void n("Error","Could not find ingredient to edit.");const o=document.getElementById("editIngredientForm");o.innerHTML=`<input type="hidden" id="editIngredientProductId" value="${t}"><input type="hidden" id="editIngredientId" value="${l}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Ingredient Name</label><input type="text" id="editIngredientName" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">TD (mg)</label><input type="number" step="any" id="editTherapeuticDose" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">MDD (g/day)</label><input type="number" step="any" id="editMdd" class="w-full px-3 py-2 border rounded-lg" min="0" required></div><div><label class="block text-sm font-medium mb-1">Solubility</label><select id="editSolubility" class="w-full px-3 py-2 border rounded-lg"></select></div><div><label class="block text-sm font-medium mb-1">Cleanability</label><select id="editCleanability" class="w-full px-3 py-2 border rounded-lg" required></select></div><div><label class="block text-sm font-medium mb-1">PDE (mg/day)</label><input type="number" step="any" id="editPde" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div><div><label class="block text-sm font-medium mb-1">LD50 (mg/kg)</label><input type="number" step="any" id="editLd50" class="w-full px-3 py-2 border rounded-lg" min="0" placeholder="Optional"></div></div>`,document.getElementById("editIngredientModalTitle").textContent=`Edit: ${i.name}`,document.getElementById("editIngredientName").value=i.name,document.getElementById("editTherapeuticDose").value=i.therapeuticDose,document.getElementById("editMdd").value=i.mdd/1e3,document.getElementById("editPde").value=i.pde??"",document.getElementById("editLd50").value=i.ld50??"",populateDynamicSelectsForElement(o),document.getElementById("editSolubility").value=i.solubility,document.getElementById("editCleanability").value=i.cleanability,document.getElementById("editIngredientModal").style.display="flex"}export function saveIngredientChanges(l){l.preventDefault();const d=parseInt(document.getElementById("editIngredientProductId").value),r=parseInt(document.getElementById("editIngredientId").value),a=e.products.find(e=>e.id===d),s=a?.activeIngredients.find(e=>e.id===r);if(!s)return void n("Error","Save failed. Could not find original ingredient.");const c=document.getElementById("editPde").value,u=document.getElementById("editLd50").value;s.name=document.getElementById("editIngredientName").value.trim(),s.therapeuticDose=parseFloat(document.getElementById("editTherapeuticDose").value),s.mdd=1e3*parseFloat(document.getElementById("editMdd").value),s.solubility=document.getElementById("editSolubility").value,s.cleanability=document.getElementById("editCleanability").value,s.pde=c?parseFloat(c):null,s.ld50=u?parseFloat(u):null,!s.name||isNaN(s.therapeuticDose)||isNaN(s.mdd)||!s.solubility||!s.cleanability||null===s.pde&&null===s.ld50?n("Validation Error","Please fill all required fields."):(o(),i("editIngredientModal"),t(),n("Success",`${s.name} was updated successfully.`))}export function deleteProduct(l){if(confirm("Are you sure you want to delete this entire product?")){const d=e.products.filter(e=>e.id!==l);e.setProducts(d),o(),t()}}export function deleteIngredient(l,d){const i=e.products.find(e=>e.id===l);if(i){if(1===i.activeIngredients.length)return void n("Cannot Remove","A product must have at least one ingredient. To remove this, please delete the entire product.");confirm("Are you sure you want to remove this ingredient?")&&(i.activeIngredients=i.activeIngredients.filter(e=>e.id!==d),o(),t())}}export function populateFilterSelects(){const t=[...new Set(e.products.map(e=>e.productType))].sort();c(document.querySelector(".filterColProductType"),null,!0,t);const l=[...new Set(e.products.map(e=>e.line).filter(Boolean))].sort();c(document.querySelector(".filterColLine"),null,!0,l);const d=document.querySelector(".filterColTrainNo");if(d){const t=[...new Set(e.products.map(e=>a(e)).filter(e=>"N/A"!==e))].sort((e,t)=>e-t);d.innerHTML='<option value="all">All</option>',t.forEach(e=>{d.innerHTML+=`<option value="T${e}">T${e}</option>`})}}export function resetFilters(t){const l=document.getElementById(t);l.querySelectorAll('.filter-row input[type="text"], .filter-row input[type="number"]').forEach(e=>e.value=""),l.querySelectorAll(".filter-row select").forEach(e=>e.value="all"),e.sortState.key="rpn",e.sortState.direction="desc",handleSearchAndFilter(t)}export function addNewProduct(l){l.preventDefault();const d=document.getElementById("addProductCode").value.trim(),r=document.getElementById("addProductName").value.trim(),a=parseFloat(document.getElementById("addBatchSize").value),s=new Date(document.getElementById("addProductDate").value).toISOString();let c=document.getElementById("addProductType").value,u=document.getElementById("addProductLine").value;if("Other"===u){const e=document.getElementById("addOtherLine").value.trim();if(!e)return void n("Validation Error","Please specify the Other Line.");u=e}if("Other"===c){const e=document.getElementById("addOtherProductType").value.trim();if(!e)return void n("Validation Error","Please specify the 'Other' dosage form or choose a different option.");c=e}if(!d||!r||!s||isNaN(a)||a<=0||!c)return void n("Validation Error","Please fill all required product fields, including Dosage Form.");if(e.products.find(e=>e.productCode.toLowerCase()===d.toLowerCase()))return void n("Validation Error",`Product code "${d}" already exists. Please use a unique product code.`);const p=document.querySelectorAll("#ingredientsContainer > div"),m=[];let y=!0;if(p.forEach(t=>{if(!y)return;const l={id:e.nextIngredientId};e.setNextIngredientId(e.nextIngredientId+1),l.name=t.querySelector('[name="ingredientName"]').value.trim(),l.therapeuticDose=parseFloat(t.querySelector('[name="therapeuticDose"]').value),l.mdd=1e3*parseFloat(t.querySelector('[name="mdd"]').value),l.solubility=t.querySelector('[name="solubility"]').value,l.cleanability=t.querySelector('[name="cleanability"]').value;const d=t.querySelector('[name="pde"]').value,n=t.querySelector('[name="ld50"]').value;l.pde=d?parseFloat(d):null,l.ld50=n?parseFloat(n):null,!l.name||isNaN(l.therapeuticDose)||isNaN(l.mdd)||!l.solubility||!l.cleanability||null===l.pde&&null===l.ld50?y=!1:m.push(l)}),!y)return n("Validation Error","Please fill all required fields for each ingredient."),void e.setNextIngredientId(e.nextIngredientId-m.length);const g={id:e.nextProductId,productCode:d,name:r,batchSizeKg:a,date:s,productType:c,line:u,machineIds:[],activeIngredients:m,isCritical:!1,criticalReason:""};e.setNextProductId(e.nextProductId+1);const v=[...e.products,g];e.setProducts(v),o(),t(),i("addProductModal")}window.updateDosageFormOptions=function(e){let t=document.getElementById("add"===e?"addProductLine":"editProductLine").value;if(!["Solids","Semisolid","Liquids","Other","Others"].includes(t))try{"add"===e?(document.getElementById("addOtherLineContainer").style.display="block",document.getElementById("addOtherLine").value=t,document.getElementById("addProductLine").value="Other"):(document.getElementById("editOtherLineContainer").style.display="block",document.getElementById("editOtherLine").value=t,document.getElementById("editProductLine").value="Other"),t="Other"}catch(e){}let l=[];"Solids"===t?l=["Tablets","Capsules","Powder","Other"]:"Semisolid"===t?l=["Ointment","Cream","Gel","Other"]:"Liquids"===t?l=["Syrup","Solution","Suspension","Other"]:"Other"===t&&(l=["Other"]),document.getElementById("add"===e?"addProductType":"editProductType").innerHTML='<option value="" disabled selected>Select a form...</option>'+l.map(e=>`<option value="${e}">${e}</option>`).join("")};