import*as e from"./state.js";import{fullAppRender as t}from"./app.js";import{generateTrainMap as o}from"./utils.js";import{toggleScoringEditMode as r}from"./scoringView.js";import{renderRpnChart as n}from"./worstCaseView.js";import{renderMacoChart as a}from"./dashboardView.js";const s=document.getElementById("loader");export const showLoader=()=>s.style.display="flex";export const hideLoader=()=>s.style.display="none";export function showCustomAlert(e,t){document.getElementById("customAlertTitle").textContent=e,document.getElementById("customAlertMessage").textContent=t,document.getElementById("customAlertModal").style.display="flex"}export const hideModal=e=>document.getElementById(e).style.display="none";export function saveAllDataToLocalStorage(){try{localStorage.setItem("macoProducts",JSON.stringify(e.products)),localStorage.setItem("macoMachines",JSON.stringify(e.machines)),localStorage.setItem("macoScoringCriteria",JSON.stringify(e.scoringCriteria)),localStorage.setItem("macoDetergentIngredients",JSON.stringify(e.detergentIngredients)),localStorage.setItem("machineStageDisplayOrder",JSON.stringify(e.machineStageDisplayOrder))}catch(e){console.error("Failed to save data to localStorage",e),showCustomAlert("Save Error","Could not save data. Storage might be full.")}}export function loadAllDataFromLocalStorage(){const t=localStorage.getItem("macoProducts"),o=localStorage.getItem("macoMachines"),r=localStorage.getItem("macoScoringCriteria"),n=localStorage.getItem("macoDetergentIngredients"),a=localStorage.getItem("machineStageDisplayOrder");if(t)try{e.setProducts(JSON.parse(t))}catch(e){console.error("Error loading products",e)}if(o)try{e.setMachines(JSON.parse(o))}catch(e){console.error("Error loading machines",e)}if(r)try{e.setScoringCriteria(JSON.parse(r))}catch(e){console.error("Error loading scoring criteria",e)}if(n)try{e.setDetergentIngredients(JSON.parse(n))}catch(e){console.error("Error loading detergent ingredients",e)}if(a)try{e.setMachineStageDisplayOrder(JSON.parse(a))}catch(e){console.error("Error loading machine stage order",e)}}export function saveStateForUndo(){o();const t=e.history.slice(0,e.historyIndex+1),r={products:JSON.parse(JSON.stringify(e.products)),machines:JSON.parse(JSON.stringify(e.machines)),scoringCriteria:JSON.parse(JSON.stringify(e.scoringCriteria)),detergentIngredients:JSON.parse(JSON.stringify(e.detergentIngredients))};t.push(r),e.setHistory(t,t.length-1),updateUndoRedoButtons(),saveAllDataToLocalStorage()}export function updateUndoRedoButtons(){const t=document.getElementById("undo-btn"),o=document.getElementById("redo-btn");t&&(t.disabled=e.historyIndex<=0),o&&(o.disabled=e.historyIndex>=e.history.length-1)}export function undoChange(){if(e.historyIndex>0){const o=e.historyIndex-1,n=e.history[o];e.setProducts(JSON.parse(JSON.stringify(n.products))),e.setMachines(JSON.parse(JSON.stringify(n.machines))),e.setScoringCriteria(JSON.parse(JSON.stringify(n.scoringCriteria))),e.setDetergentIngredients(JSON.parse(JSON.stringify(n.detergentIngredients))),e.setHistory(e.history,o),e.scoringInEditMode&&r(!1),t(),updateUndoRedoButtons(),saveAllDataToLocalStorage()}}export function redoChange(){if(e.historyIndex<e.history.length-1){const o=e.historyIndex+1,n=e.history[o];e.setProducts(JSON.parse(JSON.stringify(n.products))),e.setMachines(JSON.parse(JSON.stringify(n.machines))),e.setScoringCriteria(JSON.parse(JSON.stringify(n.scoringCriteria))),e.setDetergentIngredients(JSON.parse(JSON.stringify(n.detergentIngredients))),e.setHistory(e.history,o),e.scoringInEditMode&&r(!1),t(),updateUndoRedoButtons(),saveAllDataToLocalStorage()}}export function toggleDarkMode(t){const o=document.getElementById("theme-toggle-light-icon"),r=document.getElementById("theme-toggle-dark-icon");t?(document.documentElement.classList.add("dark"),o&&o.classList.add("hidden"),r&&r.classList.remove("hidden")):(document.documentElement.classList.remove("dark"),o&&o.classList.remove("hidden"),r&&r.classList.add("hidden")),e.rpnChartInstance&&n(),e.macoChartInstance&&a()}export function printCurrentView(t,o="all"){"scoring-system"===t&&e.scoringInEditMode&&(e.setScoringWasInEditModeForPrint(!0),r(!1)),console.log("Printing view:",t,"Train:",o),document.body.classList.add(`printing-${t}`),"worstCaseProducts"===t?import("./worstCaseView.js").then(e=>{window.printSelectedTrain=o,e.renderWorstCaseByTrain(),setTimeout(()=>{window.print()},200)}):"macoForTrains"===t?(window.printSelectedTrain=o,import("./macoProductView.js").then(e=>{e.renderMacoForTrains();const t=document.querySelectorAll("#macoForTrains .train-content.collapsed"),o=[];t.forEach(e=>{const t=e.id.match(/content-pm-(\d+)/);if(t){o.push(t[1]),e.classList.remove("collapsed");const r=document.getElementById(`toggle-pm-${t[1]}`);r&&(r.textContent="▼")}});const r=document.querySelectorAll('#macoForTrains [id^="maco-breakdown-details-"].hidden'),n=[];r.forEach(e=>{const t=e.id.match(/maco-breakdown-details-(\d+)/);if(t){n.push(t[1]),e.classList.remove("hidden");const o=document.getElementById(`breakdown-toggle-btn-${t[1]}`);o&&(o.textContent="Hide MACO Calculation Breakdown")}}),setTimeout(()=>{window.print(),setTimeout(()=>{o.forEach(e=>{const t=document.getElementById(`content-pm-${e}`),o=document.getElementById(`toggle-pm-${e}`);t&&t.classList.add("collapsed"),o&&(o.textContent="▶")}),n.forEach(e=>{const t=document.getElementById(`maco-breakdown-details-${e}`),o=document.getElementById(`breakdown-toggle-btn-${e}`);t&&t.classList.add("hidden"),o&&(o.textContent="Show MACO Calculation Breakdown")})},1e3)},200)})):"detergentMaco"===t?(window.printSelectedTrain=o,import("./macoDetergentView.js").then(e=>{e.renderDetergentMaco();const t=document.querySelectorAll("#detergentMaco .train-content.collapsed"),o=[];t.forEach(e=>{const t=e.id.match(/content-dm-(\d+)/);if(t){o.push(t[1]),e.classList.remove("collapsed");const r=document.getElementById(`toggle-dm-${t[1]}`);r&&(r.textContent="▼")}}),setTimeout(()=>{window.print(),setTimeout(()=>{o.forEach(e=>{const t=document.getElementById(`content-dm-${e}`),o=document.getElementById(`toggle-dm-${e}`);t&&t.classList.add("collapsed"),o&&(o.textContent="▶")})},1e3)},200)}).catch(e=>{console.error("Error loading detergent view for print:",e),window.print()}).finally(()=>{setTimeout(()=>{window.printSelectedTrain=null,import("./macoDetergentView.js").then(e=>e.renderDetergentMaco()).catch(()=>{})},1200)})):"trainSummary"===t?(window.printSelectedTrain=o,console.log("Setting printSelectedTrain to:",o),import("./trainSummaryView.js").then(e=>{e.renderTrainSummary(),setTimeout(()=>{const t=document.getElementById("trainSummaryContainer"),o=document.getElementById("noTrainSummaryMessage");if(console.log("Container display:",t?t.style.display:"not found"),console.log("No trains message display:",o?o.style.display:"not found"),console.log("Container has content:",!!t&&t.innerHTML.length>0),!t||"none"===t.style.display)return console.warn("Train summary container is hidden or missing"),void alert("No train data to print. Please ensure you have created trains first.");window.print(),setTimeout(()=>{window.printSelectedTrain=null,e.renderTrainSummary()},1e3)},500)}).catch(e=>{console.error("Error loading train summary view:",e),alert("Error loading train summary: "+e.message)})):setTimeout(()=>{window.print()},100)}export function toggleColumn(e,t){if("pde"===e||"ld50"===e){["productRegister","worstCaseProducts"].forEach(t=>{document.querySelectorAll(`#${t} .mainTable, #${t} .ingredients-sub-table`).forEach(t=>{t.classList.toggle(`hide-${e}`)}),document.querySelectorAll(`#${t}, #${t} .train-content-inner`).forEach(t=>{t&&t.classList.toggle(`hide-${e}`)})});const t=null!==document.querySelector(`#productRegister .mainTable.hide-${e}`);localStorage.setItem(`productRegister-${e}Hidden`,t),updateToggleIcons("productRegister"),updateToggleIcons("worstCaseProducts"),import("./worstCaseView.js").then(e=>{e.renderWorstCaseByTrain()}),import("./worstCaseView.js").then(e=>{e.renderRpnChart&&e.renderRpnChart()})}else{document.querySelectorAll(`#${t} .mainTable, #${t} .ingredients-sub-table`).forEach(t=>{t.classList.toggle(`hide-${e}`)});const o=null!==document.querySelector(`#${t} .mainTable.hide-${e}`);localStorage.setItem(`${t}-${e}Hidden`,o),updateToggleIcons(t)}}export function toggleColumnVisibilityDropdown(){const e=document.getElementById("columnVisibilityDropdown");e.classList.toggle("hidden"),e.classList.contains("hidden")||document.addEventListener("click",function t(o){o.target.closest("#columnVisibilityDropdown")||o.target.closest('button[onclick="toggleColumnVisibilityDropdown()"]')||(e.classList.add("hidden"),document.removeEventListener("click",t))})}export function updateToggleIcons(e){const t=document.getElementById(e);if(!t)return;let o,r;if("worstCaseProducts"===e){const e=localStorage.getItem("productRegister-pdeHidden"),t=localStorage.getItem("productRegister-ld50Hidden");if(null===e&&null===t)o=!1,r=!1;else{const n="true"===e,a="true"===t;n&&a?(o=!1,r=!0):(o=n,r=a)}}else{const t=localStorage.getItem(`${e}-pdeHidden`),n=localStorage.getItem(`${e}-ld50Hidden`);o="true"===t,r="true"===n}const n=t.querySelector(".toggle-pde"),a=t.querySelector(".toggle-ld50");n&&(n.innerHTML=o?"Show PDE":"Hide PDE"),a&&(a.innerHTML=r?"Show LD50":"Hide LD50");document.querySelectorAll(`#${e} .mainTable, #${e} .ingredients-sub-table`).forEach(e=>{e&&(e.classList.toggle("hide-pde",o),e.classList.toggle("hide-ld50",r))});document.querySelectorAll(`#${e}, #${e} .train-content-inner`).forEach(e=>{e&&(e.classList.toggle("hide-pde",o),e.classList.toggle("hide-ld50",r))})}export function exportToExcel(){showLoader(),import("./utils.js").then(t=>{const{getProductTrainId:o,calculateScores:r}=t,n=[];if(e.products.forEach(e=>{let t="No";e.isCritical&&(t="Yes"+(e.criticalReason?`: ${e.criticalReason}`:""));const a=o(e),s=e.date?new Date(e.date).toLocaleDateString():"";n.push({Date:s,"Product Code":e.productCode,"Product Name":e.name,"Train No.":a,"Dosage Form":e.productType||"","Batch Size (Kg)":e.batchSizeKg,"Special Case Product":t,"Active Ingredient":"",Solubility:"","Therapeutic Dose (mg/day)":"",Cleanability:"","PDE (µg/day)":"","LD50 (mg/kg)":"","Solubility Score":"","Therapeutic Dose Score":"","Cleanability Score":"","Toxicity Score":"",RPN:"","RPN Rating":""}),e.activeIngredients.forEach(e=>{const t=r(e);n.push({Date:"","Product Code":"","Product Name":`  └─ ${e.name}`,"Train No.":"","Dosage Form":"","Batch Size (Kg)":"","Special Case Product":"","Active Ingredient":e.name,Solubility:e.solubility||"","Therapeutic Dose (mg/day)":e.therapeuticDose||"",Cleanability:e.cleanability||"","PDE (µg/day)":e.pde||"","LD50 (mg/kg)":e.ld50||"","Solubility Score":t.solubilityScore||"","Therapeutic Dose Score":t.therapeuticDoseScore||"","Cleanability Score":t.cleanabilityScore||"","Toxicity Score":t.pdeScore||t.ld50Score||"",RPN:t.rpn,"RPN Rating":t.rpnRatingText})})}),0===n.length)return hideLoader(),void showCustomAlert("No Data","There is no data in the current view to export.");const a=XLSX.utils.json_to_sheet(n),s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,a,"MACO Report");const i=Object.keys(n[0]).map(e=>({wch:Math.max(e.length,...n.map(t=>String(t[e]||"").length))+2}));a["!cols"]=i,XLSX.writeFile(s,"MACO_All_Products_Report.xlsx"),hideLoader()}).catch(e=>{console.error("Error exporting to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export data to Excel.")})}export function exportAllToJson(){showLoader();try{const t={exportDate:(new Date).toISOString(),scoringCriteria:e.scoringCriteria,products:e.products,machines:e.machines,detergentIngredients:e.detergentIngredients},o=JSON.stringify(t,null,2),r=new Blob([o],{type:"application/json"}),n=URL.createObjectURL(r),a=document.createElement("a");a.href=n,a.download="maco_data_export.json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}catch(e){showCustomAlert("Error","Failed to export data to JSON."+e.message)}finally{hideLoader()}}export function importFromJson(o){const r=o.target.files[0];if(!r)return;const n=new FileReader;n.onload=function(r){try{const o=JSON.parse(r.target.result);o&&o.products&&o.scoringCriteria&&o.machines?(e.setProducts(o.products),e.setMachines(o.machines),e.setScoringCriteria(o.scoringCriteria),o.detergentIngredients&&e.setDetergentIngredients(o.detergentIngredients),saveStateForUndo(),t(),showCustomAlert("Success","Data imported successfully.")):showCustomAlert("Error","Invalid JSON file structure.")}catch(e){showCustomAlert("Error","Failed to parse JSON file.")}finally{o.target.value=""}},n.readAsText(r)}export function toggleOtherProductType(e,t){const o=document.getElementById(t),r=o.querySelector("input");"Other"===e.value?(o.style.display="block",r.required=!0):(o.style.display="none",r.required=!1,r.value="")}export function toggleOtherMachineStage(e,t){const o=document.getElementById(t),r=o.querySelector("input");"Other"===e.value?(o.style.display="block",r.required=!0):(o.style.display="none",r.required=!1,r.value="")}export function toggleOtherMachineGroup(e,t){const o=document.getElementById(t),r=o.querySelector("input");"Other"===e.value?(o.style.display="block",r.required=!0):(o.style.display="none",r.required=!1,r.value="")}export function clampSafetyFactor(e,t){const o=parseFloat(e.min),r=parseFloat(e.max);let n=parseFloat(e.value);isNaN(n)&&(n=o),n<o?n=o:n>r&&(n=r),parseFloat(e.value)!==n&&(e.value=n),e.id.startsWith("product-sf-input")?recalculateProductMacoForTrain(t):e.id.startsWith("sf-input-train")&&recalculateDetergentMacoForTrain(t)}export function toggleTrain(e){const t=document.getElementById(`content-${e}`),o=document.getElementById(`toggle-${e}`);t&&o&&(t.classList.contains("collapsed")?(t.classList.remove("collapsed"),o.textContent="▼"):(t.classList.add("collapsed"),o.textContent="▶"))}export function toggleMacoBreakdown(e){const t=document.getElementById(`maco-breakdown-details-${e}`),o=document.getElementById(`breakdown-toggle-btn-${e}`);t.classList.contains("hidden")?(t.classList.remove("hidden"),o.textContent="Hide MACO Calculation Breakdown"):(t.classList.add("hidden"),o.textContent="Show MACO Calculation Breakdown")}export function exportWorstCaseToExcel(t="all"){showLoader(),import("./utils.js").then(o=>{const{getProductTrainId:r,calculateScores:n,getToxicityPreference:a}=o,s=[];let i=e.viewProducts.worstCaseProducts||e.products;if(0===i.length)return hideLoader(),void showCustomAlert("No Data","There are no products in the worst case view to export.");const c={};i.forEach(e=>{const t=r(e);"N/A"!==t&&(c[t]||(c[t]=[]),c[t].push(e))});let d=c;if("all"!==t&&(d={},Array.isArray(t)?t.forEach(e=>{c[e]&&(d[e]=c[e])}):c[t]&&(d={[t]:c[t]}),0===Object.keys(d).length)){hideLoader();return void showCustomAlert("No Data",`${Array.isArray(t)?`Trains ${t.join(", ")}`:`Train ${t}`} not found or has no products.`)}const l=a();if(Object.keys(d).sort((e,t)=>e-t).forEach(e=>{const t=d[e];s.push({Train:`Train ${e} - Worst Case Analysis`,"Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""}),t.forEach(e=>{const t=e.activeIngredients.map(e=>n(e,l).rpn);e.sortValue=t.length>0?Math.max(...t):0}),t.sort((e,t)=>t.sortValue-e.sortValue),t.forEach(e=>{const t=e.isCritical?"Yes":"No";s.push({Train:"","Product Code":e.productCode,"Product Name":e.name,"Highest RPN":e.sortValue,"Special Case Product":t,Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""});e.activeIngredients.sort((e,t)=>n(t,l).rpn-n(e,l).rpn).forEach(e=>{const t=n(e,l);s.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:e.name,"TD Score":t.therapeuticDoseScore,"Solubility Score":t.solubilityScore,"Cleanability Score":t.cleanabilityScore,"PDE Score":t.pdeScore??"N/A","LD50 Score":t.ld50Score??"N/A",RPN:t.rpn,Rating:t.rpnRatingText})}),s.push({Train:"","Product Code":"","Product Name":"","Highest RPN":"","Special Case Product":"",Ingredient:"","TD Score":"","Solubility Score":"","Cleanability Score":"","PDE Score":"","LD50 Score":"",RPN:"",Rating:""})})}),0===s.length)return hideLoader(),void showCustomAlert("No Data","There is no data in the worst case view to export.");const u=XLSX.utils.json_to_sheet(s),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,u,"Worst Case Products");const g=Object.keys(s[0]).map(e=>({wch:Math.max(e.length,...s.map(t=>String(t[e]||"").length))+2}));u["!cols"]=g;const h=(new Date).toISOString().split("T")[0];let p="";"all"!==t&&(p=Array.isArray(t)?`_Trains_${t.join("_")}`:`_Train_${t}`),XLSX.writeFile(m,`MACO_Worst_Case_Products${p}_${h}.xlsx`),hideLoader()}).catch(e=>{console.error("Error exporting worst case to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export worst case data to Excel.")})}export function exportMachinesToExcel(){showLoader();try{if(0===e.machines.length)return hideLoader(),void showCustomAlert("No Data","There are no machines to export.");const t=[],o={};e.machines.forEach(e=>{o[e.stage]||(o[e.stage]=[]),o[e.stage].push(e)}),e.machineStageDisplayOrder.forEach(r=>{o[r]&&o[r].forEach(o=>{const r=e.products.filter(e=>e.machineIds&&e.machineIds.includes(o.id)),n=r.map(e=>e.name).join(", ")||"None",a=r.length;t.push({"Machine Number":o.machineNumber,"Machine Name":o.name,Stage:o.stage,"Area (sq cm)":o.area,"Assigned Products Count":a,"Assigned Products":n})})});const r=XLSX.utils.json_to_sheet(t),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,r,"Machines");const a=[{wch:15},{wch:20},{wch:15},{wch:15},{wch:20},{wch:50}];r["!cols"]=a;const s=(new Date).toISOString().split("T")[0];XLSX.writeFile(n,`MACO_Machines_${s}.xlsx`),hideLoader(),showCustomAlert("Success","Machines data exported to Excel successfully!")}catch(e){console.error("Error exporting machines to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export machines data to Excel.")}}export function exportProductMacoToExcel(t="all"){showLoader(),import("./utils.js").then(o=>{const{getTrainData:r,getWorstCaseProductType:n,getMacoPerSwabForTrain:a,getLargestEssaForLineAndDosageForm:s}=o,i=r();if(0===i.length)return hideLoader(),void showCustomAlert("No Data","There are no trains to export. Assign machines to products first.");let c=i;if("all"!==t&&(c=Array.isArray(t)?i.filter(e=>t.includes(String(e.id))):i.filter(e=>String(e.id)===String(t))),0===c.length)return hideLoader(),void showCustomAlert("No Data","No trains match the selected criteria.");const d=[];c.forEach(t=>{const o=n(t.products.map(e=>e.productType)),r=(e.safetyFactorConfig[o]||e.safetyFactorConfig.Other).max,a=t.lowestLtd*t.minBsMddRatio/r,c=10*t.minMbsKg;let l=1/0,u=1/0;const m="true"===localStorage.getItem("productRegister-pdeHidden"),g="true"===localStorage.getItem("productRegister-ld50Hidden");if(null===t.lowestPde||m||(l=t.lowestPde*t.minBsMddRatio),null!==t.lowestLd50&&!g){const e=70*t.lowestLd50/2e3,o=t.products.flatMap(e=>e.activeIngredients.map(e=>e.mdd/1e3)),n=Math.min(...o);u=e*t.minMbsKg*1e3/(r*n)}const h=s(t,i),p=.004*h,S=[{name:"0.1% Therapeutic Dose",value:a},{name:"10 ppm Criterion",value:c}];null===t.lowestPde||m||S.push({name:"Health-Based Limit (PDE)",value:l}),null===t.lowestLd50||g||S.push({name:"Health-Based Limit (NOEL)",value:u}),S.push({name:"Visual Clean Limit",value:p});const w=S.reduce((e,t)=>t.value<e.value?t:e),y=w.value,C=h>0?y/h:0,f=C*t.assumedSsa,N=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),A=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),P=t.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),T=t.worstProductRpn?`${t.worstProductRpn.productName} (${t.worstProductRpn.ingredientName}) - RPN: ${t.worstProductRpn.rpn}`:"N/A";d.push({Train:`T${t.id}`,"Total Products":t.products.length,"Total Machines":N.length,"Total Area (ESSA) cm²":t.essa.toLocaleString(),Products:P,Machines:A,"Worst-Case Dosage Form":o,"Safety Factor":r,"Lowest LTD (mg)":t.lowestLtd,"Min Batch Size (kg)":t.minMbsKg,"Min BS/MDD Ratio":t.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":null!==t.lowestPde?t.lowestPde:"N/A","Worst-Case Product (by RPN)":T,"MACO - Therapeutic Dose (mg)":a.toFixed(2),"MACO - 10 ppm (mg)":c.toFixed(2),"MACO - Health-Based (mg)":"number"==typeof l?l.toFixed(2):"N/A","MACO - Visual Clean (mg)":p.toFixed(2),"Selected MACO Method":w.name,"Final MACO (mg)":y.toFixed(2),"MACO per Area (mg/cm²)":C.toExponential(3),"MACO per Swab (mg/Swab)":f.toFixed(4)})});const l=XLSX.utils.json_to_sheet(d),u=XLSX.utils.book_new();XLSX.utils.book_append_sheet(u,l,"Product MACO Report");l["!cols"]=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:40},{wch:18},{wch:15},{wch:18},{wch:15},{wch:20},{wch:15},{wch:18},{wch:18}];const m=(new Date).toISOString().split("T")[0];let g="Product_MACO_Report";if("all"!==t)if(Array.isArray(t)){g+=`_Trains_${t.sort((e,t)=>e-t).join("_")}`}else g+=`_Train_${t}`;g+=`_${m}.xlsx`,XLSX.writeFile(u,g),hideLoader(),showCustomAlert("Success","Product MACO data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Product MACO to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export Product MACO data to Excel.")})}export function exportDetergentMacoToExcel(t="all"){showLoader(),import("./utils.js").then(o=>{const{getTrainData:r,getWorstCaseProductType:n}=o;let a=r();if("all"!==t&&(a=Array.isArray(t)?a.filter(e=>t.includes(String(e.id))):a.filter(e=>String(e.id)===String(t))),0===a.length)return hideLoader(),void showCustomAlert("No Data","There are no trains to export. Assign machines to products first.");if(0===e.detergentIngredients.length)return hideLoader(),void showCustomAlert("No Data","There are no detergent ingredients configured. Add detergent ingredients first.");const s=[],i=parseFloat(document.getElementById("bodyWeight")?.value)||70,c=e.detergentIngredients.map(e=>parseFloat(e.ld50)).filter(e=>!isNaN(e)),d=c.length>0?Math.min(...c):0,l=e.detergentIngredients.map(e=>e.name).filter(e=>""!==e.trim()).join(", ");a.forEach(t=>{const r=n(t.products.map(e=>e.productType)),c=e.safetyFactorConfig[r]||e.safetyFactorConfig.Other,u=document.getElementById(`sf-input-train-${t.id}`),m=u&&parseFloat(u.value)||c.max,g=5e-4*d*i/m,h=g*t.minBsMddRatio,p=o.getLargestEssaForLineAndDosageForm(t,a),S=p>0?h/p:0,w=S*t.assumedSsa,y=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),C=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),f=t.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),N=t.worstProductRpn?`${t.worstProductRpn.productName} (${t.worstProductRpn.ingredientName}) - RPN: ${t.worstProductRpn.rpn}`:"N/A";s.push({Train:`T${t.id}`,"Total Products":t.products.length,"Total Machines":y.length,"Total Area (ESSA) cm²":t.essa.toLocaleString(),Products:f,Machines:C,"Worst-Case Dosage Form":r,"Safety Factor Range":`${c.min} - ${c.max}`,"Applied Safety Factor":m,"Detergent Ingredients":l,"Body Weight (kg)":i,"Minimum LD50 (mg/kg)":d,"Min Batch Size (kg)":t.minMbsKg,"Min BS/MDD Ratio":t.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":N,"ADI (mg)":g.toFixed(4),"MACO (mg)":h.toFixed(2),"MACO per Area (mg/cm²)":S.toExponential(3),"MACO per Swab (mg/Swab)":w.toFixed(4)})});const u=XLSX.utils.json_to_sheet(s),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,u,"Detergent MACO Report");u["!cols"]=[{wch:8},{wch:12},{wch:12},{wch:15},{wch:50},{wch:50},{wch:15},{wch:15},{wch:15},{wch:30},{wch:12},{wch:15},{wch:12},{wch:12},{wch:40},{wch:12},{wch:12},{wch:18},{wch:18}];const g=(new Date).toISOString().split("T")[0];XLSX.writeFile(m,`Detergent_MACO_Report_${g}.xlsx`),hideLoader(),showCustomAlert("Success","Detergent MACO data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Detergent MACO to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export Detergent MACO data to Excel.")})}export function exportTrainSummaryToExcel(t="all"){showLoader(),import("./utils.js").then(o=>{const{getTrainData:r}=o,n=r();if(0===n.length)return hideLoader(),void showCustomAlert("No Data","There are no trains to export. Assign machines to products first.");let a=n;if("all"!==t&&(a=Array.isArray(t)?n.filter(e=>t.includes(String(e.id))):n.filter(e=>String(e.id)===String(t))),0===a.length)return hideLoader(),void showCustomAlert("No Data","No trains match the selected criteria.");const s=[];a.forEach(t=>{const o=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{id:t,name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),r=t.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),n=t.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),a=t.products.map(e=>`${e.productCode}: ${e.name}`).join("\n"),i=o.map(e=>`${e.machineNumber}: ${e.name}`).join("\n");s.push({"Train ID":`T${t.id}`,"Products Count":t.products.length,"Machines Count":o.length,"Total Area (ESSA) cm²":t.essa.toLocaleString(),"Products (Code - Name)":n,"Machines (Number - Name)":r,"Products Detailed":a,"Machines Detailed":i,"Min Batch Size (kg)":t.minMbsKg,"Min BS/MDD Ratio":t.minBsMddRatio.toFixed(2),"Assumed SSA (cm²)":t.assumedSsa,"Lowest LTD (mg)":t.lowestLtd,"Lowest PDE (mg)":null!==t.lowestPde?t.lowestPde:"N/A","Worst RPN Product":t.worstProductRpn?`${t.worstProductRpn.productName} (${t.worstProductRpn.ingredientName}) - RPN: ${t.worstProductRpn.rpn}`:"N/A"})});const i=XLSX.utils.json_to_sheet(s),c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,i,"Train Summary Report");i["!cols"]=[{wch:10},{wch:12},{wch:12},{wch:15},{wch:60},{wch:60},{wch:40},{wch:40},{wch:15},{wch:15},{wch:15},{wch:12},{wch:12},{wch:50}];const d=(new Date).toISOString().split("T")[0];let l="Train_Summary_Report";if("all"!==t)if(Array.isArray(t)){l+=`_Trains_${t.sort((e,t)=>e-t).join("_")}`}else l+=`_Train_${t}`;l+=`_${d}.xlsx`,XLSX.writeFile(c,l),hideLoader(),showCustomAlert("Success","Train Summary data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Train Summary to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export Train Summary data to Excel.")})}export function exportSummaryToExcel(){showLoader(),import("./utils.js").then(t=>{const{getProductTrainId:o,calculateScores:r}=t,n=e.products.flatMap(e=>{const t=o(e);return e.activeIngredients.map(o=>({productName:e.name,productCode:e.productCode,ingredientName:o.name,rpn:r(o).rpn,trainId:"N/A"!==t?`T${t}`:"N/A",scores:r(o)}))}).sort((e,t)=>t.rpn-e.rpn).slice(0,10),a=e.products.filter(e=>e.isCritical);if(0===n.length&&0===a.length)return hideLoader(),void showCustomAlert("No Data","There are no summary data to export. Add products and ingredients first.");const s=XLSX.utils.book_new();if(n.length>0){const e=n.map((e,t)=>({Rank:t+1,"Product Code":e.productCode,"Product Name":e.productName,Train:e.trainId,Ingredient:e.ingredientName,RPN:e.rpn})),t=XLSX.utils.json_to_sheet(e),o=[{wch:8},{wch:15},{wch:30},{wch:10},{wch:25},{wch:8}];t["!cols"]=o,XLSX.utils.book_append_sheet(s,t,"Top 10 RPN")}if(a.length>0){const e=a.map(e=>({"Product Code":e.productCode,"Product Name":e.name,"Product Type":e.productType,"Batch Size (kg)":e.batchSizeKg,"MDD (mg)":e.mddMg,"Critical Reason":e.criticalReason||"No reason provided",Train:"N/A"!==o(e)?`T${o(e)}`:"N/A"})),t=XLSX.utils.json_to_sheet(e),r=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:50},{wch:10}];t["!cols"]=r,XLSX.utils.book_append_sheet(s,t,"Critical Products")}const i=e.products.map(e=>{const t=o(e),n=e.activeIngredients.reduce((e,t)=>{const o=r(t).rpn;return o>e.rpn?{...t,rpn:o}:e},{rpn:0,name:"N/A"});return{"Product Code":e.productCode,"Product Name":e.name,"Product Type":e.productType,"Batch Size (kg)":e.batchSizeKg,"MDD (mg)":e.mddMg,Train:"N/A"!==t?`T${t}`:"N/A","Is Critical":e.isCritical?"Yes":"No","Critical Reason":e.criticalReason||"N/A","Ingredients Count":e.activeIngredients.length,"Highest RPN Ingredient":n.name,"Highest RPN Value":n.rpn||0}}),c=XLSX.utils.json_to_sheet(i);c["!cols"]=[{wch:15},{wch:30},{wch:15},{wch:12},{wch:12},{wch:10},{wch:10},{wch:40},{wch:12},{wch:25},{wch:12}],XLSX.utils.book_append_sheet(s,c,"All Products");const d=(new Date).toISOString().split("T")[0];XLSX.writeFile(s,`MACO_Summary_Report_${d}.xlsx`),hideLoader(),showCustomAlert("Success","Summary report data exported to Excel successfully!")}).catch(e=>{console.error("Error exporting Summary to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export Summary report data to Excel.")})}export function exportAllTabsToExcel(){showLoader(),import("./utils.js").then(t=>{const{getTrainData:o,getWorstCaseProductType:r,getProductTrainId:n,calculateScores:a}=t,s=o();if(0===s.length)return hideLoader(),void showCustomAlert("No Data","There are no trains to export. Assign machines to products first.");const i=XLSX.utils.book_new();try{const t=[];s.forEach(o=>{const n=r(o.products.map(e=>e.productType)),a=(e.safetyFactorConfig[n]||e.safetyFactorConfig.Other).max,i=o.lowestLtd*o.minBsMddRatio/a,c=10*o.minMbsKg;let d=1/0,l=1/0;const u="true"===localStorage.getItem("productRegister-pdeHidden"),m="true"===localStorage.getItem("productRegister-ld50Hidden");if(null===o.lowestPde||u||(d=o.lowestPde*o.minBsMddRatio),null!==o.lowestLd50&&!m){const e=70*o.lowestLd50/2e3,t=o.products.flatMap(e=>e.activeIngredients.map(e=>e.mdd/1e3)),r=Math.min(...t);l=e*o.minMbsKg*1e3/(a*r)}const g=getLargestEssaForLineAndDosageForm(o,s),h=.004*g,p=[{name:"0.1% Therapeutic Dose",value:i},{name:"10 ppm Criterion",value:c}];null===o.lowestPde||u||p.push({name:"Health-Based Limit (PDE)",value:d}),null===o.lowestLd50||m||p.push({name:"Health-Based Limit (NOEL)",value:l}),p.push({name:"Visual Clean Limit",value:h});const S=p.reduce((e,t)=>t.value<e.value?t:e),w=S.value,y=g>0?w/g:0,C=y*o.assumedSsa,f=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),N=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),A=o.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),P=o.worstProductRpn?`${o.worstProductRpn.productName} (${o.worstProductRpn.ingredientName}) - RPN: ${o.worstProductRpn.rpn}`:"N/A";t.push({Train:`T${o.id}`,"Total Products":o.products.length,"Total Machines":f.length,"Total Area (ESSA) cm²":o.essa.toLocaleString(),Products:A,Machines:N,"Worst-Case Dosage Form":n,"Safety Factor":a,"Lowest LTD (mg)":o.lowestLtd,"Min Batch Size (kg)":o.minMbsKg,"Min BS/MDD Ratio":o.minBsMddRatio.toFixed(2),"Lowest PDE (mg)":null!==o.lowestPde?o.lowestPde:"N/A","Worst-Case Product (by RPN)":P,"MACO - Therapeutic Dose (mg)":i.toFixed(2),"MACO - 10 ppm (mg)":c.toFixed(2),"MACO - Health-Based (mg)":"number"==typeof d?d.toFixed(2):"N/A","MACO - Visual Clean (mg)":h.toFixed(2),"Selected MACO Method":S.name,"Final MACO (mg)":w.toFixed(2),"MACO per Area (mg/cm²)":y.toExponential(3),"MACO per Swab (mg/Swab)":C.toFixed(4)})});const o=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(i,o,"Product MACO")}catch(e){console.error("Error creating Product MACO sheet:",e)}try{if(e.detergentIngredients.length>0){const t=parseFloat(document.getElementById("bodyWeight")?.value)||70,o=e.detergentIngredients.map(e=>parseFloat(e.ld50)).filter(e=>!isNaN(e)),n=o.length>0?Math.min(...o):0,a=e.detergentIngredients.map(e=>e.name).filter(e=>""!==e.trim()).join(", "),c=[];s.forEach(o=>{const i=r(o.products.map(e=>e.productType)),d=e.safetyFactorConfig[i]||e.safetyFactorConfig.Other,l=document.getElementById(`sf-input-train-${o.id}`),u=l&&parseFloat(l.value)||d.max,m=5e-4*n*t/u,g=m*o.minBsMddRatio,h=getLargestEssaForLineAndDosageForm(o,s),p=h>0?g/h:0,S=p*o.assumedSsa,w=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),y=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),C=o.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),f=o.worstProductRpn?`${o.worstProductRpn.productName} (${o.worstProductRpn.ingredientName}) - RPN: ${o.worstProductRpn.rpn}`:"N/A";c.push({Train:`T${o.id}`,"Total Products":o.products.length,"Total Machines":w.length,"Total Area (ESSA) cm²":o.essa.toLocaleString(),Products:C,Machines:y,"Worst-Case Dosage Form":i,"Safety Factor Range":`${d.min} - ${d.max}`,"Applied Safety Factor":u,"Detergent Ingredients":a,"Body Weight (kg)":t,"Minimum LD50 (mg/kg)":n,"Min Batch Size (kg)":o.minMbsKg,"Min BS/MDD Ratio":o.minBsMddRatio.toFixed(2),"Worst-Case Product (by RPN)":f,"ADI (mg)":m.toFixed(4),"MACO (mg)":g.toFixed(2),"MACO per Area (mg/cm²)":p.toExponential(3),"MACO per Swab (mg/Swab)":S.toFixed(4)})});const d=XLSX.utils.json_to_sheet(c);XLSX.utils.book_append_sheet(i,d,"Detergent MACO")}}catch(e){console.error("Error creating Detergent MACO sheet:",e)}try{const t=[];s.forEach(o=>{const r=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o||{id:t,name:`Unknown (ID: ${t})`,machineNumber:"N/A"}}),n=o.machineIds.map(t=>{const o=e.machines.find(e=>e.id===t);return o?o.name:`Unknown (ID: ${t})`}).join(", "),a=o.products.map(e=>`${e.productCode} - ${e.name}`).join("; "),s=o.products.map(e=>`${e.productCode}: ${e.name}`).join("\n"),i=r.map(e=>`${e.machineNumber}: ${e.name}`).join("\n");t.push({"Train ID":`T${o.id}`,"Products Count":o.products.length,"Machines Count":r.length,"Total Area (ESSA) cm²":o.essa.toLocaleString(),"Products (Code - Name)":a,"Machines (Number - Name)":n,"Products Detailed":s,"Machines Detailed":i,"Min Batch Size (kg)":o.minMbsKg,"Min BS/MDD Ratio":o.minBsMddRatio.toFixed(2),"Assumed SSA (cm²)":o.assumedSsa,"Lowest LTD (mg)":o.lowestLtd,"Lowest PDE (mg)":null!==o.lowestPde?o.lowestPde:"N/A","Worst RPN Product":o.worstProductRpn?`${o.worstProductRpn.productName} (${o.worstProductRpn.ingredientName}) - RPN: ${o.worstProductRpn.rpn}`:"N/A"})});const o=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(i,o,"Train Summary")}catch(e){console.error("Error creating Train Summary sheet:",e)}try{const t=e.products.flatMap(e=>{const t=n(e);return e.activeIngredients.map(o=>({productName:e.name,productCode:e.productCode,ingredientName:o.name,rpn:a(o).rpn,trainId:"N/A"!==t?`T${t}`:"N/A"}))}).sort((e,t)=>t.rpn-e.rpn).slice(0,10);if(t.length>0){const e=t.map((e,t)=>({Rank:t+1,"Product Code":e.productCode,"Product Name":e.productName,Train:e.trainId,Ingredient:e.ingredientName,RPN:e.rpn})),o=XLSX.utils.json_to_sheet(e);XLSX.utils.book_append_sheet(i,o,"Top 10 RPN")}}catch(e){console.error("Error creating Top 10 RPN sheet:",e)}try{const t=e.products.filter(e=>e.isCritical);if(t.length>0){const e=t.map(e=>({"Product Code":e.productCode,"Product Name":e.name,"Product Type":e.productType,"Batch Size (kg)":e.batchSizeKg,"MDD (mg)":e.mddMg,"Critical Reason":e.criticalReason||"No reason provided",Train:"N/A"!==n(e)?`T${n(e)}`:"N/A"})),o=XLSX.utils.json_to_sheet(e);XLSX.utils.book_append_sheet(i,o,"Critical Products")}}catch(e){console.error("Error creating Critical Products sheet:",e)}try{const t=e.products.map(e=>{const t=n(e),o=e.activeIngredients.reduce((e,t)=>{const o=a(t).rpn;return o>e.rpn?{...t,rpn:o}:e},{rpn:0,name:"N/A"});return{"Product Code":e.productCode,"Product Name":e.name,"Product Type":e.productType,"Batch Size (kg)":e.batchSizeKg,"MDD (mg)":e.mddMg,Train:"N/A"!==t?`T${t}`:"N/A","Is Critical":e.isCritical?"Yes":"No","Critical Reason":e.criticalReason||"N/A","Ingredients Count":e.activeIngredients.length,"Highest RPN Ingredient":o.name,"Highest RPN Value":o.rpn||0}}),o=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(i,o,"All Products")}catch(e){console.error("Error creating All Products sheet:",e)}try{const t=[];e.products.forEach(e=>{const o=n(e),r={"Product Code":e.productCode,"Product Name":e.name,"Product Type":e.productType,"Batch Size (kg)":e.batchSizeKg,"MDD (mg)":e.mddMg,Train:"N/A"!==o?`T${o}`:"N/A","Is Critical":e.isCritical?"Yes":"No","Critical Reason":e.criticalReason||"N/A","Ingredient Type":"PRODUCT","Ingredient Name":"","LTD (mg)":"","PDE (mg)":"","LD50 (mg/kg)":"",Severity:"",Occurrence:"",Detection:"",RPN:""};t.push(r),e.activeIngredients.forEach(e=>{const o=a(e);t.push({"Product Code":"","Product Name":"","Product Type":"","Batch Size (kg)":"","MDD (mg)":"",Train:"","Is Critical":"","Critical Reason":"","Ingredient Type":"INGREDIENT","Ingredient Name":e.name,"LTD (mg)":e.ltdMg||"N/A","PDE (mg)":e.pdeMg||"N/A","LD50 (mg/kg)":e.ld50||"N/A",Severity:o.severity,Occurrence:o.occurrence,Detection:o.detection,RPN:o.rpn})})});const o=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(i,o,"Product Register")}catch(e){console.error("Error creating Product Register sheet:",e)}const c=(new Date).toISOString().split("T")[0];XLSX.writeFile(i,`Complete_MACO_Report_${c}.xlsx`),hideLoader(),showCustomAlert("Success","Complete report with all tabs exported to Excel successfully!")}).catch(e=>{console.error("Error exporting all tabs to Excel:",e),hideLoader(),showCustomAlert("Error","Failed to export complete report to Excel.")})}export function toggleStageSection(e){const t=document.getElementById(`stage-${e}`),o="none"===t.style.display;t.style.display=o?"":"none",localStorage.setItem(`machineStage-${e}-hidden`,!o);const r=t.parentElement.querySelector("button");r&&(r.textContent=o?"Hide":"Show")}