import*as e from"./state.js";import{fullAppRender as t}from"./app.js";import{showLoader as r,hideLoader as n,showCustomAlert as o,saveStateForUndo as i}from"./ui.js";import{getRpnRatingClass as a}from"./utils.js";export function toggleScoringEditMode(t){e.setScoringInEditMode(t);const r=document.getElementById("editScoringBtn");t?(r.textContent="View",r.className="px-4 py-2 text-sm rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"):(r.textContent="Edit",r.className="px-4 py-2 text-sm rounded-lg btn-gradient"),renderScoringSystem()}export function renderScoringSystem(){const t=document.getElementById("scoringSystemContainer");if(t.innerHTML="",e.scoringInEditMode){const r=document.createElement("form");r.id="scoringForm",r.className="space-y-6";for(const t in e.scoringCriteria){const n=e.scoringCriteria[t],o=document.createElement("div");o.innerHTML=`<h4 class="text-lg font-semibold mb-3">${n.title}</h4>`;const i=document.createElement("div");i.id=`fields-container-${t}`,i.className="space-y-2",n.criteria.forEach(e=>i.appendChild(d(t,e))),o.appendChild(i);const a=document.createElement("div");a.className="pt-2 no-print",a.innerHTML=`<button type="button" onclick="addCriterionToScoringTab('${t}')" class="text-sm px-3 py-1 rounded-md text-white btn-gradient">+ Add Criterion</button>`,o.appendChild(a),r.appendChild(o)}t.appendChild(r);const n=document.createElement("button");n.onclick=e=>saveScoringCriteria(e),n.className="w-full mt-6 py-2.5 text-white rounded-lg no-print btn-gradient",n.textContent="Save All Changes",t.appendChild(n)}else{const r=document.createElement("div");r.className="grid grid-cols-1 md:grid-cols-2 gap-6";for(const t in e.scoringCriteria){const n=e.scoringCriteria[t],o=document.createElement("div");o.className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700";let i=`<h4 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">${n.title}</h4>\n                                     <div class="overflow-hidden rounded-md border border-gray-300 dark:border-gray-600">\n                                         <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">`;const d="rpn_threshold"===n.type;i+=`<thead class="bg-gray-50 dark:bg-gray-700/50">\n                                    <tr>\n                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${d?"Range Description":"Criteria"}</th>\n                                        <th scope="col" class="px-3 py-2 text-left text-sm font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">${d?"Rating":"Score"}</th>\n                                    </tr>\n                                  </thead>\n                                  <tbody class="divide-y divide-gray-200 dark:divide-gray-600" style="background-color: var(--bg-secondary);">`,n.criteria.forEach(e=>{let t,r;if(d){t=e.rangeDescription;r=`<span class="rpn-rating-badge ${a(e.rating)}">${e.rating}</span>`}else{t=e.text;r=`<span class="score-badge ${`score-${e.score}`}">${e.score}</span>`}i+=`<tr>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${t}</td>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm">${r}</td>\n                                      </tr>`}),i+="</tbody></table></div>",o.innerHTML=i,r.appendChild(o)}t.appendChild(r)}}function d(t,r){const n=document.createElement("div");n.className="grid gap-2 items-center p-2 border rounded-md",n.style.borderColor="var(--border-color)";const o=e.scoringCriteria[t].type;if("exactMatch"===o)n.style.gridTemplateColumns="3fr 1fr 0.5fr",n.innerHTML=`<input type="text" value="${r.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" value="${r.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if("range"===o)n.style.gridTemplateColumns="2fr 1fr 1fr 1fr 0.5fr",n.innerHTML=`<input type="text" value="${r.text}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="text"><input type="number" step="any" value="${r.lowerBound??""}" placeholder="Min" class="w-full px-2 py-1 border rounded-md text-sm" data-field="lowerBound" min="0"><input type="number" step="any" value="${r.upperBound??""}" placeholder="Max" class="w-full px-2 py-1 border rounded-md text-sm" data-field="upperBound" min="0"><input type="number" value="${r.score}" class="w-full px-2 py-1 border rounded-md text-sm" data-field="score" min="0">`;else if("rpn_threshold"===o){n.style.gridTemplateColumns="1fr 1fr 1fr 1fr 0.5fr";const e=r.max===1/0?"":r.max;n.innerHTML=`<input type="number" value="${r.min}" placeholder="Min RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="minRpn" min="0"><input type="number" value="${e}" placeholder="Max RPN" class="w-full px-2 py-1 border rounded-md text-sm" data-field="maxRpn" min="0"><input type="text" value="${r.rating}" placeholder="Rating" class="w-full px-2 py-1 border rounded-md text-sm" data-field="ratingText"><span class="text-xs self-center" style="color:var(--text-secondary);">${r.rangeDescription}</span>`}return n.innerHTML+='<button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>',n}export function addCriterionToScoringTab(t){const r=document.getElementById(`fields-container-${t}`),n=e.scoringCriteria[t];let o;"rpn_threshold"===n.type?o={min:0,max:10,rating:"NEW",rangeDescription:"0-10"}:(o={...n.criteria[0]||{text:"",score:0},text:"New Criterion",score:n.defaultScore||1},"range"===n.type&&(delete o.lowerBound,delete o.upperBound,o.comparison=n.criteria[0]?.comparison||"between_inclusive_both")),r.appendChild(d(t,o))}export function saveScoringCriteria(a){const d=a.target;r(),d.disabled=!0;try{const r=JSON.parse(JSON.stringify(e.scoringCriteria));let n=!0;for(const t in r){if(!n)break;const o=r[t],i=e.scoringCriteria[t].type;o.criteria=[];const a=document.getElementById(`fields-container-${t}`);a&&Array.from(a.children).forEach(r=>{if(!n)return;const a={};if("exactMatch"===i||"range"===i){if(a.text=r.querySelector('[data-field="text"]').value,a.score=parseInt(r.querySelector('[data-field="score"]').value),!a.text||isNaN(a.score))return void(n=!1);if("range"===i){const o=r.querySelector('[data-field="lowerBound"]').value,i=r.querySelector('[data-field="upperBound"]').value;if(a.lowerBound=o?parseFloat(o):void 0,a.upperBound=i?parseFloat(i):void 0,o&&isNaN(a.lowerBound)||i&&isNaN(a.upperBound)||void 0!==a.lowerBound&&void 0!==a.upperBound&&a.lowerBound>=a.upperBound)return void(n=!1);void 0===a.lowerBound&&void 0!==a.upperBound?a.comparison="less_inclusive":void 0!==a.lowerBound&&void 0===a.upperBound?a.comparison="greater_exclusive":a.comparison=e.scoringCriteria[t].criteria.find(e=>e.text===a.text)?.comparison||"between_exclusive_lower_inclusive_upper"}}else if("rpn_threshold"===i){a.min=parseFloat(r.querySelector('[data-field="minRpn"]').value);const e=r.querySelector('[data-field="maxRpn"]').value;if(a.max=""===e||null===e?1/0:parseFloat(e),a.rating=r.querySelector('[data-field="ratingText"]').value.trim(),isNaN(a.min)||""!==e&&isNaN(a.max)||!a.rating||a.min>=a.max)return void(n=!1);a.rangeDescription=`${a.min} - ${e||"Infinity"}`}o.criteria.push(a)})}n?(e.setScoringCriteria(r),i(),toggleScoringEditMode(!1),t(),o("Success","Changes saved successfully.")):o("Validation Error","Please check your input. Some fields may be invalid.")}catch(e){console.error("Error saving scoring criteria:",e),o("Error","Failed to save changes. Please try again.")}finally{n(),d.disabled=!1}}